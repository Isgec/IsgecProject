/////************************ISSUE NO.0004767  **************///////**1/11/2011**////

CREATE OR REPLACE PACKAGE BODY cir_comm_mast_bind IS
  procedure cir_comm_mast_bind_p(pcomp_code in varchar2,punit_code in varchar2, porderby in varchar2, p_accounts out t_accounts) as
   v_str varchar2(4000);
   Begin
    v_str:='select a.*,cir_get_publ_name(a.comp_code,a.publ) publ_name, cir_get_edtn_name(a.comp_code,a.edtn) edtn_name 
                  from cir_comm_mast a 
                    where a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' order by '||porderby;
    --insert into test1(vstring,vstring2) values(' cir_comm_mast_bind ',v_str);commit;                    
   	  open p_accounts for v_str;
      
   End cir_comm_mast_bind_p;
END;
/
/////************************END***ISSUE NO.0004767  **************///////**1/11/2011**////

/////************************END***ISSUE NO.0004826  **************///////**1/11/2011**////
CREATE OR REPLACE PACKAGE BODY cir_agency_bind is
procedure cir_agency_listing_p (--Agency Master Listing
    pcompcode       in varchar2,
    punit           in varchar2,
    pagty           in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts_cursor) as
Begin
    open p_accounts for
    select A.COMP_CODE,A.UNIT,A.BRANCH_CODE,C."Branch_Name" BRANCH_NAME, A.AGCD,A.DPCD,A.AG_NAME,A.AG_NAME_OTH_LANG,
        A.AG_CLASS,(SELECT CLASS_DESC FROM CIR_AGENCY_CLASS_MAST WHERE CIR_AGENCY_CLASS_MAST.COMP_CODE=A.COMP_CODE AND CIR_AGENCY_CLASS_MAST.CLASS_CODE=A.AG_CLASS) AG_CLASS_NAME,
        A.AG_TYPE,CIR_GET_AGENCY_TYPE(A.COMP_CODE,A.AG_TYPE) AG_TYPE_NAME, A.SUPPLY_START_DT,
        A.ADDR1, A.ADDR2, A.ADDR3,A.PIN_CODE, A.CITY_CODE,CIR_GET_CITY(A.COMP_CODE,A.CITY_CODE) CITY_NAME, A.DIST_CODE,CIR_GET_DIST(A.COMP_CODE,A.STATE_CODE,A.DIST_CODE) DIST_NAME,
        A.STATE_CODE,CIR_GET_STATE(A.COMP_CODE,A.COUNTRY_CODE,A.STATE_CODE) STATE_NAME, A.TEHSIL_TALUKA TALUKA_CODE,CIR_GET_TALUKA(A.COMP_CODE,A.TEHSIL_TALUKA) TALUKA_NAME, 
        A.STATION_CODE,CIR_GET_DROP_POINT_NAME(A.COMP_CODE,A.UNIT,A.STATION_CODE,1) DROP_POINT_NAME,
        A.AREA_CODE,CIR_GET_AREA(A.COMP_CODE,A.AREA_CODE) AREA_NAME, A.PHONE_NO1, A.PHONE_NO2, A.MOBILE_NO1, A.MOBILE_NO2,A.FAX_NO, A.EMAIL_ID, A.SUSPEND, A.SUSPEND_TYPE, A.SUSPEND_DATE, 
        A.TO_BILL, A.BILL_AGCD, A.BILL_DPCD,CIR_GET_AGENCY(A.COMP_CODE,A.UNIT,A.BILL_AGCD,A.BILL_DPCD) BILL_AGENCY, A.PAYMODE, A.CREDIT_DAYS, A.PRINT_LABEL, A.PIN_PACKET, 
        A.PIN_AGCD, A.PIN_DPCD,CIR_GET_AGENCY(A.COMP_CODE,A.UNIT,A.PIN_AGCD,A.PIN_DPCD) PIN_AGENCY, A.PIN_OPEN_INSIDE,
        A.NAME_ON_LABEL, A.PRINT_SEQ,CASE WHEN A.UNSOLD_VALID_FLAG='D' THEN 'Daily' WHEN A.UNSOLD_VALID_FLAG='W' THEN 'Weekly' ELSE 'Monthly' END BILL_CYCLE, 
        A.SECURITY_PER, A.SEC_AMT_LIMT, A.SUPPLY_STOP_FLAG, A.SUPPLY_STOP_PER, A.ABC_CITYCODE,CIR_GET_CITY(A.COMP_CODE,A.ABC_CITYCODE) ABC_CITY_NAME,
        B.NAME CON_PER_NAME,B.DESIG CON_PER_DESIG,B.PER_ROLE CON_PER_PER_ROLE,B.DATE_OF_BIRTH DATE_OF_BIRTH, B.PHONE_NO1 CON_PER_PHONE_NO1, B.PHONE_NO2 CON_PER_PHONE_NO2, 
        B.MOBILE_NO1 CON_PER_MOBILE_NO1, B.MOBILE_NO2 CON_PER_MOBILE_NO2, B.FAX_NO CON_PER_FAX_NO, B.EMAIL_ID CON_PER_EMAIL_ID
    from cir_agmast a,cir_ag_con_per b,branch_mst c
        where a.comp_code=b.comp_code(+) and a.comp_code = pcompcode and a.unit=b.unit(+) and (a.unit = punit or punit is null) and 
        a.agcd=b.agcd(+) and a.dpcd=b.dpcd(+) and a.branch_code=c."Branch_Code" and (ag_type = pagty or pagty is null)
    order by a.comp_code,a.unit,a.ag_name, b.name;
    
End cir_agency_listing_p;
/////************************END***ISSUE NO.0004826  **************///////**1/11/2011**////



/////************************ISSUE NO.0005466  **************///////**2/11/2011**////

CREATE OR REPLACE PACKAGE BODY cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and (d.unit_code=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and (d.unit=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/


/////************************END***ISSUE NO.0005466  **************///////**2/11/2011**////


//////////////////////////////issue no-4818//specification////////////////////////////////////////
CREATE OR REPLACE PACKAGE ERP6MAR.cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/
////////////////////////////////////////////////body///////////////////////////////////////
CREATE OR REPLACE PACKAGE BODY ERP6MAR.cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt from
               (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
  
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,--for group based on State S,District D,Taluka T,Branch B
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;

     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;

  End cir_publ_unsold_supply;


    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
  
   procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
            
    v1 c1%rowtype;
   
  Begin
        
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));

        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,agname,city_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd order by publ_name,main_edtn_name,edtn_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code order by state_name,dist_name,taluka_name;

                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    
  End cir_monthly_net_paid_sale;

  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;

/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/

    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      
      v_opbal           number(10):=0;

  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);

            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/

            
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);

            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                                              
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
                
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;

            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            
            open p_accounts3 for v_query1;

            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
                   
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            
            open p_accounts5 for v_query1; 
        
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        
        open p_accounts5 for select sysdate from dual; 
        
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
   
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
    
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/


/////////////////////////////////end of issue/////////////////////////////////////////////////////////////////





//////////*************** START OF ISSUE NO. 0005380  ORCL PRO ******************///****************//////



 CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_lbl_prn IS
  procedure cir_rep_lbl_prn_bhaskar_p(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     plbldt         in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2         in varchar2,
     p_accounts     out t_accounts) as
   Begin
       open p_accounts for
          select cir_lblmast.*,cir_get_mode_name(comp_code,unit_code||route) mode_name,
          SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn  ,'1',''''||pdateformat||'''','',''),1,30) edtn_name,
          (select distinct reg_no from cir_edtn_mast where comp_code = pcomp_code and edtn=cir_lblmast.edtn_1) AS "REG_NO" 
           from cir_lblMAST
             where comp_code = pcomp_code and 
                   unit_code = punit_code and 
                   lbl_dt    = to_date(plbldt,''''||pdateformat||'''') and 
                   ((publ    = ppubl) or (ppubl is null)) and 
                   ((nvl(edtn,edtn_1)    = pedtn) or (pedtn is null)) and
                   nvl(edtn,edtn_1) in(select edtn from cir_edtn_mast where comp_code=pcomp_code and 
                   (unit_code=punit_code or punit_code is null) and ((edtn = pedtn) or (pedtn is null)) and (main_edtn=pmainedtn or pmainedtn is null)) and
                   ((route   = proute) or (proute is null)) and 
                   ((agcd    = pagcd) or (pagcd is null)) and 
                   ((dpcd    = pdpcd) or (pdpcd is null));
 
    End cir_rep_lbl_prn_bhaskar_p;
     
    procedure cir_rep_lbl_prn2_p(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     proutetype     in varchar2,
     proutecode     in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     ppinpkt        in varchar2,
     psupply_from   in number,
     psupply_till   in number,
     pedtntype      in varchar2,
     plbldt         in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     pdistrictcode  in varchar2,
     ptalukacode    in varchar2,
     porderby       in number,    
     p_accounts     out t_accounts)
     As
     v_dt           date;
     vsupply_from   number(7);
     vsupply_till   number(7);
     vorderby number(1):=0;
    Begin
        v_dt:=to_date(plbldt,''''||pdateformat||'''');
        vorderby:=  nvl(porderby,0);
        if psupply_from is null then
            vsupply_from:=1;
        else
            vsupply_from:=psupply_from;
        end if;
        if psupply_till is null then
           vsupply_till:=9999999;
        else
           vsupply_till:=psupply_till;   
        end if;
        
        delete from test1;INSERT INTO TEST1 VALUES(' cir_rep_lbl_prn2_p COMPCODE '||pcompcode||' UNIT '||punitcode||' PUBLICATION '||ppublcode||' MAINEDITION '||pmainedtn||' EDITION '||pedtncode||' ROUTETYPE '||proutetype||' ROUTECODE '||proutecode||' AGCD '||pagcd||' DPCD '||pdpcd||' PINPACKET '||ppinpkt,' SUPPLYFROM '||psupply_from||' SUPPLYTO '||psupply_till||' EDITIONTYPE '||pedtntype||' LABELDATE '||plbldt||' DATEFORMAT '||pdateformat||' EXTRA1 '||pextra1||' EXTRA2 '||pextra2||' DISTRICTCODE '||pdistrictcode||' TALUKACODE '||ptalukacode||' v_dt '||v_dt); COMMIT;
        if vorderby='1' then
            open p_accounts for
            select comp_code,unit_code,agcd,dpcd,lbl_dt,lblty,route,subrt,sub_subrt,rtnm,SUBSTR(rtonm,1,35) rtonm,subrtnm,SUBSTR(subrtonm,1,35) subrtonm,subsubrtnm,SUBSTR(subsubrtonm,1,35) subsubrtonm,
            lbl_sno,lbl_tno,msg_1,msg_2,msg_3,agname,substr(city_name,1,30) city_name,substr(city_oname,1,35) city_oname,substr(station_name,1,30) station_name,substr(station_oname,1,35) station_oname,
            lblln1,lblln2,lblln3,lblln4,
            lblln5,tcp1,tcp2,tcp3,cp1,cp2,cp3,lbl_lno,pkt_size,no_page,
            publ  ,cir_get_name.cir_publ(comp_code,publ  ,'1',''''||pdateformat||'''','','') publ_name  ,publ_name publ_oname ,--cir_get_name.cir_publ(comp_code,publ  ,'2',''''||pdateformat||'''','','') publ_oname, 
            publ_1,cir_get_name.cir_publ(comp_code,publ_1,'1',''''||pdateformat||'''','','') publ_1_name,cir_get_name.cir_publ(comp_code,publ_1,'2',''''||pdateformat||'''','','') publ_1_oname,
            publ_2,cir_get_name.cir_publ(comp_code,publ_2,'1',''''||pdateformat||'''','','') publ_2_name,cir_get_name.cir_publ(comp_code,publ_2,'2',''''||pdateformat||'''','','') publ_2_oname,
            publ_3,cir_get_name.cir_publ(comp_code,publ_3,'1',''''||pdateformat||'''','','') publ_3_name,cir_get_name.cir_publ(comp_code,publ_3,'2',''''||pdateformat||'''','','') publ_3_oname,
            publ_4,cir_get_name.cir_publ(comp_code,publ_4,'1',''''||pdateformat||'''','','') publ_4_name,cir_get_name.cir_publ(comp_code,publ_4,'2',''''||pdateformat||'''','','') publ_4_oname,
            edtn  ,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn  ,'1',''''||pdateformat||'''','',''),1,30) edtn_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn  ,'2',''''||pdateformat||'''','','') edtn_oname,
            edtn_1,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_1  ,'1',''''||pdateformat||'''','',''),1,30) edtn_1_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_1,'2',''''||pdateformat||'''','','') edtn_1_oname,
            edtn_2,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_2  ,'1',''''||pdateformat||'''','',''),1,30) edtn_2_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_2,'2',''''||pdateformat||'''','','') edtn_2_oname,
            edtn_3,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_3  ,'1',''''||pdateformat||'''','',''),1,30) edtn_3_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_3,'2',''''||pdateformat||'''','','') edtn_3_oname,
            edtn_4,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_4  ,'1',''''||pdateformat||'''','',''),1,30) edtn_4_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_4,'2',''''||pdateformat||'''','','') edtn_4_oname,
            supply_1,supply_2,supply_3,supply_4,seq_no,coag,codp,agty,period,city_seqno,route_seqno, substr(agoname,1,35) agoname,lbl_print_no,case when pedtntype='M' then sup_rate else null end sup_rate,
            pin_open_inside,lbl_lno||'/'||(select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  
            l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and nvl(l.supply_1,0)>0) route_packet,(select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and 
            l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and l.subrt=cir_lblmast.subrt and nvl(l.supply_1,0)>0) sub_route_packet,
            (select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  
            l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and l.subrt=cir_lblmast.subrt and l.sub_subrt=cir_lblmast.sub_subrt and nvl(l.supply_1,0)>0 ) sub_subroute_packet,
            nvl(dist_seqno,1) dist_seqno,substr(distname,1,4) distname,distoname distoname  
            from cir_lblmast
                 where comp_code = pcompcode and 
                       unit_code = punitcode and 
                       lbl_dt    = v_dt and 
                       (publ     = ppublcode or ppublcode is null) and 
                       (nvl(edtn,edtn_1)    = pedtncode or pedtncode is null) and
                       nvl(edtn,edtn_1) in(select edtn from cir_edtn_mast where comp_code=pcompcode and 
                       (unit_code=punitcode or punitcode is null) and (edtn = pedtncode or pedtncode is null) and 
                       (main_edtn=pmainedtn or pmainedtn is null)) and
                       (route   = proutecode or proutecode is null) and 
                       (agcd    = pagcd or pagcd is null) and 
                       (dpcd    = pdpcd or pdpcd is null) and
                       (pin_open_inside=ppinpkt or ppinpkt is null) and agcd||dpcd in(select distinct agcd||dpcd 
                       from cir_lblmast where comp_code = pcompcode and unit_code = punitcode and 
                       lbl_dt    = v_dt and (publ    = ppublcode or ppublcode is null) and 
                       (nvl(edtn,edtn_1) = pedtncode or pedtncode is null) and 
                       (route   = proutecode or proutecode is null) and 
                       (agcd    = pagcd or pagcd is null) and 
                       (dpcd    = pdpcd or pdpcd is null)
                       group by agcd,dpcd
                       having sum(supply_1) between vsupply_from and vsupply_till) and
                       agcd||dpcd in(select agcd||dpcd from cir_agmast where comp_code = pcompcode and unit = punitcode and 
                       (dist_code=pdistrictcode or pdistrictcode is null) and (tehsil_taluka=ptalukacode or ptalukacode is null))  
                       order by unit_code,dist_seqno,seq_no,route,edtn,agname;
        else
            open p_accounts for
            select comp_code,unit_code,agcd,dpcd,lbl_dt,lblty,route,subrt,sub_subrt,rtnm,SUBSTR(rtonm,1,35) rtonm,subrtnm,SUBSTR(subrtonm,1,35) subrtonm,subsubrtnm,SUBSTR(subsubrtonm,1,35) subsubrtonm,
            lbl_sno,lbl_tno,msg_1,msg_2,msg_3,agname,city_name,city_oname,station_name,station_oname,lblln1,lblln2,lblln3,lblln4,
            lblln5,tcp1,tcp2,tcp3,cp1,cp2,cp3,lbl_lno,pkt_size,no_page,
            publ  ,cir_get_name.cir_publ(comp_code,publ  ,'1',''''||pdateformat||'''','','') publ_name  ,publ_name publ_oname ,--cir_get_name.cir_publ(comp_code,publ  ,'2',''''||pdateformat||'''','','') publ_oname, 
            publ_1,cir_get_name.cir_publ(comp_code,publ_1,'1',''''||pdateformat||'''','','') publ_1_name,cir_get_name.cir_publ(comp_code,publ_1,'2',''''||pdateformat||'''','','') publ_1_oname,
            publ_2,cir_get_name.cir_publ(comp_code,publ_2,'1',''''||pdateformat||'''','','') publ_2_name,cir_get_name.cir_publ(comp_code,publ_2,'2',''''||pdateformat||'''','','') publ_2_oname,
            publ_3,cir_get_name.cir_publ(comp_code,publ_3,'1',''''||pdateformat||'''','','') publ_3_name,cir_get_name.cir_publ(comp_code,publ_3,'2',''''||pdateformat||'''','','') publ_3_oname,
            publ_4,cir_get_name.cir_publ(comp_code,publ_4,'1',''''||pdateformat||'''','','') publ_4_name,cir_get_name.cir_publ(comp_code,publ_4,'2',''''||pdateformat||'''','','') publ_4_oname,
            edtn  ,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn  ,'1',''''||pdateformat||'''','',''),1,30) edtn_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn  ,'2',''''||pdateformat||'''','','') edtn_oname,
            edtn_1,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_1  ,'1',''''||pdateformat||'''','',''),1,30) edtn_1_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_1,'2',''''||pdateformat||'''','','') edtn_1_oname,
            edtn_2,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_2  ,'1',''''||pdateformat||'''','',''),1,30) edtn_2_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_2,'2',''''||pdateformat||'''','','') edtn_2_oname,
            edtn_3,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_3  ,'1',''''||pdateformat||'''','',''),1,30) edtn_3_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_3,'2',''''||pdateformat||'''','','') edtn_3_oname,
            edtn_4,SUBSTR(cir_get_name.cir_edtn(comp_code,unit_code,edtn_4  ,'1',''''||pdateformat||'''','',''),1,30) edtn_4_name ,cir_get_name.cir_edtn(comp_code,unit_code,edtn_4,'2',''''||pdateformat||'''','','') edtn_4_oname,
            supply_1,supply_2,supply_3,supply_4,seq_no,coag,codp,agty,period,city_seqno,route_seqno, substr(agoname,1,40) agoname,lbl_print_no,case when pedtntype='M' then sup_rate else 0 end sup_rate,
            pin_open_inside,lbl_lno||'/'||(select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  
            l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and nvl(l.supply_1,0)>0) route_packet,(select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and 
            l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and l.subrt=cir_lblmast.subrt and nvl(l.supply_1,0)>0) sub_route_packet,
            (select count(*) from cir_lblmast l where l.comp_code=cir_lblmast.comp_code and l.unit_code=cir_lblmast.unit_code and l.lbl_dt=cir_lblmast.lbl_dt and  
            l.publ=cir_lblmast.publ and l.route=cir_lblmast.route and l.subrt=cir_lblmast.subrt and l.sub_subrt=cir_lblmast.sub_subrt and nvl(l.supply_1,0)>0 ) sub_subroute_packet,
            nvl(dist_seqno,1) dist_seqno,null distname,distoname distoname
            from cir_lblmast
                 where comp_code = pcompcode and 
                       unit_code = punitcode and 
                       lbl_dt    = v_dt and 
                       (publ     = ppublcode or ppublcode is null) and 
                       (nvl(edtn,edtn_1)    = pedtncode or pedtncode is null) and
                       nvl(edtn,edtn_1) in(select edtn from cir_edtn_mast where comp_code=pcompcode and 
                       (unit_code=punitcode or punitcode is null) and (edtn = pedtncode or pedtncode is null) and 
                       (main_edtn=pmainedtn or pmainedtn is null)) and
                       (route   = proutecode or proutecode is null) and 
                       (agcd    = pagcd or pagcd is null) and 
                       (dpcd    = pdpcd or pdpcd is null) and
                       (pin_open_inside=ppinpkt or ppinpkt is null) and agcd||dpcd in(select distinct agcd||dpcd 
                       from cir_lblmast where comp_code = pcompcode and unit_code = punitcode and 
                       lbl_dt    = v_dt and (publ    = ppublcode or ppublcode is null) and 
                       (nvl(edtn,edtn_1) = pedtncode or pedtncode is null) and 
                       (route   = proutecode or proutecode is null) and 
                       (agcd    = pagcd or pagcd is null) and 
                       (dpcd    = pdpcd or pdpcd is null)
                       group by agcd,dpcd
                       having sum(supply_1) between vsupply_from and vsupply_till) and
                       agcd||dpcd in(select agcd||dpcd from cir_agmast where comp_code = pcompcode and unit = punitcode and 
                       (dist_code=pdistrictcode or pdistrictcode is null) and (tehsil_taluka=ptalukacode or ptalukacode is null))  
                       order by unit_code,seq_no,route,edtn,agname;
        end if;
    End cir_rep_lbl_prn2_p;
  procedure cir_rep_exlbl_prn_bhaskar_p(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     plbldt         in varchar2,
     pdateformat     in varchar2,
     pextra1         in varchar2,
     pextra2         in varchar2,
     p_accounts     out t_accounts)
   As
   Begin
       open p_accounts for
          select a.*,cir_get_mode_name_agn(a.comp_code, a.unit_code, a.agcd, a.dpcd, a.publ_code, a.edtn_code) mode_name,
         b.ag_name_oth_lang,cir_get_name.cir_city(a.comp_code,b.city_code,2,'','','') city_name_oth,b.print_seq
           from cir_extra_lable_det a ,cir_agmast b
             where a.comp_code = b.comp_code and
                   a.unit_code = b.unit and
                   a.agcd = b.agcd and
                   a.dpcd = b.dpcd and
                   a.comp_code = pcomp_code and 
                   a.unit_code = punit_code and
                   ((a.publ_code = ppubl) or (ppubl is null)) and 
                   ((a.edtn_code = pedtn) or (pedtn is null)) and
                   a.edtn_code in(select edtn from cir_edtn_mast e where e.comp_code=pcomp_code and 
                   (e.unit_code=punit_code or punit_code is null) and ((a.edtn_code = pedtn) or (pedtn is null)) and (e.main_edtn=pmainedtn or pmainedtn is null)) and
                   ((a.agcd    = pagcd) or (pagcd is null)) and 
                   ((a.dpcd    = pdpcd) or (pdpcd is null)) and 
                   (nvl(b.suspend,'N')='N') 
                   order by to_number(print_seq);
   End cir_rep_exlbl_prn_bhaskar_p;
END cir_rep_lbl_prn;
/




//////////*************** END OF ISSUE NO. 0005380 ******************///****************///

/*****************************Issue No. 5511 Laxman*************************/

CREATE OR REPLACE PACKAGE fa_rep_books IS
   TYPE t_accounts_cursor IS REF CURSOR;

    PROCEDURE fa_daybook_p (
      pcompcode     IN       VARCHAR2,
      punitcode     IN       VARCHAR2,
      pbran_code    IN       VARCHAR2,
      p_vchty       IN       VARCHAR2,
      p_frdt        IN       VARCHAR2,
      p_todt        IN       VARCHAR2,
      p_acc_cdp     IN       VARCHAR2,
      ppassed_flag   IN       VARCHAR2,
      pdateformat   IN       VARCHAR2,
      pextra1       IN       VARCHAR2,
      pextra2       IN       VARCHAR2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor);
END fa_rep_books;
/
CREATE OR REPLACE PACKAGE BODY fa_rep_books
IS
   PROCEDURE fa_daybook_p (
      pcompcode     IN       VARCHAR2,
      punitcode     IN       VARCHAR2,
      pbran_code    IN       VARCHAR2,
      p_vchty       IN       VARCHAR2,
      p_frdt        IN       VARCHAR2,
      p_todt        IN       VARCHAR2,
      p_acc_cdp     IN       VARCHAR2,
      ppassed_flag   IN       VARCHAR2,
      pdateformat   IN       VARCHAR2,
      pextra1       IN       VARCHAR2,
      pextra2       IN       VARCHAR2,
      p_accounts    OUT      t_accounts_cursor,
      p_accounts1   OUT      t_accounts_cursor,
      p_accounts2   OUT      t_accounts_cursor)
   AS
      v_frdt   DATE;
      v_todt   DATE;
   BEGIN
      v_frdt := TO_DATE (p_frdt, '''' || pdateformat || '''');
      v_todt := TO_DATE (p_todt, '''' || pdateformat || '''');


       IF NVL (ppassed_flag, 'N') = 'P'
      THEN
      OPEN p_accounts FOR
         SELECT   unit_code, vch_id, doc_type,
                  TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE", vch_enln,
                  acc_cdp, acc_cds,
                  fa_get_account_name (comp_code, acc_cdp) acc_name,
                  DECODE (SIGN (vch_gamt), 1, 'Dr', -1, 'Cr') dbcr,
                  ABS (vch_gamt) vch_gamt, vch_ln1, vch_ln2, vch_chno,

                  /*vch_chdate*/
                  TO_CHAR (vch_chdate, 'dd/mm/yyyy') AS "VCH_CHDATE"
             FROM fa_vch_mst
            WHERE comp_code = pcompcode
              AND (unit_code = punitcode OR punitcode IS NULL)
              AND (bran_code = pbran_code OR pbran_code IS NULL)
              AND (doc_type = p_vchty OR p_vchty IS NULL)
              AND vch_date >= v_frdt
              AND vch_date <= v_todt
              AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
              AND NVL (passed, 'N') = 'P'
              AND status IS NULL
              AND NVL (control_no, 0) <> NVL (vch_id, 0)
         ORDER BY unit_code, vch_date, vch_id, doc_type, vch_enln;

      OPEN p_accounts1 FOR
         SELECT   unit_code, TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE",
                  (DECODE (debit, 'D', vch_gamt)) debit_amt,
                  (DECODE (credit, 'C', vch_gamt)) credit_amt
             FROM (SELECT unit_code, vch_date,
                          DECODE (SIGN (vch_gamt), 1, 'D') debit,
                          DECODE (SIGN (vch_gamt), -1, 'C') credit,
                          ABS (vch_gamt) vch_gamt
                     FROM fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND NVL (passed, 'N') = 'P'
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0))
         ORDER BY vch_date, unit_code;
       
        OPEN p_accounts2 FOR
        SELECT SUM((CASE DEBIT WHEN 'D' THEN vch_gamt END)) DEBIT_AMT,
           SUM((CASE CREDIT WHEN 'C' THEN vch_gamt END)) CREDIT_AMT FROM 
            (SELECT unit_code, VCH_DATE,
                        CASE SIGN(vch_gamt) WHEN 1 THEN 'D' END debit,
                        CASE SIGN(vch_gamt) WHEN - 1 THEN 'C' END credit,
                        ABS(vch_gamt) vch_gamt FROM  fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND NVL (passed, 'N') = 'P'
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0));
         
         ELSIF NVL (ppassed_flag, 'N') = 'N' THEN
            OPEN p_accounts FOR
         SELECT   unit_code, vch_id, doc_type,
                  TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE", vch_enln,
                  acc_cdp, acc_cds,
                  fa_get_account_name (comp_code, acc_cdp) acc_name,
                  DECODE (SIGN (vch_gamt), 1, 'Dr', -1, 'Cr') dbcr,
                  ABS (vch_gamt) vch_gamt, vch_ln1, vch_ln2, vch_chno,

                  /*vch_chdate*/
                  TO_CHAR (vch_chdate, 'dd/mm/yyyy') AS "VCH_CHDATE"
             FROM fa_vch_mst
            WHERE comp_code = pcompcode
              AND (unit_code = punitcode OR punitcode IS NULL)
              AND (bran_code = pbran_code OR pbran_code IS NULL)
              AND (doc_type = p_vchty OR p_vchty IS NULL)
              AND vch_date >= v_frdt
              AND vch_date <= v_todt
              AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
              AND NVL (passed, 'N') = 'N'
              AND status IS NULL
              AND NVL (control_no, 0) <> NVL (vch_id, 0)
         ORDER BY unit_code, vch_date, vch_id, doc_type, vch_enln;

      OPEN p_accounts1 FOR
         SELECT   unit_code, TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE",
                  (DECODE (debit, 'D', vch_gamt)) debit_amt,
                  (DECODE (credit, 'C', vch_gamt)) credit_amt
             FROM (SELECT unit_code, vch_date,
                          DECODE (SIGN (vch_gamt), 1, 'D') debit,
                          DECODE (SIGN (vch_gamt), -1, 'C') credit,
                          ABS (vch_gamt) vch_gamt
                     FROM fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND NVL (passed, 'N') = 'N'
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0))
         ORDER BY vch_date, unit_code;
        
        OPEN p_accounts2 FOR
        SELECT SUM((CASE DEBIT WHEN 'D' THEN vch_gamt END)) DEBIT_AMT,
           SUM((CASE CREDIT WHEN 'C' THEN vch_gamt END)) CREDIT_AMT FROM 
            (SELECT unit_code, VCH_DATE,
                        CASE SIGN(vch_gamt) WHEN 1 THEN 'D' END debit,
                        CASE SIGN(vch_gamt) WHEN - 1 THEN 'C' END credit,
                        ABS(vch_gamt) vch_gamt FROM  fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND NVL (passed, 'N') = 'N'
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0));
                      
         ELSE
         OPEN p_accounts FOR
         SELECT   unit_code, vch_id, doc_type,
                  TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE", vch_enln,
                  acc_cdp, acc_cds,
                  fa_get_account_name (comp_code, acc_cdp) acc_name,
                  DECODE (SIGN (vch_gamt), 1, 'Dr', -1, 'Cr') dbcr,
                  ABS (vch_gamt) vch_gamt, vch_ln1, vch_ln2, vch_chno,

                  /*vch_chdate*/
                  TO_CHAR (vch_chdate, 'dd/mm/yyyy') AS "VCH_CHDATE"
             FROM fa_vch_mst
            WHERE comp_code = pcompcode
              AND (unit_code = punitcode OR punitcode IS NULL)
              AND (bran_code = pbran_code OR pbran_code IS NULL)
              AND (doc_type = p_vchty OR p_vchty IS NULL)
              AND vch_date >= v_frdt
              AND vch_date <= v_todt
              AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
              AND status IS NULL
              AND NVL (control_no, 0) <> NVL (vch_id, 0)
         ORDER BY unit_code, vch_date, vch_id, doc_type, vch_enln;

      OPEN p_accounts1 FOR
         SELECT   unit_code, TO_CHAR (vch_date, 'dd/mm/yyyy') AS "VCH_DATE",
                  (DECODE (debit, 'D', vch_gamt)) debit_amt,
                  (DECODE (credit, 'C', vch_gamt)) credit_amt
             FROM (SELECT unit_code, vch_date,
                          DECODE (SIGN (vch_gamt), 1, 'D') debit,
                          DECODE (SIGN (vch_gamt), -1, 'C') credit,
                          ABS (vch_gamt) vch_gamt
                     FROM fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0))
         ORDER BY vch_date, unit_code;
         
         OPEN p_accounts2 FOR
            SELECT SUM((CASE DEBIT WHEN 'D' THEN vch_gamt END)) DEBIT_AMT,
            SUM((CASE CREDIT WHEN 'C' THEN vch_gamt END)) CREDIT_AMT FROM 
            (SELECT unit_code, VCH_DATE,
                        CASE SIGN(vch_gamt) WHEN 1 THEN 'D' END debit,
                        CASE SIGN(vch_gamt) WHEN - 1 THEN 'C' END credit,
                        ABS(vch_gamt) vch_gamt FROM  fa_vch_mst
                    WHERE comp_code = pcompcode
                      AND (unit_code = punitcode OR punitcode IS NULL)
                      AND (bran_code = pbran_code OR pbran_code IS NULL)
                      AND (doc_type = p_vchty OR p_vchty IS NULL)
                      AND vch_date >= v_frdt
                      AND vch_date <= v_todt
                      AND (acc_cdp = p_acc_cdp OR p_acc_cdp IS NULL)
                      AND status IS NULL
                      AND NVL (control_no, 0) <> NVL (vch_id, 0));
         
         END IF;
         
   END fa_daybook_p;
END fa_rep_books;
/
/*****************************Issue No. 5511 Laxman*************************/
/**************Issue No.5518***********/
CREATE OR REPLACE PACKAGE BODY cir_rep_unsold_stock IS
  procedure cir_unsold_stock_p(
      pcompcode         in varchar2,
      punitcode         in varchar2,
      pbrancode         in varchar2,
      ppublcode         in varchar2,
      pfromdt           in varchar2,
      ptilldt           in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
       v_frdt date;
       v_todt date;

        cursor c1 is
        select publ,edtn,copy_rate from
        (select publ,edtn,copy_rate from cir_unsold_dtl
        where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt<=v_todt and
        (publ= ppublcode or ppublcode is null) and branch_code=nvl(pbrancode,branch_code) and (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
        --and edtn in('215','081')
        group by publ,edtn,copy_rate
        union
        select publ_code publ,edtn_code edtn, edtn_rate copy_rate from cir_branch_return_det
        where comp_code=pcompcode and unit_code=punitcode and recptdt<=v_todt and branch_code=nvl(pbrancode,branch_code) and
        (publ_code= ppublcode or ppublcode is null) --and edtn_code in('215','081')
        group by publ_code,edtn_code,edtn_rate
        union
        select publ_code publ,edtn_code edtn, edtn_rate copy_rate from cir_return_sale_det
        where comp_code=pcompcode and unit_code=punitcode and recptdt<=v_todt and branch_code=nvl(pbrancode,branch_code) and (publ_code= ppublcode or ppublcode is null) --and edtn_code in('215','081')
        union
        select publ,edtn,copy_rate from cir_unsold_dtl_dis--for company return
        where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt<=v_todt and
        (publ= ppublcode or ppublcode is null) and branch_code=nvl(pbrancode,branch_code) and (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
        --and edtn in('215','081')
        group by publ,edtn,copy_rate
        union
        select publ_code publ,edtn_code edtn, edtn_rate copy_rate from cir_physical_ver_det
        where comp_code=pcompcode and unit_code=punitcode and recptdt<=v_todt and branch_code=nvl(pbrancode,branch_code) and 
        (publ_code= ppublcode or ppublcode is null)--and edtn_code in('215','081')
        union
        select a.publ publ,a.edtn edtn, a.sup_rate copy_rate from cir_dbksup_resale a,cir_agmast b
        where a.comp_code=pcompcode and a.comp_code=b.comp_code and a.unit_code=punitcode and a.unit_code=b.unit and
        (a.publ= ppublcode or ppublcode is null) and a.agcd=b.agcd and a.dpcd=b.dpcd and a.supdate<=v_todt and 
        nvl(a.return_copy_sale,'N')='Y' and a.resale_branch=nvl(pbrancode,a.resale_branch))
        order by publ,edtn,copy_rate;
      v1 c1%rowtype;
      v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;

      v_opbal           number(10):=0;

      v_branch_rec_copy number(10):=0;v_branch_trf_copy number(10):=0;
      v_unsold_copy number(10):=0;v_sale_copy number(10):=0;v_resale_copy number(10):=0;v_comp_ret_copy number(10):=0;
      v_short_excess number(10):=0;
    Begin
        v_frdt    :=to_date(pfromdt,''''||pdateformat||'''');
        v_todt    :=to_date(ptilldt,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values('cir_rep_unsold_stock ',pcompcode||','||punitcode||','||pbrancode||','||ppublcode||','||pfromdt||','||ptilldt||','||pdateformat||','||pextra1||','||pextra2);commit;
        delete cir_temp_unsold_stock where sess_id=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;

            v_opbal_unsold:=0;      v_op_branch_rec :=0;    v_op_branch_trf:=0;     v_op_sale:=0;
            v_op_resale:=0;         v_op_comp_ret   :=0;    v_op_short_excess:=0;   v_opbal:=0;
            v_branch_rec_copy:=0;   v_branch_trf_copy:=0;   v_unsold_copy:=0;       v_sale_copy:=0;
            v_resale_copy:=0;       v_comp_ret_copy :=0;    v_short_excess:=0;

            /*-------for opening balance ----------*/
            select nvl(sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0) into v_opbal_unsold
            from cir_unsold_dtl
            where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt<v_frdt and publ=v1.publ and edtn=v1.edtn and
            copy_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(edtn_copy),0) into v_op_branch_rec from cir_branch_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='TI' and recptdt<v_frdt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(edtn_copy),0) into v_op_branch_trf from cir_branch_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='TRF' and recptdt<v_frdt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(no_of_copy),0) into v_op_sale from cir_return_sale_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='RET' and recptdt<v_frdt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            /*select nvl(sum(return_copy),0) into v_op_comp_ret from cir_company_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='RET' and recptdt<v_frdt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);*/

            select nvl(sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis
                where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt<v_frdt and publ=v1.publ and edtn=v1.edtn and
                copy_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(sup_copy),0) into v_op_resale from cir_dbksup_resale
                where comp_code=pcompcode and unit_code=punitcode and publ=v1.publ and edtn=v1.edtn and
                      supdate<v_frdt and sup_rate=v1.copy_rate and nvl(return_copy_sale,'N')='Y'
                      and (resale_branch=pbrancode or pbrancode is null);

            select nvl(sum(nvl(short_excess,1)*no_of_copy),0) into v_op_short_excess from cir_physical_ver_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='VR' and recptdt<v_frdt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);
            /*-------for opening balance ----------*/


            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_comp_ret,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);

            /*-------for Period from to till date----------*/
            select nvl(sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0) into v_unsold_copy
            from cir_unsold_dtl
            where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt>=v_frdt and recptdt<=v_todt and
             publ=v1.publ and edtn=v1.edtn and copy_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null) ;

            select nvl(sum(edtn_copy),0) into v_branch_rec_copy from cir_branch_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='TI' and recptdt>=v_frdt and recptdt<=v_todt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(edtn_copy),0) into v_branch_trf_copy from cir_branch_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='TRF' and recptdt>=v_frdt and recptdt<=v_todt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            select nvl(sum(no_of_copy),0) into v_sale_copy from cir_return_sale_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='RET' and recptdt>=v_frdt and recptdt<=v_todt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);

            /*select nvl(sum(return_copy),0) into v_comp_ret_copy from cir_company_return_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='RET' and recptdt>=v_frdt and recptdt<=v_todt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);*/

            select nvl(sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0) into v_comp_ret_copy
            from cir_unsold_dtl_dis
                where comp_code=pcompcode and unit_code=punitcode and doctype='UCN' and recptdt>=v_frdt and recptdt<=v_todt and
                publ=v1.publ and edtn=v1.edtn and copy_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null) ;

            select nvl(sum(sup_copy),0) into v_resale_copy from cir_dbksup_resale
                where comp_code=pcompcode and unit_code=punitcode and publ=v1.publ and edtn=v1.edtn and
                      supdate>=v_frdt and supdate<=v_todt and sup_rate=v1.copy_rate and nvl(return_copy_sale,'N')='Y' and
                      (resale_branch=pbrancode or pbrancode is null);

            select nvl(sum(nvl(short_excess,1)*no_of_copy),0) into v_short_excess from cir_physical_ver_det
                where comp_code=pcompcode and unit_code=punitcode and doctype='VR' and recptdt>=v_frdt and recptdt<=v_todt and
                publ_code=v1.publ and edtn_code=v1.edtn and edtn_rate=v1.copy_rate and (branch_code=pbrancode or pbrancode is null);
            /*-------for Period from to till date----------*/
            if abs(nvl(v_opbal,0))+nvl(v_unsold_copy,0)+nvl(v_branch_rec_copy,0)+nvl(v_sale_copy,0)+nvl(v_resale_copy,0)+nvl(v_comp_ret_copy,0)+
                nvl(v_branch_trf_copy,0)+abs(nvl(v_short_excess,0))<>0 then
                insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                opbal,unsold_return,branch_rec,unsold_sale,unsold_resale,comp_return,branch_tran,short_excess,sess_id)
                values(pcompcode,punitcode,pbrancode,v1.publ,v1.edtn,v_todt,v1.copy_rate,v_opbal,v_unsold_copy,v_branch_rec_copy,
                v_sale_copy,v_resale_copy,v_comp_ret_copy,v_branch_trf_copy,v_short_excess,userenv('sessionid'));
            end if;
        commit;
        end loop;
        close c1;

        open p_accounts for
        select a.comp_code comp_code,a.unit_code unit_code,a.branch_code branch_code,a.publ_code publ_code,cir_get_publ_seqno(a.comp_code,a.publ_code) publ_seqno,
        cir_get_name.cir_publ(a.comp_code,a.publ_code,'1',pdateformat,'','') publ_name,
        b.main_edtn main_edtn_code,cir_get_edtn_seqno(a.comp_code,b.main_edtn) main_edtn_seqno,
        a.edtn_code edtn_code,cir_get_edtn_seqno(a.comp_code,a.edtn_code) edtn_seqno,cir_get_name.cir_edtn(a.comp_code,a.unit_code,a.edtn_code,'1',pdateformat,'','') edtn_name,
        a.copy_rate copy_rate,
        a.opbal opbal,a.unsold_return unsold_return,a.branch_rec branch_rec,a.unsold_sale unsold_sale,
        nvl(a.opbal,0)+nvl(a.unsold_return,0)+nvl(a.branch_rec,0) tot,
        a.unsold_resale unsold_resale,a.comp_return comp_return,a.branch_tran branch_tran,
        ((nvl(a.opbal,0)+nvl(a.unsold_return,0)+nvl(a.branch_rec,0))-(nvl(a.unsold_sale,0)+nvl(a.unsold_resale,0)+nvl(a.comp_return,0)+nvl(a.branch_tran,0))) total_bal,
        a.short_excess short_excess,((nvl(a.opbal,0)+nvl(a.unsold_return,0)+nvl(a.branch_rec,0))-(nvl(a.unsold_sale,0)+nvl(a.unsold_resale,0)+nvl(a.comp_return,0)+nvl(a.branch_tran,0)))+nvl(a.short_excess,0) closing_bal
        from cir_temp_unsold_stock a,cir_edtn_mast b where a.sess_id=userenv('sessionid') and a.comp_code=b.comp_code and a.edtn_code=b.edtn
        order by publ_seqno,publ_code,main_edtn_seqno,edtn_seqno,edtn_code,copy_rate;

        delete cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;

    End cir_unsold_stock_p;
End cir_rep_unsold_stock;
/
/**************Issue No.5518 Laxman***********/
/****************Laxman**********************/
CREATE OR REPLACE FUNCTION cir_publ_type
(pcomp_code     in varchar2,
 publ_type      in varchar2,
 pextra1        in varchar2,
 pextra2        in varchar2) RETURN varchar2 IS
    v_name  varchar2(200);
BEGIN
    Begin
      select "pubname" into v_name from pub_type_mast  where "pubtypecode"=publ_type;
    Exception when others then
                     v_name:=null;
    End;
  return nvl(v_name,'');
END;
//****************************/



//****************** Start Issue no. 4688 *******************//


CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and (d.unit_code=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and (d.unit=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/




*****************************************************  body ***********************************************





CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and (d.unit_code=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and (d.unit=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/



//************************End Issue no. 4688 ***************//

//////////*************** START*****ISSUE NO. 0005549 ******************///*******7/11/2011****//////

DROP CIR_GENRATE_CODE;

CREATE OR REPLACE PACKAGE Cir_Genrate_Code IS
	type p_circul_cursor is ref cursor;
PROCEDURE agency_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE agency_class_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE suspend_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE area_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE publ_mast_p(
   pcompcode    in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   ppubl_code   out p_circul_cursor);

PROCEDURE edtn_mast_p (
    pcompcode   in varchar2,
    ppubl_code  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pedtn_code  out p_circul_cursor);

PROCEDURE agmast_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pag_code    out p_circul_cursor);

PROCEDURE agsubcode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pag_code        out p_circul_cursor);

PROCEDURE areacode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    parea_code      out p_circul_cursor);

PROCEDURE drop_point_code_P (
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pdrop_point_code    out p_circul_cursor);

Procedure executive_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pexe_code   out p_circul_cursor);

PROCEDURE routecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    prt_code    out p_circul_cursor);

PROCEDURE subroutecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    prtcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psubrt_code out p_circul_cursor);

PROCEDURE subsubroutecode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    prtcode         in varchar2,
    psubrtcode      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    psubsubrt_code  out p_circul_cursor);

PROCEDURE transportercode_P (
    pcompcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptp_code    out p_circul_cursor);

PROCEDURE districtcode_P (
    pcompcode   in varchar2,
    pstatecode  in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdist_code  out p_circul_cursor);

PROCEDURE comm_catg_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE comm_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE zone_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE taluka_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE receipt_p (
    pcompcode   in varchar2,
    pbranchcode in varchar2,
    pdoctype    in varchar2,
    precptdt    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE mode_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE supply_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE expenses_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE city_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE cir_region_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preg_code   out p_circul_cursor);

PROCEDURE cir_unsold_receipt_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preceipt_no out p_circul_cursor);

PROCEDURE cir_surcharge_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor);

PROCEDURE cir_roleMatser_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor);

PROCEDURE cir_narr_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pnarr_cd        out p_circul_cursor);

Procedure cir_taxi_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptaxi_code  out p_circul_cursor);

PROCEDURE cir_lable_htmlformatid_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pformat_id  out p_circul_cursor);
PROCEDURE cir_installment_code_p (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pcode       out p_circul_cursor);
PROCEDURE race_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);  
    
PROCEDURE inct_slab_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);
PROCEDURE festival_code_P (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    ptype_code      out p_circul_cursor);           
END Cir_Genrate_Code;
/



DROP PACKAGE BODY CIR_GENRATE_CODE;

CREATE OR REPLACE PACKAGE BODY Cir_Genrate_Code IS
PROCEDURE agency_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(agency_type_code,3,5))+1 into vno from cir_agency_typ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
      vtype_code:='AT'||'001';
     Else
    vtype_code:='AT'||lpad(vno,3,'0');
     End if;

  open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_type_p;

PROCEDURE agency_class_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(8);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select to_number(max(substr(class_code,3,5)))+1 into vno from cir_agency_class_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='AC'||'001';
     Else
        vtype_code:='AC'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_class_p;

PROCEDURE suspend_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(suspend_type_code,3,5))+1 into vno from cir_suspend_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='ST'||'001';
     Else
        vtype_code:='ST'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End suspend_type_p;

PROCEDURE area_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(area_type,3,5))+1 into vno from cir_area_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
    vtype_code:='AR'||'001';
    Else
    vtype_code:='AR'||lpad(vno,3,'0');
    End if;

     open ptype_code for select vtype_code as "VAR_CODE" from dual;

End area_type_p;

PROCEDURE publ_mast_p(
   pcompcode    in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   ppubl_code   out p_circul_cursor) as
    vno         number(5);
    vpubl_code  varchar2(15);

BEGIN

    Begin
       select max(to_number(substr(publ,2)))+1 into vno from cir_publ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vpubl_code:='P'||'01';
    Else
        vpubl_code:='P'||lpad(vno,2,'0');
    End if;

    open ppubl_code for  select vpubl_code as "VAR_CODE" from dual;

End publ_mast_p;

PROCEDURE edtn_mast_p (
    pcompcode   in varchar2,
    ppubl_code  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pedtn_code  out p_circul_cursor) as
    vno         number(5);
    vedtn_code  varchar2(15);
BEGIN

    Begin
       select max(substr(edtn,2))+1 into vno from cir_edtn_mast where comp_code=pcompcode /*and publ=ppubl_code*/;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vedtn_code:=/*'E'||*/'001';
    Else
        vedtn_code:=/*'E'||*/lpad(vno,3,'0');
    End if;

    open pedtn_code for select vedtn_code as "VAR_CODE" from dual;

End edtn_mast_p;

PROCEDURE agmast_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pag_code    out p_circul_cursor) as
    vno         number(8);
    vag_code    varchar2(8);
    v_prefix    varchar2(20);
Begin

    Begin
        if upper(pextra2)='D' then
          v_prefix:='D'||upper(pprefix);
          select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast_dis
              where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        else
            v_prefix:=upper(pprefix);
            select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast
                  where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        end if;
    Exception when others then
         vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:=upper(v_prefix)||'0001';
    else
       vag_code:=upper(v_prefix)||lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agmast_P;

PROCEDURE agsubcode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pag_code        out p_circul_cursor) as
    vno             number(8);
    vag_code        varchar2(8);

BEGIN

    Begin
        if upper(pextra2)='D' then
            select to_number(max(dpcd))+1 into vno from cir_agmast_dis
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        else
            select to_number(max(dpcd))+1 into vno from cir_agmast
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        end if;
    Exception when others then
      vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:='0001';
    else
       vag_code:=lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agsubcode_P;

PROCEDURE areacode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    parea_code      out p_circul_cursor) as
    vno             number(8);
    varea_code      varchar2(15);

BEGIN

    Begin
       select max(substr(area_code,2,5))+1 into vno from cir_area_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        varea_code:='A'||'0001';
     Else
        varea_code:='A'||lpad(vno,4,'0');
     End if;

    open parea_code for select varea_code as "VAR_CODE" from dual;

End areacode_P;

PROCEDURE drop_point_code_P (
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pdrop_point_code    out p_circul_cursor) as
    vno         number(8);
    vdrop_point varchar2(15);

BEGIN

    Begin
        select max(substr(drop_point,2,5))+1 into vno from cir_drop_point_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vdrop_point:='D'||'0001';
    Else
        vdrop_point:='D'||lpad(vno,4,'0');
    End if;

    open pdrop_point_code for select vdrop_point as "VAR_CODE" from dual;

End drop_point_code_P;

Procedure executive_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pexe_code   out p_circul_cursor) as
    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
       select max(substr(executive_code,2,5))+1 into vno from cir_executive_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        v_code:='E'||'00001';
    Else
        v_code:='E'||lpad(vno,5,'0');
    End if;

    open pexe_code for select v_code as "VAR_CODE" from dual;

End executive_code_p;

PROCEDURE routecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    prt_code    out p_circul_cursor) As
    vno         number(8);
    vrt_code    varchar2(15);
BEGIN
    Begin
       select max(substr(route_code,3,5))+1 into vno from cir_route_mast where comp_code=pcompcode and unit=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vrt_code:='RT'||'001';
    Else
        vrt_code:='RT'||lpad(vno,3,'0');
    End if;

    open prt_code for select vrt_code as "VAR_CODE" from dual;

End routecode_P;

PROCEDURE subroutecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    prtcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psubrt_code out p_circul_cursor) as
    vno         number(8);
    vsubrt_code varchar2(15);
BEGIN
    Begin
        select max(substr(subrt_code,3,5))+1 into vno from cir_sub_route_mast where comp_code=pcompcode and unit=punitcode and route_code=prtcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubrt_code:='SR'||'001';
    Else
        vsubrt_code:='SR'||lpad(vno,3,'0');
    End if;

    open psubrt_code for select vsubrt_code as "VAR_CODE" from dual;

End subroutecode_P;

PROCEDURE subsubroutecode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    prtcode         in varchar2,
    psubrtcode      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    psubsubrt_code  out p_circul_cursor) as
    vno             number(8);
    vsubsubrt_code  varchar2(15);
BEGIN
    Begin
        select max(substr(sub_subrt_code,3,5))+1 into vno from cir_sub_subroute_mast
            where comp_code=pcompcode and unit=punitcode and route_code=prtcode and
                    subrt_code=psubrtcode;
    Exception When Others Then
       vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubsubrt_code:='SS'||'001';
    Else
        vsubsubrt_code:='SS'||lpad(vno,3,'0');
    End if;
    open psubsubrt_code for select vsubsubrt_code as "VAR_CODE" from dual;

End subsubroutecode_P;

PROCEDURE transportercode_P (
    pcompcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptp_code    out p_circul_cursor) as
    vno         number(8);
    vtp_code    varchar2(8);

Begin

    Begin
        select max(substr(transporter_code,2))+1 into vno from cir_transporter_mast
            where comp_code=pcompcode and upper(substr(transporter_code,1,1))=upper(pprefix);
    Exception when others then
        vno:=0;
    End;

    if nvl(vno,0)=0 then
        vtp_code:=upper(pprefix)||'0001';
    else
        vtp_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open ptp_code for select vtp_code as "VAR_CODE" from dual;
End transportercode_P;

PROCEDURE districtcode_P (
    pcompcode   in varchar2,
    pstatecode  in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdist_code  out p_circul_cursor) as
    vno         number(8);
    vdist_code  varchar2(8);

Begin

    Begin
        select max(substr(dist_code,3))+1 into vno from cir_dist_mast
            where comp_code=pcompcode and upper(substr(dist_code,1,2))=upper(pprefix);
    Exception when others then
    vno:=0;
    End;
    if nvl(vno,0)=0 then
        vdist_code:=upper(pprefix)||'0001';
    else
        vdist_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open pdist_code for select vdist_code as "VAR_CODE" from dual;

End districtcode_P;

PROCEDURE comm_catg_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);
    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_catg_code,3,5))+1 into vno from cir_comm_catg_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='C';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_catg_p;

PROCEDURE comm_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_code,3,5))+1 into vno from cir_comm_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='F';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_p;

PROCEDURE zone_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(zone_code,3,5))+1 into vno from cir_zone_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='ZN'||'001';
    Else
        vtype_code:='ZN'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End zone_p;

PROCEDURE taluka_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(talu_code,3,6))+1 into vno from cir_taluka_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='TK'||'0001';
    Else
        vtype_code:='TK'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End taluka_p;

PROCEDURE receipt_p (
    pcompcode   in varchar2,
    pbranchcode in varchar2,
    pdoctype    in varchar2,
    precptdt    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(20);
    vrecptno  varchar2(15);
    v_dt date;
BEGIN

    v_dt:=to_date(precptdt,''''||pdateformat||'''');

    Begin
       if upper(pextra2)='D' then
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr_dis
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       else
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       end if;
    Exception When Others Then
       vno:=null;
    End;

    If nvl(vno,0)=0 Then
      vrecptno:=pbranchcode||'-'||to_char(v_dt,'yymm')||'0001';
    Else
      vrecptno:=pbranchcode||'-'||lpad(vno,8,'0');
    End if;

    open ptype_code for select vrecptno as "VAR_CODE" from dual;

End receipt_p;

PROCEDURE mode_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(mode_code,3,3))+1 into vno from cir_route_mode_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='RM'||'001';
    Else
        vtype_code:='RM'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End mode_p;

PROCEDURE supply_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(sup_ty_code,2,2))+1 into vno from cir_supply_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='S'||'01';
    Else
        vtype_code:='S'||lpad(vno,2,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End supply_type_p;

PROCEDURE expenses_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(exp_type_code,2,3))+1 into vno from cir_expenses_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='E'||'001';
    Else
        vtype_code:='E'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End expenses_type_p;

PROCEDURE city_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(city_code,3,6))+1 into vno from cir_city_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 then
        vtype_code:='CT'||'0001';
    Else
        vtype_code:='CT'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End city_p;

PROCEDURE cir_region_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preg_code   out p_circul_cursor)
    as
    vno         number(5);
    vreg_code   varchar2(15);
BEGIN

    Begin
       select max(substr(reg_code,3,6))+1 into vno from cir_region_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vreg_code:='RG'||'0001';
    Else
        vreg_code:='RG'||lpad(vno,4,'0');
    End if;

    open preg_code for select vreg_code as "VAR_CODE" from dual;

End cir_region_p;

PROCEDURE cir_unsold_receipt_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    preceipt_no     out p_circul_cursor)
    As
    vno number(5);
    vtype_code  varchar2(15);
    v_sess_id   number(20);
    v_prefix    varchar2(20);
    v_no        varchar2(20);
    v_dt        date;
    v_chkdt     date;
BEGIN
    /*loop
     begin
        select gen_unsold_rec_yn into v_gen_unsold_rec_yn from cir_control;
        if nvl(v_gen_unsold_rec_yn,'N')  = 'N' then
           exit;
        end if;
        exception when no_data_found then
            insert into cir_control values('Y');
            exit;
     end;
    end loop;
    update cir_control set GEN_UNSOLD_REC_YN='Y';commit;*/

    /*Begin
        if upper(pextra2)='D' then
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr_dis where comp_code=pcompcode;
        else
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr where comp_code=pcompcode;
        end if;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='UN'||'000001';
    Else
        vtype_code:='UN'||lpad(vno,6,'0');
    End if;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
    */

    v_dt    :=to_date(pextra1,''''||pdateformat||'''');
    v_prefix:='UN'||to_char(v_dt,'yymm');

    select trunc(v_dt,'mm') into v_chkdt from dual;

    begin
        select curr_no into v_no from cir_series
        where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    exception when no_data_found then
        v_no:=null;
    end;

    if v_no is null or v_no='0' then
        vtype_code:=v_prefix||'00001';
        insert into cir_series(comp_code,unit_code,branch_code,ty,year_monid,prefix, curr_no)
        values(pcompcode,null,null,'UCN',trunc(v_dt,'mm'),v_prefix,1);
    else
        v_no        :=to_number(v_no)+1;
        vtype_code  :=v_prefix||lpad(v_no,5,'0');
        update cir_series set curr_no=nvl(curr_no,0)+1
            where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    end if;
    commit;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
End cir_unsold_receipt_p;

PROCEDURE cir_surcharge_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
            select max(substr(surch_cd,2,3))+1 into vno from cir_surcharge_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='S'||'001';
    Else
        vsurch_cd:='S'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_surcharge_p;

PROCEDURE cir_roleMatser_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
       select max(substr(role_code,2,3))+1 into vno from cir_role_mast where comp_code=pcompcode;
          Exception When Others Then
               vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='R'||'001';
    Else
        vsurch_cd:='R'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_roleMatser_p;

PROCEDURE cir_narr_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pnarr_cd        out p_circul_cursor)
    as
    vno             number(5);
    vsurch_cd       varchar2(15);
BEGIN
    Begin
        select max(substr(na_code,3,4))+1 into vno from fa_vch_narration_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        vsurch_cd:='N'||'001';
    Else
        vsurch_cd:='N'||lpad(vno,3,'0');
    End if;

    open pnarr_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_narr_p;

Procedure cir_taxi_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptaxi_code  out p_circul_cursor) as

    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
        select max(substr(taxi_id,2,4))+1 into vno from cir_taxi_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='V'||'0001';
    Else
        v_code:='V'||lpad(vno,4,'0');
    End if;

    open ptaxi_code for select v_code as "VAR_CODE" from dual;

End cir_taxi_code_p;

PROCEDURE cir_lable_htmlformatid_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pformat_id  out p_circul_cursor)
    As
    vno         number(8);
    v_code      varchar2(15);
    v_sess_id   number(20);
Begin
    Begin
        select max(formatid)+1 into vno from cir_lable_htmlformat;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:=1;
    Else
        v_code:=vno;
    End if;
    insert into cir_lable_htmlformat(comp_code,formatid,format_desc) values(pcompcode,v_code,pextra1);commit;
    open pformat_id for select v_code as "FORMAT_ID" from dual;

End cir_lable_htmlformatid_p;
PROCEDURE cir_installment_code_p (
        pcompcode   in varchar2,
        punitcode   in varchar2,
        pdateformat in varchar2,
        pextra1     in varchar2,
        pextra2     in varchar2,
        pcode       out p_circul_cursor) as
    vno         number(10);
    v_code      varchar2(15);
    Begin

    Begin
        select max(substr(inst_code,2,7))+1 into vno from cir_installment_mast where comp_code=pcompcode;
        Exception When Others Then
            vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='I'||'0000001';
    Else
        v_code:='I'||lpad(vno,7,'0');
    End if;

    open pcode for select v_code as "VAR_CODE" from dual;

    End cir_installment_code_p;
PROCEDURE race_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN
    Begin
       select to_number(max(substr(race_code,3,5)))+1 into vno from cir_race_mast;
    Exception When Others Then
        vno:=null;
    End;
    
    If nvl(vno,0)=0 Then
        vtype_code:='RC'||'001';
    Else
        vtype_code:='RC'||lpad(vno,3,'0');
    End if;
    open ptype_code for select vtype_code as "VAR_CODE" from dual;
    
End race_code_P; 

PROCEDURE inct_slab_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(inct_slab_id),0)+1 into vno from cir_inct_slab_hdr;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End inct_slab_code_p;   

PROCEDURE festival_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(fest_code),0)+1 into vno from cir_festival_mast;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End festival_code_p;

END Cir_Genrate_Code;
/

/****************************************************************************************************************/


DROP PACKAGE CIR_DYNAMIC_DML;

CREATE OR REPLACE PACKAGE Cir_Dynamic_DML IS
  procedure variable_insert_stmt(
      ptable_name in varchar2,
      pcolname in varchar2,
      pcolvalue in varchar2,
      pdelimiter in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2);
  /*procedure variable_insert_stmt(
      ptable_name in varchar2,
      pcolname in varchar2,
      pcolvalue in varchar2,
      pdelimiter in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2,
      p_error_text out varchar2);*/

  procedure variable_update_stmt(
      ptable_name in varchar2,
      pcolname in varchar2,
      pcolvalue in varchar2,
      pcond_colname in varchar2,
      pdelimiter in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2);
  procedure variable_delete_stmt(
      ptable_name in varchar2,
      pcond_colname in varchar2,
      pcond_colval in varchar2,
      pdelimiter in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2);
      type t_accounts_type is ref cursor;
  procedure variable_execute_stmt(
      ptable_name in varchar2,
      pcond_colname in varchar2,
      pcond_colval in varchar2,
      pdelimiter in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2,
      p_accounts out t_accounts_type);
      type t_accounts is ref cursor;
   
   procedure variable_order(
      pcomp_code in varchar2,
      pcomp_val in varchar2,
      punit_code in varchar2,
      punit_val in varchar2,
      ptable_name in varchar2,
      pcolname in varchar2,
      porder in varchar2,
      pdateformat in varchar2,
      pextra1 in varchar2,
      pextra2 in varchar2,
      p_accounts out t_accounts);
END Cir_Dynamic_DML;
/



DROP PACKAGE BODY CIR_DYNAMIC_DML;

CREATE OR REPLACE PACKAGE BODY Cir_Dynamic_DML IS
PROCEDURE variable_insert_stmt(
    ptable_name     in varchar2,
    pcolname        in varchar2,
    pcolvalue       in varchar2,
    pdelimiter      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2) as

    pstmt_str   varchar2(4000);
    v_sess_id   number;
cursor cur_stmt is

--delete from temp_col_ins
--commit;
    select * from temp_col_ins  where session_id=v_sess_id order by sqno;
    rec_stmt cur_stmt%rowtype;

    vlength     number(5);
    vcolval     varchar2(4000);
    vrunval     varchar2(1);
    vcol_name     varchar2(500);
    vno         number(5);
    vrec         varchar2(4000);
    vrec_upd     varchar2(4000);
    vformat     varchar2(20);
    v_col_exists number(5);
Begin
    --insert into test1(vstring) values (pcolname||'33333'||pcolvalue);commit;
    dbg('vrec:');
   -- delete from 
    insert into searchtbl(search) values ('neha');commit;


    Begin
        select userenv('sessionid') into v_sess_id from dual;
          delete from temp_col_ins where session_id=v_sess_id;
        vlength    :=null;    vcolval:=null;    vrunval:=null;    vcol_name:=null;vno:=null;

        vcolval    :=replace(pcolname,pdelimiter,',');
        vlength    :=length(vcolval);
        vno            :=1;

        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
              vcol_name:=vcol_name||vrunval;
          else
            --insert into test1(vstring2) values (vno||','||upper(ltrim(rtrim(vcol_name)))||','||v_sess_id);
            --commit;
              insert into temp_col_ins (sqno,col_name,session_id) values (vno,upper(ltrim(rtrim(vcol_name))),v_sess_id);
              vno:=vno+1;
            vcol_name:='';
          end if;
        end loop;

         insert into searchtbl(search) values ('neha_1');commit;
        /*select count(*) into v_col_exists from col where tname=upper(ltrim(rtrim(ptable_name))) and
                cname=upper(ltrim(rtrim(vcol_name)));*/
        select count(*) into v_col_exists from temp_col_ins where session_id=v_sess_id and
            col_name=upper(ltrim(rtrim(vcol_name)));
        if nvl(v_col_exists,0)=0 then
            insert into temp_col_ins(sqno,col_name,session_id) values (vno,upper(vcol_name),v_sess_id);
        end if;
        commit;
        vlength:=null;    vcolval:=null;     vrunval:=null;    vcol_name:=null;    vno:=null;
        if instr(pcolvalue,',')>0 or instr(pcolvalue,'''')>0 then
           vcolval:=replace(pcolvalue,',','~~~');
        else
             vcolval:=pcolvalue;
        end if;
        vcolval:=replace(vcolval,pdelimiter,',');
        vlength:=length(vcolval);
        vno:=1;
        for i in 1.. vlength loop
          vrunval            :=substr(vcolval,i,1);
          if vrunval    !=',' then
              vcol_name    :=vcol_name||vrunval;
          else
              vcol_name    :=replace(vcol_name,'~~~',',');
            update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=v_sess_id;
              vno:=vno+1;
            vcol_name:='';
          end if;
        end loop;
        if vcol_name is not null then
            update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=v_sess_id;
        end if;
        update temp_col_ins set col_data_type=(select coltype from col where tname = upper(ltrim(rtrim(ptable_name))) and cname = upper(ltrim(rtrim(temp_col_ins.col_name))))
            where session_id=v_sess_id;
        commit;
         insert into searchtbl(search) values ('neha_2');commit;
        vrec:='insert into '||ptable_name||'('||replace(pcolname,pdelimiter,',')||') values ( ';

        insert into searchtbl(search) values (vrec);commit;

        --select "date_format" into vformat from preferrences;
          vformat:=pdateformat;
        open cur_stmt;
          loop
            fetch cur_stmt into rec_stmt;
               exit when cur_stmt%notfound;
               if rec_stmt.col_data_type='DATE' then
                    vrec:=vrec||'to_date('||rec_stmt.col_value||','||''''||vformat||''''||')'||',';
               else
                    vrec:=vrec||rec_stmt.col_value||',';
               end if;
          end loop;
        vrec        :=substr(vrec,1,length(vrec)-1)||')';
        vlength    :=null;
        vcolval    :=null;
        vrunval    :=null;
        vcol_name:=null;
        vno:=null;
        /*vcolval:=replace(pcond_colname,pdelimiter,',');
        vlength:=length(vcolval);
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 update temp_col_ins set upd_flag='I' where col_name=vcol_name and session_id=userenv('sessionid');
               vcol_name:='';
          end if;
        end loop;
        commit;
     close cur_stmt; */
     update temp_col_ins set upd_str=vrec where session_id=v_sess_id and rownum<2;
     --update temp_col_ins1 set upd_str=vrec where session_id=v_sess_id and rownum<2;
     --insert into test1(vstring) values (pcolname||'33333'||vrec);
     commit;

    End;
    dbg('vrec:'||vrec);
    execute immediate vrec;
    commit;
     --delete from temp_col_ins where session_id=userenv('sessionid');
    commit;
End variable_insert_stmt;

PROCEDURE variable_update_stmt(
   ptable_name      in varchar2,
   pcolname         in varchar2,
   pcolvalue        in varchar2,
   pcond_colname    in varchar2,
   pdelimiter       in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2) as

pstmt_str varchar2(4000);
cursor cur_stmt is select * from temp_col_ins  where session_id=userenv('sessionid') order by sqno;
    rec_stmt cur_stmt%rowtype;
cursor cur_upd_stmt is select * from temp_col_ins  where nvl(upd_flag,'N')='U' and session_id=userenv('sessionid');
    rec_upd_stmt cur_upd_stmt%rowtype;

    vlength     number(5);
    vcolval     varchar2(4000);
    vrunval     varchar2(1);
    vcol_name     varchar2(100);
    vno         number(5);
    vrec         varchar2(4000);
    vrec_upd     varchar2(4000);
    vpextra1     varchar2(4000);
    vformat     varchar2(20);
Begin
insert into searchtbl values('tblname-'|| ptable_name||'colname-'|| pcolname||'colvalue-'|| pcolvalue|| 'condname-' || pcond_colname|| 'delimeter-'|| pdelimiter || 'dateformat-'|| pdateformat || 'pextra1-'||pextra1||'pextra2-'|| pextra2);commit;






    --insert into test1(vstring) values (vrec||vrec_upd||ptable_name||','||pcolname||','||pcolvalue||','||pcond_colname||','||pdelimiter||','||pdateformat||','||pextra1||','||pextra2);
    Begin
        delete from temp_col_ins where session_id=userenv('sessionid');
        vlength        :=null;    vcolval:=null;    vrunval:=null;    vcol_name    :=null;    vno:=null;

        vcolval        :=replace(pcolname,pdelimiter,',');    vlength        :=length(vcolval);    vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
              vcol_name:=vcol_name||vrunval;
          else
              insert into temp_col_ins (sqno,col_name,session_id) values (vno,vcol_name,userenv('sessionid'));
              vno                :=vno+1;
            vcol_name    :='';
          end if;
        end loop;
        commit;
        vlength:=null;    vcolval:=null;    vrunval:=null;    vcol_name:=null;    vno:=null;

        if instr(pcolvalue,',')>0 then
            vcolval:=replace(pcolvalue,',','~~~');
        else
            vcolval:=pcolvalue;
        end if;

        vcolval:=replace(vcolval,pdelimiter,',');    vlength:=length(vcolval);    vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 vcol_name:=replace(vcol_name,'~~~',',');
               update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=userenv('sessionid');
                 vno:=vno+1;
               vcol_name:='';
          end if;
        end loop;
        /*Start New Change For Old and New Concept */
        if pextra1='' or pextra1 is null then
             vpextra1:=pcolvalue;
        else
             vpextra1:=pextra1;
        end if;
        vlength:=null;    vcolval:=null;    vrunval:=null;    vcol_name:=null;    vno:=null;

        if instr(vpextra1,',')>0 then
            vcolval:=replace(vpextra1,',','~~~');
        else
            vcolval:=vpextra1;
        end if;

        vcolval:=replace(vcolval,pdelimiter,',');    vlength:=length(vcolval);    vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 vcol_name:=replace(vcol_name,'~~~',',');
               update temp_col_ins set col_value_old=vcol_name where sqno=vno and session_id=userenv('sessionid');
                 vno:=vno+1;
               vcol_name:='';
          end if;
        end loop;
        /*End New Change For Old and New Concept */
        update temp_col_ins set temp_col_ins.col_data_type=(select col.coltype from col where col.tname = upper(ltrim(rtrim(ptable_name))) and col.cname = upper(ltrim(rtrim(temp_col_ins.col_name))))
            where session_id=userenv('sessionid');
        commit;
        vrec:='update '||ptable_name||' set ';
        --select "date_format" into vformat from preferrences;
          vformat:=pdateformat;
        open cur_stmt;
          loop
            fetch cur_stmt into rec_stmt;
               exit when cur_stmt%notfound;
               if rec_stmt.col_data_type='DATE' then
                    vrec:=vrec||rec_stmt.col_name||'=to_date('||rec_stmt.col_value||','||''''||vformat||''''||')'||',';
               else
                    vrec:=vrec||rec_stmt.col_name||'='||replace(rec_stmt.col_value,'null','')||',';
               end if;
          end loop;
          vrec:=substr(vrec,1,length(vrec)-1);
        vlength:=null;    vcolval:=null;    vrunval:=null;    vcol_name:=null;    vno:=null;

        vcolval:=replace(pcond_colname,pdelimiter,',');    vlength:=length(vcolval);

        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
              vcol_name:=vcol_name||vrunval;
          else
              update temp_col_ins set upd_flag='U' where col_name=vcol_name and session_id=userenv('sessionid');
            vcol_name:='';
          end if;
        end loop;
        commit;
      close cur_stmt;
        if pcond_colname is not null then
             vrec_upd:=' where ';
        else
             vrec_upd:='';
        end if;

        open cur_upd_stmt;
          loop
            fetch cur_upd_stmt into rec_upd_stmt;
               exit when cur_upd_stmt%notfound;
               if rec_upd_stmt.col_data_type='DATE' then
                    vrec_upd:=vrec_upd||rec_upd_stmt.col_name||'=to_date('||rec_upd_stmt.col_value_old||','||''''||vformat||''''||')'||' and ';
               else
                    vrec_upd:=vrec_upd||rec_upd_stmt.col_name||'='||rec_upd_stmt.col_value_old||' and ';
               end if;
          end loop;
         close cur_upd_stmt;
         vrec_upd:=substr(vrec_upd,1,length(vrec_upd)-5);
         update temp_col_ins set upd_str=vrec||vrec_upd where session_id=userenv('sessionid') and rownum<2;
         commit;

    End;
     insert into test1(vstring) values (vrec||vrec_upd);commit;
    execute immediate vrec||vrec_upd;
    --insert into temp_col_ins1 values (vrec||vrec_upd);
    commit;
       --delete from temp_col_ins where session_id=userenv('sessionid');commit;

End variable_update_stmt;

procedure variable_delete_stmt(
  ptable_name   in varchar2,
  pcond_colname in varchar2,
  pcond_colval  in varchar2,
  pdelimiter    in varchar2,
  pdateformat   in varchar2,
  pextra1       in varchar2,
  pextra2       in varchar2) as

  pstmt_str varchar2(4000);
cursor cur_stmt is select * from temp_col_ins  where session_id=userenv('sessionid') order by sqno;
    rec_stmt cur_stmt%rowtype;

cursor cur_upd_stmt is select * from temp_col_ins  where nvl(upd_flag,'N')='U' and session_id=userenv('sessionid');
    rec_upd_stmt cur_upd_stmt%rowtype;

    vlength     number(5);
    vcolval     varchar2(4000);
    vrunval     varchar2(1);
    vcol_name   varchar2(100);
    vno         number(5);
    vrec        varchar2(4000);
    vformat     varchar2(20);
Begin
    Begin
        delete from temp_col_ins where session_id=userenv('sessionid');
        vlength:=null;
        vcolval:=null;
        vrunval:=null;
        vcol_name:=null;
        vno:=null;
        vcolval:=replace(pcond_colname,pdelimiter,',');
        vlength:=length(vcolval);
        vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 insert into temp_col_ins (sqno,col_name,upd_flag,session_id,upd_str) values (vno,vcol_name,'U',userenv('sessionid'),pcond_colval);
                 vno:=vno+1;
               vcol_name:='';
          end if;
        end loop;
        commit;
        vlength:=null;
        vcolval:=null;
        vrunval:=null;
        vcol_name:=null;
        vno:=null;
        if instr(pcond_colval,',')>0 then
           vcolval:=replace(pcond_colval,',','~~~');
        else
             vcolval:=pcond_colval;
        end if;
        vcolval:=replace(vcolval,pdelimiter,',');
        vlength:=length(vcolval);
        vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 --vcol_name:=replace(vcol_name,'~~~',',');
               update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=userenv('sessionid');
                 vno:=vno+1;
               vcol_name:='';
          end if;
        end loop;
        update temp_col_ins set temp_col_ins.col_data_type=(select col.coltype from col where col.tname = upper(ltrim(rtrim(ptable_name))) and cname = upper(ltrim(rtrim(temp_col_ins.col_name))))
            where session_id=userenv('sessionid');
        commit;
        vrec:='delete from '||ptable_name||' where ';
        --select "date_format" into vformat from preferrences;
        vformat:=pdateformat;
        open cur_stmt;
          loop
            fetch cur_stmt into rec_stmt;
               exit when cur_stmt%notfound;
               if rec_stmt.col_data_type='DATE' then
                    vrec:=vrec||rec_stmt.col_name||'=to_date('||rec_stmt.col_value||','||''''||vformat||''''||')'||' and ';
               else
                    vrec:=vrec||rec_stmt.col_name||'='||rec_stmt.col_value||' and ';
               end if;
          end loop;
         vrec:=substr(vrec,1,length(vrec)-5);
         --update temp_col_ins set upd_str=vrec where session_id=userenv('sessionid') and rownum<2;
         --commit;

    End;
    insert  into temp_col_ins_c (vstr) values (vrec);
    commit;
    execute immediate vrec;
    commit;
    delete from temp_col_ins where session_id=userenv('sessionid');
    commit;

End variable_delete_stmt;

procedure variable_execute_stmt(
  ptable_name   in varchar2,
  pcond_colname in varchar2,
  pcond_colval  in varchar2,
  pdelimiter    in varchar2,
  pdateformat   in varchar2,
  pextra1       in varchar2,
  pextra2       in varchar2,
  p_accounts    out t_accounts_type) as

  pstmt_str varchar2(4000);
cursor cur_stmt is select * from temp_col_ins  where session_id=userenv('sessionid');
    rec_stmt cur_stmt%rowtype;

/*cursor cur_upd_stmt is select * from temp_col_ins  where nvl(upd_flag,'N')='U' and session_id=userenv('sessionid');
    rec_upd_stmt cur_upd_stmt%rowtype;*/

    vlength     number(5);
    vcolval     varchar2(4000);
    vrunval     varchar2(1);
    vcol_name   varchar2(100);
    vno         number(5);
    vrec        varchar2(4000);
    vformat     varchar2(20);
Begin

delete from searchtbl;
insert into searchtbl values('table-'||ptable_name);
insert into searchtbl values('pcond_colname-'||pcond_colname);
insert into searchtbl values('pcond_colval-'||pcond_colval);
insert into searchtbl values('pdelimiter-'||pdelimiter);
insert into searchtbl values('pdateformat-'||pdateformat);
commit;
     insert into temp_col_ins1 (sqno,col_name,upd_str,session_id) values (9999,'',sysdate||pcond_colname||'#'||pcond_colval||'#'||vrec,userenv('sessionid'));
    Begin
        delete from temp_col_ins where session_id=userenv('sessionid');
        delete from temp_col_ins1 where session_id=userenv('sessionid');
        vlength    :=null;    vcolval    :=null;    vrunval    :=null;    vcol_name    :=null;vno:=null;
        vcolval    :=replace(pcond_colname,pdelimiter,',');
        vlength    :=length(vcolval);vno:=1;

        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
              vcol_name:=vcol_name||vrunval;
          else
              insert into temp_col_ins (sqno,col_name,upd_flag,session_id) values (vno,vcol_name,'U',userenv('sessionid'));
            insert into temp_col_ins1 (sqno,col_name,upd_flag,session_id) values (vno,vcol_name,'U',userenv('sessionid'));
            vno:=vno+1;
            vcol_name:='';
          end if;
        end loop;
        commit;
        vlength:=null;
        vcolval:=null;
        vrunval:=null;
        vcol_name:=null;
        vno:=null;
        vcolval:=replace(pcond_colval,pdelimiter,',');
        vlength:=length(vcolval);
        vno:=1;
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
               update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=userenv('sessionid');
               vno:=vno+1;
               vcol_name:='';
          end if;
        end loop;
        update temp_col_ins set temp_col_ins.col_data_type=(select col.coltype from col where col.tname = upper(ltrim(rtrim(ptable_name))) and cname = upper(ltrim(rtrim(temp_col_ins.col_name))))
            where session_id=userenv('sessionid');
               delete from temp_col_ins where col_value=''''||'''' and session_id=userenv('sessionid');
        commit;
        vrec:='select * from '||ptable_name||' where ';
        --select "date_format" into vformat from preferrences;
          vformat:=pdateformat;
        open cur_stmt;
          loop
            fetch cur_stmt into rec_stmt;
               exit when cur_stmt%notfound;
               if rec_stmt.col_data_type='DATE' then
                    vrec:=vrec||rec_stmt.col_name||'=to_date('||rec_stmt.col_value||','||''''||vformat||''''||')'||' and   ';
               else
                    --vrec:=vrec||rec_stmt.col_name||'='||rec_stmt.col_value||' and ';
                    vrec:=vrec||'(('||rec_stmt.col_name||'='||rec_stmt.col_value||') or ('||rec_stmt.col_name||' like '||rec_stmt.col_value||'))'||' and   ';
               end if;
          end loop;
          /*if substr(vrec,length(vrec)-5,5)=' and ' then
             vrec:=substr(vrec,1,length(vrec)-4);
          elsif substr(vrec,length(vrec)-7,7)=' where ' then
             vrec:=substr(vrec,1,length(vrec)-6);
          end if;*/
             vrec:=substr(vrec,1,length(vrec)-7);
             --insert into test1(vstring) values(vrec);
         update temp_col_ins set upd_str=vrec where session_id=userenv('sessionid') and rownum<2;
         commit;

    End;
   -- delete from searchtbl;
    --insert into searchtbl values(pextra1);commit;

    if pextra1 is not null then
       vrec:=vrec||' order by '||pextra1;
       insert into temp_col_ins1 (sqno,col_name,upd_str,session_id) values (1234,'',pcond_colname||'#'||pcond_colval||'#'||vrec,userenv('sessionid'));
    else
       vrec:=vrec||' order by rowid ';
    end if;
   -- insert into searchtbl values(vrec);commit;

    --insert into temp_col_ins1 values (vrec);
    insert into temp_col_ins1 (sqno,col_name,upd_str,session_id) values (9999,'',pcond_colname||'#'||pcond_colval||'#'||vrec,userenv('sessionid'));
    open p_accounts for vrec;
      dbg(vrec);
    --delete from temp_col_ins where session_id=userenv('sessionid');
    commit;
End variable_execute_stmt;

--var a refcursor;
--exec CIR_DYNAMIC_DML.variable_order('','','','','ABC_CHARGE_MAST','CHG_CODE','ASC','','','',:A);

procedure variable_order(
 pcomp_code     in varchar2,
 pcomp_val         in varchar2,
 punit_code     in varchar2,
 punit_val         in varchar2,
 ptable_name     in varchar2,
 pcolname         in varchar2,
 porder         in varchar2,
 pdateformat     in varchar2,
 pextra1         in varchar2,
 pextra2         in varchar2,
 p_accounts     out t_accounts) as
Begin


   if punit_code is null and pcomp_code is not null then
      open p_accounts for ' select * from '||ptable_name||' where '||pcomp_code||'='||''''||pcomp_val||''''||' order by '||pcolname||' '||porder;
   elsif pcomp_code is null and punit_code is not null then
      open p_accounts for ' select * from '||ptable_name||' where '||punit_code||'='||''''||punit_val||''''||' order by '||pcolname||' '||porder;
   elsif pcomp_code is null and punit_code is null then
      open p_accounts for ' select * from '||ptable_name||' order by '||pcolname||' '||porder;
   else
         open p_accounts for ' select * from '||ptable_name||' where '||pcomp_code||'='||''''||pcomp_val||''''||' and '||punit_code||'='||''''||punit_val||''''||' order by '||pcolname||' '||porder;
   end if;
End variable_order;

PROCEDURE variable_insert_stmt(
    ptable_name     in varchar2,
    pcolname        in varchar2,
    pcolvalue       in varchar2,
    pdelimiter      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_error_text    out varchar2) as

    pstmt_str   varchar2(4000);
    v_sess_id   number;
cursor cur_stmt is
    select * from temp_col_ins  where session_id=v_sess_id order by sqno;
    rec_stmt cur_stmt%rowtype;
/*cursor cur_upd_stmt is
    select * from temp_col_ins  where nvl(upd_flag,'N')='I' and session_id=v_sess_id;
    rec_upd_stmt cur_upd_stmt%rowtype;*/
    vlength     number(5);
    vcolval     varchar2(4000);
    vrunval     varchar2(1);
    vcol_name     varchar2(100);
    vno         number(5);
    vrec         varchar2(4000);
    vrec_upd     varchar2(4000);
    vformat     varchar2(20);
    v_col_exists number(5);
Begin
    --insert into test1(vstring) values (pcolname||'33333'||pcolvalue);commit;
    Begin
        select userenv('sessionid') into v_sess_id from dual;
        delete from temp_col_ins where session_id=v_sess_id;
        vlength    :=null;    vcolval:=null;    vrunval:=null;    vcol_name:=null;vno:=null;

        vcolval    :=replace(pcolname,pdelimiter,',');
        vlength    :=length(vcolval);
        vno            :=1;

        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
              vcol_name:=vcol_name||vrunval;
          else
            --insert into test1(vstring2) values (vno||','||upper(ltrim(rtrim(vcol_name)))||','||v_sess_id);
            --commit;
              insert into temp_col_ins (sqno,col_name,session_id) values (vno,upper(ltrim(rtrim(vcol_name))),v_sess_id);
              vno:=vno+1;
            vcol_name:='';
          end if;
        end loop;
        /*select count(*) into v_col_exists from col where tname=upper(ltrim(rtrim(ptable_name))) and
                cname=upper(ltrim(rtrim(vcol_name)));*/
        select count(*) into v_col_exists from temp_col_ins where session_id=v_sess_id and
            col_name=upper(ltrim(rtrim(vcol_name)));
        if nvl(v_col_exists,0)=0 then
            insert into temp_col_ins(sqno,col_name,session_id) values (vno,upper(vcol_name),v_sess_id);
        end if;
        commit;
        vlength:=null;    vcolval:=null;     vrunval:=null;    vcol_name:=null;    vno:=null;
        if instr(pcolvalue,',')>0 or instr(pcolvalue,'''')>0 then
           vcolval:=replace(pcolvalue,',','~~~');
        else
             vcolval:=pcolvalue;
        end if;
        vcolval:=replace(vcolval,pdelimiter,',');
        vlength:=length(vcolval);
        vno:=1;
        for i in 1.. vlength loop
          vrunval            :=substr(vcolval,i,1);
          if vrunval    !=',' then
              vcol_name    :=vcol_name||vrunval;
          else
              vcol_name    :=replace(vcol_name,'~~~',',');
            update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=v_sess_id;
              vno:=vno+1;
            vcol_name:='';
          end if;
        end loop;
        if vcol_name is not null then
            update temp_col_ins set col_value=vcol_name where sqno=vno and session_id=v_sess_id;
        end if;
        update temp_col_ins set col_data_type=(select coltype from col where tname = upper(ltrim(rtrim(ptable_name))) and cname = upper(ltrim(rtrim(temp_col_ins.col_name))))
            where session_id=v_sess_id;
        commit;
        vrec:='insert into '||ptable_name||'('||replace(pcolname,pdelimiter,',')||') values ( ';

        --select "date_format" into vformat from preferrences;
          vformat:=pdateformat;
        open cur_stmt;
          loop
            fetch cur_stmt into rec_stmt;
               exit when cur_stmt%notfound;
               if rec_stmt.col_data_type='DATE' then
                    vrec:=vrec||'to_date('||rec_stmt.col_value||','||''''||vformat||''''||')'||',';
               else
                    vrec:=vrec||rec_stmt.col_value||',';
               end if;
          end loop;
        vrec        :=substr(vrec,1,length(vrec)-1)||')';
        vlength    :=null;
        vcolval    :=null;
        vrunval    :=null;
        vcol_name:=null;
        vno:=null;
        /*vcolval:=replace(pcond_colname,pdelimiter,',');
        vlength:=length(vcolval);
        for i in 1.. vlength loop
          vrunval:=substr(vcolval,i,1);
          if vrunval!=',' then
                   vcol_name:=vcol_name||vrunval;
          else
                 update temp_col_ins set upd_flag='I' where col_name=vcol_name and session_id=userenv('sessionid');
               vcol_name:='';
          end if;
        end loop;
        commit;
     close cur_stmt; */
     update temp_col_ins set upd_str=vrec where session_id=v_sess_id and rownum<2;
     --update temp_col_ins1 set upd_str=vrec where session_id=v_sess_id and rownum<2;
     --insert into test1(vstring) values (pcolname||'33333'||vrec);
     commit;

    End;
    execute immediate vrec;
    commit;
     --delete from temp_col_ins where session_id=userenv('sessionid');
    commit;
    exception
       when others then
            p_error_text := 'Error:'||sqlerrm;
End variable_insert_stmt;

END Cir_Dynamic_DML;
/
/*******************************************************************************************************************/
DROP PACKAGE IR_CHECK_DUPLICACY;

CREATE OR REPLACE PACKAGE cir_check_duplicacy IS
  type t_circul_type is ref cursor;
  procedure cir_check_duplicacy_p(
  pcomp_col 		in varchar2,
  pcomp_val 		in varchar2,
  punit_col 		in varchar2,
  punit_val 		in varchar2,
	ptbl_name 		in varchar2,
	pdesc_col 		in varchar2,
	pdesc_val 		in varchar2,
	palias_col 		in varchar2,
	palias_val 		in varchar2,
	pdateformat 	in varchar2,
	pextra1 			in varchar2,
	pextra2 			in varchar2,
	p_circul 			out t_circul_type);
End cir_check_duplicacy;
/



DROP PACKAGE BODY CIR_CHECK_DUPLICACY;

CREATE OR REPLACE PACKAGE BODY cir_check_duplicacy IS

--var a refcursor;
--exec cir_check_duplicacy.cir_check_duplicacy_p('LOC_ID',''''||'BRY'||'''','','','CRM_ZONE_MASTER','ZONE_NAME',''''||'BAREILLY'||'''','','','','','',:a);
	Procedure cir_check_duplicacy_p(
  	pcomp_col 		in varchar2,
	  pcomp_val 		in varchar2,
	  punit_col 		in varchar2,
	  punit_val 		in varchar2,
		ptbl_name 		in varchar2,
		pdesc_col 		in varchar2,
		pdesc_val 		in varchar2,
		palias_col 		in varchar2,
		palias_val 		in varchar2,
		pdateformat 	in varchar2,
		pextra1 			in varchar2,
		pextra2 			in varchar2,
		p_circul 			out t_circul_type)
	As
	 v_str1 varchar2(2000);
	 v_str2 varchar2(2000);
	 v_cnt1 number(5):=0;
	 v_cnt2 number(5):=0;
	 v_comp_exists number(1):=0;
	 v_unit_exists number(1):=0;
	Begin
	    v_str1:='pcomp_col '||pcomp_col||' pcomp_val '||pcomp_val||' punit_col '||punit_col||' punit_val '||punit_val||' ptbl_name '||ptbl_name||' pdesc_col '||pdesc_col||' pdesc_val '||pdesc_val||' palias_col '||palias_col||' palias_val '||palias_val;
	    insert into test1(vstring,vstring2) values(' duplicacy ',v_str1);
	    commit;
	  delete from cir_chk_duplicacy where 1=1;
		select count(*) into v_comp_exists from col where tname=ptbl_name and cname =pcomp_col;
    insert into test1(vstring,vstring2) values(' v_comp_exists ',v_comp_exists);
    commit;
		select count(*) into v_unit_exists from col where tname=ptbl_name and cname =punit_col;
    insert into test1(vstring,vstring2) values(' v_unit_exists ',v_unit_exists);
    commit;
	  select count(*) into v_cnt1 from col where tname=ptbl_name and cname =pdesc_col;
    insert into test1(vstring,vstring2) values(' v_cnt1 ',v_cnt1);
    commit;
	  select count(*) into v_cnt2 from col where tname=ptbl_name and cname =palias_col;
    insert into test1(vstring,vstring2) values(' v_cnt2 ',v_cnt2);
    commit;	
	  if v_cnt1=1 and v_cnt2=0 then
	    if v_comp_exists=1 and v_unit_exists=0 then--if comp code exists and unit code not exists in table
	    	--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||pdesc_col||'='||''''||pdesc_val||'''';
	    	v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    elsif v_comp_exists=1 and v_unit_exists=1 then--if both are existng in table
	    	--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||punit_col||'='||''''||punit_val||''''||' and '||pdesc_col||'='||''''||pdesc_val||'''';
	    	v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and '||punit_col||'='||punit_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    else--if both are not existng in table
				--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pdesc_col||'='||''''||pdesc_val||'''';
				v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where upper('||pdesc_col||')=upper('||pdesc_val||')';
	    end if;
	    insert into test1(vstring,vstring2) values(' 1duplicacy ',v_str1);
	    commit;
	    execute immediate v_str1;
	  elsif v_cnt1=0 and v_cnt2=1 then
	    if v_comp_exists=1 and v_unit_exists=0 then--if comp code exists and unit code not exists in table
	    	--v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||palias_col||'='||''''||palias_val||'''';
	    	v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    elsif v_comp_exists=1 and v_unit_exists=1 then--if both are existng in table
	    	--v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||punit_col||'='||''''||punit_val||''''||' and '||palias_col||'='||''''||palias_val||'''';
	    	v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and '||punit_col||'='||punit_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    else--if both are not existng in table
				--v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where '||palias_col||'='||''''||palias_val||'''';
				v_str2:=' insert into cir_chk_duplicacy(rec_name2) select count(*) from '||ptbl_name||' where upper('||pdesc_col||')=upper('||pdesc_val||')';
	    end if;
	    insert into test1(vstring,vstring2) values(' 2duplicacy ',v_str2);
	    commit;	    
	    execute immediate v_str2;
	  elsif v_cnt1=1 and v_cnt2=1 then
	    if v_comp_exists=1 and v_unit_exists=0 then--if comp code exists and unit code not exists in table
	    	--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||pdesc_col||'='||''''||pdesc_val||'''';
	    	v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    elsif v_comp_exists=1 and v_unit_exists=1 then--if both are existng in table
	    	--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||punit_col||'='||''''||punit_val||''''||' and '||pdesc_col||'='||''''||pdesc_val||'''';
	    	v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and '||punit_col||'='||punit_val||' and upper('||pdesc_col||')=upper('||pdesc_val||')';
	    else--if both are not existng in table
				--v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where '||pdesc_col||'='||''''||pdesc_val||'''';
				v_str1:=' insert into cir_chk_duplicacy(rec_name1) select count(*) from '||ptbl_name||' where upper('||pdesc_col||')=upper('||pdesc_val||')';
	    end if;
	    insert into test1(vstring,vstring2) values(' 3duplicacy ',v_str1);
	    commit;
	    execute immediate v_str1;
	    if v_comp_exists=1 and v_unit_exists=0 then--if comp code exists and unit code not exists in table
	    	--v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||palias_col||'='||''''||palias_val||''''||')';
	    	v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and upper('||palias_col||')=upper('||palias_val||')'||')';
	    elsif v_comp_exists=1 and v_unit_exists=1 then--if both are existng in table
	    	--v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where '||pcomp_col||'='||''''||pcomp_val||''''||' and '||punit_col||'='||''''||punit_val||''''||' and '||palias_col||'='||''''||palias_val||''''||')';
	    	v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where '||pcomp_col||'='||pcomp_val||' and '||punit_col||'='||punit_val||' and upper('||palias_col||')=upper('||palias_val||')'||')';
	    else--if both are not existng in table
				--v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where '||palias_col||'='||''''||palias_val||''''||')';
				v_str2:=' update cir_chk_duplicacy set rec_name2=(select count(*) from '||ptbl_name||' where upper('||palias_col||')=upper('||palias_val||')'||')';
	    end if;
	    insert into test1(vstring,vstring2) values(' 4duplicacy ',v_str2);
	    commit;	  	
	  	execute immediate v_str2;
	  else
	   	insert into cir_chk_duplicacy(rec_name1,rec_name2) values(0,0);
	  end if;
		commit;

		open p_circul for
		select distinct nvl(rec_name1,0) "NAME",nvl(rec_name2,0) "ALIAS" from cir_chk_duplicacy where 1=1;
		
	End cir_check_duplicacy_p;

End cir_check_duplicacy;
/



//////////*************** end*****ISSUE NO. 0005549 ******************///*******7/11/2011****//////
/*********************************7-nov-2011 Laxman*****************/
CREATE OR REPLACE procedure cir_route_droppoint_detail_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    proutecode      in varchar2,
    ptaxi_id        in varchar2,
    puserid         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    P_Accounts      OUT Cur_Type_New1.cursor_type,
    P_Accounts1     OUT Cur_Type_New1.cursor_type,
    P_Accounts2     OUT Cur_Type_New1.cursor_type)
  As
  Begin
  	open p_Accounts for
  	    SELECT R.COMP_CODE COMP_CODE,R.UNIT_CODE UNIT_CODE,R.TAXI_ID TAXI_ID,
        M.RT_CODE RT_CODE,CIR_GET_ROUTE_NAME(R.COMP_CODE,R.UNIT_CODE,M.RT_CODE) ROUTE_NAME,
        R.DROP_POINT_CODE DROP_POINT_CODE,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT_CODE,R.DROP_POINT_CODE,1) DROP_POINT_NAME, 
        R.ARRIVAL_TIME ARRIVAL_TIME,R.STOPPAGE_TIME STOPPAGE_TIME,P.LATITUDE LATITUDE,P.LOGNITUDE LOGNITUDE,R.DROP_POINT_SEQNO DROP_POINT_SEQNO 
        FROM CIR_TAXI_MAST M,CIR_TAXI_ROUTE R,CIR_DROP_POINT_MAST P
        WHERE M.COMP_CODE=R.COMP_CODE AND M.COMP_CODE=P.COMP_CODE AND R.COMP_CODE=PCOMPCODE AND 
        M.UNIT_CODE=R.UNIT_CODE AND M.UNIT_CODE=P.UNIT_CODE AND R.UNIT_CODE=PUNITCODE AND M.TAXI_ID=R.TAXI_ID AND 
        (R.TAXI_ID =PTAXI_ID OR PTAXI_ID IS NULL) AND (M.RT_CODE=PROUTECODE) AND R.DROP_POINT_CODE=P.DROP_POINT
        ORDER BY ROUTE_NAME,DROP_POINT_SEQNO;
                 
    open p_Accounts1 for select sysdate as "CUR_DATE" from dual;
                     
    open p_Accounts2 for select sysdate as "CUR_DATE" from dual;
  End cir_route_droppoint_detail_p;
/
CREATE OR REPLACE PROCEDURE cir_festival_bind(
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out cur_type_new1.cursor_type)
as
begin
    open p_Accounts for
    select * from cir_festival_mast order by fest_name;

end cir_festival_bind;
/
/*********************************7-nov-2011 Laxman*****************/



//////////////////////////////////////////////issue no. 4763///////////////////////////////////////////////////
////////////////////////////////////////////////body////////////////////////////////////////////////////


CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and (d.unit_code=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and (d.unit=punit_code or punit_code is null) and d.publ=p.publ and d.publ=e.publ and (d.publ=ppubl or ppubl is null) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/


///////////////////////////////////description//////////////////////////////////////////////////////////


CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     proute                in varchar2,
     pfrom_supdate         in varchar2,
     ptill_supdate         in varchar2,
     pdateformat         in varchar2,
     pextra1             in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);

   procedure cir_rep_supply_po(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

  procedure cir_rep_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
  
  procedure cir_rep_taluka_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
     
  procedure cir_rep_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);     

  procedure cir_rep_taluka_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
     
  procedure cir_rep_route_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

    procedure cir_rep_dist_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
    procedure cir_rep_taluka_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

     procedure cir_route_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
     procedure cir_dist_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_taluka_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_dist_taluka_wise_sup(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);
     
    procedure cir_supply_comp(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     psupdate           in varchar2,
     psupdate1          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

    procedure cir_route_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_dist_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pdist              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_taluka_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     ptaluka            in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_edition_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

     procedure cir_dist_taluka_publ_wise(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
        
procedure cir_datewise_resale(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);              
END;
/
/////////////////////////////////////////////////end of issue 4763///////////////////////////////////////////////////////////////////
/*******************************8-NOV-2011 Laxman*****************************/

CREATE OR REPLACE procedure cir_route_droppoint_detail_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    proutecode      in varchar2,
    ptaxi_id        in varchar2,
    puserid         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    P_Accounts      OUT Cur_Type_New1.cursor_type,
    P_Accounts1     OUT Cur_Type_New1.cursor_type,
    P_Accounts2     OUT Cur_Type_New1.cursor_type)
  As
  Begin
  	open p_Accounts for
  	    SELECT R.COMP_CODE COMP_CODE,R.UNIT_CODE UNIT_CODE,R.TAXI_ID TAXI_ID,M.VEHICLE_NO VEHICLE_NO, 
        M.RT_CODE RT_CODE,CIR_GET_ROUTE_NAME(R.COMP_CODE,R.UNIT_CODE,M.RT_CODE) ROUTE_NAME,
        R.DROP_POINT_CODE DROP_POINT_CODE,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT_CODE,R.DROP_POINT_CODE,1) DROP_POINT_NAME, 
        R.ARRIVAL_TIME ARRIVAL_TIME,R.STOPPAGE_TIME STOPPAGE_TIME,P.LATITUDE LATITUDE,P.LOGNITUDE LOGNITUDE,R.DROP_POINT_SEQNO DROP_POINT_SEQNO 
        FROM CIR_TAXI_MAST M,CIR_TAXI_ROUTE R,CIR_DROP_POINT_MAST P
        WHERE M.COMP_CODE=R.COMP_CODE AND M.COMP_CODE=P.COMP_CODE AND R.COMP_CODE=PCOMPCODE AND 
        M.UNIT_CODE=R.UNIT_CODE AND M.UNIT_CODE=P.UNIT_CODE AND R.UNIT_CODE=PUNITCODE AND M.TAXI_ID=R.TAXI_ID AND 
        (R.TAXI_ID =PTAXI_ID OR PTAXI_ID IS NULL) AND (M.RT_CODE=PROUTECODE) AND R.DROP_POINT_CODE=P.DROP_POINT
        ORDER BY ROUTE_NAME,DROP_POINT_SEQNO;
                 
    open p_Accounts1 for select sysdate as "CUR_DATE" from dual;
                     
    open p_Accounts2 for select sysdate as "CUR_DATE" from dual;
  End cir_route_droppoint_detail_p;
/
/*****************************8-NOV-2011 Laxman********************/




//////////////////////////issue no-4869/////specification////////////////////////////////////

CREATE OR REPLACE PACKAGE DAILYPOST.cir_rep_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     proute                in varchar2,
     pfrom_supdate         in varchar2,
     ptill_supdate         in varchar2,
     pdateformat         in varchar2,
     pextra1             in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);

   procedure cir_rep_supply_po(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

  procedure cir_rep_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
  
  procedure cir_rep_taluka_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
     
  procedure cir_rep_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);     

  procedure cir_rep_taluka_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
     
  procedure cir_rep_route_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

    procedure cir_rep_dist_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
    procedure cir_rep_taluka_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

     procedure cir_route_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
     procedure cir_dist_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_taluka_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_dist_taluka_wise_sup(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);
     
    procedure cir_supply_comp(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     psupdate           in varchar2,
     psupdate1          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

    procedure cir_route_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_dist_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pdist              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_taluka_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     ptaluka            in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_edition_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

     procedure cir_dist_taluka_publ_wise(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
        
procedure cir_datewise_resale(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);              
END;
/
//////////////////////////////////////body////////////////////////////////

CREATE OR REPLACE PACKAGE BODY DAILYPOST.cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and d.unit_code=nvl(punit_code,d.unit_code) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and d.unit=nvl(punit_code,d.unit) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/

//////////////////////end of procedure//////////////////////////////////////////////////////

//////////////////////////////function issue no-4869///////////////////

CREATE OR REPLACE FUNCTION HT18JULY.cir_get_edtn_name(pcomp_code in varchar2,pedtn in varchar2) RETURN varchar2 IS
vedtn_name varchar2(500);
BEGIN
   Begin
      select edtn_name into vedtn_name from cir_edtn_mast where comp_code=pcomp_code and edtn=pedtn;
           exception when others then
            vedtn_name:=null;
  End;
    return nvl(vedtn_name,'');
END;
/


/////////////////////////////end of function/////////////////////////////////////////////




//*************************************5257 11/11/2011 Ritu***********************//


CREATE OR REPLACE PROCEDURE HT18JULY.cir_rep_return_sale(
      pcompcode         in varchar2,
      punitcode         in varchar2,
      pbrancode         in varchar2,
      ppublcode         in varchar2,
      pmedtncode        in varchar2,
      pedtncode         in varchar2,
      pacc_code         in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      puserid           in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      pextra3           in varchar2,
      pextra4           in varchar2,
      pextra5           in varchar2,
      p_accounts        OUT Cur_Type_New1.cursor_type,
      p_accounts1       OUT Cur_Type_New1.cursor_type,
      p_accounts2       OUT Cur_Type_New1.cursor_type,
      p_accounts3       OUT Cur_Type_New1.cursor_type)
    As
      v_bill_frdt         date;
      v_bill_todt         date;

  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

        open p_accounts for
        select x.comp_code as "COMP_CODE",x.unit_code as "UNIT_CODE",x.branch_code as "BRANCH_CODE",x.recptno as "RECPTNO",
        x.recptdt as "RECPTDT",x.acc_code as "ACC_CODE",x.acc_name as "ACC_NAME",
        x.tax1_type as "TAX1_TYPE",x.tax1_rate as "TAX1_RATE",x.tax2_type as "TAX2_TYPE",x.tax2_rate as "TAX2_RATE",
        x.publ_code as "PUBL_CODE",x.publ_name as "PUBL_NAME",
        x.main_edtn as "MAIN_EDTN",x.main_edtn_name as "MAIN_EDTN_NAME", x.edtn_code as "EDTN_CODE",x.edtn_name as "EDTN_NAME",
        x.edtn_rate as "EDTN_RATE",x.no_of_copy as "NO_OF_COPY",x.copy_rate as "COPY_RATE",x.copy_weight as "COPY_WEIGHT",
        x.grs_amt as "GRS_AMT",x.tax1_amt as "TAX1_AMT",x.tax2_amt as "TAX2_AMT",(x.grs_amt+x.tax1_amt+x.tax2_amt) as "BILL_AMT"
        from (select h.comp_code,h.unit_code,h.branch_code,h.recptno,h.recptdt,h.acc_code,m.acc_name,
        case when h.tax1_type<>'0' then h.tax1_type else null end tax1_type ,h.tax1_rate,
        case when h.tax2_type<>'0' then h.tax2_type else null end tax2_type,h.tax2_rate,d.publ_code,p.publ_name,
        e.main_edtn,cir_get_edtn_name(h.comp_code,e.main_edtn) main_edtn_name, d.edtn_code,e.edtn_name,
        d.edtn_rate,sum(d.no_of_copy) no_of_copy,d.copy_rate,sum(d.copy_weight) copy_weight,
        d.copy_rate*sum(d.copy_weight) grs_amt,
        case when h.tax1_type='P' then round((d.copy_rate*sum(d.copy_weight)*h.tax1_rate)/100,2) when h.tax1_type='F' then round(h.tax1_rate,2) else round(h.tax1_rate,2) end tax1_amt,
        case when h.tax2_type='P' then round((d.copy_rate*sum(d.copy_weight)*h.tax2_rate)/100,2) when h.tax2_type='F' then round(h.tax2_rate,2) else round(h.tax2_rate,2) end tax2_amt
        from  cir_return_sale_hdr h,cir_return_sale_det d,fa_acc_mast m,cir_publ_mast p, cir_edtn_mast e
        where h.comp_code=d.comp_code and h.comp_code=p.comp_code and h.comp_code=e.comp_code and h.comp_code=m.comp_code and  h.comp_code=pcompcode and h.unit_code=d.unit_code  and
        (h.unit_code=punitcode or punitcode is null) and
        h.doctype=d.doctype and h.doctype='RET' and h.recptno=d.recptno and h.recptdt=d.recptdt and h.recptdt between v_bill_frdt and v_bill_todt and
        (h.branch_code=pbrancode or pbrancode is null) and m.cdp=h.acc_code and d.publ_code=p.publ and d.publ_code=nvl(ppublcode,d.publ_code) and
        d.edtn_code=e.edtn and d.edtn_code=nvl(pedtncode,d.edtn_code) and e.main_edtn=nvl(pmedtncode,e.main_edtn ) and
        (h.acc_code=pacc_code or pacc_code is null) and nvl(d.edtn_rate,0)>0
        group by h.comp_code,h.unit_code,h.branch_code,h.recptno,h.recptdt,h.acc_code,m.ACC_NAME,
        h.tax1_type ,h.tax1_rate,h.tax2_type ,h.tax2_rate,d.publ_code,p.publ_name,e.main_edtn,d.edtn_code,e.edtn_name,
        d.edtn_rate,d.copy_rate) x
        order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtn_name,edtn_name;

        open p_accounts1 for
        select x.comp_code as "COMP_CODE",x.unit_code as "UNIT_CODE",x.branch_code as "BRANCH_CODE",x.recptno as "RECPTNO",x.recptdt as "RECPTDT",
        x.acc_code as "ACC_CODE",x.acc_name as "ACC_NAME",
        x.tax1_type as "TAX1_TYPE",x.tax1_rate AS "TAX1_RATE",x.tax2_type as "TAX2_TYPE",x.tax2_rate AS "TAX2_RATE",sum(x.no_of_copy) "NO_OF_COPY",
        x.copy_rate AS "COPY_RATE",sum(x.copy_weight) AS "COPY_WEIGHT",
        sum(x.grs_amt) AS "GRS_AMT",sum(x.tax1_amt) as "TAX1_AMT", sum(x.tax2_amt) as "TAX2_AMT",
        sum(x.grs_amt+x.tax1_amt+x.tax2_amt) as "BILL_AMT"
        from (select h.comp_code,h.unit_code,h.branch_code,h.recptno,h.recptdt,h.acc_code,m.acc_name,
        case when h.tax1_type<>'0' then h.tax1_type else null end tax1_type ,h.tax1_rate,
        case when h.tax2_type<>'0' then h.tax2_type else null end tax2_type,h.tax2_rate,d.publ_code,p.publ_name,
        e.main_edtn,cir_get_edtn_name(h.comp_code,e.main_edtn) main_edtn_name, d.edtn_code,e.edtn_name,
        d.edtn_rate,sum(d.no_of_copy) no_of_copy,d.copy_rate,sum(d.copy_weight) copy_weight,
        d.copy_rate*sum(d.copy_weight) grs_amt,
        case when h.tax1_type='P' then round((d.copy_rate*sum(d.copy_weight)*h.tax1_rate)/100,2) when h.tax1_type='F' then round(h.tax1_rate,2) else round(h.tax1_rate,2) end tax1_amt,
        case when h.tax2_type='P' then round((d.copy_rate*sum(d.copy_weight)*h.tax2_rate)/100,2) when h.tax2_type='F' then round(h.tax2_rate,2) else round(h.tax2_rate,2) end tax2_amt
        from  cir_return_sale_hdr h,cir_return_sale_det d,fa_acc_mast m,cir_publ_mast p, cir_edtn_mast e
        where h.comp_code=d.comp_code and h.comp_code=p.comp_code and h.comp_code=e.comp_code and h.comp_code=m.comp_code and  h.comp_code=pcompcode and h.unit_code=d.unit_code  and
        (h.unit_code=punitcode or punitcode is null) and
        h.doctype=d.doctype and h.doctype='RET' and h.recptno=d.recptno and h.recptdt=d.recptdt and h.recptdt between v_bill_frdt and v_bill_todt and
        (h.branch_code=pbrancode or pbrancode is null) and m.cdp=h.acc_code and d.publ_code=p.publ and d.publ_code=nvl(ppublcode,d.publ_code) and
        d.edtn_code=e.edtn and d.edtn_code=nvl(pedtncode,d.edtn_code) and e.main_edtn=nvl(pmedtncode,e.main_edtn ) and
        (h.acc_code=pacc_code or pacc_code is null) and nvl(d.edtn_rate,0)>0
        group by h.comp_code,h.unit_code,h.branch_code,h.recptno,h.recptdt,h.acc_code,m.ACC_NAME,
        h.tax1_type ,h.tax1_rate,h.tax2_type ,h.tax2_rate,d.publ_code,p.publ_name,e.main_edtn,d.edtn_code,e.edtn_name,
        d.edtn_rate,d.copy_rate) x
        group by x.comp_code,x.unit_code,x.branch_code,x.recptno,x.recptdt,x.acc_code,x.acc_name,x.tax1_type ,x.tax1_rate,x.tax2_type,x.tax2_rate,x.copy_rate
        order by comp_code,unit_code,recptdt,recptno;

        open p_accounts2 for select sysdate as "CUR_DATE" from dual;

        open p_accounts3 for select sysdate as "CUR_DATE" from dual;

    End cir_rep_return_sale;
/



///////////////////////////////////end of issue////////////////////////////////////////////////////

/////////////////////////issue no-5023////specification////procedure for taluka////////////////////////////////////////


CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/

/////////////////////////////body///////////////////////////////////////////////////
CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt from
               (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
  
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;

     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;

  End cir_publ_unsold_supply;


    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
  
   procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
            
    v1 c1%rowtype;
   
  Begin
        
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));

        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name,copy_rate;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                order by state_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",comm_amt as "COPY_RATE", sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd,comm_amt order by publ_name,main_edtn_name,edtn_name,copy_rate;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                comm_amt as "COPY_RATE",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code,comm_amt order by state_name,dist_name,taluka_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    
  End cir_monthly_net_paid_sale;

  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;

/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/

    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      
      v_opbal           number(10):=0;

  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);

            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/

            
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);

            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                                              
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
                
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;

            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            
            open p_accounts3 for v_query1;

            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
                   
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            
            open p_accounts5 for v_query1; 
        
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        
        open p_accounts5 for select sysdate from dual; 
        
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
   
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
    
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/


///////////////////////////////////end of taluka procedure////////////////////////////////////////////////////


//////////////////////////procedure for district   /////  specification////////////////////////////////////////
CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/


////////////////////////////////////////////body///////////////////////////////////////////


CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt from
               (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt 
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
  
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;

     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;

  End cir_publ_unsold_supply;


    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
    
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                                              
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
    
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
  
   procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
            
    v1 c1%rowtype;
   
  Begin
        
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));

        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name,copy_rate;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                order by state_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                gross_amt AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",comm_amt as "COPY_RATE", sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd,comm_amt order by publ_name,main_edtn_name,edtn_name,copy_rate;

                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                comm_amt as "COPY_RATE",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code,comm_amt order by state_name,dist_name,taluka_name,comm_amt;

                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",0 "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    
  End cir_monthly_net_paid_sale;

  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;

/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/

    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      
      v_opbal           number(10):=0;

  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);

            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);

            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);

            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/

            
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);

            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                                              
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
                
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
               
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
    
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;

            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            
            open p_accounts3 for v_query1;

            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
                   
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            
            open p_accounts5 for v_query1; 
        
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        
        open p_accounts5 for select sysdate from dual; 
        
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
   
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
    
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/


//////////////////////////end of issue 5023/////////////////////////////////////////////////////////////
////////////////////////5435
CREATE OR REPLACE package body cir_publ_bind is
   procedure cir_publ_bind_p (
     pcomp_code in varchar2,
     pdateformat in varchar2,
     pextra1 in varchar2,
     pextra2 in varchar2,
     p_accounts out t_accounts_cursor) as
   Begin
      open p_accounts for
         select * from cir_publ_mast
                 where comp_code = pcomp_code and
                       ((upper(publ_name) like upper(pextra1)||'%') or (pextra1 is null)) 
                       
                       and(PUBL =pextra2 or  pextra2 is null)
                     
                       --nvl(freeze_flag,'N')='N' 
                 order by publ;
   End cir_publ_bind_p;
   procedure cir_publ_bind_p (
   	pcomp_code in varchar2,
   	ppubl_code in varchar2,
    pdateformat in varchar2,
    pextra1 in varchar2,
    pextra2 in varchar2,
   	p_accounts out t_accounts_cursor) as
   Begin
      open p_accounts for
         select * from cir_publ_mast
                 where comp_code = pcomp_code and 
                       (publ=ppubl_code or ppubl_code is null) and
                       ((upper(publ_name) like upper(pextra1)||'%') or (pextra1 is null)) 
                       --nvl(freeze_flag,'N')='N'
                 order by publ;
   End cir_publ_bind_p;
End cir_publ_bind;
/

/***************************************17_nov-2011 Laxman*********************************/
CREATE OR REPLACE procedure cir_for_dispute_bill(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagency_type    in varchar2,
    pclass_type     in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,   
    ppubltype       in varchar2,
    ppublcode       in varchar2,
    pfromdate       in varchar2, 
    ptilldate       in varchar2,
    ptype           in varchar2,--for disputed D or undisputed bill U
    puserid         in varchar2, 
    pdateformate    in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    p_accounts      OUT Cur_Type_New1.cursor_type,
    p_accounts1     OUT Cur_Type_New1.cursor_type)
is
    v_frdt     date;
    v_todt     date;

begin
    v_frdt:=to_date(pfromdate,''''||pdateformate||'''');
    v_todt:=to_date(ptilldate,''''||pdateformate||'''');
    
    if upper(ptype)='U' then--for Undisputed bills
        if ppubltype is null and ppublcode is null then
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL", null as "DISPUTE_REMARK" 
            from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='N'
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N')
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         else
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL", null as "DISPUTE_REMARK" 
            from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='N' and 
                    b.publ in(select publ from cir_publ_mast where comp_code=pcompcode and publ=nvl(ppublcode,publ) and pro_type=nvl(ppubltype,pro_type)) 
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N')
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         end if;   
     else--for disputed bills
        if ppubltype is null and ppublcode is null then
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL",b.dispute_rmrk as "DISPUTE_REMARK" from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='Y'
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N'),
                b.dispute_rmrk
                having sum( o.amount )>0
                order by agency_name,billdt,billno;     
         else
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL",b.dispute_rmrk as "DISPUTE_REMARK" from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='Y' and
                    b.publ in(select publ from cir_publ_mast where comp_code=pcompcode and publ=nvl(ppublcode,publ) and pro_type=nvl(ppubltype,pro_type))
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N'),
                b.dispute_rmrk
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         end if;       
     end if;       
    
    open p_accounts1 for select sysdate as "CUR_DATE" from dual;
    
End cir_for_dispute_bill;
///////////////////////////////////////
CREATE OR REPLACE procedure cir_updation_dispute_bill(
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pagcd               in varchar2,
    pdpcd               in varchar2,   
    pbillno             in varchar2,
    pbilldt             in varchar2,
    pdisputed_rmrk      in varchar2,
    pdisputed_flag      in varchar2,
    ptype               in varchar2,--for disputed D or undisputed bill U
    puserid             in varchar2, 
    pdateformate        in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pextra3             in varchar2,
    pextra4             in varchar2,
    pextra5             in varchar2,
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
    p_accounts          OUT Cur_Type_New1.cursor_type)
is
    v_billdt  date;
    v_cnt number(5);
begin
    v_billdt:=to_date(pbilldt,''''||pdateformate||'''');
    if ptype='D' then
        select count(*) into v_cnt from cir_outmast where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
            billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd and nvl(dispute_flag,'N')='Y';
    else
        select count(*) into v_cnt from cir_outmast where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
            billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd and nvl(dispute_flag,'N')='N';
    end if;
    
    if v_cnt>0 then
        v_cnt:=0;
        update cir_outmast set dispute_flag=pdisputed_flag, dispute_user_code=puserid, dispute_dt =sysdate,
        dispute_rmrk=pdisputed_rmrk
         where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
        billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd;
        v_cnt:=1;
    end if;
    COMMIT;
    open p_accounts for select v_cnt as "UPDATE_RECORD" from dual;
    
End cir_updation_dispute_bill;
/


/***************************************17_nov-2011 Laxman*********************************/
/***************************************17-NOV-2011 NEHA*****************************************/

CREATE OR REPLACE procedure cir_fetch_supplment_rate(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    ppublcode       in varchar2,
    pfromdate       in varchar2, 
    ptilldate       in varchar2,
    puserid         in varchar2, 
    pdateformate    in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    p_accounts      OUT Cur_Type_New1.cursor_type)
is
    v_from_date     date;
    v_till_date     date;
    v_dt            date;
    v_day           varchar2(20);
    v_flg           varchar2(1):='N';
    v_recno         number;
    cursor c1 is
    select s.comp_code comp_code,s.unit_code unit_code,s.publ_code publ_code,p.publ_name publ_name,e.main_edtn main_edtn,cir_get_edtn_name(s.comp_code,e.main_edtn) main_edtn_name,
    s.edtn_code edtn,e.edtn_name edtn_name,s.supl_name_sun supl_name,max(s.valid_from) valid_from,max(s.valid_till) valid_till,s.insertion_fee,
    s.sun_allow,s.mon_allow,s.tue_allow,s.wed_allow,s.thu_allow,s.fri_allow,s.sat_allow
    from cir_publ_mast p,cir_edtn_mast e,cir_edtn_supl_mast s
    where p.comp_code=e.comp_code and p.comp_code=s.comp_code and p.comp_code=pcompcode and
        p.publ=e.publ and p.publ=s.publ_code and (p.publ=ppublcode or ppublcode is null) and (s.unit_code=punitcode or punitcode is null) and e.edtn=s.edtn_code --and
        --v_from_date between valid_from and valid_till  and 
        --v_till_date between valid_from and valid_till
        group by s.comp_code,s.unit_code,s.publ_code,p.publ_name,e.main_edtn,
    s.edtn_code,e.edtn_name,s.supl_name_sun,s.insertion_fee,sun_allow,mon_allow,tue_allow,wed_allow,thu_allow,fri_allow,sat_allow;
    v1 c1%rowtype;
begin
    v_from_date:=to_date(pfromdate,''''||pdateformate||'''');
    v_till_date:=to_date(ptilldate,''''||pdateformate||'''');
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --DBMS_OUTPUT.PUT_LINE('v_from_date='||v_from_date);
    open c1;
    loop
        fetch c1 into v1;
        exit when c1%notfound;
        
        v_dt:=v_from_date;
        --DBMS_OUTPUT.PUT_LINE('v_dt='||v_dt);
        Loop
            --DBMS_OUTPUT.PUT_LINE('v1.valid_from ='||v1.valid_from||' v1.valid_till '||v1.valid_till);
                if v_dt>v_till_date then
                    exit;
                end if;
            if v_dt between v1.valid_from and v1.valid_till then

                v_day:=to_char(v_dt,'DY');
                --DBMS_OUTPUT.PUT_LINE('v_day ='||v_day||' v1.sun_allow '||v1.sun_allow||' v1.mon_allow '||v1.mon_allow||' v1.tue_allow '||v1.tue_allow||' v1.wed_allow '||v1.wed_allow||' v1.thu_allow '||v1.thu_allow||' v1.fri_allow '||v1.fri_allow||' v1.sat_allow '||v1.sat_allow);
                if v_day='SUN' then 
                    if v1.sun_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                elsif v_day='MON' then 
                    if v1.mon_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                elsif v_day='TUE' then 
                    if v1.tue_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;    
                elsif v_day='WED' then 
                    if v1.wed_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                elsif v_day='THU' then 
                    if v1.thu_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                elsif v_day='FRI' then 
                    if v1.fri_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                else
                    if v1.sat_allow='Y' then 
                        v_flg:='Y';
                    else
                        v_flg:='N';
                    end if;
                end if;
                --DBMS_OUTPUT.PUT_LINE('v_flg='||v_flg);
                if v_flg='Y' then
                    insert into cir_temp_bill_collection
                        (comp_code, unit_code, billno,publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
                        billdt,comm_amt,cur_sessionid)
                    values(v1.comp_code,v1.unit_code,v1.publ_code,v1.publ_name,v1.main_edtn,v1.edtn,v1.main_edtn_name,v1.edtn_name,
                        v1.supl_name,v_dt,v1.insertion_fee,userenv('sessionid'));
                end if; 
            end if;
            v_dt:=v_dt+1;                       
        End loop;
    end loop;
    close c1;
                
    open p_accounts for 
    select comp_code AS "COMP_CODE", unit_code AS "UNIT_CODE", billno as "PUBL_CODE",publ_code AS "PUBL_NAME", agcd AS "MAIN_EDTN", dpcd AS "EDTN",
    agname AS "MAIN_EDTN_NAME",agname_oth_lang AS "EDTN_NAME", city_code AS "SUPL_NAME", 
    billdt AS "SUPDATE" ,comm_amt AS "INSERTION_FEE" 
    from cir_temp_bill_collection  where cur_sessionid=userenv('sessionid');
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
End cir_fetch_supplment_rate;
/


CREATE OR REPLACE procedure cir_fetch_suppliment_data_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagtype         in varchar2,
    pagclass        in varchar2,
    psup_type       in varchar2,
    pagcode         in varchar2,
    pdepocode       in varchar2,
    pcode           in varchar2,
    pprocesstype    in varchar2,---process by Zone.Region,Branch,District,Route
    pdatefrom       in varchar2,
    pdatetill       in varchar2,
    pedtncode_val   in varchar2,--for edition code
    psupdate_val    in varchar2,--for supply date
    pinc_rate_val   in varchar2,--for insertion rate
    psupl_no_val    in varchar2,--for no. of insertion
    psupl_name_val  in varchar2,--for suppliment name
    pdelimiter      in varchar2,
    puserid         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    P_Accounts      OUT Cur_Type_New1.cursor_type)
  As
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    v_sname     varchar2(8000);
    vno         number:=0;
    v_frdt      date;
    v_todt      date;
    v_doctype   varchar2(10):='CN';
    v_recptdt   date;
    v_dt        date;
    v_sess_id   varchar2(30);
    cursor c1 is
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ,a.edtn edtn,a.supdate supdate,
        a.agcd agcd,a.dpcd dpcd,a.billagcd billagcd,a.billdpcd billdpcd,
        b.inc_rate inc_rate,b.noof_supl no_of_supl,b.supl_name supl_name,sum(a.sup_copy) sup_copy
        from cir_dbksup a,cir_temp_suppliment b,cir_supply_type_mast c,cir_agmast d
        where a.comp_code = pcompcode and a.comp_code = b.comp_code and a.comp_code = c.comp_code and a.comp_code = d.comp_code and 
              a.unit_code=nvl(punitcode,a.unit_code) and a.unit_code=d.unit and a.edtn=b.edition_code and 
              a.supdate >= v_frdt and a.supdate <=v_todt and a.sup_type_code =c.sup_ty_code and
              a.sup_type_code=nvl(psup_type,a.sup_type_code) and --nvl(c.handling_pay,'N')='Y' and 
              a.agcd = d.agcd and a.dpcd = d.dpcd and d.agcd = nvl(pagcode,d.agcd) and d.dpcd = nvl(pdepocode,d.dpcd) and 
              (d.ag_type =pagtype or pagtype is null) and (d.ag_class =pagclass or pagclass is null) and 
              (d.dist_code in(select debit_head from CIR_LEDGER_REPORT where sess_id=userenv('sessionid') and debit_head is not null) or pcode is null) and 
              b.sess_id=userenv('sessionid') and a.supdate=b.sup_date and a.billagcd is not null
              group by a.comp_code,a.unit_code,a.publ,a.edtn,a.supdate,a.agcd,a.dpcd,a.billagcd,a.billdpcd,b.inc_rate,b.noof_supl,b.supl_name
              order by a.comp_code,a.unit_code,a.supdate,a.publ,a.edtn;
    v1 c1%rowtype;
    v_amt       number(15,2);
    v_remark    varchar2(500);
    v_recptno   varchar2(50);
    v_dsign     number(5);
    
    v_bran_code  varchar2(20);
    v_rec_no     number(10);  
    v_unsold_copy number(10);
    vdistcode   varchar2(4000);
    vtalukacode varchar2(4000);     
  Begin
    --insert into test1(vstring,vstring2) values('pdatefrom '||pdatefrom||' pdatetill '||pdatetill||'precptdt '||precptdt,' pdelimiter '||pdelimiter); commit;
    v_frdt      :=to_date(pdatefrom,''''||pdateformat||'''');
    v_todt      :=to_date(pdatetill,''''||pdateformat||'''');
    v_recptdt   :=to_date(pdatetill,''''||pdateformat||'''');
    
    delete from cir_supl_process_det_temp where recptno=''''||userenv('sessionid')||'''';commit;
    delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    select userenv('sessionid') into v_sess_id from dual;
/* for  Edition Code */
    vlength :=null; v_val :=null; vrunval :=null; vno:=null;
    v_val   :=replace(pedtncode_val,pdelimiter,',');
    vlength :=length(v_val);vno:=1;

    --insert into test1(vstring,vstring2) values('pedtncode_val '||pedtncode_val||' psupdate_val '||psupdate_val||'pinc_rate_val '||pinc_rate_val||'psupl_no_val '||psupl_no_val,' pdelimiter '||pdelimiter); commit;

    for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_temp_suppliment(comp_code ,unit_code ,seq_no,edition_code,sess_id)
                    values (pcompcode,punitcode,vno,v_name,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
    end loop;

/* for Supply Date */
    vlength:=null; v_val:=null;vrunval:=null;v_name:=null; vno:=null;v_sname:=null;
    v_val       :=replace(psupdate_val,pdelimiter,',');
    vlength     :=length(v_val);vno:=1;

    for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name  :=v_name||vrunval;
        else
        v_dt:=to_date(v_name,''''||pdateformat||'''');
            update cir_temp_suppliment set sup_date=v_dt
                where seq_no=vno and sess_id=userenv('sessionid');
            vno     :=vno+1;
            v_name  :='';
        end if;
    end loop;

/* for Incanctive Per Copy Rate */
    vlength:=null; v_val:=null;vrunval:=null;v_name:=null; vno:=null;v_sname:=null;
    v_val       :=replace(pinc_rate_val,pdelimiter,',');
    vlength     :=length(v_val);vno:=1;

    for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name  :=v_name||vrunval;
        else
            update cir_temp_suppliment set inc_rate=(v_name)
                where seq_no=vno and sess_id=userenv('sessionid');
            vno     :=vno+1;
            v_name  :='';
        end if;
        --insert into test1(vstring,vstring2) values(' suppliment122 ',v_val||'  '||vrunval||'  '||v_name);commit;
  
    end loop;

/* for No of Supl */
    vlength:=null; v_val:=null;vrunval:=null;v_name:=null; vno:=null;v_sname:=null;
    v_val       :=replace(psupl_no_val,pdelimiter,',');
    vlength     :=length(v_val);vno:=1;

    for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name  :=v_name||vrunval;
        else
            --insert into test1(vstring,vstring2) values(' suppliment ',4);commit;
            update cir_temp_suppliment set noof_supl=(v_name)
                where seq_no=vno and sess_id=userenv('sessionid');
            vno     :=vno+1;
            v_name  :='';
        end if;
    end loop;

/* for Supl Name*/
    vlength:=null; v_val:=null;vrunval:=null;v_name:=null; vno:=null;v_sname:=null;
    v_val       :=replace(psupl_name_val,pdelimiter,',');
    vlength     :=length(v_val);vno:=1;

    for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_sname  :=v_sname||vrunval;
        else
            --insert into test1(vstring,vstring2) values(' suppliment ',4);commit;
            update cir_temp_suppliment set supl_name=(v_sname)
                where seq_no=vno and sess_id=userenv('sessionid');
            vno     :=vno+1;
            v_name  :='';
        end if;
    end loop;
  
    if pcode is not null then
        vdistcode:=pcode||',';

    /* for  District Code */
        vlength :=null; v_val :=null; v_name:=null;vrunval :=null; vno:=null;
        v_val   :=replace(vdistcode,',',',');
        vlength :=length(v_val);vno:=1;

        for i in 1.. vlength loop
            vrunval:=substr(v_val,i,1);
            if vrunval!=',' then
                v_name:=v_name||vrunval;
            else
                insert into CIR_LEDGER_REPORT(comp_code ,unit_code ,debit_head,credit_head,rec_seqno,sess_id)
                        values (pcompcode,punitcode,v_name,null,vno,userenv('sessionid'));
                vno:=vno+1;
                v_name:='';
            end if;
        end loop;
    end if;

    commit;
    
    open c1;
    loop
        fetch c1 into v1;
        exit when c1%notfound;
        
        /*select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_unsold_copy
        from cir_unsold_dtl 
        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype='UCN' and 
            process_crdt=v1.supdate and agcd=v1.billagcd and dpcd=v1.billdpcd and publ=v1.publ and edtn=v1.edtn and process_crno is not null;*/
        
        v_amt:=(nvl(v1.sup_copy,0)-nvl(v_unsold_copy,0))*nvl(v1.inc_rate,0)*nvl(v1.no_of_supl,0);
        if nvl(v_amt,0)<>0 then 
            insert into cir_supl_process_det_temp(comp_code,unit_code,publ_code,edtn_code,supdate,agcd,dpcd,
                tot_supply,per_copy_rate,no_of_supl,recptdt,recptno,amount,bilagcd,bildpcd,created_by,doctype,supl_name)
                    values(v1.comp_code,v1.unit_code,v1.publ,v1.edtn,v1.supdate,v1.agcd,v1.dpcd,
                       nvl(v1.sup_copy,0)-nvl(v_unsold_copy,0),v1.inc_rate,v1.no_of_supl,v_recptdt,userenv('sessionid'),v_amt,v1.billagcd,v1.billdpcd,puserid,v_doctype,v1.supl_name);
        end if;               
   end loop;
   close c1;

   v_amt:=0;
   --insert into test1(vstring,vstring2) values(' suppliment charges1 ',userenv('sessionid'));commit;

   commit;

   open P_Accounts for
    select s.comp_code as "COMP_CODE",s.unit_code AS "UNIT_CODE",s.recptno as "RECPTNO",s.recptdt as "RECPTDT", s.bilagcd AS "AGCD",s.bildpcd AS "DPCD",m.ag_name AS "AG_NAME",
    cir_get_drop_point_name(s.comp_code,s.unit_code,m.station_code,1) as "DROP_POINT_NAME",cir_get_city(s.comp_code,m.city_code) as "CITY_NAME",
    s.doctype as "DOCTYPE",sum(s.tot_supply) as "SUPPLY",count(s.no_of_supl) as "NO_OF_INSERTION", 
    sum(s.amount) as "AMOUNT"
    from cir_supl_process_det_temp s,cir_agmast m
    where s.comp_code=m.comp_code and s.unit_code=m.unit and s.bilagcd=m.agcd and s.bildpcd=m.dpcd and s.recptno=v_sess_id
    group by s.comp_code,s.unit_code,s.recptno,s.recptdt,s.doctype,s.bilagcd,s.bildpcd,m.station_code,m.city_code,m.ag_name
    having sum(amount)>0
    order by comp_code,unit_code,bilagcd,bildpcd;
   
   
   delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
   delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
End cir_fetch_suppliment_data_p;
/


CREATE OR REPLACE procedure cir_suppliment_cn_process_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdepocode       in varchar2,
    pdatefrom       in varchar2,
    pdatetill       in varchar2,
    pdoctype        in varchar2,
    precptdt        in varchar2,
    precptno        in varchar2,
    preason         in varchar2,
    premark         in varchar2,
    puserid         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    P_Accounts      OUT Cur_Type_New1.cursor_type)
  As
    vlength     number(7);
    v_frdt      date;
    v_todt      date;
    v_doctype   varchar2(10);
    v_recptdt   date;
    v_dt        date;
    v_sess_id   varchar2(30);
    cursor c2 is
        select s.comp_code,s.unit_code,s.doctype,sum(s.tot_supply) tot_supply,s.recptdt,s.recptno,sum(s.amount) amount,s.bilagcd,s.bildpcd 
        from cir_supl_process_det s,cir_agmast m 
        where s.comp_code=m.comp_code and s.comp_code=pcompcode and s.unit_code=m.unit and s.unit_code=punitcode and 
        s.bilagcd=m.agcd and (s.bilagcd=pagcode or pagcode is null) and s.bildpcd=m.dpcd and (s.bildpcd= pdepocode or pdepocode is null) and
        s.recptno=precptno and s.recptdt=v_recptdt
        group by s.comp_code,s.unit_code,s.doctype,s.recptdt,s.recptno,s.bilagcd,s.bildpcd
        having sum(s.amount)>0
        order by s.comp_code,s.unit_code,s.bilagcd,s.bildpcd;
    v_amt       number(15,2);
    v_remark    varchar2(500);
    v_recptno   varchar2(50);
    v_dsign     number(5);
    
    v_bran_code  varchar2(20);
    v_rec_no     number(10);  
    v_unsold_copy number(10);
    vdistcode   varchar2(4000);
    vtalukacode varchar2(4000);     
    v2 c2%rowtype;
  Begin
    --insert into test1(vstring,vstring2) values('pdatefrom '||pdatefrom||' pdatetill '||pdatetill||' precptdt '||precptdt,' pdateformat '||pdateformat); commit;
    v_frdt      :=to_date(pdatefrom,''''||pdateformat||'''');
    v_todt      :=to_date(pdatetill,''''||pdateformat||'''');
    v_recptdt   :=to_date(precptdt,''''||pdateformat||'''');

    insert into cir_supl_process_det
        (comp_code, unit_code, publ_code, edtn_code, supdate, agcd, dpcd, tot_supply, per_copy_rate, no_of_supl, doctype, recptdt, recptno, amount, bilagcd, bildpcd, created_by, created_date, updated_by, updated_date, supl_name)
        select comp_code, unit_code, publ_code, edtn_code, supdate, agcd, dpcd, tot_supply, per_copy_rate, no_of_supl, doctype, recptdt, recptno, amount, bilagcd, bildpcd, created_by, created_date, updated_by, updated_date, supl_name 
        from cir_supl_process_det_temp where comp_code=pcompcode and unit_code=punitcode and 
            bilagcd=pagcode and bildpcd= pdepocode and recptno=precptno and recptdt=v_recptdt;
            
    if pdoctype is null then
        v_doctype:='CN';
    else
        v_doctype:=pdoctype;
    end if;
        
   v_amt:=0;
   --insert into test1(vstring,vstring2) values(' suppliment charges1 ',userenv('sessionid'));commit;
   open c2;
   loop
    fetch c2 into v2;
    exit when c2%notfound;
        --insert into test1(vstring,vstring2) values(' suppliment charges2 ',userenv('sessionid'));commit;
        select branch_code into v_bran_code from cir_agmast 
            where comp_code=v2.comp_code and unit=v2.unit_code and agcd=v2.bilagcd and dpcd=v2.bildpcd;
        
        select Dsign into v_dsign from cir_docmst where Comp_code=pcompcode AND doc_type=v_doctype;

        if(v_dsign=-1) THEN
            v_amt:=v2.amount*v_dsign;
        else
            v_amt:=v2.amount*v_dsign;
        end if;
        if premark is null then
            v_remark:='Being amount auto credited against suppliment charges';
        else
            v_remark:=premark;
        end if;     


        Begin
            select max(to_number(substr(recptno,-8)))+1 into v_rec_no from cir_rcphdr 
                where comp_code=v2.comp_code  and doctype=v_doctype and to_char(recptdt,'yymm')=to_char(v_recptdt,'yymm') and 
                    branch_code=v_bran_code;
            Exception When Others Then
                v_rec_no:=null;
        End;
        
        If nvl(v_rec_no,0)=0 Then
          v_recptno:=v_bran_code||'-'||to_char(v_recptdt,'yymm')||'0001';
        Else
          v_recptno:=v_bran_code||'-'||lpad(v_rec_no,8,'0');
        End if;
    
          insert into cir_rcphdr(comp_code,unit_code,agcd,dpcd,doctype,
                                 recptno,recptdt,amount,reason,remark,
                                 achd,voucherno,voucherdt,userid,creation_date,branch_code)
                          values(v2.comp_code, v2.unit_code,v2.bilagcd, v2.bildpcd,v2.doctype,
                                 v_recptno,v2.recptdt,v_amt,nvl(preason,'SUPPLIMENT CHARGES'),v_remark,
                                 'NM',v_recptno,v2.recptdt,puserid,sysdate,v_bran_code);
          insert into cir_rcpdet(comp_code,unit_code,agcd,dpcd,doctyp,
                                 recptno,recptdt,payfor,achd,amount,
                                 reason,remark,voucherno,voucherdt,usrid,
                                 creation_date,branch_code)
                          values(v2.comp_code, v2.unit_code,v2.bilagcd, v2.bildpcd,v2.doctype,
                                 v_recptno,v2.recptdt,v2.unit_code,'NM',v_amt,
                                 nvl(preason,'SUPPLIMENT CHARGES'),v_remark,v_recptno,v2.recptdt,puserid,
                                 sysdate,v_bran_code);
          insert into cir_outmast(comp_code,unit_code,agcd,dpcd,doctyp,
                                  recptno,recptdt,achd,amount,reason,
                                  remark,voucherno,voucherdt,usrid,creation_date,branch_code)
                           values(v2.comp_code, v2.unit_code,v2.bilagcd, v2.bildpcd,v2.doctype,
                                  v_recptno,v2.recptdt,'NM',v_amt,nvl(preason,'SUPPLIMENT CHARGES'),
                                  v_remark,v_recptno,v2.recptdt,puserid,sysdate,v_bran_code);                               
        
          update cir_supl_process_det set recptno=v_recptno
            where comp_code=v2.comp_code and unit_code=v2.unit_code and doctype=v2.doctype and recptno=v_sess_id and 
                  recptdt=v2.recptdt and supdate >= v_frdt and supdate <= v_todt and bilagcd = v2.bilagcd and bildpcd = v2.bildpcd;
                  
   end loop;
   close c2;
    DELETE from cir_supl_process_det_temp where comp_code=pcompcode and unit_code=punitcode and 
            bilagcd=pagcode and bildpcd= pdepocode and recptno=precptno and recptdt=v_recptdt;
   commit;
            
   open P_Accounts for
   select sysdate from dual;
   
   delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
   delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
  End cir_suppliment_cn_process_p;
/


//=====================================issue No--5582 17/11/2011======================================

//=============================================body============================================================

CREATE OR REPLACE PACKAGE BODY .cir_rep_billing IS
  procedure cir_billing_agency_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

        open p_accounts for
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              ((upper(a.ag_name) like upper(pextra1)||'%') or (pextra1 is null))
        union
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              upper(a.agcd) = upper(pextra1)
        order by ag_name,city_name;

    End cir_billing_agency_list_p;

    procedure cir_billno_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pbillagcd         in varchar2,
      pbilldpcd         in varchar2,
      pbill_freq        in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
      v_bill_frdt date;
      v_bill_todt date;
    Begin
      v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
      v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
      
      open p_accounts for
        select min(billno) MIN_BILLNO,max(billno) MAX_BILLNO from cir_bill_det
            where comp_code=pcomp_code and unit_code=punit_code and billdt >= v_bill_frdt and billdt<=v_bill_todt and
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and publ=nvl(ppubl,publ) and bill_flag=nvl(pbill_freq,bill_flag);
            
    End cir_billno_list_p;
 /*
set serveroutput on;
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
var v7 refcursor;
var v8 refcursor;
var v9 refcursor;
var v10 refcursor;
var v11 refcursor;
var v12 refcursor;
var v13 refcursor;
exec cir_rep_billing.cir_bill_print_punya('SP002','AUR','','M','01-jul-2011','31-jul-2011','AUR1107114','AUR1107114','L0012','0001','','','','','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11,:v12,:v13);
--*/

  procedure cir_bill_print_punya(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pbranchcode     in varchar2,
      pdistcode       in varchar2,  
      ptalukacode     in varchar2,
      pcitycode       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,
      pextra2         in varchar2,
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12    out t_accounts)
    As
      v_bill_frdt     date;
      v_bill_todt     date;
      v_dt            date;
      v_query1        varchar2(32000);
      v_query2        varchar2(32000);
    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ,*/a.agcd agcd,a.dpcd dpcd,a.billno billno,a.billdt billdt,
        min(a.bill_frdt) frdt,max(a.bill_todt) todt,nvl(sum(bill_sec_amt),0) bill_sec_amt  
        from cir_bill a,cir_agmast b
                where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                    a.agcd=b.agcd and a.dpcd=b.dpcd and ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                    /*((a.publ=ppubl) or (ppubl is null)) and*/ a.agcd=nvl(pbillagcd,a.agcd) and
                    a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                    (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                    (b.city_code =pcitycode or pcitycode is null) and a.bill_flag=pbill_freq and nvl(a.bill_copy,0)>0 
            group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,a.billno,a.billdt
            order by comp_code,unit_code,/*publ,*/billdt,billno,agcd,dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_det is
        select distinct publ,edtn from cir_bill_det
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and billdt=rec_bill.billdt and billno=rec_bill.billno and
              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd
        union
        select distinct publ,edtn
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and 
              recptdt>=v_bill_frdt and recptdt<=v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
              order by publ,edtn;
rec_det cur_det%rowtype;
              
    cursor cur_dbksup is
        select comp_code,unit_code,publ,edtn,supdate,copy_rate,
        sum(supply_copy) supply_copy from(select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup_resale d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        0 supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        minus
        select comp_code comp_code,unit_code unit_code,publ publ,edtn edtn,recptdt supdate,copy_rate copy_rate,
        0 supply_copy
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate))
    group by comp_code,unit_code,publ,edtn,supdate,copy_rate
    order by comp_code,unit_code,publ,edtn,supdate;
rec_dbksup cur_dbksup%rowtype;

    cursor cur_unsold is
        select comp_code,unit_code,publ,edtn,recptdt,copy_rate,sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) return_copy
        from cir_unsold_dtl
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate
    order by comp_code,unit_code,recptdt,publ,edtn,copy_rate;
rec_unsold cur_unsold%rowtype;

      cursor cur_publ_edtn is
            select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_bill_det a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
        ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null)
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_unsold_dtl a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null) and
        (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0
        order by comp_code,unit_code,publ_code,edtn;

        v1 cur_publ_edtn%rowtype;

        v_edtn_cnt        number(5):=0;
        vvar              varchar2(8000);
        vvar_name         varchar2(8000);
        vvar1             varchar2(8000);
        vvar2             varchar2(8000);
        vvar3             varchar2(8000);
        vvar33            varchar2(8000);
        vvar4             varchar2(8000);
        vvar5             varchar2(8000);
        vvar6             varchar2(8000);
        vvar7             varchar2(8000);
        vvar8             varchar2(8000);
        vvar11            varchar2(8000);
        sum_vvar          varchar2(8000);
        sum_vvar1         varchar2(8000);
        sum_vvar2         varchar2(8000);
        sum_vvar3         varchar2(8000);
        sum_vvar33        varchar2(8000);
        sum_vvar4         varchar2(8000);
        sum_vvar5         varchar2(8000);
        sum_vvar6         varchar2(8000);
        sum_vvar7         varchar2(8000);
        sum_vvar8         varchar2(8000);
        sum_vvar11        varchar2(8000);
        vtot_publ         varchar2(8000);
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_sec_opbal        number(14,2):=0;
        v_sec_pbal       number(14,2):=0;
        v_sec_rcpt        number(14,2):=0;
        v_sec_dn          number(14,2):=0;
    cursor cur_exist_edtn is
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.billno billno,a.billdt billdt,a.edtn edtn 
        from cir_bill_det a,cir_agmast b
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                a.agcd=b.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                (b.city_code =pcitycode or pcitycode is null) and 
                nvl(a.bill_copy,0)>0 and a.bill_flag=pbill_freq 
         union
        select distinct a.comp_code comp_code,a.unit_code unit_code,c.billno billno,c.billdt billdt,a.edtn edtn 
        from cir_unsold_dtl a,cir_agmast b,cir_bill c
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and
            a.unit_code=c.unit_code and 
            a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and c.billdt >= v_bill_frdt and c.billdt<=v_bill_todt and
            ((c.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
            a.agcd=b.agcd and a.agcd=c.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=c.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
            (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
            (b.city_code =pcitycode or pcitycode is null) and 
            (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0 and 
            c.bill_flag=pbill_freq         
            order by comp_code,unit_code,billdt,billno;
    rec_exist_edtn cur_exist_edtn%rowtype;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date

        --delete from test1;commit;

        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        
        Open cur_bill;---main cursor bill
        Loop
          fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
              end if;
            open cur_det;
            loop
                fetch cur_det into rec_det;
                exit when cur_det%notfound;
                
                Open cur_dbksup;
                fetch cur_dbksup into rec_dbksup;
                if cur_dbksup%notfound then

                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select max(comm_rate) comm_rate,max(sur_rate) sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt between v_bill_frdt and v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and  
                              publ=rec_det.publ and edtn=rec_det.edtn;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    v_gross_amt   :=0;
                    v_comm_amt    :=0;
                    v_sur_amt     :=0;

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 v_dt,0,0,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                else
                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select comm_rate,sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt >= v_bill_frdt and billdt<=v_bill_todt and billdt=rec_bill.billno and
                              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                              publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and
                              rec_dbksup.supdate >= fromdt and rec_dbksup.supdate<=todt;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    
                        v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                        v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*(v_comm_rate/100)),2),0);
                        v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);
                    

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                end if;
            Close cur_dbksup;
            
            
            Open cur_unsold;
            loop
                fetch cur_unsold into rec_unsold;
                exit when cur_unsold%notfound;
                
                    insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_unsold.recptdt,rec_unsold.return_copy,rec_unsold.copy_rate,0,0,0,0,0,
                                 userenv('sessionid'));
                                 
                                 v_return_copy:=nvl(v_return_copy,0)+nvl(rec_unsold.return_copy,0);
                                 
                                 rec_unsold.recptdt:=null;rec_unsold.return_copy:=null;rec_unsold.copy_rate:=null;
                    

                    
            end loop;
            Close cur_unsold;
            if nvl(v_return_copy,0)=0 then
                insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                             v_dt,0,0,0,0,0,0,0,
                             userenv('sessionid'));     
                    
            end if;
            v_return_copy:=0;v_return_amt:=0;            
            
            End loop;
            close cur_det;
            
        v_dt:=v_dt+1;
        End Loop;--close loop for date

            v_opbal     :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_dbcramt from
            (select sum(amount) amount from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctyp='BIL' and 
                    billdt>= v_opdate and billdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd 
            union all
            select sum(amount) amount from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctype<>'BIL' and 
                    recptdt>= v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd);

            select sum(amount) into v_dbamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount>0;

            select sum(amount) into v_cramt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype not in('RCR','UCN') and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount<0;

            select sum(amount) into v_recamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='RCR' and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            select sum(amount) into v_sec_pbal from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and 
                recptdt>=v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_sec_pbal:=nvl(v_sec_pbal,0)+nvl(v_sec_opbal,0);
            
            select sum(amount) into v_sec_rcpt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype<>'DN' and 
                recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
                      
            select sum(amount) into v_sec_dn from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype='DN' and
                      recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_dbamt:=nvl(v_dbamt,0)-nvl(rec_bill.bill_sec_amt,0);

            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,
            bill_amt,return_amt,country_code)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal,
            nvl(v_sec_rcpt,0),nvl(v_sec_pbal,0),v_sec_dn);
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));        
        End Loop;
        Close cur_bill;
        --delete from test1;delete searchtbl;commit;
    open cur_publ_edtn;
    loop
        fetch cur_publ_edtn into v1;
      exit when cur_publ_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
        if vvar is null then
            vvar        :='decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :='nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :='nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            --sum_vvar33   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :='nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :='nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :='decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :='nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :='nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :='nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :='sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :='"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN IF ',sum_vvar3);commit;
          else
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :=vvar_name||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :=vvar1||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :=sum_vvar1||',nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :=vvar2||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy*u.supply_rate))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :=sum_vvar2||',nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :=vvar3||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33      :=vvar33||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            --sum_vvar33  :=sum_vvar33||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :=vvar4||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :=sum_vvar4||',nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :=vvar5||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :=sum_vvar5||',nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :=vvar6||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :=vvar6||',decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :=sum_vvar6||',nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :=vvar7||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :=sum_vvar7||',nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :=vvar8||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :=sum_vvar8||',nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            --vvar    :=vvar||',decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_Supply"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :=vvar1||',sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :=vtot_publ||',"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN ELSE ',sum_vvar3);commit;
          end if;
          v_edtn_cnt:=nvl(v_edtn_cnt,0)+1;
            
          insert into cir_temp_suppliment(comp_code,unit_code,seq_no,edition_code,sess_id)
          values(v1.comp_code,v1.unit_code,v_edtn_cnt,v1.edtn,userenv('sessionid'));
           
        end loop;
        close cur_publ_edtn;
        
        open cur_exist_edtn;
        loop
            fetch cur_exist_edtn into rec_exist_edtn;
            exit when cur_exist_edtn%notfound;

            --select seq_no into v_exist_edtn from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            --edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid');  
            
            update cir_temp_bill_collection set remarks=remarks||'#'||(select seq_no from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid'))
            where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and billno=rec_exist_edtn.billno and billdt=rec_exist_edtn.billdt and
                  cur_sessionid=userenv('sessionid');
        end loop;
        close cur_exist_edtn;
        update cir_temp_bill_collection set remarks=substr(remarks,2,length(remarks)) where cur_sessionid=userenv('sessionid');        
        --COMMIT;
        
        --insert into test1(vstring,vstring2) values(' billing var3 ',vvar3);commit;
       
        --insert into searchtbl(search) values(' billing first '||pcomp_code||' , '||punit_code||' , '||pbill_freq||' , '||pfrom_billno||' , '||ptill_billno||' , '||v_bill_frdt||' , '||v_bill_todt||' , '||pbillagcd||' , '||pbilldpcd||' , '||ppubl );commit;
        open p_accounts  for
        select z.comp_code comp_code,z.unit_code unit_code,z.agcd agcd,z.dpcd dpcd,z.ag_name ag_name,z.ag_name_oth_lang ag_name_oth_lang,
        z.addr1 addr1,z.addr2 addr2,z.addr3 addr3,z.city_name city_name,
        initcap(z.taluka_name) taluka_name,initcap(z.dist_name) dist_name,
        z.state_name state_name,z.pin_code pin_code,z.billno billno,z.billdt billdt,
        z.bill_copy bill_copy,z.gross_amount gross_amount,
        z.sur_amount sur_amount,z.comm_amount comm_amount,z.bill_amount bill_amount,z.bill_sec_amt bill_sec_amt,
        z.edtn_remark edtn_remark,z.return_amt return_amt,
        (select name from cir_ag_con_per where comp_code=z.comp_code and unit=z.unit_code and agcd=z.agcd and dpcd=z.dpcd and rownum<2) contact_person_name
        from(select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,
        cir_get_taluka(b.comp_code,a.tehsil_taluka) taluka_name,cir_get_dist(b.comp_code,a.state_code,a.dist_code) dist_name,
        cir_get_state(b.comp_code,a.country_code,a.state_code) state_name,a.pin_code pin_code,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,sum(b.bill_sec_amt) bill_sec_amt,
        min(c.remarks) edtn_remark,(select nvl(sum(d.copy_amt),0) return_amt from cir_unsold_dtl d 
        where b.comp_code=d.comp_code and b.unit_code=d.unit_code and d.doctype='UCN' and d.recptdt >= v_bill_frdt and d.recptdt<=v_bill_todt and
        b.agcd=d.agcd and b.dpcd=d.dpcd and (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0) return_amt        
        --,bill_frdt,bill_todt,bill_flag,bill_remark
        from cir_agmast a,cir_bill b,cir_temp_bill_collection c
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit=b.unit_code and a.unit=c.unit_code and 
        b.unit_code=punit_code and b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and  
        b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        /*((b.publ=ppubl) or (ppubl is null)) and */a.agcd=b.agcd and a.dpcd=b.dpcd and b.branch_code=nvl(pbranchcode,b.branch_code) and 
        (a.dist_code =pdistcode or pdistcode is null) and (a.tehsil_taluka =ptalukacode or ptalukacode is null) and 
        (a.city_code =pcitycode or pcitycode is null) and b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and 
        c.billno=b.billno and c.billdt=b.billdt and c.cur_sessionid=userenv('sessionid')
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,
        a.city_code,a.tehsil_taluka,a.dist_code,a.country_code,a.state_code,a.pin_code,b.billno,b.billdt) z
        order by z.comp_code,z.unit_code,z.billdt,z.billno,z.agcd,z.dpcd;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day,'||sum_vvar||' from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,to_char(supply_date,''dd'') sup_day ,'||vvar||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts1'||v_query1);commit;

        open p_accounts1 for v_query1;
                
        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar1||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar1||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts2  '||v_query1);commit;

        open p_accounts2 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar2||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar2||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts3  '||v_query1);commit;

        open p_accounts3 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO,'||sum_vvar3||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,SRLNO,'||vvar3||','||vvar33||'
        from (select comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate, sum(return_copy) return_copy ,
        ROW_NUMBER( ) OVER (PARTITION BY
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code ORDER BY 
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code) SRLNO
        from cir_bill_return_print 
        where comp_code='||''''||pcomp_code||''''||' and unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate) u
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,SRLNO)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts4 ',v_query1);commit;
        open p_accounts4 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar4||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar4||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts5',v_query1);commit;

        open p_accounts5 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar5||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar5||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts6',v_query1);commit;

        open p_accounts6 for v_query1;

        v_query1:='select comp_code,unit,billno,billdt,agcd,dpcd,'||sum_vvar6||' 
        from (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.publ publ,u.edtn edtn,u.agcd agcd,u.dpcd dpcd,'||vvar6||'
        from cir_bill_det u,cir_agmast m
        where u.comp_code='||''''||pcomp_code||''''||' and u.comp_code=m.comp_code and u.unit_code=m.unit and u.unit_code='||''''||punit_code ||''''||' and u.billdt >='||''''||v_bill_frdt||''''||' and u.billdt <='||''''||v_bill_todt||''''||' and ((billno between '||''''||pfrom_billno||''''||' and '||''''||ptill_billno||''''||') or ('||''''||pfrom_billno||''''||' is null)) and
        u.agcd=m.agcd and u.agcd=nvl('||''''||pbillagcd||''''||',u.agcd) and u.dpcd=nvl('||''''||pbilldpcd||''''||',u.dpcd) and 
        u.bill_flag='||''''||pbill_freq||''''||' and u.branch_code=nvl('||''''||pbranchcode||''''||',u.branch_code) and (m.dist_code ='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka ='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and (m.city_code ='||''''||pcitycode||''''||' or '||''''||pcitycode||''''||'is null)
        group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts7',v_query1);commit;
        open p_accounts7 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar7||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar7||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts8',v_query1);commit;
        open p_accounts8 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar8||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar8||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts9',v_query1);commit;

        open p_accounts9 for v_query1;

        open p_accounts10 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance",
        nvl(return_amt,0) as "Deposit Previous Balance",nvl(bill_amt,0) as "Cuurent Deposit",to_number(country_code) as "Deposit Debit Amt",
        abs(nvl(return_amt,0)+nvl(bill_amt,0)+nvl(to_number(country_code),0)) as "Deposit Balance"
        from cir_temp_outstanding
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts11 for 
        select distinct h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
        h.agcd agcd,h.dpcd dpcd,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        m.billno billno,m.billdt billdt, h.remark remark 
        from cir_rcphdr h,cir_bill_print m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=punit_code  and h.unit_code=m.unit_code and 
        h.doctype in('CN','DN') and h.recptdt >=v_bill_frdt and h.recptdt<=v_bill_todt and h.achd='NM' and h.amount<>0 and
        h.agcd=m.agcd and h.dpcd=m.dpcd and h.reason!='SEC DEBIT' and cur_sessionid=userenv('sessionid') 
        order by m.billdt,m.billno,agcd,dpcd,h.recptdt,recptno;
        
        open p_accounts12 for select sysdate from dual;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');commit;
        --delete from cir_temp_outstanding; commit;
                
    End cir_bill_print_punya;


  procedure cir_bill_print_bhaskar(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,--for Agency Class
      pextra2         in varchar2,--for Agency Type
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12     out t_accounts)
    As
      v_bill_frdt         date;
      v_bill_todt         date;
          v_dt            date;
         v_query1        varchar2(8000);
      v_query2        varchar2(8000);
    cursor cur_bill is
        select distinct b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt,min(b.bill_frdt) frdt,max(b.bill_todt) todt from cir_bill b,cir_agmast m
                where b.comp_code=m.comp_code and b.comp_code=pcomp_code and b.unit_code=nvl(punit_code,b.unit_code) and b.unit_code=m.unit and 
                b.billdt between v_bill_frdt and v_bill_todt and
                b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                            b.publ=nvl(ppubl,b.publ) and b.agcd=nvl(pbillagcd,b.agcd) and b.agcd=m.agcd and
                            b.dpcd=nvl(pbilldpcd,b.dpcd) and b.dpcd=m.dpcd and (m.ag_class=pextra1 or pextra1 is null) and
                            (m.ag_type=pextra2 or pextra2 is null) 
            group by b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt
            order by b.comp_code,b.unit_code,b.publ,b.billdt,b.billno,b.agcd,b.dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_dbksup is
        select d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate copy_rate,d.comm_fix_auto_spl,d.comm_code,sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast s
        where d.comp_code=s.comp_code and d.comp_code=rec_bill.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_bill.publ and
              d.supdate=v_dt and d.billagcd=rec_bill.agcd and d.billdpcd=rec_bill.dpcd and
              d.sup_type_code=s.sup_ty_code and upper(s.bill_pay)='Y'
    group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code
    order by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate;
rec_dbksup cur_dbksup%rowtype;

      cursor cur_publ_edtn is
            select distinct comp_code,unit_code,publ_code,cir_get_publ_name(comp_code,publ_code) publ_name,edtn_code edtn,cir_get_edtn_name(comp_code,edtn_code) edtn_name
            from cir_bill_print
        where cur_sessionid=userenv('sessionid') and comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
                    ((publ_code=ppubl) or (ppubl is null)) and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbillagcd or pbillagcd is null)
        order by comp_code,unit_code,publ_code,edtn_code;

        v1 cur_publ_edtn%rowtype;
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date
        --delete from test1;commit;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
            end if;

            Open cur_dbksup;
                Loop
              fetch cur_dbksup into rec_dbksup;
              exit when cur_dbksup%notfound;

                select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0 return_amt into v_return_copy,v_return_amt
                from cir_unsold_dtl
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                      recptdt=rec_dbksup.supdate and publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and agcd=rec_bill.agcd and
                      dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;

                v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                v_comm_rate   :=0;
                v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*v_comm_rate),2),0);
                v_sur_rate    :=0;
                v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);

                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           return_copy,return_amt,cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                             rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                             v_return_copy,v_return_amt,userenv('sessionid'));
               End loop;
            Close cur_dbksup;

            v_dt:=v_dt+1;
            End Loop;--close loop for date
            v_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,'','')+
                      cir_accounts.cir_agency_ytodt(rec_bill.comp_code,rec_bill.unit_code,NULL,rec_bill.agcd,rec_bill.dpcd,v_opdate,rec_bill.frdt,'NM',pdateformat,'','');

            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and billdt >= rec_bill.frdt and billdt<=rec_bill.todt/* and
                      publ=rec_bill.publ*/;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                            agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.todt and
                            doctyp<>'BIL' and achd='NM' /*and publ=rec_bill.publ*/;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp='RCR' and achd='NM' /*and publ=rec_bill.publ*/;

            v_opbal:=nvl(v_opbal,0)+NVL(V_recamt,0);--nvl(v_billamt,0)+nvl(v_dbcramt,0);

            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',/*rec_bill.publ,*/
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal);
        
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));
            v_opbal:=0;v_billamt:=0;v_dbcramt:=0;v_dbamt:=0;v_cramt:=0;v_recamt:=0;            
        End Loop;
        Close cur_bill;
     --delete from test1;commit;

      --insert into test1(vstring,vstring2) values(' billing ',vvar);commit;

        open p_accounts  for
        select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,
        (select max(d.comm_rate) from cir_bill_det d where d.comp_code=b.comp_code and d.unit_code=b.unit_code and d.agcd=b.agcd and 
        d.dpcd=b.dpcd and d.billno=b.billno and d.billdt=b.billdt) comm_rate   
        --,bill_frdt,bill_todt,bill_flag,bill_remark
                    from cir_agmast a,cir_bill b
        where a.comp_code=pcomp_code and a.unit=b.unit_code and b.unit_code=nvl(punit_code,b.unit_code) and b.billdt between v_bill_frdt and v_bill_todt and
                    b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    b.publ=nvl(ppubl,b.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and (a.ag_class=pextra1 or pextra1 is null) and
                            (a.ag_type=pextra2 or pextra2 is null) 
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,a.city_code,b.billno,b.billdt
        order by b.comp_code,b.unit_code,b.billdt,b.billno,b.agcd,b.dpcd;

        open p_accounts1 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate copy_rate,sum(supply_copy) supply from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,u.supply_rate supply_rate,sum(u.supply_copy) supply_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt,u.supply_rate)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd;

        open p_accounts2 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(supply_copy) tot_supply,sum(gross) gross_amt,sum(return_copy) return_copy,sum(return_amt) return_amt,
        sum(tot_amt) tot_amt,sum(tot_comm) tot_comm ,sum(tot_surcharge) tot_surcharge,sum(net_amt) net_amt
        from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.supply_copy) supply_copy,
        sum(u.gross_amt) gross,sum(u.return_copy) return_copy,sum(u.return_amt) return_amt,sum(u.gross_amt-u.return_amt) tot_amt,sum(u.comm_amt) tot_comm,
        sum(u.sur_amt) tot_surcharge,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts3 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(gross) gross_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt) gross
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts4 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_copy) return_copy from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_copy) return_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts5 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_amt) return_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_amt) return_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts6 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_amt) tot_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt) tot_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts7 for 
        select comp_code,unit,billno,billdt,agcd,dpcd,sum(tot_comm) tot_comm from 
        (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.comm_amt) tot_comm
        from cir_bill_det u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd;

        open p_accounts8 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_surcharge) tot_surcharge from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.sur_amt) tot_surcharge
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts9 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(net_amt) net_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts10 for 
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance"
        from cir_temp_outstanding
        where comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
        dt between v_bill_frdt and v_bill_todt;
        
        open p_accounts11 for
        select comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate,sum(bill_copy) bill_copy,sum(nvl(copy_rate,0)*nvl(bill_copy,0)) gross_amt 
        from cir_bill_det 
        where comp_code=pcomp_code and unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and 
        ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
         group by comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate
         order by comp_code,unit_code,billdt,billno,agcd,dpcd;
         
        open p_accounts12 for
        select distinct b.comp_code comp_code,b.unit_code unit_code,b.billno billno,b.billdt billdt,b.agcd agcd,b.dpcd dpcd,
        (select nvl(sum(a.sup_copy),0) from cir_dbksup a,cir_supply_type_mast s 
        where b.comp_code=a.comp_code and s.comp_code=a.comp_code and a.unit_code=b.unit_code and b.publ=a.publ and
        a.edtn =b.edtn and a.sup_type_code=s.sup_ty_code and s.bill_pay='N' and 
        a.supdate between v_bill_frdt and v_bill_todt and --between b.fromdt and  b.todt and 
        a.billagcd =b.agcd and a.billdpcd=b.dpcd) unpaid_copy
        from cir_bill_det b
        where b.comp_code=pcomp_code and b.unit_code=punit_code and 
        (b.publ=ppubl or ppubl is null) and
        (b.agcd=pbillagcd or pbillagcd is null) and (b.dpcd=pbilldpcd or pbilldpcd is null) and
        b.billdt between trunc(v_bill_frdt,'MM') and v_bill_todt
        order by b.comp_code,b.unit_code,b.billno,b.billdt,b.agcd,b.dpcd;

    End cir_bill_print_bhaskar;
    
  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt  date;
    v_todt  date;
    v_start_date    date;
        cursor cur_not_supply is
            select distinct u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date>= v_start_date  and d.supply_date<=v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;        
                
    rec_agcd cur_agcd%rowtype;

        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;

   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
    if v_frdt=v_start_date then
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;
    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;
        --insert into test1(vstring,vstring2) values('Weekly bill1 ',rec_not_supply.agcd||rec_not_supply.dpcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;    

    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            --insert into test1(vstring,vstring2) values('Weekly bill1 ',v_opbal||' , '||rec_agcd.billagcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and
                      agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and billdt >= v_opdate and billdt<v_frdt;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            --insert into test1(vstring,vstring2) values('Weekly bill ',v_opbal||' , '||rec_agcd.billagcd);
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,abs(v_recamt),v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;
        
     open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",
        sum(nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)) as "TOTAL_COPY",sum(nvl(p01,0)*nvl(sup_rate,0)+nvl(p02,0)*nvl(sup_rate,0)+nvl(p03,0)*nvl(sup_rate,0)+nvl(p04,0)*nvl(sup_rate,0)+nvl(p05,0)*nvl(sup_rate,0)+nvl(p06,0)*nvl(sup_rate,0)+nvl(p07,0)*nvl(sup_rate,0)) as "TOTAL_AMT",
        sum(daily_return) as "DAILY_RETURN",sum(sun_return) as "SUN_RETURN"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        d.supply_rate sup_rate,d.comm_rate,
        case when to_char(d.supply_date,'d')='1' then SUM(return_copy) else 0  end sun_return,
        case when to_char(d.supply_date,'d')<>'1' then SUM(return_copy) else 0 end daily_return  
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate,d.comm_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,publ,edtn;
    
    open p_accounts1 for
    select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
    dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
    return_amt as "Deposit Balance"
    from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
    in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')) 
    order by comp_code,unit_code,agname;    

    open p_accounts2 for 
    select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
    h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
    case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
    else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
    h.remark remark 
    from cir_rcphdr h,cir_agmast m
    where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and 
    h.doctype in('CN','DN') and h.recptdt >=v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
    h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
    (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
    (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
    (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
    order by m.ag_name,h.recptdt,h.recptno;
    
    open p_accounts3 for 
    select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
    sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
    where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and 
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')
    group by comp_code,unit_code,agcd,dpcd
    order by comp_code,unit_code,agency_name,agcd,dpcd;

    open p_accounts4 for select sysdate from dual;

    open p_accounts5 for select sysdate from dual;
    open p_accounts6 for select sysdate from dual;
    open p_accounts7 for select sysdate from dual;
    open p_accounts8 for select sysdate from dual;
    open p_accounts9 for select sysdate from dual;
    
    open p_accounts10 for select sysdate from dual;
    
    --delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
    --delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 error ');commit;
    
    
   End cir_before_bill_print_p1;

/*
  set serveroutput on;
  var v1 refcursor;
  var v2 refcursor;
  var v3 refcursor;
  var v4 refcursor;
  var v5 refcursor;
  var v6 refcursor;
  var v7 refcursor;
  var v8 refcursor;
  var v9 refcursor;
  var v10 refcursor;
  var v11 refcursor;
  exec cir_rep_billing.cir_before_bill_print_p2('SP002','AUR','','','','','','','','B0052','0001','01-nov-2010','07-nov-2010','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11);
  */
  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt          date;
    v_todt          date;
    v_start_date    date;
    
    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
        
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date between v_start_date and v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        d.cur_sessionid=userenv('sessionid') and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;       
    rec_agcd cur_agcd%rowtype;
    
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;   
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;
   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p2 ', pbillagcd||pbilldpcd);commit; 
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
        
    if v_frdt=v_start_date then
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;
    
    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code  and billdt >= v_opdate and 
                billdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,v_recamt,v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;    
        
        open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,
        cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",sum(gross_amt) as "TOTAL_AMT",
        sum(u01) as "SUN_RET",sum(u02) as "MON_RET",sum(u03) as "TUE_RET",sum(u04) as "WED_RET",sum(u05) as "THU_RET",sum(u06) as "FRI_RET",sum(u07) as "SAT_RET",sum(return_gross_amt) as "RETURN_TOTAL_AMT"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,d.supply_rate sup_rate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        sum(nvl(d.supply_copy,0)*nvl(d.supply_rate,0)) gross_amt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.return_copy,0)) else 0 end u01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.return_copy,0)) else 0 end u02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.return_copy,0)) else 0 end u03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.return_copy,0)) else 0 end u04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.return_copy,0)) else 0 end u05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.return_copy,0)) else 0 end u06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.return_copy,0)) else 0 end u07,        
        sum(nvl(d.return_copy,0)*nvl(d.supply_rate,0)) return_gross_amt
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date <=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,billagcd,billdpcd,publ,edtn;
    
        open p_accounts1 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
        return_amt as "Deposit Balance"
        from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
        in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
        supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid'))
        order by comp_code,unit_code,agname,agcd,dpcd;    

        open p_accounts2 for 
        select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        h.remark remark 
        from cir_rcphdr h,cir_agmast m
        where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and h.recptdt >= v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
        h.doctype in('CN','DN') and h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
        (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
        (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
        order by m.ag_name,h.agcd,h.dpcd,h.recptdt,h.recptno;
    
        open p_accounts3 for 
        select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
        where comp_code=pcompcode and unit_code=punitcode and supply_date >= v_frdt and supply_date<=v_todt and 
        agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid')
        group by comp_code,unit_code,agcd,dpcd
        order by comp_code,unit_code,agency_name,agcd,dpcd;
        
        open p_accounts4 for 
        select comp_code,unit_code,billagcd,billdpcd,agency_name,
        abs(sum(p01)) as "SUN",abs(sum(p02)) as "MON",abs(sum(p03)) as "TUE",abs(sum(p04)) as "WED",abs(sum(p05)) as "THU",abs(sum(p06)) as "FRI",abs(sum(p07)) as "SAT",
        abs(sum(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0))) as "TOT_RECEIPT_AMT"
        from(
        select d.comp_code comp_code,d.unit_code unit_code,d.agcd billagcd,d.dpcd billdpcd,case when plangtype='1' then m.ag_name else m.ag_name_oth_lang  end agency_name,d.supply_date recptdt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.rec_amt,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.rec_amt,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.rec_amt,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.rec_amt,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.rec_amt,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.rec_amt,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.rec_amt,0)) else 0 end p07
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and cur_sessionid=userenv('sessionid') 
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.supply_date)
        group by comp_code,unit_code,billagcd,billdpcd,agency_name
        order by comp_code,unit_code,agency_name,billagcd,billdpcd;

        open p_accounts5 for select sysdate from dual;
        open p_accounts6 for select sysdate from dual;
        open p_accounts7 for select sysdate from dual;
        open p_accounts8 for select sysdate from dual;
        open p_accounts9 for select sysdate from dual;
        open p_accounts10 for select sysdate from dual;
            
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;

    insert into ERRORMESSAGE(message) values('Weekly bill print p2 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p2 error ');commit;        
   End cir_before_bill_print_p2;
       
    procedure cir_bill_register_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      ppubl         in varchar2,
      repty         in varchar2,--Is is used State(1)/District(2)/Taluka(3)
      pbill_freq    in varchar2,
      pfrom_billdt  in varchar2,
      ptill_billdt  in varchar2,
      pbillagcd     in varchar2,
      pbilldpcd     in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,--State or district or Taluka Code
      pextra2       in varchar2,
      p_accounts    out t_accounts)
    As
        vfrdt date;
        vtodt date;
        v_statecode   varchar2(20);
        v_distcode    varchar2(20);
        v_citycode    varchar2(20);
        v_taluka      varchar2(20);        
    Begin
        --delete from test1;insert into test1(vstring,vstring2) values('cir bill register ','pcomp_code '||pcomp_code||','||punit_code||','||ppubl||','||repty||','||pbill_freq||','||pfrom_billdt||','||ptill_billdt||','||pbillagcd||','||pbilldpcd||','||pdateformat||','||pextra1||','||pextra2);commit;
        if repty='1' then--State
            v_statecode:=pextra1;
        elsif repty='2' then    --District
            v_distcode:=pextra1;
        elsif repty='3' then    --Taluka
            v_taluka:=pextra1;
        else--City
            v_citycode:=pextra1;
        end if;        
        vfrdt:=to_date(pfrom_billdt,''''||pdateformat||'''');
        vtodt:=to_date(ptill_billdt,''''||pdateformat||'''');

        if nvl(repty,'N')='1' then--for state
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,agency_name,billdt,billno;
        elsif nvl(repty,'N')='2' then --for district
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_dist(b.comp_code,m.state_code,m.dist_code) AS "DIST_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.dist_code
            order by comp_code, state_name,dist_name,agency_name,billdt,billno;        
        elsif nvl(repty,'N')='3' then---for taluka
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_taluka(b.comp_code,m.tehsil_taluka) as "TALUKA_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.tehsil_taluka
            order by comp_code, state_name,taluka_name,agency_name,billdt,billno;        
        else---for city
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,"CITY NAME",agency_name,billdt,billno;        
        end if;
        
     End cir_bill_register_p;

/*
var v1 refcursor;
exec cir_rep_billing.cir_billing_outstanding_p('SP002','AUR','','M','01-nov-2010','30-nov-2010','','','','dd/mm/yyyy','','',:v1);
*/
    procedure cir_billing_outstanding_p(
            pcomp_code      in varchar2,
            punit_code      in varchar2,
            repty           in varchar2,
            pbill_freq      in varchar2,
            pfrom_billdt    in varchar2,
            ptill_billdt    in varchar2,
            ppubl           in varchar2,
            pbillagcd       in varchar2,
            pbilldpcd       in varchar2,
            pdateformat     in varchar2,
            pbrancode       in varchar2,
            pdistcode       in varchar2,
            pagclass        in varchar2,
            pextra1         in varchar2,--for executive code
            pextra2         in varchar2,
            p_accounts      out t_accounts,
            p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);
      
    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ publ,*/a.agcd agcd,a.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        /*a.billno billno,a.billdt billdt,*/sum(a.bill_copy) supply_copy,sum(a.gross_amount) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        c.bill_sec_amt bill_sec_amt
        from cir_bill_det a,cir_agmast b,cir_bill c
            where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and 
                  a.unit_code=b.unit and a.unit_code=c.unit_code and
                  a.unit_code=nvl(punit_code,a.unit_code) and
                  a.billdt=c.billdt and a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and a.billno=c.billno and 
                  (a.bill_flag=pbill_freq or pbill_freq is null) and a.publ=nvl(ppubl,a.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                  a.agcd=c.agcd and a.dpcd=c.dpcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  (b.ag_class=pagclass or pagclass is null) and 
                  (b.state_code=v_statecode or v_statecode is null) and (b.dist_code=v_distcode or v_distcode is null) and 
                  (b.tehsil_taluka=v_taluka or v_taluka is null) and (b.branch_code=pbrancode or pbrancode is null) and
                  (b.city_code=v_citycode or v_citycode is null) and (b.executive_code = pextra1 or pextra1 is null)
                  group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka,c.bill_sec_amt/*,a.billno,a.billdt*/
                  order by a.comp_code,a.unit_code,/*a.billdt,a.billno,*/a.agcd,a.dpcd/*,a.publ*/;
        v1 cur_bill%rowtype;
      
      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_billno          varchar2(20);
        v_bildt           date;
        v_frdt            date;
        v_todt            date;
        v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_opdate          date;
        v_state_name      varchar2(200);
        v_dist_name       varchar2(200);
        v_taluka_name     varchar2(200);
        v_city_name       varchar2(200);
    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');
    
    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then    
        v_distcode:=pdistcode;
    elsif repty='C' then    
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;
    
    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit; 
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;
            
            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt into 
            v_ret_copy,v_ret_gross,v_ret_comm from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and process_crdt >= v_bill_frdt and process_crdt<=v_bill_todt and agcd=v1.agcd and 
                dpcd=v1.dpcd and process_crno is not null/*and publ=v1.publ*/;
            
            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_rcphdr
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and doctype<>'BIL' and recptdt>=v_opdate and recptdt<v_bill_frdt and achd='NM') ;
            
            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            
            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC';
            
            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                else
                    if v2.doctyp='RCR' then   
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;
            
            v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;           
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            /*v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
            begin
                v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
            exception when others then
                v_taluka_name   :='N/A';
            end;    
            v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);*/
                        
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd, 
            supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,        
            agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
               values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v1.country_code,v1.bill_sec_amt,v_sec_bal);
    
            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name:=null;v_dist_name:=null;v_taluka_name:=null;v_city_name:=null;
        End Loop;
        Close cur_bill;
        commit;
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0))  net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name;            
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name,ag_name;     

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,
            a.state_code state_name,
            sum(a.supply_copy) supply_code,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;
            
        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code,a.city_code
            order by comp_code,unit_code,state_name,district_name,city_name,ag_name;  
            
            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,a.comm_amt comm_amt,(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;   

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;            
        end if;
        
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    End cir_billing_outstanding_p;    

    procedure cir_unitwise_p(
        pcomp_code    in varchar2,
        punit_code    in varchar2,
        ppubl_code    in varchar2,
        pbill_freq    in varchar2,
        pfrom_billdt  in varchar2,
        ptill_billdt  in varchar2,
        pdateformat   in varchar2,
        pextra1       in varchar2,
        pextra2       in varchar2,
        p_accounts    out t_accounts) as
        vquery varchar2(4000);
        vquery_all varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
        cursor cur_mon is select distinct mon_date,to_char(mon_date,'Mon-YY') mon  from col_dates;
        rec_mon cur_mon%rowtype;
      Begin
        vquery:=null;
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        delete from col_dates;commit;
        insert into col_dates (mon_date) (select distinct trunc(billdt,'MM') from cir_bill
                                                where comp_code=pcomp_code and
                                                      ((unit_code=punit_code) or (punit_code is null)) and
                                                      ((publ     =ppubl_code) or (ppubl_code is null)) and
                                                      ((bill_flag=pbill_freq) or (pbill_freq is null)) and
                                                      billdt between v_bill_frdt and v_bill_todt);
         open cur_mon;
           loop
              fetch cur_mon into rec_mon;
                /*vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||',
                          to_date('||''''||rec_mon.mon_date||''''||','||''''||pdateformat||''''||'))'||'"'||rec_mon.mon||'",';*/
                exit when cur_mon%notfound;
                vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||','||''''||rec_mon.mon_date||''''||') "'||rec_mon.mon||'",';
           end loop;
         close cur_mon;
         vquery:=substr(vquery,1,length(vquery)-1);
         if vquery is null then
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name from cir_bill a,pub_cent_mast b
                    where a.comp_code=b."Comp_Code" and a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         else
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name,'||vquery||' from cir_bill a,pub_cent_mast b
                    where /*a.comp_code=b."Comp_Code" and */a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         end if;                                                         
          --insert into test1(vstring) values(vquery_all);commit;
          open p_accounts for vquery_all;
      End cir_unitwise_p;

      procedure cir_billing_rate_p (
        pcomp_code            in varchar2,
        punit_code            in varchar2,
        ppubl                 in varchar2,
        pagcd                 in varchar2,
        pdpcd                 in varchar2,
        BILLNO_FROM           in varchar2,
        BILLNO_TO             in varchar2,
        pfrom_billdt          in varchar2,
        ptill_billdt          in varchar2,
        pdateformat           in varchar2,
        pextra1               in varchar2,
        pextra2               in varchar2,
        p_accounts            out t_accounts,
        p_accounts1           out t_accounts,
        p_accounts2           out t_accounts,
        p_accounts3           out t_accounts)
    AS
        vquery   varchar2(4000);
        vquery1  varchar2(4000);
        vquery2  varchar2(4000);
        vquery3  varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

           open p_accounts for
           select comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy,(copy_rate*bill_copy) AS "TOTAL"
               from cir_bill_det
                where comp_code=pcomp_code and unit_code=punit_code
                and BILLDT  between v_bill_frdt and v_bill_todt
                and ((publ=ppubl ) or (ppubl is null))
                and ((agcd=pagcd) or (pagcd is null))
                and ((dpcd=pdpcd) or (pdpcd is null))
                group by comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy;

          vquery1 := vquery1||'SELECT SUM(a.SUP_COPY),a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd
                            from cir_dbksup a,cir_bill_det b
                            where a.COMP_CODE='''||pcomp_code||'''
                            and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                            and ((a.publ='''||ppubl||''' ) or ('''||ppubl||'''  is null))
                            and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||'''  is null))
                            and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||'''  is null))   AND
                            a.AGCD || a.DPCD =b.AGCD || b.DPCD  AND
                            a.UNIT_CODE=b.UNIT_CODE AND
                            b.COMP_CODE=a.COMP_CODE
                            AND (b.PUBL='''||ppubl||''' OR '''||ppubl||''' IS NULL)
                            and b.BILLDT  between '''||v_bill_frdt||''' and '''||v_bill_todt||'''
                            AND a.SUPDATE BETWEEN  b.FROMDT AND  b.TODT
                            AND a.EDTN =b.EDTN
                            and a.SUP_TYPE_CODE IN
                            (SELECT cir_supply_type_mast.SUP_TY_CODE FROM cir_supply_type_mast WHERE cir_supply_type_mast.BILL_PAY=''N''
                            AND cir_supply_type_mast.COMP_CODE=a.COMP_CODE AND a.SUP_TYPE_CODE=cir_supply_type_mast.SUP_TY_CODE )
                            group by a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd';
                        --   INSERT INTO SEARCHTBL VALUES(vquery1);COMMIT;
                        open p_accounts1 for
                       vquery1;

        vquery2 := vquery2||'SELECT SUM(a.AMOUNT) as "CREDIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                             from cir_outmast a
                             where a.COMP_CODE='''||PCOMP_CODE||'''
                             and( a.unit_code='''||punit_code||'''  or '''||punit_code||'''  IS NULL)
                             and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                             and ((a.publ='''||ppubl||''' ) or ('''||ppubl||''' is null))
                             and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||''' is null))
                             and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                             a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                             WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                           --AND b.PUBL=a.PUBL
                             AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                             and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                             a.DOCTYP in(''UCN'',''CN'') and a.achd<>''SC''
                             group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

                             open p_accounts2 for
                                  vquery2;

         vquery3 := vquery3||'SELECT SUM(a.AMOUNT) as "DEBIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO, a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                                from cir_outmast a
                                where a.COMP_CODE='''||PCOMP_CODE||'''
                                and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                                and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                                and ((a.publ='''||ppubl||'''  ) or ('''||ppubl||'''  is null))
                                and ((a.agcd='''||pagcd||'''  ) or ('''||pagcd||'''  is null))
                                and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                                a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                                WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                                --AND b.PUBL=a.PUBL
                                AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                                and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                                a.DOCTYP in(''DN'') and a.achd<>''SC''
                                group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

        open p_accounts3 for vquery3;

     End  cir_billing_rate_p;

  Procedure cir_before_bill_process_p(
    pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2)
  As
       ln_count           number;
       vsrch_amt           number;                                
       --bill_no               varchar2(20) ;
       daily_gross_amount number(15,2);
       daily_net_amount   number(15,2);
       tot_surcharge_amt  number(15,2);
       vcomm_per           number;
       vcomm_amt           number(15,2);
       curr_bilagcd           varchar2(30) := 'DUMMY_CURR';
       prev_bilagcd       varchar2(30) := 'DUMMY_PREV';
       curr_record           varchar2(100):= 'DUMMY_CURR'; --new add
       prev_record           varchar2(100):= 'DUMMY_PREV'; --new add
       tot_copy           number := 0;
       vbill_no            varchar2(20);
       vid                   number;
       v_frdt               date;
       v_todt               date;
       v_billdt           date;
        
       v_agcd_sec_per  number:=0;v_agcd_sec_amt_limt number:=0;
        
        v_sec_limit     number(10,2);
        v_bill_dbn_amt  number(10,2);
        v_bill_sec_amt  number(10,2);
        v_remark varchar2(200);
        v_reptno varchar2(25);
        v_rec_no            number(10);
        v_daily_comm_amt    number(15,2);
        v_daily_sur_amt     number(15,2);
        v_daily_gross_amt   number(15,2);
        v_daily_bill_amt    number(15,2);
        v_return_copy       number(10);
        v_return_amt        number(10,2);
      cursor agency_cur is
            /*select distinct m.comp_code comp_code,m.unit unit,m.agcd bill_agcd,m.dpcd bill_dpcd from 
            (select distinct a.comp_code,a.unit,a.bill_agcd,a.bill_dpcd
            from cir_agmast a
            where  a.comp_code = pcomp_code and a.unit     = punit_code and 
            a.agcd||a.dpcd in (select distinct agcd||dpcd agcdpdcd from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct agcd||dpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) and 
            a.bill_agcd=nvl(pbillagcd,a.bill_agcd) and a.bill_dpcd=nvl(pbilldpcd,a.bill_dpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y') u,cir_agmast m
            where u.comp_code = m.comp_code and u.comp_code = pcomp_code and u.unit=m.unit and u.unit = punit_code and 
            u.bill_agcd=m.agcd and u.bill_dpcd=m.dpcd and
            (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and 
            (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
            (m.branch_code=pbranchcode or pbranchcode is null)
            order by m.comp_code,m.unit,m.agcd,m.dpcd;*/
            select distinct x.comp_code comp_code,x.unit_code unit,x.billagcd bill_agcd,x.billdpcd bill_dpcd 
            from(select u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billagcd,u.billdpcd 
            from(select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd  from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) u,cir_agmast a
            where a.comp_code=u.comp_code and a.unit=u.unit_code and a.agcd=u.agcd and a.dpcd=u.dpcd and
            u.billagcd=nvl(pbillagcd,u.billagcd) and u.billdpcd=nvl(pbilldpcd,u.billdpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y' and
            (a.ag_type=pagencytype or pagencytype is null) and (a.ag_class=pagencyclass or pagencyclass is null) and 
            (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and 
            (a.branch_code=pbranchcode or pbranchcode is null))x
            order by x.comp_code,x.unit_code,x.billagcd,x.billdpcd; 

    agency_rec agency_cur%rowtype;
    
        cursor cur_supply is 
        select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.comm_fix_auto_spl comm_fix_auto_spl,
        u.comm_code comm_code,u.sup_rate sup_rate,u.supdate supdate,u.surch_cd surch_cd,sum(u.sup_copy) sup_copy from 
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
        d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0
            union all
             select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
                    d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup_resale d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0) u 
        where u.comp_code = agency_rec.comp_code and u.unit_code = agency_rec.unit and 
                u.agcd=agency_rec.bill_agcd and u.dpcd=agency_rec.bill_dpcd/*u.agcd||u.dpcd in (select agcd||dpcd from cir_agmast 
                        where comp_code = agency_rec.comp_code and unit = agency_rec.unit and
                              bill_agcd = agency_rec.bill_agcd and
                              bill_dpcd = agency_rec.bill_dpcd)*/
       group by u.comp_code,u.unit_code,u.publ,u.edtn,u.comm_fix_auto_spl,u.comm_code,u.sup_rate,u.supdate,u.surch_cd;
       rec_supply cur_supply%rowtype;

       avg_sup number;
       
       cursor comm_auto is select * from cir_comm_mast
            where comp_code = pcomp_code and
                  unit_code = punit_code and
                  publ = rec_supply.publ and
                  edtn = rec_supply.edtn and
                  comm_type = rec_supply.comm_fix_auto_spl and
                  comm_catg_code = rec_supply.comm_code and  
                  valid_from = (select max(valid_from) from cir_comm_mast
                                     where comp_code = pcomp_code and
                                           unit_code = punit_code and
                                           publ = rec_supply.publ and
                                           edtn = rec_supply.edtn and
                                           comm_type = rec_supply.comm_fix_auto_spl and
                                           comm_catg_code = rec_supply.comm_code and  
                                           valid_from <= v_billdt and
                                           avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0)) and
                  avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0);
        rec_comm_auto comm_auto%rowtype;          
       
       cursor comm_fix_spl is select * from cir_comm_mast
                                where comp_code = pcomp_code and
                                      unit_code = punit_code and
                                      publ = rec_supply.publ and
                                      edtn = rec_supply.edtn and
                                      comm_type = rec_supply.comm_fix_auto_spl and
                                      comm_catg_code = rec_supply.comm_code and  
                                      valid_from = (select max(valid_from) from cir_comm_mast
                                                         where comp_code = pcomp_code and
                                                               unit_code = punit_code and
                                                               publ = rec_supply.publ and
                                                               edtn = rec_supply.edtn and
                                                               comm_type = rec_supply.comm_fix_auto_spl and
                                                               comm_catg_code = rec_supply.comm_code and  
                                                               valid_from <= rec_supply.supdate);
        rec_comm_fix_spl comm_fix_spl%rowtype;          
                  
       cursor cur_surcharge is select * from cir_surcharge_mast 
                where comp_code  = pcomp_code and 
                      unit       = punit_code and
                      publ       = rec_supply.publ and
                      edtn       = rec_supply.edtn and
                      surch_cd   = rec_supply.surch_cd and 
                      valid_from = (select max(valid_from) from cir_surcharge_mast 
                                                where comp_code  = pcomp_code and 
                                                      unit       = punit_code and
                                                      publ       = rec_supply.publ and
                                                      edtn       = rec_supply.edtn and
                                                      surch_cd   = rec_supply.surch_cd and
                                                      valid_from<= rec_supply.supdate);
       rec_surcharge cur_surcharge%rowtype;
       
       v_bran_code cir_agmast.branch_code%type;
       v_rec_amt number:=0;
       v_rcp_count number:=0;

    Begin
        v_frdt         :=to_date(pfrdt,''''||pdateformat||'''');
        v_todt         :=to_date(ptodt,''''||pdateformat||'''');
        v_billdt     :=v_todt;
    Begin

        open agency_cur; 
        loop 
            fetch agency_cur into agency_rec;
            exit when agency_cur%notfound;
            
            curr_bilagcd := agency_rec.bill_agcd ||agency_rec.bill_dpcd;
            curr_record  := agency_rec.bill_agcd ||agency_rec.bill_dpcd/*||agency_rec.publ*/;
       ---------------------------------------------- add new code ------------------------------------------------------
            if curr_record <> prev_record then
                daily_gross_amount  := 0;
                tot_copy            := 0;
                tot_surcharge_amt   := 0;
                vsrch_amt           :=0;
                vcomm_amt           :=0;
            end if;

            open cur_supply;
            loop 
                fetch cur_supply into rec_supply;
                exit when cur_supply%notfound;
                tot_copy := nvl(tot_copy,0) + nvl(rec_supply.sup_copy,0) ;
                daily_gross_amount := nvl(daily_gross_amount,0)  + nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                v_daily_gross_amt:=nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                if rec_supply.comm_fix_auto_spl!='A' then
                    open comm_fix_spl;
                    fetch comm_fix_spl into rec_comm_fix_spl;
                    
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vcomm_per:= rec_comm_fix_spl.sun_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vcomm_per:= rec_comm_fix_spl.mon_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday commition rate
                        vcomm_per:= rec_comm_fix_spl.tue_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday commition rate
                        vcomm_per:= rec_comm_fix_spl.wed_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday commition rate
                        vcomm_per:= rec_comm_fix_spl.thu_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday commition rate
                        vcomm_per:= rec_comm_fix_spl.fri_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday commition rate
                        vcomm_per:= rec_comm_fix_spl.sat_comm_rate;
                    else
                        vcomm_per:=    0;
                    end if;
                    rec_comm_fix_spl.sun_comm_rate:=0; rec_comm_fix_spl.mon_comm_rate:=0; rec_comm_fix_spl.tue_comm_rate:=0;
                    rec_comm_fix_spl.wed_comm_rate:=0;rec_comm_fix_spl.thu_comm_rate:=0; rec_comm_fix_spl.fri_comm_rate:=0;
                    rec_comm_fix_spl.sat_comm_rate:=0;                                     
                    if nvl(rec_comm_fix_spl.comm_catg_type,'N')='P' then
                        vcomm_amt:=nvl(vcomm_amt,0) + (nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                        v_daily_comm_amt:=(nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_fix_spl.comm_catg_type,'N')='C' then
                        vcomm_amt:= nvl(vcomm_amt,0) + nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                        v_daily_comm_amt:=nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                    else
                        vcomm_amt:=0;
                        v_daily_comm_amt:=0;
                    end if;
                    close comm_fix_spl;   
                end if; 
                            
                open cur_surcharge;
                fetch cur_surcharge into rec_surcharge;
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vsrch_amt:= rec_surcharge.sun_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vsrch_amt:= rec_surcharge.mon_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday surcharge rate
                        vsrch_amt:= rec_surcharge.tue_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday surcharge rate
                        vsrch_amt:= rec_surcharge.wed_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday surcharge rate
                        vsrch_amt:= rec_surcharge.thu_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday surcharge rate
                        vsrch_amt:= rec_surcharge.fri_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday surcharge rate
                        vsrch_amt:= rec_surcharge.sat_rate;
                    else
                        vsrch_amt:=    0;
                    end if;
                close cur_surcharge;    
                
                tot_surcharge_amt   :=  nvl(tot_surcharge_amt,0) + nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_sur_amt     :=  nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_bill_amt    :=  nvl(v_daily_gross_amt,0)+nvl(v_daily_sur_amt,0)-nvl(v_daily_comm_amt,0);
                
                If pextra1 is null then
                    select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
                        from cir_unsold_dtl
                        where comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and doctype='UCN' and
                            app_dt=rec_supply.supdate and publ=rec_supply.publ and edtn=rec_supply.edtn and agcd=agency_rec.bill_agcd and
                            dpcd=agency_rec.bill_dpcd and copy_rate=rec_supply.sup_rate and
                             (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                                
                    select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
                        where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and
                            agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and recptdt = rec_supply.supdate and
                            doctype='RCR' and achd='NM';
                            
                    select count(*) into v_rcp_count from cir_bill_return_print
                        where cur_sessionid=userenv('sessionid') and comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and 
                            receipt_date=rec_supply.supdate and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd;
                    if nvl(v_rcp_count,0)>0 then
                        v_rec_amt:=0; 
                    else
                        insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
                        values(rec_supply.comp_code,rec_supply.unit_code,agency_rec.bill_agcd,agency_rec.bill_dpcd,rec_supply.supdate,v_rec_amt);
                    end if;
                End if;
        
                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                   supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                   return_copy,return_amt,cur_sessionid,rec_amt)
                                        values(rec_supply.comp_code,rec_supply.unit_code,null,v_billdt,rec_supply.publ,rec_supply.edtn,agency_rec.bill_agcd,agency_rec.bill_dpcd,
                             rec_supply.supdate,rec_supply.sup_copy,rec_supply.sup_rate,nvl(v_daily_gross_amt,0),nvl(vcomm_per,0),nvl(v_daily_comm_amt,0),nvl(vsrch_amt,0),nvl(v_daily_sur_amt,0),
                             v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                v_rec_amt:=0;v_rcp_count:=0;
            end loop; 
            avg_sup:=nvl(tot_copy,0);

            if rec_supply.comm_fix_auto_spl = 'A' then
                 --cal_avg_copy(agency_rec.bilagcd,agency_rec.bildpcd,agency_rec.publ);
                if tot_copy > 0 then 
                    open comm_auto;
                    fetch comm_auto into rec_comm_auto;
                    vcomm_per :=  rec_comm_auto.sun_comm_rate;
                    if nvl(rec_comm_auto.comm_catg_type,'N')='P' then
                          vcomm_amt:=nvl(daily_gross_amount,0)*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_auto.comm_catg_type,'N')='C' then
                          vcomm_amt:=nvl(tot_copy,0)*nvl(vcomm_per,0);
                    else
                          vcomm_amt:=0;
                    end if;      
                    close comm_auto;
                end if;
            end if;
           
           close cur_supply;
           daily_net_amount := nvl(daily_gross_amount,0) + nvl(tot_surcharge_amt,0) - nvl(vcomm_amt,0);
           vbill_no         :=nvl(vbill_no,0)+1;
           --vbill_no:=cir_generate_billno(agency_rec.comp_code,agency_rec.unit,v_billdt,pdateformat,'','');

           if nvl(tot_copy,0) > 0 then
             Begin
                 select abs(sum(amount)) into v_sec_limit from cir_rcphdr 
                      where comp_code=  agency_rec.comp_code and
                            unit_code=  agency_rec.unit and
                            agcd     =  agency_rec.bill_agcd and
                            dpcd     =  agency_rec.bill_dpcd and
                            recptdt  <= v_todt and
                            achd     =  'SC';
                      exception when others then
                            v_sec_limit:=0;
             End;

            select distinct security_per,sec_amt_limt,branch_code into v_agcd_sec_per,v_agcd_sec_amt_limt,v_bran_code from cir_agmast 
              where comp_code = pcomp_code and unit = punit_code and agcd=agency_rec.bill_agcd and 
                    dpcd=agency_rec.bill_dpcd;
             
             if nvl(v_agcd_sec_per,0)>0 then
                 if nvl(v_agcd_sec_amt_limt,0)>nvl(v_sec_limit,0) then
                    v_bill_dbn_amt:=nvl(v_agcd_sec_per,0)*nvl(daily_net_amount,0)/100;
                 end if;
                 if nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0)<nvl(v_bill_dbn_amt,0) then
                    v_bill_sec_amt:=nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0);
                 else
                    v_bill_sec_amt:=nvl(v_bill_dbn_amt,0);
                 end if;
                if nvl(v_bill_sec_amt,0)<0 then
                    v_bill_sec_amt:=0;
                end if;
             end if;
            
            update cir_bill_print set billno=vbill_no,sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;

            /*update cir_bill_print set sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;*/
           
            v_sec_limit      :=0; v_bill_dbn_amt:=0; v_bill_sec_amt   :=0;
            v_remark         :='';v_reptno      :='';v_rec_no         :=0; 
            v_daily_comm_amt :=0; v_daily_sur_amt:=0;v_daily_gross_amt:=0;
            v_daily_bill_amt :=0;
           end if;
       end loop;
    close agency_cur;
    commit;
    End;  
  
  End cir_before_bill_process_p;
  
  procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,--for executive code
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_start_date  date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);

    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate 
            from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcomp_code and d.unit_code=m.unit and d.unit_code=punit_code and 
                d.doctype='UCN' and d.agcd=m.agcd  and d.dpcd=m.dpcd and d.app_dt >= v_start_date  and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and 
                d.app_dt<=v_bill_todt and  (m.ag_class=pagclass or pagclass is null) and (m.dist_code=v_distcode or v_distcode is null) and 
                (m.tehsil_taluka=v_taluka or v_taluka is null) and d.supply_copy>0 and (m.branch_code=pbrancode or pbrancode is null) and
                (m.executive_code = pextra1 or pextra1 is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date  and supply_date<=v_bill_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
    cursor cur_bill is
        select distinct x.comp_code comp_code,x.unit_code unit_code,x.agcd agcd,x.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        sum(x.supply_copy) supply_copy,sum(x.gross_amount) gross_amount,sum(x.sur_amount) sur_amount,sum(x.comm_amount) comm_amount,
        sum(x.bill_sec_amt) bill_sec_amt from
        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        sum(a.supply_copy) supply_copy,sum(a.gross_amt) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        sum(a.sec_amt) bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_bill_frdt and a.supply_date<=v_bill_todt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.publ_code=nvl(ppubl,a.publ_code) and a.cur_sessionid=userenv('sessionid')
                  group by a.comp_code,a.unit_code,a.agcd,a.dpcd
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        0 supply_copy,0 gross_amount,0 sur_amount,0 comm_amount,0 bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_start_date and a.supply_date<v_bill_frdt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.cur_sessionid=userenv('sessionid') and a.publ_code=nvl(ppubl,a.publ_code)) x,cir_agmast b
                  where x.comp_code=b.comp_code and x.unit_code=b.unit and x.agcd=b.agcd and x.dpcd=b.dpcd
                  group by x.comp_code,x.unit_code,x.agcd,x.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka
                  order by x.comp_code,x.unit_code,x.agcd,x.dpcd;
        v1 cur_bill%rowtype;
      
      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_city_name       varchar2(100);
        --v_billno          varchar2(20);
        --v_bildt           date;
        
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        --v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX'; 

       v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_psecamt         number(15,2):=0;
        v_csecamt         number(15,2):=0;  
        v_opdate          date;
        v_bill_exist      number(5);

        v_pbillret        number(15,2):=0;
        v_state_name        varchar2(200);
        v_dist_name         varchar2(200);
        v_taluka_name       varchar2(200);

    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');
    v_start_date    :=trunc(v_bill_frdt,'mm');
    
    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then
        v_distcode:=pdistcode;
    elsif repty='C' then
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');

    
    select count(*) into v_bill_exist from cir_bill_det b,cir_publ_mast p 
        where b.comp_code=pcomp_code and b.comp_code = p.comp_code and b.unit_code=punit_code and 
            b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and b.publ =p.publ and 
            (b.agcd=nvl(pbillagcd,b.agcd) or pbillagcd='') and (b.dpcd=nvl(pbilldpcd,b.dpcd) or pbilldpcd='');
    
    if v_bill_frdt=v_start_date then
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_bill_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    end if;    
    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit; 
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date and supply_date<=v_bill_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcomp_code and unit_code=punit_code and 
                supply_date>= v_start_date and supply_date<=v_bill_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and app_dt=rec_not_supply.supply_date and 
                publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_bill_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;v_rec_amt:=0;
    end loop;
    close cur_not_supply;
    
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;

            select sum(u.tot_return),sum(u.gross_amt),sum(u.comm_amt) into v_ret_copy,v_ret_gross,v_ret_comm from
            (select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt  
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and process_crno is null/*and publ=v1.publ*/
            union
            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt 
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and 
                process_crno is not null /*and publ=v1.publ*/) u;
                
            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp <>'BIL' and recptdt>=v_opdate and recptdt<v_start_date and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp<>'UCN' and recptdt>=v_start_date and recptdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd);
            
            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            
            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
             agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC' ;
            
            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);

            select sum(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)),abs(sum(sec_amt)) into v_pbillret,v_psecamt 
            from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date>=v_start_date and supply_date<v_bill_frdt and  
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                            
            select abs(sum(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date >= v_bill_frdt and supply_date<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                
            if nvl(v_bill_exist,0)=0 then
                v_sec_bal   :=nvl(v_sec_bal,0)-nvl(v_psecamt,0)-nvl(v_csecamt,0);
            else
                v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_psecamt,0);
            end if;
            
            v_prev_bal      :=nvl(v_prev_bal,0)+nvl(v_pbillret,0)+nvl(v_psecamt,0);
                        
            v_rec_amt:=0;v_pbillret:=0;v_csecamt:=0;v_psecamt:=0;
            
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    if v_bill_exist=0 then
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0)+nvl(v_csecamt,0);
                    else
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                    end if;    
                else
                    if v2.doctyp='RCR' then   
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;

            v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;           
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd, 
            supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,        
            agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
               values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v1.country_code,v1.bill_sec_amt,v_sec_bal);
    
            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name    :=null;v_dist_name     :=null;v_taluka_name   :=null; v_city_name:=null; 
        End Loop;
        Close cur_bill;
        commit;
        
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name;            
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,district_name,ag_name;     

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;
            
        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code,a.city_code
            order by comp_code,unit_code,city_name,ag_name;  
            
            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;   

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;            
        end if;
        
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;        
    End cir_weekly_bill_summary_p;         
End cir_rep_billing;
/



///////////////////////////////////////////description/////////////////////////////////////////////////////////////////////////

 CREATE OR REPLACE PACKAGE .cir_rep_billing IS
  type t_accounts is ref cursor;
  procedure cir_billing_agency_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_billno_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_bill_print_punya(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,  
    ptalukacode      in varchar2,
    pcitycode        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);  
  
  procedure cir_bill_print_bhaskar(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);

  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);

  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);
        
  procedure cir_bill_register_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_outstanding_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);

  procedure cir_unitwise_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_rate_p (
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    BILLNO_FROM     in varchar2,
    BILLNO_TO       in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,  
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts,
    p_accounts2     out t_accounts,
    p_accounts3     out t_accounts);

  Procedure cir_before_bill_process_p(
      pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2);

procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);    
End cir_rep_billing;
/

//==========================================================end of procedre 5582===============================
/*****************************Laxman 19-nov-2011******************************/

CREATE or replace FUNCTION cir_get_agency_type(pcomp_code in varchar2,pagtype in varchar2) RETURN varchar2 IS
vag_type_desc cir_agency_typ_mast.agency_type_desc%type;
BEGIN
	Begin
     select agency_type_desc into vag_type_desc 
        from cir_agency_typ_mast
         where comp_code=pcomp_code and
               agency_type_code=pagtype;
	Exception when others then
		vag_type_desc :=null;
	End;
  return nvl(vag_type_desc,'');
END;
/*****************************Laxman 19-nov-2011******************************/


//************************************************* 5707 **************************************************//


CREATE OR REPLACE procedure HT18JULY.cir_route_detail_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    proutetype      in varchar2,--for Route R,Sub Route SR,Sub Sub Route SS
    puserid         in varchar2,
    psortby         in varchar2,--for Name Wise 1,Seq No. 2
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    P_Accounts      OUT Cur_Type_New1.cursor_type,
    P_Accounts1     OUT Cur_Type_New1.cursor_type,
    P_Accounts2     OUT Cur_Type_New1.cursor_type)
  As
  V_QUERY   VARCHAR2(4000);
  V_SORTEDBY  VARCHAR2(200);
Begin
    IF PROUTETYPE='R' THEN
        IF V_SORTEDBY=1 THEN
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_NAME,ROUTE_SEQ';     
        ELSE
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_SEQ,ROUTE_NAME';
        END IF;
    ELSIF PROUTETYPE='SR' THEN
        IF V_SORTEDBY=1 THEN
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_NAME,SUBRT_NAME,ROUTE_SEQ,SUBRT_SEQ';     
        ELSE
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_SEQ,SUBRT_SEQ,ROUTE_NAME,SUBRT_NAME';
        END IF;
    ELSE
        IF V_SORTEDBY=1 THEN
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_NAME,SUBRT_NAME,SUB_SUBRT_NAME,ROUTE_SEQ,SUBRT_SEQ,SUB_SUBRT_SEQ';     
        ELSE
            V_SORTEDBY:=' ORDER BY UNIT,ROUTE_SEQ,SUBRT_SEQ,SUB_SUBRT_SEQ,ROUTE_NAME,SUBRT_NAME,SUB_SUBRT_NAME';
        END IF;
    END IF;
    

    IF PROUTETYPE='R' THEN--FOR ROUTE
        V_QUERY:='SELECT R.COMP_CODE COMP_CODE, R.UNIT UNIT , R.ROUTE_CODE ROUTE_CODE, R.ROUTE_NAME ROUTE_NAME, R.ROUTE_NAME_OTH_LANG ROUTE_NAME_OTH_LANG, 
            R.ARR_TIME ARR_TIME, R.DEP_TIME DEP_TIME, R.ROUTE_DIST ROUTE_DIST, R.ROUTE_MODE ROUTE_MODE, R.ROUTE_SEQ ROUTE_SEQ, R.ROUTE_ALERT ROUTE_ALERT, 
            R.FREEZE_FLAG FREEZE_FLAG, R.START_POINT START_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT,R.START_POINT,1) START_DROP_POINT,
            R.END_POINT END_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT,R.END_POINT,1) END_DROP_POINT
            FROM CIR_ROUTE_MAST R
            WHERE R.COMP_CODE='||''''||PCOMPCODE||''''||' AND (R.UNIT='||''''||PUNITCODE||''''||' OR '||''''||PUNITCODE||''''||' IS NULL)  
            '||V_SORTEDBY;
            --insert into test1(vstring,vstring2) values('cir_route_detail_p FOR ROUTE ',V_QUERY);commit;
  	    OPEN P_ACCOUNTS FOR V_QUERY;
  	    
    ELSIF PROUTETYPE='SR' THEN--FOR SUB ROUTE

  	    
        V_QUERY:='SELECT R.COMP_CODE COMP_CODE, R.UNIT UNIT , R.ROUTE_CODE ROUTE_CODE, R.ROUTE_NAME ROUTE_NAME, R.ROUTE_NAME_OTH_LANG ROUTE_NAME_OTH_LANG,
        S.SUBRT_CODE SUBRT_CODE,S.SUBRT_NAME  SUBRT_NAME,S.SUBRT_NAME_OTH_LANG  SUBRT_NAME_OTH_LANG,
        S.ARR_TIME ARR_TIME, S.DEP_TIME DEP_TIME, S.SUBRT_DIST ROUTE_DIST, S.SUBRT_MODE ROUTE_MODE, R.ROUTE_SEQ ROUTE_SEQ,S.SUBRT_SEQ SUBRT_SEQ,
        S.FREEZE_FLAG FREEZE_FLAG, S.START_POINT START_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT,S.START_POINT,1) START_DROP_POINT,
        S.END_POINT END_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,R.UNIT,S.END_POINT,1) END_DROP_POINT
        FROM CIR_ROUTE_MAST R,CIR_SUB_ROUTE_MAST S
        WHERE R.COMP_CODE='||''''||PCOMPCODE||''''||' AND R.COMP_CODE=S.COMP_CODE AND (R.UNIT='||''''||PUNITCODE||''''||' OR '||''''||PUNITCODE||''''||' IS NULL) AND R.UNIT=S.UNIT AND
        R.ROUTE_CODE=S.ROUTE_CODE '||V_SORTEDBY;  
  	    --insert into test1(vstring,vstring2) values('cir_route_detail_p FOR sub ROUTE ',V_QUERY);commit;
        OPEN P_ACCOUNTS FOR V_QUERY;
        
    ELSE
  	    V_QUERY:='SELECT R.COMP_CODE COMP_CODE, R.UNIT UNIT , R.ROUTE_CODE ROUTE_CODE, R.ROUTE_NAME ROUTE_NAME, R.ROUTE_NAME_OTH_LANG ROUTE_NAME_OTH_LANG,
        S.SUBRT_CODE SUBRT_CODE,S.SUBRT_NAME  SUBRT_NAME,S.SUBRT_NAME_OTH_LANG  SUBRT_NAME_OTH_LANG,T.SUB_SUBRT_CODE SUB_SUBRT_CODE,T.SUB_SUBRT_NAME  SUB_SUBRT_NAME,T.SUB_SUBRT_NAME_OTH_LANG  SUB_SUBRT_NAME_OTH_LANG,
        T.ARR_TIME ARR_TIME, T.DEP_TIME DEP_TIME, T.SUB_SUBRT_DIST SUB_SUBRT_DIST, T.SUB_SUBRT_MODE ROUTE_MODE, R.ROUTE_SEQ ROUTE_SEQ,S.SUBRT_SEQ SUBRT_SEQ,
        T.SUB_SUBRT_SEQ SUB_SUBRT_SEQ,
        T.FREEZE_FLAG FREEZE_FLAG, T.START_POINT START_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,T.UNIT,T.START_POINT,1) START_DROP_POINT,
        T.END_POINT END_POINT,CIR_GET_DROP_POINT_NAME(R.COMP_CODE,T.UNIT,T.END_POINT,1) END_DROP_POINT
        FROM CIR_ROUTE_MAST R,CIR_SUB_ROUTE_MAST S,CIR_SUB_SUBROUTE_MAST T
        WHERE R.COMP_CODE='||''''||PCOMPCODE||''''||' AND R.COMP_CODE=S.COMP_CODE AND R.COMP_CODE=T.COMP_CODE AND (R.UNIT='||''''||PUNITCODE||''''||' OR '||''''||PUNITCODE||''''||' IS NULL) AND R.UNIT=S.UNIT AND
        R.UNIT=T.UNIT AND R.ROUTE_CODE=S.ROUTE_CODE  AND R.ROUTE_CODE=T.ROUTE_CODE AND S.SUBRT_CODE=T.SUBRT_CODE '||V_SORTEDBY;
        --insert into test1(vstring,vstring2) values('cir_route_detail_p FOR sub sub ROUTE ',V_QUERY);commit;
        OPEN P_ACCOUNTS FOR V_QUERY;
    END IF;
                 
    OPEN P_ACCOUNTS1 FOR SELECT SYSDATE AS "CUR_DATE" FROM DUAL;
                     
    OPEN P_ACCOUNTS2 FOR SELECT SYSDATE AS "CUR_DATE" FROM DUAL;
  END cir_route_detail_p;
/

//*****************************************************************************************//

//**************************************************** 5707 *************************************//

CREATE OR REPLACE procedure HT18JULY.cir_updation_seqno(
    pcompcode           in varchar2,
    punitcode           in varchar2,
    prtcode             in varchar2,
    psubrtcode          in varchar2,
    psub_subrtcode      in varchar2,
    pagcd               in varchar2,
    pdpcd               in varchar2,
    proute_seqno        in number,   
    pupdtype            in varchar2,--for Route R or Sub Route SR or SUB Sub Route SS
    puserid             in varchar2, 
    pdateformate        in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pextra3             in varchar2,
    pextra4             in varchar2,
    pextra5             in varchar2,
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
    p_accounts          OUT Cur_Type_New1.cursor_type)
is
    v_cnt number(5):=0;
begin
    
    if pupdtype='R' then
        select count(*) into v_cnt from cir_route_mast 
            where comp_code=pcompcode and unit=punitcode and route_code=prtcode;
        
        if nvl(v_cnt,0)>0 then  
            update cir_route_mast set route_seq=proute_seqno 
                where comp_code=pcompcode and unit=punitcode and route_code=prtcode;
        end if;        
    elsif pupdtype='SR' then
        select count(*) into v_cnt from cir_sub_route_mast
        where comp_code=pcompcode and unit=punitcode and route_code=prtcode and subrt_code=psubrtcode;
        
        if nvl(v_cnt,0)>0 then
            update cir_sub_route_mast set subrt_seq=proute_seqno 
                where comp_code=pcompcode and unit=punitcode and route_code=prtcode and subrt_code=psubrtcode;
        end if;   
    elsif pupdtype='SS' then
            select count(*) into v_cnt from cir_sub_subroute_mast
            where comp_code=pcompcode and unit=punitcode and route_code=prtcode and subrt_code=psubrtcode and sub_subrt_code=psub_subrtcode;
        
        if nvl(v_cnt,0)>0 then
            update cir_sub_subroute_mast set sub_subrt_seq=proute_seqno 
                where comp_code=pcompcode and unit=punitcode and route_code=prtcode and subrt_code=psubrtcode and sub_subrt_code=psub_subrtcode;
        end if;                            
    end if;
    commit;

    open p_accounts for select v_cnt as "UPDATE_RECORD" from dual;
    
End cir_updation_seqno;
/





//************************** Start of issue 4566 --- 4698 *************************************//

body----->


CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     proute                in varchar2,
     pfrom_supdate         in varchar2,
     ptill_supdate         in varchar2,
     pdateformat         in varchar2,
     pextra1             in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);

   procedure cir_rep_supply_po(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

  procedure cir_rep_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
  
  procedure cir_rep_taluka_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
     
  procedure cir_rep_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

  procedure cir_rep_dist_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);     

  procedure cir_rep_taluka_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
     
  procedure cir_rep_route_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

    procedure cir_rep_dist_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
    procedure cir_rep_taluka_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

     procedure cir_route_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
     procedure cir_dist_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_taluka_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

     procedure cir_dist_taluka_wise_sup(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);
     
    procedure cir_supply_comp(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     psupdate           in varchar2,
     psupdate1          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

    procedure cir_route_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_dist_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pdist              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_taluka_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     ptaluka            in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_edition_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);

    procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);

     procedure cir_dist_taluka_publ_wise(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
        
procedure cir_datewise_resale(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);              
END;
/

------body end/////


pkg----->




CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As

     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;

    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;

      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;

      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;

      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;

      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;

     open p_accounts1 for vquery1;
  End cir_rep_supply1;

procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as

     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;

     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;

    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;

    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';

        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;

    open p_accounts for vquery;


    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';

        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
             
     rec_sup_type cur_sup_type%rowtype;

    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and d.unit_code=nvl(punit_code,d.unit_code) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and d.unit=nvl(punit_code,d.unit) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        
        rec_dbk cur_dbk%rowtype;
        
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
                    
        rec_main_edtn cur_main_edtn%rowtype;                                    
        
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
                    
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;

        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;

        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
         
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;

            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;

        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;

        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;

    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;

    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    

  End cir_rep_supply_po;

  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_daybook;

  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_dist_daybook;

  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;

   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);

       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;

       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;

       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;

  End cir_rep_taluka_daybook;

  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
        
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;

  End cir_rep_day_daybook;

  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_dist_day_daybook;

  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;

    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');

    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';

       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;

        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';

       open p_accounts1 for vquery3||vquery2;

        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;

   End cir_rep_taluka_day_daybook;

  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;

        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;

procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');

    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_dist_challan;

    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As

     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');

        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;

    End cir_rep_taluka_challan;

    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
                  
    End cir_route_wise_supply;

    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;

    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
                  
     End cir_taluka_wise_supply;


    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;

       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;

       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;

       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;

       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
        
     End cir_dist_taluka_wise_sup;

     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;

        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;

             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;

     End cir_supply_comp;

    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;

   End cir_route_supply_variance_p;

    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;

            end if;
   End cir_dist_supply_variance_p;

    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd and
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;

    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;

        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;

        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;

   End cir_edition_supply_variance_p;

   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;

     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);

     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;

    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;

procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
      
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;

        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
                        
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;


        end if;

        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;

        open p_accounts for v_query;

    End cir_dist_taluka_publ_wise;

    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;

        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;

        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;

        open p_accounts for v_query;

    End cir_datewise_resale;
END cir_rep_supply;
/



function--->



CREATE OR REPLACE FUNCTION HT18JULY.cir_get_edtn_supl(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    pedtn_code      in varchar2,
    pdate           in date,
    pdateformat     in varchar2,
    plangtype       in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2) return varchar2 is
    
    v_supl_name varchar2(1000);
Begin
        select  case when to_char(pdate,'DY')='SUN' then s.supl_name_sun  
                when to_char(pdate,'DY')='MON' then s.supl_name_mon
                when to_char(pdate,'DY')='TUE' then s.supl_name_tue
                when to_char(pdate,'DY')='WED' then s.supl_name_wed
                when to_char(pdate,'DY')='THU' then s.supl_name_thu
                when to_char(pdate,'DY')='FRI' then s.supl_name_fri
                when to_char(pdate,'DY')='SAT' then s.supl_name_sat
                else null end supl_name into v_supl_name
        from cir_edtn_supl_mast s,cir_edtn_mast e
        where s.comp_code=pcomp_code and s.comp_code=e.comp_code and s.unit_code=punit_code and s.unit_code=e.unit_code and 
            s.publ_code=e.publ and s.edtn_code=e.edtn and s.edtn_code=pedtn_code and 
            s.valid_from=(select max(valid_from) from cir_edtn_supl_mast 
            where comp_code=pcomp_code and unit_code=punit_code and edtn_code=pedtn_code and valid_from<=pdate);
    return  v_supl_name;       
    
End cir_get_edtn_supl;
/




//************************** End of issue 4566 --- 4698 *************************************//

//************************************5441************************************//

CREATE OR REPLACE procedure HT18JULY.cir_for_dispute_bill(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagency_type    in varchar2,
    pclass_type     in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,   
    ppubltype       in varchar2,
    ppublcode       in varchar2,
    pfromdate       in varchar2, 
    ptilldate       in varchar2,
    ptype           in varchar2,--for disputed D or undisputed bill U
    puserid         in varchar2, 
    pdateformate    in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    p_accounts      OUT Cur_Type_New1.cursor_type,
    p_accounts1     OUT Cur_Type_New1.cursor_type)
is
    v_frdt     date;
    v_todt     date;

begin
    v_frdt:=to_date(pfromdate,''''||pdateformate||'''');
    v_todt:=to_date(ptilldate,''''||pdateformate||'''');
    
    if upper(ptype)='U' then--for Undisputed bills
        if ppubltype is null and ppublcode is null then
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL", null as "DISPUTE_REMARK" 
            from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='N'
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N')
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         else
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL", null as "DISPUTE_REMARK" 
            from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='N' and 
                    b.publ in(select publ from cir_publ_mast where comp_code=pcompcode and publ=nvl(ppublcode,publ) and pro_type=nvl(ppubltype,pro_type)) 
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N')
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         end if;   
     else--for disputed bills
        if ppubltype is null and ppublcode is null then
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL",b.dispute_rmrk as "DISPUTE_REMARK" from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='Y'
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N'),
                b.dispute_rmrk
                having sum( o.amount )>0
                order by agency_name,billdt,billno;     
         else
            open p_accounts for 
            select o.comp_code AS "COMP_CODE",o.unit_code AS "UNIT_CODE",o.agcd as "AGCD",o.dpcd as "DPCD", m.ag_name as "AGENCY_NAME",
            m.station_code as "DROP_POINT",cir_get_drop_point_name(o.comp_code,o.unit_code,m.station_code,1) as "DROP_POINT_NAME", 
            m.city_code as "CITY_CODE",cir_get_city(o.comp_code,m.city_code) as "CITY_NAME",  
            o.billno as "BILLNO", o.billdt as "BILLDT" ,o.publ as "PUBL" ,cir_get_publ_name(o.comp_code,o.publ) as "PUBL_NAME",
            b.amount as "BILL_AMOUNT",sum(o.amount) as "DUE_AMOUNT",nvl(b.dispute_flag,'N') as "DISPUTE_BILL",b.dispute_rmrk as "DISPUTE_REMARK" from cir_outmast o,cir_agmast m,cir_outmast b 
                where o.comp_code=m.comp_code and o.comp_code=b.comp_code and o.comp_code=pcompcode and 
                     o.unit_code=m.unit and o.unit_code=b.unit_code and o.unit_code=punitcode and o.doctyp=b.doctyp and b.doctyp='BIL' and 
                    o.agcd=m.agcd and o.agcd=b.agcd and o.agcd =nvl(pagcd,o.agcd) and o.dpcd=m.dpcd and o.dpcd=b.dpcd and o.dpcd =nvl(pdpcd,o.dpcd) and 
                    o.billdt=b.billdt and o.billdt between v_frdt and v_todt and (o.publ = ppublcode or ppublcode is null) and 
                    o.billno=b.billno and o.billno  is not null and (m.ag_type=pagency_type or pagency_type is null) and 
                    (m.ag_class=pclass_type or pclass_type is null) and nvl(b.dispute_flag,'N')='Y' and
                    b.publ in(select publ from cir_publ_mast where comp_code=pcompcode and publ=nvl(ppublcode,publ) and pro_type=nvl(ppubltype,pro_type))
                group by  o.comp_code,o.unit_code,o.agcd,o.dpcd,m.ag_name,m.station_code,m.city_code,o.billno, o.billdt, o.publ,b.amount,nvl(b.dispute_flag,'N'),
                b.dispute_rmrk
                having sum( o.amount )>0
                order by agency_name,billdt,billno;
         end if;       
     end if;       
    
    open p_accounts1 for select sysdate as "CUR_DATE" from dual;
    
End cir_for_dispute_bill;
/

//**************************************5441**********************************//

CREATE OR REPLACE procedure HT18JULY.cir_updation_dispute_bill(
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pagcd               in varchar2,
    pdpcd               in varchar2,   
    pbillno             in varchar2,
    pbilldt             in varchar2,
    pdisputed_rmrk      in varchar2,
    pdisputed_flag      in varchar2,
    ptype               in varchar2,--for disputed D or undisputed bill U
    puserid             in varchar2, 
    pdateformate        in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pextra3             in varchar2,
    pextra4             in varchar2,
    pextra5             in varchar2,
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
    p_accounts          OUT Cur_Type_New1.cursor_type)
is
    v_billdt  date;
    v_cnt number(5);
begin
    v_billdt:=to_date(pbilldt,''''||pdateformate||'''');
    if ptype='D' then
        select count(*) into v_cnt from cir_outmast where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
            billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd and nvl(dispute_flag,'N')='Y';
    else
        select count(*) into v_cnt from cir_outmast where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
            billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd and nvl(dispute_flag,'N')='N';
    end if;
    
    if v_cnt>0 then
        v_cnt:=0;
        update cir_outmast set dispute_flag=pdisputed_flag, dispute_user_code=puserid, dispute_dt =sysdate,
        dispute_rmrk=pdisputed_rmrk
         where comp_code=pcompcode and unit_code=punitcode and doctyp='BIL' and 
        billno=pbillno and billdt=v_billdt and agcd=pagcd and dpcd=pdpcd;
        v_cnt:=1;
    end if;
    COMMIT;
    open p_accounts for select v_cnt as "UPDATE_RECORD" from dual;
    
End cir_updation_dispute_bill;

//**************************************5738*************************//

DROP PACKAGE HT18JULY.CIR_GENRATE_CODE;

CREATE OR REPLACE PACKAGE HT18JULY.Cir_Genrate_Code IS
	type p_circul_cursor is ref cursor;
PROCEDURE mach_config_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code 	out p_circul_cursor);              
END
END Cir_Genrate_Code;
/



DROP PACKAGE BODY HT18JULY.CIR_GENRATE_CODE;

CREATE OR REPLACE PACKAGE BODY HT18JULY.Cir_Genrate_Code IS
PROCEDURE agency_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(agency_type_code,3,5))+1 into vno from cir_agency_typ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
      vtype_code:='AT'||'001';
     Else
    vtype_code:='AT'||lpad(vno,3,'0');
     End if;

  open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_type_p;

PROCEDURE agency_class_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(8);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select to_number(max(substr(class_code,3,5)))+1 into vno from cir_agency_class_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='AC'||'001';
     Else
        vtype_code:='AC'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_class_p;

PROCEDURE suspend_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(suspend_type_code,3,5))+1 into vno from cir_suspend_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='ST'||'001';
     Else
        vtype_code:='ST'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End suspend_type_p;

PROCEDURE area_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(area_type,3,5))+1 into vno from cir_area_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
    vtype_code:='AR'||'001';
    Else
    vtype_code:='AR'||lpad(vno,3,'0');
    End if;

     open ptype_code for select vtype_code as "VAR_CODE" from dual;

End area_type_p;

PROCEDURE publ_mast_p(
   pcompcode    in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   ppubl_code   out p_circul_cursor) as
    vno         number(5);
    vpubl_code  varchar2(15);

BEGIN

    Begin
       select max(to_number(substr(publ,2)))+1 into vno from cir_publ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vpubl_code:='P'||'01';
    Else
        vpubl_code:='P'||lpad(vno,2,'0');
    End if;

    open ppubl_code for  select vpubl_code as "VAR_CODE" from dual;

End publ_mast_p;

PROCEDURE edtn_mast_p (
    pcompcode   in varchar2,
    ppubl_code  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pedtn_code  out p_circul_cursor) as
    vno         number(5);
    vedtn_code  varchar2(15);
BEGIN

    Begin
       select max(substr(edtn,2))+1 into vno from cir_edtn_mast where comp_code=pcompcode /*and publ=ppubl_code*/;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vedtn_code:=/*'E'||*/'001';
    Else
        vedtn_code:=/*'E'||*/lpad(vno,3,'0');
    End if;

    open pedtn_code for select vedtn_code as "VAR_CODE" from dual;

End edtn_mast_p;

PROCEDURE agmast_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pag_code    out p_circul_cursor) as
    vno         number(8);
    vag_code    varchar2(8);
    v_prefix    varchar2(20);
Begin

    Begin
        if upper(pextra2)='D' then
          v_prefix:='D'||upper(pprefix);
          select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast_dis
              where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        else
            v_prefix:=upper(pprefix);
            select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast
                  where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        end if;
    Exception when others then
         vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:=upper(v_prefix)||'0001';
    else
       vag_code:=upper(v_prefix)||lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agmast_P;

PROCEDURE agsubcode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pag_code        out p_circul_cursor) as
    vno             number(8);
    vag_code        varchar2(8);

BEGIN

    Begin
        if upper(pextra2)='D' then
            select to_number(max(dpcd))+1 into vno from cir_agmast_dis
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        else
            select to_number(max(dpcd))+1 into vno from cir_agmast
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        end if;
    Exception when others then
      vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:='0001';
    else
       vag_code:=lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agsubcode_P;

PROCEDURE areacode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    parea_code      out p_circul_cursor) as
    vno             number(8);
    varea_code      varchar2(15);

BEGIN

    Begin
       select max(substr(area_code,2,5))+1 into vno from cir_area_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        varea_code:='A'||'0001';
     Else
        varea_code:='A'||lpad(vno,4,'0');
     End if;

    open parea_code for select varea_code as "VAR_CODE" from dual;

End areacode_P;

PROCEDURE drop_point_code_P (
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pdrop_point_code    out p_circul_cursor) as
    vno         number(8);
    vdrop_point varchar2(15);

BEGIN

    Begin
        select max(substr(drop_point,2,5))+1 into vno from cir_drop_point_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vdrop_point:='D'||'0001';
    Else
        vdrop_point:='D'||lpad(vno,4,'0');
    End if;

    open pdrop_point_code for select vdrop_point as "VAR_CODE" from dual;

End drop_point_code_P;

Procedure executive_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pexe_code   out p_circul_cursor) as
    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
       select max(substr(executive_code,2,5))+1 into vno from cir_executive_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        v_code:='E'||'00001';
    Else
        v_code:='E'||lpad(vno,5,'0');
    End if;

    open pexe_code for select v_code as "VAR_CODE" from dual;

End executive_code_p;

PROCEDURE routecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    prt_code    out p_circul_cursor) As
    vno         number(8);
    vrt_code    varchar2(15);
BEGIN
    Begin
       select max(substr(route_code,3,5))+1 into vno from cir_route_mast where comp_code=pcompcode and unit=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vrt_code:='RT'||'001';
    Else
        vrt_code:='RT'||lpad(vno,3,'0');
    End if;

    open prt_code for select vrt_code as "VAR_CODE" from dual;

End routecode_P;

PROCEDURE subroutecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    prtcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psubrt_code out p_circul_cursor) as
    vno         number(8);
    vsubrt_code varchar2(15);
BEGIN
    Begin
        select max(substr(subrt_code,3,5))+1 into vno from cir_sub_route_mast where comp_code=pcompcode and unit=punitcode and route_code=prtcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubrt_code:='SR'||'001';
    Else
        vsubrt_code:='SR'||lpad(vno,3,'0');
    End if;

    open psubrt_code for select vsubrt_code as "VAR_CODE" from dual;

End subroutecode_P;

PROCEDURE subsubroutecode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    prtcode         in varchar2,
    psubrtcode      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    psubsubrt_code  out p_circul_cursor) as
    vno             number(8);
    vsubsubrt_code  varchar2(15);
BEGIN
    Begin
        select max(substr(sub_subrt_code,3,5))+1 into vno from cir_sub_subroute_mast
            where comp_code=pcompcode and unit=punitcode and route_code=prtcode and
                    subrt_code=psubrtcode;
    Exception When Others Then
       vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubsubrt_code:='SS'||'001';
    Else
        vsubsubrt_code:='SS'||lpad(vno,3,'0');
    End if;
    open psubsubrt_code for select vsubsubrt_code as "VAR_CODE" from dual;

End subsubroutecode_P;

PROCEDURE transportercode_P (
    pcompcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptp_code    out p_circul_cursor) as
    vno         number(8);
    vtp_code    varchar2(8);

Begin

    Begin
        select max(substr(transporter_code,2))+1 into vno from cir_transporter_mast
            where comp_code=pcompcode and upper(substr(transporter_code,1,1))=upper(pprefix);
    Exception when others then
        vno:=0;
    End;

    if nvl(vno,0)=0 then
        vtp_code:=upper(pprefix)||'0001';
    else
        vtp_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open ptp_code for select vtp_code as "VAR_CODE" from dual;
End transportercode_P;

PROCEDURE districtcode_P (
    pcompcode   in varchar2,
    pstatecode  in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdist_code  out p_circul_cursor) as
    vno         number(8);
    vdist_code  varchar2(8);

Begin

    Begin
        select max(substr(dist_code,3))+1 into vno from cir_dist_mast
            where comp_code=pcompcode and upper(substr(dist_code,1,2))=upper(pprefix);
    Exception when others then
    vno:=0;
    End;
    if nvl(vno,0)=0 then
        vdist_code:=upper(pprefix)||'0001';
    else
        vdist_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open pdist_code for select vdist_code as "VAR_CODE" from dual;

End districtcode_P;

PROCEDURE comm_catg_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);
    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_catg_code,3,5))+1 into vno from cir_comm_catg_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='C';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_catg_p;

PROCEDURE comm_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_code,3,5))+1 into vno from cir_comm_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='F';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_p;

PROCEDURE zone_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(zone_code,3,5))+1 into vno from cir_zone_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='ZN'||'001';
    Else
        vtype_code:='ZN'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End zone_p;

PROCEDURE taluka_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(talu_code,3,6))+1 into vno from cir_taluka_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='TK'||'0001';
    Else
        vtype_code:='TK'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End taluka_p;

PROCEDURE receipt_p (
    pcompcode   in varchar2,
    pbranchcode in varchar2,
    pdoctype    in varchar2,
    precptdt    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(20);
    vrecptno  varchar2(15);
    v_dt date;
BEGIN

    v_dt:=to_date(precptdt,''''||pdateformat||'''');

    Begin
       if upper(pextra2)='D' then
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr_dis
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       else
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       end if;
    Exception When Others Then
       vno:=null;
    End;

    If nvl(vno,0)=0 Then
      vrecptno:=pbranchcode||'-'||to_char(v_dt,'yymm')||'0001';
    Else
      vrecptno:=pbranchcode||'-'||lpad(vno,8,'0');
    End if;

    open ptype_code for select vrecptno as "VAR_CODE" from dual;

End receipt_p;

PROCEDURE mode_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(mode_code,3,3))+1 into vno from cir_route_mode_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='RM'||'001';
    Else
        vtype_code:='RM'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End mode_p;

PROCEDURE supply_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(sup_ty_code,2,2))+1 into vno from cir_supply_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='S'||'01';
    Else
        vtype_code:='S'||lpad(vno,2,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End supply_type_p;

PROCEDURE expenses_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(exp_type_code,2,3))+1 into vno from cir_expenses_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='E'||'001';
    Else
        vtype_code:='E'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End expenses_type_p;

PROCEDURE city_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(city_code,3,6))+1 into vno from cir_city_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 then
        vtype_code:='CT'||'0001';
    Else
        vtype_code:='CT'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End city_p;

PROCEDURE cir_region_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preg_code   out p_circul_cursor)
    as
    vno         number(5);
    vreg_code   varchar2(15);
BEGIN

    Begin
       select max(substr(reg_code,3,6))+1 into vno from cir_region_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vreg_code:='RG'||'0001';
    Else
        vreg_code:='RG'||lpad(vno,4,'0');
    End if;

    open preg_code for select vreg_code as "VAR_CODE" from dual;

End cir_region_p;

PROCEDURE cir_unsold_receipt_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    preceipt_no     out p_circul_cursor)
    As
    vno number(5);
    vtype_code  varchar2(15);
    v_sess_id   number(20);
    v_prefix    varchar2(20);
    v_no        varchar2(20);
    v_dt        date;
    v_chkdt     date;
BEGIN
    /*loop
     begin
        select gen_unsold_rec_yn into v_gen_unsold_rec_yn from cir_control;
        if nvl(v_gen_unsold_rec_yn,'N')  = 'N' then
           exit;
        end if;
        exception when no_data_found then
            insert into cir_control values('Y');
            exit;
     end;
    end loop;
    update cir_control set GEN_UNSOLD_REC_YN='Y';commit;*/

    /*Begin
        if upper(pextra2)='D' then
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr_dis where comp_code=pcompcode;
        else
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr where comp_code=pcompcode;
        end if;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='UN'||'000001';
    Else
        vtype_code:='UN'||lpad(vno,6,'0');
    End if;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
    */

    v_dt    :=to_date(pextra1,''''||pdateformat||'''');
    v_prefix:='UN'||to_char(v_dt,'yymm');

    select trunc(v_dt,'mm') into v_chkdt from dual;

    begin
        select curr_no into v_no from cir_series
        where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    exception when no_data_found then
        v_no:=null;
    end;

    if v_no is null or v_no='0' then
        vtype_code:=v_prefix||'00001';
        insert into cir_series(comp_code,unit_code,branch_code,ty,year_monid,prefix, curr_no)
        values(pcompcode,null,null,'UCN',trunc(v_dt,'mm'),v_prefix,1);
    else
        v_no        :=to_number(v_no)+1;
        vtype_code  :=v_prefix||lpad(v_no,5,'0');
        update cir_series set curr_no=nvl(curr_no,0)+1
            where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    end if;
    commit;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
End cir_unsold_receipt_p;

PROCEDURE cir_surcharge_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
            select max(substr(surch_cd,2,3))+1 into vno from cir_surcharge_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='S'||'001';
    Else
        vsurch_cd:='S'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_surcharge_p;

PROCEDURE cir_roleMatser_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
       select max(substr(role_code,2,3))+1 into vno from cir_role_mast where comp_code=pcompcode;
          Exception When Others Then
               vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='R'||'001';
    Else
        vsurch_cd:='R'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_roleMatser_p;

PROCEDURE cir_narr_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pnarr_cd        out p_circul_cursor)
    as
    vno             number(5);
    vsurch_cd       varchar2(15);
BEGIN
    Begin
        select max(substr(na_code,3,4))+1 into vno from fa_vch_narration_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        vsurch_cd:='N'||'001';
    Else
        vsurch_cd:='N'||lpad(vno,3,'0');
    End if;

    open pnarr_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_narr_p;

Procedure cir_taxi_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptaxi_code  out p_circul_cursor) as

    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
        select max(substr(taxi_id,2,4))+1 into vno from cir_taxi_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='V'||'0001';
    Else
        v_code:='V'||lpad(vno,4,'0');
    End if;

    open ptaxi_code for select v_code as "VAR_CODE" from dual;

End cir_taxi_code_p;

PROCEDURE cir_lable_htmlformatid_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pformat_id  out p_circul_cursor)
    As
    vno         number(8);
    v_code      varchar2(15);
    v_sess_id   number(20);
Begin
    Begin
        select max(formatid)+1 into vno from cir_lable_htmlformat;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:=1;
    Else
        v_code:=vno;
    End if;
    insert into cir_lable_htmlformat(comp_code,formatid,format_desc) values(pcompcode,v_code,pextra1);commit;
    open pformat_id for select v_code as "FORMAT_ID" from dual;

End cir_lable_htmlformatid_p;
PROCEDURE cir_installment_code_p (
        pcompcode   in varchar2,
        punitcode   in varchar2,
        pdateformat in varchar2,
        pextra1     in varchar2,
        pextra2     in varchar2,
        pcode       out p_circul_cursor) as
    vno         number(10);
    v_code      varchar2(15);
    Begin

    Begin
        select max(substr(inst_code,2,7))+1 into vno from cir_installment_mast where comp_code=pcompcode;
        Exception When Others Then
            vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='I'||'0000001';
    Else
        v_code:='I'||lpad(vno,7,'0');
    End if;

    open pcode for select v_code as "VAR_CODE" from dual;

    End cir_installment_code_p;
PROCEDURE race_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN
    Begin
       select to_number(max(substr(race_code,3,5)))+1 into vno from cir_race_mast;
    Exception When Others Then
        vno:=null;
    End;
    
    If nvl(vno,0)=0 Then
        vtype_code:='RC'||'001';
    Else
        vtype_code:='RC'||lpad(vno,3,'0');
    End if;
    open ptype_code for select vtype_code as "VAR_CODE" from dual;
    
End race_code_P; 

PROCEDURE inct_slab_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(inct_slab_id),0)+1 into vno from cir_inct_slab_hdr;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End inct_slab_code_p;   

PROCEDURE festival_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(fest_code),0)+1 into vno from cir_festival_mast;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End festival_code_p;

PROCEDURE mach_config_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
BEGIN

    select nvl(max(MACH_ID),0)+1 into vno from cir_mach_config_mast;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End mach_config_code_p;
END Cir_Genrate_Code;
/


/*****************************************************************mimoh 25 nov*******************0005749***************************/


CREATE OR REPLACE PACKAGE Wesp_Updatedate
IS
PROCEDURE      Wesp_Updatedate_p(
compcode IN VARCHAR2,
userid IN VARCHAR2,
dateformat IN VARCHAR2,
code IN VARCHAR2,
curr IN VARCHAR2,
RATECODE11 IN VARCHAR2,
solo  IN VARCHAR2,
breakup VARCHAR2,
bwcode IN VARCHAR2,
rostatus IN VARCHAR2,
filename IN VARCHAR2,
tfn IN NUMBER,
insertbreak IN VARCHAR2,
prem IN VARCHAR2,
dealtype IN VARCHAR2,
pre IN VARCHAR2,
suff IN VARCHAR2,
financestatus IN  VARCHAR2,
voucherst IN VARCHAR2,
adcode IN VARCHAR2,
rodatetime IN VARCHAR2,
spacearea IN VARCHAR2,
vat IN VARCHAR2,
bookstat IN VARCHAR2,
cio_id IN VARCHAR2,
receipt_no IN VARCHAR2,
uom IN VARCHAR2,
bgcolor IN VARCHAR2,
validdate IN VARCHAR2,
agencyratecode IN VARCHAR2,
AUDIT1 IN VARCHAR2,
book_insert_date IN VARCHAR2,
agencycomm IN VARCHAR2,
rateaudit IN VARCHAR2,
billaudit IN VARCHAR2,
bill_type IN VARCHAR2,
invoice_no1 IN VARCHAR2,
copybooking IN VARCHAR2,
ratecompany IN VARCHAR2,
addagenycomm IN VARCHAR2,
agencycommlinkretainer IN VARCHAR2,
subeditionr IN VARCHAR2,
displaybilltype IN VARCHAR2,
classifiedbilltype IN VARCHAR2,
billformat IN VARCHAR2,
ratechk IN VARCHAR2,
allpkg IN VARCHAR2,
dayrate1 in varchar2,
schemetype in varchar2,
PIncludeclassi in varchar2,
receiptformat IN VARCHAR2,
v_cash_receipt in varchar2,
v_bill_orderwiselast in varchar2,
v_floor_chk in varchar2,
Unsoldflag in varchar2,
Supplystopper in  number,
drpRokeychk in varchar2,
Agencycomm_seq in varchar2,
creditreciept in varchar,
cashindisplay IN VARCHAR,
cashinclassified IN VARCHAR,
v_rate_audit_pref in varchar,
v_barcoding_allow_pref in varchar2,
v_fmgbills IN VARCHAR2,
v_billed_cashdis in varchar2,
v_billed_cashcls in varchar,
v_drpbackdate in varchar,
dockitbooking in varchar2,
allowprevbooking in varchar2,
ro_wisecashbill in varchar2,
chkval in varchar2,
approval1 in varchar2,
pckstatus in varchar2,
cash_disc in varchar2,
cash_amt in varchar2,
seperate_cashier1 in varchar2,
disp_bill in varchar2,
clas_bill in varchar2,
mantimepost in varchar2,
bkdaypost in number,
maxterutn in number,
cir_return in varchar2,
noofchkbounc in number,
noofdaychkrec in number,
retday in number,
chngsuppord in number,
max_publishday in number,
p_billno_period in varchar,
spl_trans_edit in varchar2,
spl_dis_trans_editable in varchar2,
mul_pac_sel_trans in varchar2,
shmon_minword in varchar2,
tradon_spcrg in varchar2,
rateauth     in varchar2,
f2day in number,
rateauditmodify in varchar,
bindrevenuecenter in varchar,
p_led_allow in varchar,
p_clear_allow in varchar,
repeatday in varchar,
premiumedit in varchar,
P_BILL_GENERATION in varchar,
P_PUBLICATION_CENTER in varchar,
P_allow_discount_prem IN VARCHAR,
P_SCHEME_BILLING in varchar,
P_ALLOW_PDC in varchar,
PAD_TYPE_FOR_MANUL_BILL in varchar,
RO_OUTSTAND_P IN VARCHAR2,
genrate_agency_code IN VARCHAR2,
p_dispauditbk IN VARCHAR2,
p_aotosupply  IN VARCHAR2,
p_Authorization IN VARCHAR2,
p_CIR_AUTO_APPROVAL_UNSOLD IN VARCHAR2,
p_CIR_AUTO_PHYSICAL_UNSOLD IN VARCHAR2,
p_CIR_UNSOLD_INCLUDE_INCT IN VARCHAR2,
p_CIR_UNSOLD_INCLUDE_INSFEE IN VARCHAR2,
p_CIR_UNSOLD_ON_RECEIVED_DT IN VARCHAR2

);
END      Wesp_Updatedate;
/





CREATE OR REPLACE PACKAGE BODY Wesp_Updatedate IS
PROCEDURE      Wesp_Updatedate_p(
compcode IN VARCHAR2,
userid IN VARCHAR2,
dateformat IN VARCHAR2,
code IN VARCHAR2,
curr IN VARCHAR2,
RATECODE11 IN VARCHAR2,
solo  IN VARCHAR2,
breakup VARCHAR2,
bwcode IN VARCHAR2,
rostatus IN VARCHAR2,
filename IN VARCHAR2,
tfn IN NUMBER,
insertbreak IN VARCHAR2,
prem IN VARCHAR2,
dealtype IN VARCHAR2,
pre IN VARCHAR2,
suff IN VARCHAR2,
financestatus IN  VARCHAR2,
voucherst IN VARCHAR2,
adcode IN VARCHAR2,
rodatetime IN VARCHAR2,
spacearea IN VARCHAR2,
vat IN VARCHAR2,
bookstat IN VARCHAR2,
cio_id IN VARCHAR2,
receipt_no IN VARCHAR2,
uom IN VARCHAR2,
bgcolor IN VARCHAR2,
validdate IN VARCHAR2,
agencyratecode IN VARCHAR2,
AUDIT1 IN VARCHAR2,
book_insert_date IN VARCHAR2,
agencycomm IN VARCHAR2,
rateaudit IN VARCHAR2,
billaudit IN VARCHAR2,
bill_type IN VARCHAR2,
invoice_no1 IN VARCHAR2,
copybooking IN VARCHAR2,
ratecompany IN VARCHAR2,
addagenycomm IN VARCHAR2,
agencycommlinkretainer IN VARCHAR2,
subeditionr IN VARCHAR2,
displaybilltype IN VARCHAR2,
classifiedbilltype IN VARCHAR2,
billformat IN VARCHAR2,
ratechk IN VARCHAR2,
allpkg IN VARCHAR2,
dayrate1 in varchar2,
schemetype in varchar2,
PIncludeclassi in varchar2,
receiptformat IN VARCHAR2,
v_cash_receipt in varchar2,
v_bill_orderwiselast in varchar2,
v_floor_chk in varchar2,
Unsoldflag in varchar2,
Supplystopper in  number,
drpRokeychk in varchar2,
Agencycomm_seq in varchar2,
creditreciept in varchar,
cashindisplay IN VARCHAR,
cashinclassified IN VARCHAR,
v_rate_audit_pref in varchar,
v_barcoding_allow_pref in varchar2,
v_fmgbills IN VARCHAR2,
v_billed_cashdis in varchar2,
v_billed_cashcls in varchar,
v_drpbackdate in varchar,
dockitbooking in varchar2,
allowprevbooking in varchar2,
ro_wisecashbill in varchar2,
chkval in varchar2,
approval1 in varchar2,
pckstatus in varchar2,
cash_disc in varchar2,
cash_amt in varchar2,
seperate_cashier1 in varchar2,
disp_bill in varchar2,
clas_bill in varchar2,
mantimepost in varchar2,
bkdaypost in number,
maxterutn in number,
cir_return in varchar2,
noofchkbounc in number,
noofdaychkrec in number,
retday in number,
chngsuppord in number,
max_publishday in number,
p_billno_period in varchar,
spl_trans_edit in varchar2,
spl_dis_trans_editable in varchar2,
mul_pac_sel_trans in varchar2,
shmon_minword in varchar2,
tradon_spcrg in varchar2,
rateauth     in varchar2,
f2day in number,
rateauditmodify in varchar,
bindrevenuecenter in varchar,
p_led_allow in varchar,
p_clear_allow in varchar,
repeatday in varchar,
premiumedit in varchar,
P_BILL_GENERATION in varchar,
P_PUBLICATION_CENTER in varchar,
P_allow_discount_prem IN VARCHAR,
P_SCHEME_BILLING in varchar,
P_ALLOW_PDC in varchar,
PAD_TYPE_FOR_MANUL_BILL in varchar,
RO_OUTSTAND_P IN VARCHAR2,
genrate_agency_code IN VARCHAR2,
p_dispauditbk IN VARCHAR2,
p_aotosupply  IN VARCHAR2,
p_Authorization IN VARCHAR2,
p_CIR_AUTO_APPROVAL_UNSOLD IN VARCHAR2,
p_CIR_AUTO_PHYSICAL_UNSOLD IN VARCHAR2,
p_CIR_UNSOLD_INCLUDE_INCT IN VARCHAR2,
p_CIR_UNSOLD_INCLUDE_INSFEE IN VARCHAR2,
p_CIR_UNSOLD_ON_RECEIVED_DT IN VARCHAR2


)AS
BEGIN
UPDATE LOGIN SET "date_format"=dateformat, "Autogenerate"=code,"curr_code"=curr WHERE "COM_CODE"=compcode;
COMMIT;
        UPDATE PREFERRENCES SET  "autogenerated"=code,
"currency_code"=curr ,
"rate_gr_code"=RATECODE11,
"date_format"=dateformat,"solo"=solo,"breakup"=breakup,
"blackwhitecode"=bwcode,"rostatus"=rostatus,"File_name"=filename,"Tfn"=tfn,
"Insert_breakup"=insertbreak,"Premium_type"=prem,"Deal_type"=dealtype  ,
 "prefix"=pre, "suffix"=suff, "financestatus"=financestatus , "voucherst"=voucherst,
 "Ad_category"=adcode ,"Ro_datetime"=rodatetime ,"Space_area"=spacearea,"Vat"=vat,
 "Booking_status"=bookstat,"Cio_id"=cio_id,"Receipt_no"=receipt_no,"uom_code"=uom,
 "Bgcolor_publication"=bgcolor ,"chkfor_valid_pubdates"=validdate, "Agency_ratecode"=agencyratecode,
  "audit"=AUDIT1,"book_insert_date"=book_insert_date,"agencycomm"=agencycomm,
  "rate_audit"=rateaudit,"bill_audit"=billaudit,"billtype"=bill_type,"invoice_no"=invoice_no1,
  "copy_booking"=copybooking,"RATE_COMPANY_AGENCY"=ratecompany, "ADDITIONAL_AGENCY_COMM"=addagenycomm ,
  "AGENCY_RETAINER_COMM"=agencycommlinkretainer,"SUBEDITIONRATE"=subeditionr,
  "CLS_BILLTYPE"=classifiedbilltype,"DIS_BILLTYPE"=displaybilltype,"BILLING_FORMAT"=billformat,
  "RATE_CHECK"=ratechk,"ALL_PACKAGE"=allpkg,"DAYRATE"=dayrate1,"SCHEME_TYPE"=schemetype,"DISP_CLSBILL"=PIncludeclassi   ,
  "CASH_RECEIPT_BILL"=v_cash_receipt, "BILL_ORDERWSLAST"=v_bill_orderwiselast, "FLOOR_CHK"=v_floor_chk ,
  "UNSOLD_ENTRY_FLAG"=Unsoldflag ,"SUPPLY_STOP_PERCENTAGE"=Supplystopper,"ROKEYCHECK"=drpRokeychk ,
  "AGENCYCOMM_SEQ_COM"=Agencycomm_seq ,"CREDIT_RECIPT"=creditreciept,"DISP_CASHBILL"=cashindisplay,
  "CLA_CASHBILL"=cashinclassified,"RATE_AUDIT_PREF"=v_rate_audit_pref,"BARCODING_ALLOWED"=v_barcoding_allow_pref,
  "FMG_BILL_DIS" =v_fmgbills, "BILL_DISP_CASHBILL"=v_billed_cashdis , "BILL_CLA_CASHBILL"=v_billed_cashcls,"BACKDATERECEIPT"=v_drpbackdate,"DOCKIT_BOOKING"=dockitbooking,"Allowed_old_date"=allowprevbooking,"ROWISE_CASHBOOKING"=ro_wisecashbill,"CUTOFFTIME"=chkval,"APPROVAL"=approval1,"BACK_DAYS"=pckstatus ,CASH_DISCOUNT=cash_amt,CASH_DISCOUNTTYPE=cash_disc,SEPRATE_CASHIER=seperate_cashier1,
   CIR_MANY_TIME_POSTING=mantimepost, CIR_BACKDAYS_POSTING=bkdaypost, CIR_MAX_RETURN_ALLOW=maxterutn, CIR_RETURN_LIMIT_ALLOW=cir_return, CIR_NO_OF_CHQBOUNCE=noofchkbounc, CIR_DAYS_CHQBOUNCE=noofdaychkrec, CIR_RETURN_DAYS=retday, CIR_SUP_ORDER_LIMIT=chngsuppord, DISP_BILLING_CRITERIA=disp_bill, CLSD_BILLING_CRITERIA=clas_bill,MAX_PUBLISHDAYS=max_publishday,BILLNO_PERIODICITY=p_billno_period,
   SPECIALDISC_TRANS_EDIT=spl_trans_edit, SHARING_TRANS=spl_dis_trans_editable, MULTIPACKAGE_SEL_TRANS=mul_pac_sel_trans,SCHEME_MINWORD=shmon_minword, TRADE_SPLCHARGE=tradon_spcrg,RATE_AUTHORIZATION=rateauth
  ,F2_RECORD=f2day,PUBLISHAD_EDIT_RATEAUDIT=rateauditmodify,BINDREVENUE_CENTER=bindrevenuecenter,  
  FA_LEDGER_ALLOW=p_led_allow ,CLEARANCE_TYPE_ALLOW=p_clear_allow,REPEAT_DAY_TYPE=repeatday,PREMIUM_EDIT=premiumedit,
BILL_GENERATION_PRIOR=P_BILL_GENERATION,PUBLICATION_HO=P_PUBLICATION_CENTER,SPLDISC_ALLOWPREM=P_allow_discount_prem,

BILL_SCHEME=P_SCHEME_BILLING,ALLOWED_PDC_DAYS_RECEIPT=P_ALLOW_PDC ,AD_TYPE_MANUL_BILL=PAD_TYPE_FOR_MANUL_BILL,OUTSTANDING_AMT_CRITERIA=RO_OUTSTAND_P,GENRATE_CIR_AGCD=genrate_agency_code,DISP_AUDITBKG=p_dispauditbk,CIR_DIS_AUTO_POSTING=p_aotosupply,RELAUTHREQON=p_Authorization,
CIR_AUTO_APPROVAL_UNSOLD=p_CIR_AUTO_APPROVAL_UNSOLD,CIR_AUTO_PHYSICAL_UNSOLD=p_CIR_AUTO_PHYSICAL_UNSOLD,CIR_UNSOLD_INCLUDE_INCT=p_CIR_UNSOLD_INCLUDE_INCT,
CIR_UNSOLD_INCLUDE_INSFEE=p_CIR_UNSOLD_INCLUDE_INSFEE,CIR_UNSOLD_ON_RECEIVED_DT=p_CIR_UNSOLD_ON_RECEIVED_DT

  
   WHERE "comp_code"=compcode;
COMMIT;
END      Wesp_Updatedate_p;
END      Wesp_Updatedate;
/







////////////**********************************************************************************************************/


CREATE OR REPLACE PACKAGE Currbindpreferpgld
IS
   TYPE t_account_cursor IS REF CURSOR;

   PROCEDURE currbindpreferpgld_p (
      compcode     IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   );
END Currbindpreferpgld;
/





CREATE OR REPLACE PACKAGE BODY Currbindpreferpgld
IS
   PROCEDURE currbindpreferpgld_p (
      compcode     IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   )
   AS
   BEGIN
      OPEN p_accounts FOR
         SELECT "date_format", "autogenerated", "currency_code",
                "rate_gr_code", "solo", "breakup", "blackwhitecode",
                "rostatus", "File_name", "Tfn", "Insert_breakup", "prefix",
                "suffix", "financestatus", "voucherst", "Ad_category",
                "Ro_datetime", "Vat", "Booking_status", "Cio_id",
                "Receipt_no","uom_code","Bgcolor_publication","chkfor_valid_pubdates","Agency_ratecode","audit","book_insert_date","agencycomm",
                "rate_audit","bill_audit","billtype","Premium_type","copy_booking","RATE_COMPANY_AGENCY","ADDITIONAL_AGENCY_COMM","AGENCY_RETAINER_COMM","SUBEDITIONRATE",CLS_BILLTYPE,DIS_BILLTYPE,
                "BILLING_FORMAT","RATE_CHECK","ALL_PACKAGE",dayrate,SCHEME_TYPE,DISP_CLSBILL,RECEIPT_FORMAT,CASH_RECEIPT_BILL, BILL_ORDERWSLAST, FLOOR_CHK,
                ROKEYCHECK, AGENCYCOMM_SEQ_COM, CREDIT_RECIPT,  DISP_CASHBILL, CLA_CASHBILL,
                RATE_AUDIT_PREF,BARCODING_ALLOWED, FMG_BILL_DIS,BILL_DISP_CASHBILL, BILL_CLA_CASHBILL,BACKDATERECEIPT,ROWISE_CASHBOOKING,CUTOFFTIME,DOCKIT_BOOKING,APPROVAL,BACK_DAYS,CASH_DISCOUNT,CASH_DISCOUNTTYPE,"Allowed_old_date",SEPRATE_CASHIER,
                CIR_MANY_TIME_POSTING, CIR_BACKDAYS_POSTING, CIR_MAX_RETURN_ALLOW, CIR_RETURN_LIMIT_ALLOW, CIR_NO_OF_CHQBOUNCE, CIR_DAYS_CHQBOUNCE, CIR_RETURN_DAYS, CIR_SUP_ORDER_LIMIT, DISP_BILLING_CRITERIA, CLSD_BILLING_CRITERIA,MAX_PUBLISHDAYS,
                BILLNO_PERIODICITY, SPECIALDISC_TRANS_EDIT, SHARING_TRANS, MULTIPACKAGE_SEL_TRANS,SCHEME_MINWORD, TRADE_SPLCHARGE,RATE_AUTHORIZATION,
           F2_RECORD,PUBLISHAD_EDIT_RATEAUDIT,BINDREVENUE_CENTER, FA_LEDGER_ALLOW,CLEARANCE_TYPE_ALLOW,REPEAT_DAY_TYPE,PREMIUM_EDIT,
           
           BILL_GENERATION_PRIOR,PUBLICATION_HO,SPLDISC_ALLOWPREM,BILL_SCHEME,ALLOWED_PDC_DAYS_RECEIPT,
           AD_TYPE_MANUL_BILL,OUTSTANDING_AMT_CRITERIA as RO_OUTSTAND,GENRATE_CIR_AGCD,DISP_AUDITBKG,CIR_DIS_AUTO_POSTING,RELAUTHREQON,
        CIR_AUTO_APPROVAL_UNSOLD, CIR_AUTO_PHYSICAL_UNSOLD, CIR_UNSOLD_INCLUDE_INCT, CIR_UNSOLD_INCLUDE_INSFEE, CIR_UNSOLD_ON_RECEIVED_DT   
            FROM PREFERRENCES
          WHERE "comp_code" = compcode;
          
         
   END currbindpreferpgld_p;
END Currbindpreferpgld;
/




/*****************************************************************mimoh 25 nov*******************0005749***************************/




///////////////////////////////////////////issue no. 5723,5724,5725 29/11/2011//////////////////////////////////////

/////////////////////////////////////////body////////////////////////////////////////////////////////////

CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_billing IS
  procedure cir_billing_agency_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

        open p_accounts for
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              ((upper(a.ag_name) like upper(pextra1)||'%') or (pextra1 is null))
        union
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              upper(a.agcd) = upper(pextra1)
        order by ag_name,city_name;

    End cir_billing_agency_list_p;

    procedure cir_billno_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pbillagcd         in varchar2,
      pbilldpcd         in varchar2,
      pbill_freq        in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
      v_bill_frdt date;
      v_bill_todt date;
    Begin
      v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
      v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
      
      open p_accounts for
        select min(billno) MIN_BILLNO,max(billno) MAX_BILLNO from cir_bill_det
            where comp_code=pcomp_code and unit_code=punit_code and billdt >= v_bill_frdt and billdt<=v_bill_todt and
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and publ=nvl(ppubl,publ) and bill_flag=nvl(pbill_freq,bill_flag);
            
    End cir_billno_list_p;
 /*
set serveroutput on;
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
var v7 refcursor;
var v8 refcursor;
var v9 refcursor;
var v10 refcursor;
var v11 refcursor;
var v12 refcursor;
var v13 refcursor;
exec cir_rep_billing.cir_bill_print_punya('SP002','AUR','','M','01-jul-2011','31-jul-2011','AUR1107114','AUR1107114','L0012','0001','','','','','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11,:v12,:v13);
--*/

  procedure cir_bill_print_punya(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pbranchcode     in varchar2,
      pdistcode       in varchar2,  
      ptalukacode     in varchar2,
      pcitycode       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,
      pextra2         in varchar2,
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12    out t_accounts)
    As
      v_bill_frdt     date;
      v_bill_todt     date;
      v_dt            date;
      v_query1        varchar2(32000);
      v_query2        varchar2(32000);
    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ,*/a.agcd agcd,a.dpcd dpcd,a.billno billno,a.billdt billdt,
        min(a.bill_frdt) frdt,max(a.bill_todt) todt,nvl(sum(bill_sec_amt),0) bill_sec_amt  
        from cir_bill a,cir_agmast b
                where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                    a.agcd=b.agcd and a.dpcd=b.dpcd and ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                    /*((a.publ=ppubl) or (ppubl is null)) and*/ a.agcd=nvl(pbillagcd,a.agcd) and
                    a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                    (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                    (b.city_code =pcitycode or pcitycode is null) and a.bill_flag=pbill_freq and nvl(a.bill_copy,0)>0 
            group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,a.billno,a.billdt
            order by comp_code,unit_code,/*publ,*/billdt,billno,agcd,dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_det is
        select distinct publ,edtn from cir_bill_det
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and billdt=rec_bill.billdt and billno=rec_bill.billno and
              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd
        union
        select distinct publ,edtn
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and 
              recptdt>=v_bill_frdt and recptdt<=v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
              order by publ,edtn;
rec_det cur_det%rowtype;
              
    cursor cur_dbksup is
        select comp_code,unit_code,publ,edtn,supdate,copy_rate,
        sum(supply_copy) supply_copy from(select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup_resale d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        0 supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        minus
        select comp_code comp_code,unit_code unit_code,publ publ,edtn edtn,recptdt supdate,copy_rate copy_rate,
        0 supply_copy
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate))
    group by comp_code,unit_code,publ,edtn,supdate,copy_rate
    order by comp_code,unit_code,publ,edtn,supdate;
rec_dbksup cur_dbksup%rowtype;

    cursor cur_unsold is
        select comp_code,unit_code,publ,edtn,recptdt,copy_rate,sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) return_copy
        from cir_unsold_dtl
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate
    order by comp_code,unit_code,recptdt,publ,edtn,copy_rate;
rec_unsold cur_unsold%rowtype;

      cursor cur_publ_edtn is
            select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_bill_det a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
        ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null)
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_unsold_dtl a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null) and
        (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0
        order by comp_code,unit_code,publ_code,edtn;

        v1 cur_publ_edtn%rowtype;

        v_edtn_cnt        number(5):=0;
        vvar              varchar2(8000);
        vvar_name         varchar2(8000);
        vvar1             varchar2(8000);
        vvar2             varchar2(8000);
        vvar3             varchar2(8000);
        vvar33            varchar2(8000);
        vvar4             varchar2(8000);
        vvar5             varchar2(8000);
        vvar6             varchar2(8000);
        vvar7             varchar2(8000);
        vvar8             varchar2(8000);
        vvar11            varchar2(8000);
        sum_vvar          varchar2(8000);
        sum_vvar1         varchar2(8000);
        sum_vvar2         varchar2(8000);
        sum_vvar3         varchar2(8000);
        sum_vvar33        varchar2(8000);
        sum_vvar4         varchar2(8000);
        sum_vvar5         varchar2(8000);
        sum_vvar6         varchar2(8000);
        sum_vvar7         varchar2(8000);
        sum_vvar8         varchar2(8000);
        sum_vvar11        varchar2(8000);
        vtot_publ         varchar2(8000);
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_sec_opbal        number(14,2):=0;
        v_sec_pbal       number(14,2):=0;
        v_sec_rcpt        number(14,2):=0;
        v_sec_dn          number(14,2):=0;
    cursor cur_exist_edtn is
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.billno billno,a.billdt billdt,a.edtn edtn 
        from cir_bill_det a,cir_agmast b
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                a.agcd=b.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                (b.city_code =pcitycode or pcitycode is null) and 
                nvl(a.bill_copy,0)>0 and a.bill_flag=pbill_freq 
         union
        select distinct a.comp_code comp_code,a.unit_code unit_code,c.billno billno,c.billdt billdt,a.edtn edtn 
        from cir_unsold_dtl a,cir_agmast b,cir_bill c
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and
            a.unit_code=c.unit_code and 
            a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and c.billdt >= v_bill_frdt and c.billdt<=v_bill_todt and
            ((c.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
            a.agcd=b.agcd and a.agcd=c.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=c.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
            (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
            (b.city_code =pcitycode or pcitycode is null) and 
            (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0 and 
            c.bill_flag=pbill_freq         
            order by comp_code,unit_code,billdt,billno;
    rec_exist_edtn cur_exist_edtn%rowtype;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date

        --delete from test1;commit;

        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        
        Open cur_bill;---main cursor bill
        Loop
          fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
              end if;
            open cur_det;
            loop
                fetch cur_det into rec_det;
                exit when cur_det%notfound;
                
                Open cur_dbksup;
                fetch cur_dbksup into rec_dbksup;
                if cur_dbksup%notfound then

                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select max(comm_rate) comm_rate,max(sur_rate) sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt between v_bill_frdt and v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and  
                              publ=rec_det.publ and edtn=rec_det.edtn;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    v_gross_amt   :=0;
                    v_comm_amt    :=0;
                    v_sur_amt     :=0;

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 v_dt,0,0,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                else
                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select comm_rate,sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt >= v_bill_frdt and billdt<=v_bill_todt and billdt=rec_bill.billno and
                              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                              publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and
                              rec_dbksup.supdate >= fromdt and rec_dbksup.supdate<=todt;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    
                        v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                        v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*(v_comm_rate/100)),2),0);
                        v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);
                    

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                end if;
            Close cur_dbksup;
            
            
            Open cur_unsold;
            loop
                fetch cur_unsold into rec_unsold;
                exit when cur_unsold%notfound;
                
                    insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_unsold.recptdt,rec_unsold.return_copy,rec_unsold.copy_rate,0,0,0,0,0,
                                 userenv('sessionid'));
                                 
                                 v_return_copy:=nvl(v_return_copy,0)+nvl(rec_unsold.return_copy,0);
                                 
                                 rec_unsold.recptdt:=null;rec_unsold.return_copy:=null;rec_unsold.copy_rate:=null;
                    

                    
            end loop;
            Close cur_unsold;
            if nvl(v_return_copy,0)=0 then
                insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                             v_dt,0,0,0,0,0,0,0,
                             userenv('sessionid'));     
                    
            end if;
            v_return_copy:=0;v_return_amt:=0;            
            
            End loop;
            close cur_det;
            
        v_dt:=v_dt+1;
        End Loop;--close loop for date

            v_opbal     :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_dbcramt from
            (select sum(amount) amount from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctyp='BIL' and 
                    billdt>= v_opdate and billdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd 
            union all
            select sum(amount) amount from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctype<>'BIL' and 
                    recptdt>= v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd);

            select sum(amount) into v_dbamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount>0;

            select sum(amount) into v_cramt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype not in('RCR','UCN') and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount<0;

            select sum(amount) into v_recamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='RCR' and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            select sum(amount) into v_sec_pbal from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and 
                recptdt>=v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_sec_pbal:=nvl(v_sec_pbal,0)+nvl(v_sec_opbal,0);
            
            select sum(amount) into v_sec_rcpt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype<>'DN' and 
                recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
                      
            select sum(amount) into v_sec_dn from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype='DN' and
                      recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_dbamt:=nvl(v_dbamt,0)-nvl(rec_bill.bill_sec_amt,0);

            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,
            bill_amt,return_amt,country_code)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal,
            nvl(v_sec_rcpt,0),nvl(v_sec_pbal,0),v_sec_dn);
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));        
        End Loop;
        Close cur_bill;
        --delete from test1;delete searchtbl;commit;
    open cur_publ_edtn;
    loop
        fetch cur_publ_edtn into v1;
      exit when cur_publ_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
        if vvar is null then
            vvar        :='decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :='nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :='nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            --sum_vvar33   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :='nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :='nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :='decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :='nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :='nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :='nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :='sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :='"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN IF ',sum_vvar3);commit;
          else
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :=vvar_name||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :=vvar1||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :=sum_vvar1||',nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :=vvar2||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy*u.supply_rate))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :=sum_vvar2||',nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :=vvar3||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33      :=vvar33||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            --sum_vvar33  :=sum_vvar33||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :=vvar4||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :=sum_vvar4||',nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :=vvar5||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :=sum_vvar5||',nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :=vvar6||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :=vvar6||',decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :=sum_vvar6||',nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :=vvar7||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :=sum_vvar7||',nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :=vvar8||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :=sum_vvar8||',nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            --vvar    :=vvar||',decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_Supply"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :=vvar1||',sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :=vtot_publ||',"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN ELSE ',sum_vvar3);commit;
          end if;
          v_edtn_cnt:=nvl(v_edtn_cnt,0)+1;
            
          insert into cir_temp_suppliment(comp_code,unit_code,seq_no,edition_code,sess_id)
          values(v1.comp_code,v1.unit_code,v_edtn_cnt,v1.edtn,userenv('sessionid'));
           
        end loop;
        close cur_publ_edtn;
        
        open cur_exist_edtn;
        loop
            fetch cur_exist_edtn into rec_exist_edtn;
            exit when cur_exist_edtn%notfound;

            --select seq_no into v_exist_edtn from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            --edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid');  
            
            update cir_temp_bill_collection set remarks=remarks||'#'||(select seq_no from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid'))
            where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and billno=rec_exist_edtn.billno and billdt=rec_exist_edtn.billdt and
                  cur_sessionid=userenv('sessionid');
        end loop;
        close cur_exist_edtn;
        update cir_temp_bill_collection set remarks=substr(remarks,2,length(remarks)) where cur_sessionid=userenv('sessionid');        
        --COMMIT;
        
        --insert into test1(vstring,vstring2) values(' billing var3 ',vvar3);commit;
       
        --insert into searchtbl(search) values(' billing first '||pcomp_code||' , '||punit_code||' , '||pbill_freq||' , '||pfrom_billno||' , '||ptill_billno||' , '||v_bill_frdt||' , '||v_bill_todt||' , '||pbillagcd||' , '||pbilldpcd||' , '||ppubl );commit;
        open p_accounts  for
        select z.comp_code comp_code,z.unit_code unit_code,z.agcd agcd,z.dpcd dpcd,z.ag_name ag_name,z.ag_name_oth_lang ag_name_oth_lang,
        z.addr1 addr1,z.addr2 addr2,z.addr3 addr3,z.city_name city_name,
        initcap(z.taluka_name) taluka_name,initcap(z.dist_name) dist_name,
        z.state_name state_name,z.pin_code pin_code,z.billno billno,z.billdt billdt,
        z.bill_copy bill_copy,z.gross_amount gross_amount,
        z.sur_amount sur_amount,z.comm_amount comm_amount,z.bill_amount bill_amount,z.bill_sec_amt bill_sec_amt,
        z.edtn_remark edtn_remark,z.return_amt return_amt,
        (select name from cir_ag_con_per where comp_code=z.comp_code and unit=z.unit_code and agcd=z.agcd and dpcd=z.dpcd and rownum<2) contact_person_name
        from(select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,
        cir_get_taluka(b.comp_code,a.tehsil_taluka) taluka_name,cir_get_dist(b.comp_code,a.state_code,a.dist_code) dist_name,
        cir_get_state(b.comp_code,a.country_code,a.state_code) state_name,a.pin_code pin_code,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,sum(b.bill_sec_amt) bill_sec_amt,
        min(c.remarks) edtn_remark,(select nvl(sum(d.copy_amt),0) return_amt from cir_unsold_dtl d 
        where b.comp_code=d.comp_code and b.unit_code=d.unit_code and d.doctype='UCN' and d.recptdt >= v_bill_frdt and d.recptdt<=v_bill_todt and
        b.agcd=d.agcd and b.dpcd=d.dpcd and (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0) return_amt        
        --,bill_frdt,bill_todt,bill_flag,bill_remark
        from cir_agmast a,cir_bill b,cir_temp_bill_collection c
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit=b.unit_code and a.unit=c.unit_code and 
        b.unit_code=punit_code and b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and  
        b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        /*((b.publ=ppubl) or (ppubl is null)) and */a.agcd=b.agcd and a.dpcd=b.dpcd and b.branch_code=nvl(pbranchcode,b.branch_code) and 
        (a.dist_code =pdistcode or pdistcode is null) and (a.tehsil_taluka =ptalukacode or ptalukacode is null) and 
        (a.city_code =pcitycode or pcitycode is null) and b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and 
        c.billno=b.billno and c.billdt=b.billdt and c.cur_sessionid=userenv('sessionid')
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,
        a.city_code,a.tehsil_taluka,a.dist_code,a.country_code,a.state_code,a.pin_code,b.billno,b.billdt) z
        order by z.comp_code,z.unit_code,z.billdt,z.billno,z.agcd,z.dpcd;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day,'||sum_vvar||' from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,to_char(supply_date,''dd'') sup_day ,'||vvar||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts1'||v_query1);commit;

        open p_accounts1 for v_query1;
                
        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar1||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar1||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts2  '||v_query1);commit;

        open p_accounts2 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar2||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar2||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts3  '||v_query1);commit;

        open p_accounts3 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO,'||sum_vvar3||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,SRLNO,'||vvar3||','||vvar33||'
        from (select comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate, sum(return_copy) return_copy ,
        ROW_NUMBER( ) OVER (PARTITION BY
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code ORDER BY 
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code) SRLNO
        from cir_bill_return_print 
        where comp_code='||''''||pcomp_code||''''||' and unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate) u
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,SRLNO)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts4 ',v_query1);commit;
        open p_accounts4 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar4||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar4||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts5',v_query1);commit;

        open p_accounts5 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar5||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar5||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts6',v_query1);commit;

        open p_accounts6 for v_query1;

        v_query1:='select comp_code,unit,billno,billdt,agcd,dpcd,'||sum_vvar6||' 
        from (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.publ publ,u.edtn edtn,u.agcd agcd,u.dpcd dpcd,'||vvar6||'
        from cir_bill_det u,cir_agmast m
        where u.comp_code='||''''||pcomp_code||''''||' and u.comp_code=m.comp_code and u.unit_code=m.unit and u.unit_code='||''''||punit_code ||''''||' and u.billdt >='||''''||v_bill_frdt||''''||' and u.billdt <='||''''||v_bill_todt||''''||' and ((billno between '||''''||pfrom_billno||''''||' and '||''''||ptill_billno||''''||') or ('||''''||pfrom_billno||''''||' is null)) and
        u.agcd=m.agcd and u.agcd=nvl('||''''||pbillagcd||''''||',u.agcd) and u.dpcd=nvl('||''''||pbilldpcd||''''||',u.dpcd) and 
        u.bill_flag='||''''||pbill_freq||''''||' and u.branch_code=nvl('||''''||pbranchcode||''''||',u.branch_code) and (m.dist_code ='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka ='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and (m.city_code ='||''''||pcitycode||''''||' or '||''''||pcitycode||''''||'is null)
        group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts7',v_query1);commit;
        open p_accounts7 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar7||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar7||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts8',v_query1);commit;
        open p_accounts8 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar8||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar8||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts9',v_query1);commit;

        open p_accounts9 for v_query1;

        open p_accounts10 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance",
        nvl(return_amt,0) as "Deposit Previous Balance",nvl(bill_amt,0) as "Cuurent Deposit",to_number(country_code) as "Deposit Debit Amt",
        abs(nvl(return_amt,0)+nvl(bill_amt,0)+nvl(to_number(country_code),0)) as "Deposit Balance"
        from cir_temp_outstanding
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts11 for 
        select distinct h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
        h.agcd agcd,h.dpcd dpcd,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        m.billno billno,m.billdt billdt, h.remark remark 
        from cir_rcphdr h,cir_bill_print m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=punit_code  and h.unit_code=m.unit_code and 
        h.doctype in('CN','DN') and h.recptdt >=v_bill_frdt and h.recptdt<=v_bill_todt and h.achd='NM' and h.amount<>0 and
        h.agcd=m.agcd and h.dpcd=m.dpcd and h.reason!='SEC DEBIT' and cur_sessionid=userenv('sessionid') 
        order by m.billdt,m.billno,agcd,dpcd,h.recptdt,recptno;
        
        open p_accounts12 for select sysdate from dual;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');commit;
        --delete from cir_temp_outstanding; commit;
                
    End cir_bill_print_punya;


  procedure cir_bill_print_bhaskar(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,--for Agency Class
      pextra2         in varchar2,--for Agency Type
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12     out t_accounts)
    As
      v_bill_frdt         date;
      v_bill_todt         date;
          v_dt            date;
         v_query1        varchar2(8000);
      v_query2        varchar2(8000);
    cursor cur_bill is
        select distinct b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt,min(b.bill_frdt) frdt,max(b.bill_todt) todt from cir_bill b,cir_agmast m
                where b.comp_code=m.comp_code and b.comp_code=pcomp_code and b.unit_code=nvl(punit_code,b.unit_code) and b.unit_code=m.unit and 
                b.billdt between v_bill_frdt and v_bill_todt and
                b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                            b.publ=nvl(ppubl,b.publ) and b.agcd=nvl(pbillagcd,b.agcd) and b.agcd=m.agcd and
                            b.dpcd=nvl(pbilldpcd,b.dpcd) and b.dpcd=m.dpcd and (m.ag_class=pextra1 or pextra1 is null) and
                            (m.ag_type=pextra2 or pextra2 is null) 
            group by b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt
            order by b.comp_code,b.unit_code,b.publ,b.billdt,b.billno,b.agcd,b.dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_dbksup is
        select d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate copy_rate,d.comm_fix_auto_spl,d.comm_code,sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast s
        where d.comp_code=s.comp_code and d.comp_code=rec_bill.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_bill.publ and
              d.supdate=v_dt and d.billagcd=rec_bill.agcd and d.billdpcd=rec_bill.dpcd and
              d.sup_type_code=s.sup_ty_code and upper(s.bill_pay)='Y'
    group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code
    order by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate;
rec_dbksup cur_dbksup%rowtype;

      cursor cur_publ_edtn is
            select distinct comp_code,unit_code,publ_code,cir_get_publ_name(comp_code,publ_code) publ_name,edtn_code edtn,cir_get_edtn_name(comp_code,edtn_code) edtn_name
            from cir_bill_print
        where cur_sessionid=userenv('sessionid') and comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
                    ((publ_code=ppubl) or (ppubl is null)) and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbillagcd or pbillagcd is null)
        order by comp_code,unit_code,publ_code,edtn_code;

        v1 cur_publ_edtn%rowtype;
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date
        --delete from test1;commit;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
            end if;

            Open cur_dbksup;
                Loop
              fetch cur_dbksup into rec_dbksup;
              exit when cur_dbksup%notfound;

                select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0 return_amt into v_return_copy,v_return_amt
                from cir_unsold_dtl
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                      recptdt=rec_dbksup.supdate and publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and agcd=rec_bill.agcd and
                      dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;

                v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                v_comm_rate   :=0;
                v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*v_comm_rate),2),0);
                v_sur_rate    :=0;
                v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);

                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           return_copy,return_amt,cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                             rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                             v_return_copy,v_return_amt,userenv('sessionid'));
               End loop;
            Close cur_dbksup;

            v_dt:=v_dt+1;
            End Loop;--close loop for date
            v_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,'','')+
                      cir_accounts.cir_agency_ytodt(rec_bill.comp_code,rec_bill.unit_code,NULL,rec_bill.agcd,rec_bill.dpcd,v_opdate,rec_bill.frdt,'NM',pdateformat,'','');

            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and billdt >= rec_bill.frdt and billdt<=rec_bill.todt/* and
                      publ=rec_bill.publ*/;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                            agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.todt and
                            doctyp<>'BIL' and achd='NM' /*and publ=rec_bill.publ*/;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp='RCR' and achd='NM' /*and publ=rec_bill.publ*/;

            v_opbal:=nvl(v_opbal,0)+NVL(V_recamt,0);--nvl(v_billamt,0)+nvl(v_dbcramt,0);

            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',/*rec_bill.publ,*/
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal);
        
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));
            v_opbal:=0;v_billamt:=0;v_dbcramt:=0;v_dbamt:=0;v_cramt:=0;v_recamt:=0;            
        End Loop;
        Close cur_bill;
     --delete from test1;commit;

      --insert into test1(vstring,vstring2) values(' billing ',vvar);commit;

        open p_accounts  for
        select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,
        (select max(d.comm_rate) from cir_bill_det d where d.comp_code=b.comp_code and d.unit_code=b.unit_code and d.agcd=b.agcd and 
        d.dpcd=b.dpcd and d.billno=b.billno and d.billdt=b.billdt) comm_rate   
        --,bill_frdt,bill_todt,bill_flag,bill_remark
                    from cir_agmast a,cir_bill b
        where a.comp_code=pcomp_code and a.unit=b.unit_code and b.unit_code=nvl(punit_code,b.unit_code) and b.billdt between v_bill_frdt and v_bill_todt and
                    b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    b.publ=nvl(ppubl,b.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and (a.ag_class=pextra1 or pextra1 is null) and
                            (a.ag_type=pextra2 or pextra2 is null) 
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,a.city_code,b.billno,b.billdt
        order by b.comp_code,b.unit_code,b.billdt,b.billno,b.agcd,b.dpcd;

        open p_accounts1 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate copy_rate,sum(supply_copy) supply from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,u.supply_rate supply_rate,sum(u.supply_copy) supply_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt,u.supply_rate)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd;

        open p_accounts2 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(supply_copy) tot_supply,sum(gross) gross_amt,sum(return_copy) return_copy,sum(return_amt) return_amt,
        sum(tot_amt) tot_amt,sum(tot_comm) tot_comm ,sum(tot_surcharge) tot_surcharge,sum(net_amt) net_amt
        from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.supply_copy) supply_copy,
        sum(u.gross_amt) gross,sum(u.return_copy) return_copy,sum(u.return_amt) return_amt,sum(u.gross_amt-u.return_amt) tot_amt,sum(u.comm_amt) tot_comm,
        sum(u.sur_amt) tot_surcharge,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts3 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(gross) gross_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt) gross
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts4 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_copy) return_copy from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_copy) return_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts5 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_amt) return_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_amt) return_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts6 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_amt) tot_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt) tot_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts7 for 
        select comp_code,unit,billno,billdt,agcd,dpcd,sum(tot_comm) tot_comm from 
        (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.comm_amt) tot_comm
        from cir_bill_det u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd;

        open p_accounts8 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_surcharge) tot_surcharge from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.sur_amt) tot_surcharge
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts9 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(net_amt) net_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts10 for 
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance"
        from cir_temp_outstanding
        where comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
        dt between v_bill_frdt and v_bill_todt;
        
        open p_accounts11 for
        select comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate,sum(bill_copy) bill_copy,sum(nvl(copy_rate,0)*nvl(bill_copy,0)) gross_amt 
        from cir_bill_det 
        where comp_code=pcomp_code and unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and 
        ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
         group by comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate
         order by comp_code,unit_code,billdt,billno,agcd,dpcd;
         
        open p_accounts12 for
        select distinct b.comp_code comp_code,b.unit_code unit_code,b.billno billno,b.billdt billdt,b.agcd agcd,b.dpcd dpcd,
        (select nvl(sum(a.sup_copy),0) from cir_dbksup a,cir_supply_type_mast s 
        where b.comp_code=a.comp_code and s.comp_code=a.comp_code and a.unit_code=b.unit_code and b.publ=a.publ and
        a.edtn =b.edtn and a.sup_type_code=s.sup_ty_code and s.bill_pay='N' and 
        a.supdate between v_bill_frdt and v_bill_todt and --between b.fromdt and  b.todt and 
        a.billagcd =b.agcd and a.billdpcd=b.dpcd) unpaid_copy
        from cir_bill_det b
        where b.comp_code=pcomp_code and b.unit_code=punit_code and 
        (b.publ=ppubl or ppubl is null) and
        (b.agcd=pbillagcd or pbillagcd is null) and (b.dpcd=pbilldpcd or pbilldpcd is null) and
        b.billdt between trunc(v_bill_frdt,'MM') and v_bill_todt
        order by b.comp_code,b.unit_code,b.billno,b.billdt,b.agcd,b.dpcd;

    End cir_bill_print_bhaskar;
    
  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt  date;
    v_todt  date;
    v_start_date    date;
        cursor cur_not_supply is
            select distinct u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date>= v_start_date  and d.supply_date<=v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;        
                
    rec_agcd cur_agcd%rowtype;

        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;

   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
    if v_frdt=v_start_date then
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;
    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;
        --insert into test1(vstring,vstring2) values('Weekly bill1 ',rec_not_supply.agcd||rec_not_supply.dpcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;    

    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            --insert into test1(vstring,vstring2) values('Weekly bill1 ',v_opbal||' , '||rec_agcd.billagcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and
                      agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and billdt >= v_opdate and billdt<v_frdt;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            --insert into test1(vstring,vstring2) values('Weekly bill ',v_opbal||' , '||rec_agcd.billagcd);
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,abs(v_recamt),v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;
        
     open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",
        sum(nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)) as "TOTAL_COPY",sum(nvl(p01,0)*nvl(sup_rate,0)+nvl(p02,0)*nvl(sup_rate,0)+nvl(p03,0)*nvl(sup_rate,0)+nvl(p04,0)*nvl(sup_rate,0)+nvl(p05,0)*nvl(sup_rate,0)+nvl(p06,0)*nvl(sup_rate,0)+nvl(p07,0)*nvl(sup_rate,0)) as "TOTAL_AMT",
        sum(daily_return) as "DAILY_RETURN",sum(sun_return) as "SUN_RETURN"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        d.supply_rate sup_rate,d.comm_rate,
        case when to_char(d.supply_date,'d')='1' then SUM(return_copy) else 0  end sun_return,
        case when to_char(d.supply_date,'d')<>'1' then SUM(return_copy) else 0 end daily_return  
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate,d.comm_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,publ,edtn;
    
    open p_accounts1 for
    select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
    dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
    return_amt as "Deposit Balance"
    from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
    in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')) 
    order by comp_code,unit_code,agname;    

    open p_accounts2 for 
    select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
    h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
    case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
    else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
    h.remark remark 
    from cir_rcphdr h,cir_agmast m
    where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and 
    h.doctype in('CN','DN') and h.recptdt >=v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
    h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
    (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
    (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
    (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
    order by m.ag_name,h.recptdt,h.recptno;
    
    open p_accounts3 for 
    select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
    sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
    where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and 
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')
    group by comp_code,unit_code,agcd,dpcd
    order by comp_code,unit_code,agency_name,agcd,dpcd;

    open p_accounts4 for select sysdate from dual;

    open p_accounts5 for select sysdate from dual;
    open p_accounts6 for select sysdate from dual;
    open p_accounts7 for select sysdate from dual;
    open p_accounts8 for select sysdate from dual;
    open p_accounts9 for select sysdate from dual;
    
    open p_accounts10 for select sysdate from dual;
    
    --delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
    --delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 error ');commit;
    
    
   End cir_before_bill_print_p1;

/*
  set serveroutput on;
  var v1 refcursor;
  var v2 refcursor;
  var v3 refcursor;
  var v4 refcursor;
  var v5 refcursor;
  var v6 refcursor;
  var v7 refcursor;
  var v8 refcursor;
  var v9 refcursor;
  var v10 refcursor;
  var v11 refcursor;
  exec cir_rep_billing.cir_before_bill_print_p2('SP002','AUR','','','','','','','','B0052','0001','01-nov-2010','07-nov-2010','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11);
  */
  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt          date;
    v_todt          date;
    v_start_date    date;
    
    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
        
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date between v_start_date and v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        d.cur_sessionid=userenv('sessionid') and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;       
    rec_agcd cur_agcd%rowtype;
    
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;   
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;
   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p2 ', pbillagcd||pbilldpcd);commit; 
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
        
    if v_frdt=v_start_date then
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;
    
    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code  and billdt >= v_opdate and 
                billdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,v_recamt,v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;    
        
        open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,
        cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",sum(gross_amt) as "TOTAL_AMT",
        sum(u01) as "SUN_RET",sum(u02) as "MON_RET",sum(u03) as "TUE_RET",sum(u04) as "WED_RET",sum(u05) as "THU_RET",sum(u06) as "FRI_RET",sum(u07) as "SAT_RET",sum(return_gross_amt) as "RETURN_TOTAL_AMT"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,d.supply_rate sup_rate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        sum(nvl(d.supply_copy,0)*nvl(d.supply_rate,0)) gross_amt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.return_copy,0)) else 0 end u01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.return_copy,0)) else 0 end u02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.return_copy,0)) else 0 end u03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.return_copy,0)) else 0 end u04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.return_copy,0)) else 0 end u05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.return_copy,0)) else 0 end u06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.return_copy,0)) else 0 end u07,        
        sum(nvl(d.return_copy,0)*nvl(d.supply_rate,0)) return_gross_amt
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date <=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,billagcd,billdpcd,publ,edtn;
    
        open p_accounts1 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
        return_amt as "Deposit Balance"
        from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
        in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
        supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid'))
        order by comp_code,unit_code,agname,agcd,dpcd;    

        open p_accounts2 for 
        select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        h.remark remark 
        from cir_rcphdr h,cir_agmast m
        where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and h.recptdt >= v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
        h.doctype in('CN','DN') and h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
        (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
        (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
        order by m.ag_name,h.agcd,h.dpcd,h.recptdt,h.recptno;
    
        open p_accounts3 for 
        select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
        where comp_code=pcompcode and unit_code=punitcode and supply_date >= v_frdt and supply_date<=v_todt and 
        agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid')
        group by comp_code,unit_code,agcd,dpcd
        order by comp_code,unit_code,agency_name,agcd,dpcd;
        
        open p_accounts4 for 
        select comp_code,unit_code,billagcd,billdpcd,agency_name,
        abs(sum(p01)) as "SUN",abs(sum(p02)) as "MON",abs(sum(p03)) as "TUE",abs(sum(p04)) as "WED",abs(sum(p05)) as "THU",abs(sum(p06)) as "FRI",abs(sum(p07)) as "SAT",
        abs(sum(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0))) as "TOT_RECEIPT_AMT"
        from(
        select d.comp_code comp_code,d.unit_code unit_code,d.agcd billagcd,d.dpcd billdpcd,case when plangtype='1' then m.ag_name else m.ag_name_oth_lang  end agency_name,d.supply_date recptdt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.rec_amt,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.rec_amt,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.rec_amt,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.rec_amt,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.rec_amt,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.rec_amt,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.rec_amt,0)) else 0 end p07
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and cur_sessionid=userenv('sessionid') 
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.supply_date)
        group by comp_code,unit_code,billagcd,billdpcd,agency_name
        order by comp_code,unit_code,agency_name,billagcd,billdpcd;

        open p_accounts5 for select sysdate from dual;
        open p_accounts6 for select sysdate from dual;
        open p_accounts7 for select sysdate from dual;
        open p_accounts8 for select sysdate from dual;
        open p_accounts9 for select sysdate from dual;
        open p_accounts10 for select sysdate from dual;
            
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;

    insert into ERRORMESSAGE(message) values('Weekly bill print p2 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p2 error ');commit;        
   End cir_before_bill_print_p2;
       
    procedure cir_bill_register_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      ppubl         in varchar2,
      repty         in varchar2,--Is is used State(1)/District(2)/Taluka(3)
      pbill_freq    in varchar2,
      pfrom_billdt  in varchar2,
      ptill_billdt  in varchar2,
      pbillagcd     in varchar2,
      pbilldpcd     in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,--State or district or Taluka Code
      pextra2       in varchar2,
      p_accounts    out t_accounts)
    As
        vfrdt date;
        vtodt date;
        v_statecode   varchar2(20);
        v_distcode    varchar2(20);
        v_citycode    varchar2(20);
        v_taluka      varchar2(20);        
    Begin
        --delete from test1;insert into test1(vstring,vstring2) values('cir bill register ','pcomp_code '||pcomp_code||','||punit_code||','||ppubl||','||repty||','||pbill_freq||','||pfrom_billdt||','||ptill_billdt||','||pbillagcd||','||pbilldpcd||','||pdateformat||','||pextra1||','||pextra2);commit;
        if repty='1' then--State
            v_statecode:=pextra1;
        elsif repty='2' then    --District
            v_distcode:=pextra1;
        elsif repty='3' then    --Taluka
            v_taluka:=pextra1;
        else--City
            v_citycode:=pextra1;
        end if;        
        vfrdt:=to_date(pfrom_billdt,''''||pdateformat||'''');
        vtodt:=to_date(ptill_billdt,''''||pdateformat||'''');

        if nvl(repty,'N')='1' then--for state
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,agency_name,billdt,billno;
        elsif nvl(repty,'N')='2' then --for district
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_dist(b.comp_code,m.state_code,m.dist_code) AS "DIST_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.dist_code
            order by comp_code, state_name,dist_name,agency_name,billdt,billno;        
        elsif nvl(repty,'N')='3' then---for taluka
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_taluka(b.comp_code,m.tehsil_taluka) as "TALUKA_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.tehsil_taluka
            order by comp_code, state_name,taluka_name,agency_name,billdt,billno;        
        else---for city
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,"CITY NAME",agency_name,billdt,billno;        
        end if;
        
     End cir_bill_register_p;

/*
var v1 refcursor;
exec cir_rep_billing.cir_billing_outstanding_p('SP002','AUR','','M','01-nov-2010','30-nov-2010','','','','dd/mm/yyyy','','',:v1);
*/
    procedure cir_billing_outstanding_p(
            pcomp_code      in varchar2,
            punit_code      in varchar2,
            repty           in varchar2,
            pbill_freq      in varchar2,
            pfrom_billdt    in varchar2,
            ptill_billdt    in varchar2,
            ppubl           in varchar2,
            pbillagcd       in varchar2,
            pbilldpcd       in varchar2,
            pdateformat     in varchar2,
            pbrancode       in varchar2,
            pdistcode       in varchar2,
            pagclass        in varchar2,
            pextra1         in varchar2,--for executive code
            pextra2         in varchar2,
            p_accounts      out t_accounts,
            p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);
      
    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ publ,*/a.agcd agcd,a.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        /*a.billno billno,a.billdt billdt,*/sum(a.bill_copy) supply_copy,sum(a.gross_amount) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        c.bill_sec_amt bill_sec_amt
        from cir_bill_det a,cir_agmast b,cir_bill c
            where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and 
                  a.unit_code=b.unit and a.unit_code=c.unit_code and
                  a.unit_code=nvl(punit_code,a.unit_code) and
                  a.billdt=c.billdt and a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and a.billno=c.billno and 
                  (a.bill_flag=pbill_freq or pbill_freq is null) and a.publ=nvl(ppubl,a.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                  a.agcd=c.agcd and a.dpcd=c.dpcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  (b.ag_class=pagclass or pagclass is null) and 
                  (b.state_code=v_statecode or v_statecode is null) and (b.dist_code=v_distcode or v_distcode is null) and 
                  (b.tehsil_taluka=v_taluka or v_taluka is null) and (b.branch_code=pbrancode or pbrancode is null) and
                  (b.city_code=v_citycode or v_citycode is null) and (b.executive_code = pextra1 or pextra1 is null)
                  group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka,c.bill_sec_amt/*,a.billno,a.billdt*/
                  order by a.comp_code,a.unit_code,/*a.billdt,a.billno,*/a.agcd,a.dpcd/*,a.publ*/;
        v1 cur_bill%rowtype;
      
      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_billno          varchar2(20);
        v_bildt           date;
        v_frdt            date;
        v_todt            date;
        v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_opdate          date;
        v_state_name      varchar2(200);
        v_dist_name       varchar2(200);
        v_taluka_name     varchar2(200);
        v_city_name       varchar2(200);
    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');
    
    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then    
        v_distcode:=pdistcode;
    elsif repty='C' then    
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;
    
    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit; 
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;
            
            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt into 
            v_ret_copy,v_ret_gross,v_ret_comm from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and process_crdt >= v_bill_frdt and process_crdt<=v_bill_todt and agcd=v1.agcd and 
                dpcd=v1.dpcd and process_crno is not null/*and publ=v1.publ*/;
            
            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_rcphdr
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and doctype<>'BIL' and recptdt>=v_opdate and recptdt<v_bill_frdt and achd='NM') ;
            
            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            
            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC';
            
            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                else
                    if v2.doctyp='RCR' then   
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;
            
            v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;           
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            /*v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
            begin
                v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
            exception when others then
                v_taluka_name   :='N/A';
            end;    
            v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);*/
                        
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd, 
            supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,        
            agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
               values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v1.country_code,v1.bill_sec_amt,v_sec_bal);
    
            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name:=null;v_dist_name:=null;v_taluka_name:=null;v_city_name:=null;
        End Loop;
        Close cur_bill;
        commit;
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0))  net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name;            
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name,ag_name;     

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,
            a.state_code state_name,
            sum(a.supply_copy) supply_code,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;
            
        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code,a.city_code
            order by comp_code,unit_code,state_name,district_name,city_name,ag_name;  
            
            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,a.comm_amt comm_amt,(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;   

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;            
        end if;
        
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    End cir_billing_outstanding_p;    

    procedure cir_unitwise_p(
        pcomp_code    in varchar2,
        punit_code    in varchar2,
        ppubl_code    in varchar2,
        pbill_freq    in varchar2,
        pfrom_billdt  in varchar2,
        ptill_billdt  in varchar2,
        pdateformat   in varchar2,
        pextra1       in varchar2,
        pextra2       in varchar2,
        p_accounts    out t_accounts) as
        vquery varchar2(4000);
        vquery_all varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
        cursor cur_mon is select distinct mon_date,to_char(mon_date,'Mon-YY') mon  from col_dates;
        rec_mon cur_mon%rowtype;
      Begin
        vquery:=null;
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        delete from col_dates;commit;
        insert into col_dates (mon_date) (select distinct trunc(billdt,'MM') from cir_bill
                                                where comp_code=pcomp_code and
                                                      ((unit_code=punit_code) or (punit_code is null)) and
                                                      ((publ     =ppubl_code) or (ppubl_code is null)) and
                                                      ((bill_flag=pbill_freq) or (pbill_freq is null)) and
                                                      billdt between v_bill_frdt and v_bill_todt);
         open cur_mon;
           loop
              fetch cur_mon into rec_mon;
                /*vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||',
                          to_date('||''''||rec_mon.mon_date||''''||','||''''||pdateformat||''''||'))'||'"'||rec_mon.mon||'",';*/
                exit when cur_mon%notfound;
                vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||','||''''||rec_mon.mon_date||''''||') "'||rec_mon.mon||'",';
           end loop;
         close cur_mon;
         vquery:=substr(vquery,1,length(vquery)-1);
         if vquery is null then
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name from cir_bill a,pub_cent_mast b
                    where a.comp_code=b."Comp_Code" and a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         else
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name,'||vquery||' from cir_bill a,pub_cent_mast b
                    where /*a.comp_code=b."Comp_Code" and */a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         end if;                                                         
          --insert into test1(vstring) values(vquery_all);commit;
          open p_accounts for vquery_all;
      End cir_unitwise_p;

      procedure cir_billing_rate_p (
        pcomp_code            in varchar2,
        punit_code            in varchar2,
        ppubl                 in varchar2,
        pagcd                 in varchar2,
        pdpcd                 in varchar2,
        BILLNO_FROM           in varchar2,
        BILLNO_TO             in varchar2,
        pfrom_billdt          in varchar2,
        ptill_billdt          in varchar2,
        pdateformat           in varchar2,
        pextra1               in varchar2,
        pextra2               in varchar2,
        p_accounts            out t_accounts,
        p_accounts1           out t_accounts,
        p_accounts2           out t_accounts,
        p_accounts3           out t_accounts)
    AS
        vquery   varchar2(4000);
        vquery1  varchar2(4000);
        vquery2  varchar2(4000);
        vquery3  varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

           open p_accounts for
           select comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy,(copy_rate*bill_copy) AS "TOTAL"
               from cir_bill_det
                where comp_code=pcomp_code and unit_code=punit_code
                and BILLDT  between v_bill_frdt and v_bill_todt
                and ((publ=ppubl ) or (ppubl is null))
                and ((agcd=pagcd) or (pagcd is null))
                and ((dpcd=pdpcd) or (pdpcd is null))
                group by comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy;

          vquery1 := vquery1||'SELECT SUM(a.SUP_COPY),a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd
                            from cir_dbksup a,cir_bill_det b
                            where a.COMP_CODE='''||pcomp_code||'''
                            and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                            and ((a.publ='''||ppubl||''' ) or ('''||ppubl||'''  is null))
                            and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||'''  is null))
                            and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||'''  is null))   AND
                            a.AGCD || a.DPCD =b.AGCD || b.DPCD  AND
                            a.UNIT_CODE=b.UNIT_CODE AND
                            b.COMP_CODE=a.COMP_CODE
                            AND (b.PUBL='''||ppubl||''' OR '''||ppubl||''' IS NULL)
                            and b.BILLDT  between '''||v_bill_frdt||''' and '''||v_bill_todt||'''
                            AND a.SUPDATE BETWEEN  b.FROMDT AND  b.TODT
                            AND a.EDTN =b.EDTN
                            and a.SUP_TYPE_CODE IN
                            (SELECT cir_supply_type_mast.SUP_TY_CODE FROM cir_supply_type_mast WHERE cir_supply_type_mast.BILL_PAY=''N''
                            AND cir_supply_type_mast.COMP_CODE=a.COMP_CODE AND a.SUP_TYPE_CODE=cir_supply_type_mast.SUP_TY_CODE )
                            group by a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd';
                        --   INSERT INTO SEARCHTBL VALUES(vquery1);COMMIT;
                        open p_accounts1 for
                       vquery1;

        vquery2 := vquery2||'SELECT SUM(a.AMOUNT) as "CREDIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                             from cir_outmast a
                             where a.COMP_CODE='''||PCOMP_CODE||'''
                             and( a.unit_code='''||punit_code||'''  or '''||punit_code||'''  IS NULL)
                             and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                             and ((a.publ='''||ppubl||''' ) or ('''||ppubl||''' is null))
                             and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||''' is null))
                             and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                             a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                             WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                           --AND b.PUBL=a.PUBL
                             AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                             and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                             a.DOCTYP in(''UCN'',''CN'') and a.achd<>''SC''
                             group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

                             open p_accounts2 for
                                  vquery2;

         vquery3 := vquery3||'SELECT SUM(a.AMOUNT) as "DEBIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO, a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                                from cir_outmast a
                                where a.COMP_CODE='''||PCOMP_CODE||'''
                                and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                                and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                                and ((a.publ='''||ppubl||'''  ) or ('''||ppubl||'''  is null))
                                and ((a.agcd='''||pagcd||'''  ) or ('''||pagcd||'''  is null))
                                and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                                a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                                WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                                --AND b.PUBL=a.PUBL
                                AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                                and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                                a.DOCTYP in(''DN'') and a.achd<>''SC''
                                group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

        open p_accounts3 for vquery3;

     End  cir_billing_rate_p;

  Procedure cir_before_bill_process_p(
    pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2)
  As
       ln_count           number;
       vsrch_amt           number;                                
       --bill_no               varchar2(20) ;
       daily_gross_amount number(15,2);
       daily_net_amount   number(15,2);
       tot_surcharge_amt  number(15,2);
       vcomm_per           number;
       vcomm_amt           number(15,2);
       curr_bilagcd           varchar2(30) := 'DUMMY_CURR';
       prev_bilagcd       varchar2(30) := 'DUMMY_PREV';
       curr_record           varchar2(100):= 'DUMMY_CURR'; --new add
       prev_record           varchar2(100):= 'DUMMY_PREV'; --new add
       tot_copy           number := 0;
       vbill_no            varchar2(20);
       vid                   number;
       v_frdt               date;
       v_todt               date;
       v_billdt           date;
        
       v_agcd_sec_per  number:=0;v_agcd_sec_amt_limt number:=0;
        
        v_sec_limit     number(10,2);
        v_bill_dbn_amt  number(10,2);
        v_bill_sec_amt  number(10,2);
        v_remark varchar2(200);
        v_reptno varchar2(25);
        v_rec_no            number(10);
        v_daily_comm_amt    number(15,2);
        v_daily_sur_amt     number(15,2);
        v_daily_gross_amt   number(15,2);
        v_daily_bill_amt    number(15,2);
        v_return_copy       number(10);
        v_return_amt        number(10,2);
      cursor agency_cur is
            /*select distinct m.comp_code comp_code,m.unit unit,m.agcd bill_agcd,m.dpcd bill_dpcd from 
            (select distinct a.comp_code,a.unit,a.bill_agcd,a.bill_dpcd
            from cir_agmast a
            where  a.comp_code = pcomp_code and a.unit     = punit_code and 
            a.agcd||a.dpcd in (select distinct agcd||dpcd agcdpdcd from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct agcd||dpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) and 
            a.bill_agcd=nvl(pbillagcd,a.bill_agcd) and a.bill_dpcd=nvl(pbilldpcd,a.bill_dpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y') u,cir_agmast m
            where u.comp_code = m.comp_code and u.comp_code = pcomp_code and u.unit=m.unit and u.unit = punit_code and 
            u.bill_agcd=m.agcd and u.bill_dpcd=m.dpcd and
            (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and 
            (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
            (m.branch_code=pbranchcode or pbranchcode is null)
            order by m.comp_code,m.unit,m.agcd,m.dpcd;*/
            select distinct x.comp_code comp_code,x.unit_code unit,x.billagcd bill_agcd,x.billdpcd bill_dpcd 
            from(select u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billagcd,u.billdpcd 
            from(select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd  from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) u,cir_agmast a
            where a.comp_code=u.comp_code and a.unit=u.unit_code and a.agcd=u.agcd and a.dpcd=u.dpcd and
            u.billagcd=nvl(pbillagcd,u.billagcd) and u.billdpcd=nvl(pbilldpcd,u.billdpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y' and
            (a.ag_type=pagencytype or pagencytype is null) and (a.ag_class=pagencyclass or pagencyclass is null) and 
            (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and 
            (a.branch_code=pbranchcode or pbranchcode is null))x
            order by x.comp_code,x.unit_code,x.billagcd,x.billdpcd; 

    agency_rec agency_cur%rowtype;
    
        cursor cur_supply is 
        select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.comm_fix_auto_spl comm_fix_auto_spl,
        u.comm_code comm_code,u.sup_rate sup_rate,u.supdate supdate,u.surch_cd surch_cd,sum(u.sup_copy) sup_copy from 
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
        d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0
            union all
             select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
                    d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup_resale d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0) u 
        where u.comp_code = agency_rec.comp_code and u.unit_code = agency_rec.unit and 
                u.agcd=agency_rec.bill_agcd and u.dpcd=agency_rec.bill_dpcd/*u.agcd||u.dpcd in (select agcd||dpcd from cir_agmast 
                        where comp_code = agency_rec.comp_code and unit = agency_rec.unit and
                              bill_agcd = agency_rec.bill_agcd and
                              bill_dpcd = agency_rec.bill_dpcd)*/
       group by u.comp_code,u.unit_code,u.publ,u.edtn,u.comm_fix_auto_spl,u.comm_code,u.sup_rate,u.supdate,u.surch_cd;
       rec_supply cur_supply%rowtype;

       avg_sup number;
       
       cursor comm_auto is select * from cir_comm_mast
            where comp_code = pcomp_code and
                  unit_code = punit_code and
                  publ = rec_supply.publ and
                  edtn = rec_supply.edtn and
                  comm_type = rec_supply.comm_fix_auto_spl and
                  comm_catg_code = rec_supply.comm_code and  
                  valid_from = (select max(valid_from) from cir_comm_mast
                                     where comp_code = pcomp_code and
                                           unit_code = punit_code and
                                           publ = rec_supply.publ and
                                           edtn = rec_supply.edtn and
                                           comm_type = rec_supply.comm_fix_auto_spl and
                                           comm_catg_code = rec_supply.comm_code and  
                                           valid_from <= v_billdt and
                                           avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0)) and
                  avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0);
        rec_comm_auto comm_auto%rowtype;          
       
       cursor comm_fix_spl is select * from cir_comm_mast
                                where comp_code = pcomp_code and
                                      unit_code = punit_code and
                                      publ = rec_supply.publ and
                                      edtn = rec_supply.edtn and
                                      comm_type = rec_supply.comm_fix_auto_spl and
                                      comm_catg_code = rec_supply.comm_code and  
                                      valid_from = (select max(valid_from) from cir_comm_mast
                                                         where comp_code = pcomp_code and
                                                               unit_code = punit_code and
                                                               publ = rec_supply.publ and
                                                               edtn = rec_supply.edtn and
                                                               comm_type = rec_supply.comm_fix_auto_spl and
                                                               comm_catg_code = rec_supply.comm_code and  
                                                               valid_from <= rec_supply.supdate);
        rec_comm_fix_spl comm_fix_spl%rowtype;          
                  
       cursor cur_surcharge is select * from cir_surcharge_mast 
                where comp_code  = pcomp_code and 
                      unit       = punit_code and
                      publ       = rec_supply.publ and
                      edtn       = rec_supply.edtn and
                      surch_cd   = rec_supply.surch_cd and 
                      valid_from = (select max(valid_from) from cir_surcharge_mast 
                                                where comp_code  = pcomp_code and 
                                                      unit       = punit_code and
                                                      publ       = rec_supply.publ and
                                                      edtn       = rec_supply.edtn and
                                                      surch_cd   = rec_supply.surch_cd and
                                                      valid_from<= rec_supply.supdate);
       rec_surcharge cur_surcharge%rowtype;
       
       v_bran_code cir_agmast.branch_code%type;
       v_rec_amt number:=0;
       v_rcp_count number:=0;

    Begin
        v_frdt         :=to_date(pfrdt,''''||pdateformat||'''');
        v_todt         :=to_date(ptodt,''''||pdateformat||'''');
        v_billdt     :=v_todt;
    Begin

        open agency_cur; 
        loop 
            fetch agency_cur into agency_rec;
            exit when agency_cur%notfound;
            
            curr_bilagcd := agency_rec.bill_agcd ||agency_rec.bill_dpcd;
            curr_record  := agency_rec.bill_agcd ||agency_rec.bill_dpcd/*||agency_rec.publ*/;
       ---------------------------------------------- add new code ------------------------------------------------------
            if curr_record <> prev_record then
                daily_gross_amount  := 0;
                tot_copy            := 0;
                tot_surcharge_amt   := 0;
                vsrch_amt           :=0;
                vcomm_amt           :=0;
            end if;

            open cur_supply;
            loop 
                fetch cur_supply into rec_supply;
                exit when cur_supply%notfound;
                tot_copy := nvl(tot_copy,0) + nvl(rec_supply.sup_copy,0) ;
                daily_gross_amount := nvl(daily_gross_amount,0)  + nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                v_daily_gross_amt:=nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                if rec_supply.comm_fix_auto_spl!='A' then
                    open comm_fix_spl;
                    fetch comm_fix_spl into rec_comm_fix_spl;
                    
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vcomm_per:= rec_comm_fix_spl.sun_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vcomm_per:= rec_comm_fix_spl.mon_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday commition rate
                        vcomm_per:= rec_comm_fix_spl.tue_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday commition rate
                        vcomm_per:= rec_comm_fix_spl.wed_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday commition rate
                        vcomm_per:= rec_comm_fix_spl.thu_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday commition rate
                        vcomm_per:= rec_comm_fix_spl.fri_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday commition rate
                        vcomm_per:= rec_comm_fix_spl.sat_comm_rate;
                    else
                        vcomm_per:=    0;
                    end if;
                    rec_comm_fix_spl.sun_comm_rate:=0; rec_comm_fix_spl.mon_comm_rate:=0; rec_comm_fix_spl.tue_comm_rate:=0;
                    rec_comm_fix_spl.wed_comm_rate:=0;rec_comm_fix_spl.thu_comm_rate:=0; rec_comm_fix_spl.fri_comm_rate:=0;
                    rec_comm_fix_spl.sat_comm_rate:=0;                                     
                    if nvl(rec_comm_fix_spl.comm_catg_type,'N')='P' then
                        vcomm_amt:=nvl(vcomm_amt,0) + (nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                        v_daily_comm_amt:=(nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_fix_spl.comm_catg_type,'N')='C' then
                        vcomm_amt:= nvl(vcomm_amt,0) + nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                        v_daily_comm_amt:=nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                    else
                        vcomm_amt:=0;
                        v_daily_comm_amt:=0;
                    end if;
                    close comm_fix_spl;   
                end if; 
                            
                open cur_surcharge;
                fetch cur_surcharge into rec_surcharge;
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vsrch_amt:= rec_surcharge.sun_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vsrch_amt:= rec_surcharge.mon_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday surcharge rate
                        vsrch_amt:= rec_surcharge.tue_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday surcharge rate
                        vsrch_amt:= rec_surcharge.wed_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday surcharge rate
                        vsrch_amt:= rec_surcharge.thu_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday surcharge rate
                        vsrch_amt:= rec_surcharge.fri_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday surcharge rate
                        vsrch_amt:= rec_surcharge.sat_rate;
                    else
                        vsrch_amt:=    0;
                    end if;
                close cur_surcharge;    
                
                tot_surcharge_amt   :=  nvl(tot_surcharge_amt,0) + nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_sur_amt     :=  nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_bill_amt    :=  nvl(v_daily_gross_amt,0)+nvl(v_daily_sur_amt,0)-nvl(v_daily_comm_amt,0);
                
                If pextra1 is null then
                    select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
                        from cir_unsold_dtl
                        where comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and doctype='UCN' and
                            app_dt=rec_supply.supdate and publ=rec_supply.publ and edtn=rec_supply.edtn and agcd=agency_rec.bill_agcd and
                            dpcd=agency_rec.bill_dpcd and copy_rate=rec_supply.sup_rate and
                             (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                                
                    select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
                        where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and
                            agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and recptdt = rec_supply.supdate and
                            doctype='RCR' and achd='NM';
                            
                    select count(*) into v_rcp_count from cir_bill_return_print
                        where cur_sessionid=userenv('sessionid') and comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and 
                            receipt_date=rec_supply.supdate and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd;
                    if nvl(v_rcp_count,0)>0 then
                        v_rec_amt:=0; 
                    else
                        insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
                        values(rec_supply.comp_code,rec_supply.unit_code,agency_rec.bill_agcd,agency_rec.bill_dpcd,rec_supply.supdate,v_rec_amt);
                    end if;
                End if;
        
                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                   supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                   return_copy,return_amt,cur_sessionid,rec_amt)
                                        values(rec_supply.comp_code,rec_supply.unit_code,null,v_billdt,rec_supply.publ,rec_supply.edtn,agency_rec.bill_agcd,agency_rec.bill_dpcd,
                             rec_supply.supdate,rec_supply.sup_copy,rec_supply.sup_rate,nvl(v_daily_gross_amt,0),nvl(vcomm_per,0),nvl(v_daily_comm_amt,0),nvl(vsrch_amt,0),nvl(v_daily_sur_amt,0),
                             v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                v_rec_amt:=0;v_rcp_count:=0;
            end loop; 
            avg_sup:=nvl(tot_copy,0);

            if rec_supply.comm_fix_auto_spl = 'A' then
                 --cal_avg_copy(agency_rec.bilagcd,agency_rec.bildpcd,agency_rec.publ);
                if tot_copy > 0 then 
                    open comm_auto;
                    fetch comm_auto into rec_comm_auto;
                    vcomm_per :=  rec_comm_auto.sun_comm_rate;
                    if nvl(rec_comm_auto.comm_catg_type,'N')='P' then
                          vcomm_amt:=nvl(daily_gross_amount,0)*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_auto.comm_catg_type,'N')='C' then
                          vcomm_amt:=nvl(tot_copy,0)*nvl(vcomm_per,0);
                    else
                          vcomm_amt:=0;
                    end if;      
                    close comm_auto;
                end if;
            end if;
           
           close cur_supply;
           daily_net_amount := nvl(daily_gross_amount,0) + nvl(tot_surcharge_amt,0) - nvl(vcomm_amt,0);
           vbill_no         :=nvl(vbill_no,0)+1;
           --vbill_no:=cir_generate_billno(agency_rec.comp_code,agency_rec.unit,v_billdt,pdateformat,'','');

           if nvl(tot_copy,0) > 0 then
             Begin
                 select abs(sum(amount)) into v_sec_limit from cir_rcphdr 
                      where comp_code=  agency_rec.comp_code and
                            unit_code=  agency_rec.unit and
                            agcd     =  agency_rec.bill_agcd and
                            dpcd     =  agency_rec.bill_dpcd and
                            recptdt  <= v_todt and
                            achd     =  'SC';
                      exception when others then
                            v_sec_limit:=0;
             End;

            select distinct security_per,sec_amt_limt,branch_code into v_agcd_sec_per,v_agcd_sec_amt_limt,v_bran_code from cir_agmast 
              where comp_code = pcomp_code and unit = punit_code and agcd=agency_rec.bill_agcd and 
                    dpcd=agency_rec.bill_dpcd;
             
             if nvl(v_agcd_sec_per,0)>0 then
                 if nvl(v_agcd_sec_amt_limt,0)>nvl(v_sec_limit,0) then
                    v_bill_dbn_amt:=nvl(v_agcd_sec_per,0)*nvl(daily_net_amount,0)/100;
                 end if;
                 if nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0)<nvl(v_bill_dbn_amt,0) then
                    v_bill_sec_amt:=nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0);
                 else
                    v_bill_sec_amt:=nvl(v_bill_dbn_amt,0);
                 end if;
                if nvl(v_bill_sec_amt,0)<0 then
                    v_bill_sec_amt:=0;
                end if;
             end if;
            
            update cir_bill_print set billno=vbill_no,sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;

            /*update cir_bill_print set sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;*/
           
            v_sec_limit      :=0; v_bill_dbn_amt:=0; v_bill_sec_amt   :=0;
            v_remark         :='';v_reptno      :='';v_rec_no         :=0; 
            v_daily_comm_amt :=0; v_daily_sur_amt:=0;v_daily_gross_amt:=0;
            v_daily_bill_amt :=0;
           end if;
       end loop;
    close agency_cur;
    commit;
    End;  
  
  End cir_before_bill_process_p;
  
  procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,--for executive code
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_start_date  date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);

    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate 
            from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcomp_code and d.unit_code=m.unit and d.unit_code=punit_code and 
                d.doctype='UCN' and d.agcd=m.agcd  and d.dpcd=m.dpcd and d.app_dt >= v_start_date  and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and 
                d.app_dt<=v_bill_todt and  (m.ag_class=pagclass or pagclass is null) and (m.dist_code=v_distcode or v_distcode is null) and 
                (m.tehsil_taluka=v_taluka or v_taluka is null) and d.supply_copy>0 and (m.branch_code=pbrancode or pbrancode is null) and
                (m.executive_code = pextra1 or pextra1 is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date  and supply_date<=v_bill_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
    cursor cur_bill is
        select distinct x.comp_code comp_code,x.unit_code unit_code,x.agcd agcd,x.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        sum(x.supply_copy) supply_copy,sum(x.gross_amount) gross_amount,sum(x.sur_amount) sur_amount,sum(x.comm_amount) comm_amount,
        sum(x.bill_sec_amt) bill_sec_amt from
        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        sum(a.supply_copy) supply_copy,sum(a.gross_amt) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        sum(a.sec_amt) bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_bill_frdt and a.supply_date<=v_bill_todt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.publ_code=nvl(ppubl,a.publ_code) and a.cur_sessionid=userenv('sessionid')
                  group by a.comp_code,a.unit_code,a.agcd,a.dpcd
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        0 supply_copy,0 gross_amount,0 sur_amount,0 comm_amount,0 bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_start_date and a.supply_date<v_bill_frdt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.cur_sessionid=userenv('sessionid') and a.publ_code=nvl(ppubl,a.publ_code)) x,cir_agmast b
                  where x.comp_code=b.comp_code and x.unit_code=b.unit and x.agcd=b.agcd and x.dpcd=b.dpcd
                  group by x.comp_code,x.unit_code,x.agcd,x.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka
                  order by x.comp_code,x.unit_code,x.agcd,x.dpcd;
        v1 cur_bill%rowtype;
      
      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_city_name       varchar2(100);
        --v_billno          varchar2(20);
        --v_bildt           date;
        
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        --v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX'; 

       v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_psecamt         number(15,2):=0;
        v_csecamt         number(15,2):=0;  
        v_opdate          date;
        v_bill_exist      number(5);

        v_pbillret        number(15,2):=0;
        v_state_name        varchar2(200);
        v_dist_name         varchar2(200);
        v_taluka_name       varchar2(200);

    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');
    v_start_date    :=trunc(v_bill_frdt,'mm');
    
    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then
        v_distcode:=pdistcode;
    elsif repty='C' then
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');

    
    select count(*) into v_bill_exist from cir_bill_det b,cir_publ_mast p 
        where b.comp_code=pcomp_code and b.comp_code = p.comp_code and b.unit_code=punit_code and 
            b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and b.publ =p.publ and 
            (b.agcd=nvl(pbillagcd,b.agcd) or pbillagcd='') and (b.dpcd=nvl(pbilldpcd,b.dpcd) or pbilldpcd='');
    
    if v_bill_frdt=v_start_date then
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_bill_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    end if;    
    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit; 
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date and supply_date<=v_bill_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcomp_code and unit_code=punit_code and 
                supply_date>= v_start_date and supply_date<=v_bill_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and app_dt=rec_not_supply.supply_date and 
                publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_bill_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;v_rec_amt:=0;
    end loop;
    close cur_not_supply;
    
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;

            select sum(u.tot_return),sum(u.gross_amt),sum(u.comm_amt) into v_ret_copy,v_ret_gross,v_ret_comm from
            (select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt  
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and process_crno is null/*and publ=v1.publ*/
            union
            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt 
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and 
                process_crno is not null /*and publ=v1.publ*/) u;
                
            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp <>'BIL' and recptdt>=v_opdate and recptdt<v_start_date and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp<>'UCN' and recptdt>=v_start_date and recptdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd);
            
            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            
            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
             agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC' ;
            
            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);

            select sum(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)),abs(sum(sec_amt)) into v_pbillret,v_psecamt 
            from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date>=v_start_date and supply_date<v_bill_frdt and  
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                            
            select abs(sum(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date >= v_bill_frdt and supply_date<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                
            if nvl(v_bill_exist,0)=0 then
                v_sec_bal   :=nvl(v_sec_bal,0)-nvl(v_psecamt,0)-nvl(v_csecamt,0);
            else
                v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_psecamt,0);
            end if;
            
            v_prev_bal      :=nvl(v_prev_bal,0)+nvl(v_pbillret,0)+nvl(v_psecamt,0);
                        
            v_rec_amt:=0;v_pbillret:=0;v_csecamt:=0;v_psecamt:=0;
            
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    if v_bill_exist=0 then
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0)+nvl(v_csecamt,0);
                    else
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                    end if;    
                else
                    if v2.doctyp='RCR' then   
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;

            v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;           
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd, 
            supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,        
            agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
               values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v1.country_code,v1.bill_sec_amt,v_sec_bal);
    
            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name    :=null;v_dist_name     :=null;v_taluka_name   :=null; v_city_name:=null; 
        End Loop;
        Close cur_bill;
        commit;
        
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name;            
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,district_name,ag_name;     

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;
            
        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code,a.city_code
            order by comp_code,unit_code,city_name,ag_name;  
            
            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;   

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;            
        end if;
        
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;        
    End cir_weekly_bill_summary_p;         
End cir_rep_billing;
/

==================================================description======================================================

CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_billing IS
  type t_accounts is ref cursor;
  procedure cir_billing_agency_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_billno_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_bill_print_punya(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,  
    ptalukacode      in varchar2,
    pcitycode        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);  
  
  procedure cir_bill_print_bhaskar(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);

  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);

  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);
        
  procedure cir_bill_register_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_outstanding_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);

  procedure cir_unitwise_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_rate_p (
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    BILLNO_FROM     in varchar2,
    BILLNO_TO       in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,  
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts,
    p_accounts2     out t_accounts,
    p_accounts3     out t_accounts);

  Procedure cir_before_bill_process_p(
      pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2);

procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);    
End cir_rep_billing;
/


////////////////////////////////////////////////end of issue no. 5723,5724,5725//////////////////////////////////////////////////////////////////////

/********************** 29 nov 2011 ******************/
CREATE OR REPLACE PACKAGE cir_unsold_credit_note IS
  TYPE T_Circul_Cursor is Ref Cursor;
  procedure cir_unsold_supply_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_fromdate     in varchar2,
      psup_todate         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
  procedure cir_unsold_check_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_date         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdoc_type         in varchar2,
      precptno             in varchar2,
      pmissing_recpt    in varchar2,
      plate_recpt        in varchar2,
      pbnr_recpt        in varchar2,
      punsold            in varchar2,
      pcopy_rate        in varchar2,
      pcomm_per            in varchar2,
      pcomm_type        in varchar2,
      pwaste_flag        in varchar2,
      pwaste_rate         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor,
      p_circuls1         out T_Circul_Cursor);

  procedure cir_unsold_calculation_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      pmissing_recpt    in number,
      plate_recpt        in number,
      pbnr_recpt        in number,
      punsold            in number,
      pcopy_rate        in number,
      pcomm_per            in number,
      pcomm_type        in varchar2,
      pwaste_flag        in varchar2,
      pwaste_rate         in number,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
      
  procedure cir_notapproval_list_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      pdoc_type         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      pextra3               in varchar2,
      p_circuls         out T_Circul_Cursor);
      
  procedure cir_notapproval_unsold_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      pdoc_type         in varchar2,
      precptno             in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);

  procedure cir_unsold_process_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      prec_fromdate     in varchar2,
      prec_todate         in varchar2,
      pagtype_code      in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      puserid           in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
END cir_unsold_credit_note;
/


CREATE OR REPLACE PACKAGE BODY cir_unsold_credit_note IS
  procedure cir_unsold_supply_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_fromdate     in varchar2,
      psup_todate         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,--it is use for datewise or ratewise
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor)
    As
        v_frdt date;
        v_todt date;
    Begin
        v_frdt:=to_date(psup_fromdate,''''||pdateformat||'''');
        v_todt:=to_date(psup_todate,''''||pdateformat||'''');
        if upper(pextra2)='D' then
            open p_circuls for
            select comp_code,unit_code,publ,publ_name,edtn, edtn_name,supply_date, supply_date supply_datemon,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, 
            sum(d.sup_copy) supply_copy,
            /*(select sum(u.sup_copy) from cir_dbksup_dis u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate)*/  sum(d.sup_copy) rate_supply,
            0 as RETURNABLE
            from cir_dbksup_dis d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='D'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code)
            union
            select distinct z.comp_code comp_code,z.unit_code unit_code,z.publ publ,z.publ_name publ_name,z.edtn,z.edtn_name edtn_name,MAX(z.supply_date) supply_date,last_day(trunc(z.supply_date,'mm')) supply_datemon,
            z.copy_rate copy_rate,z.comm_fix_auto_spl comm_fix_auto_spl,z.comm_code comm_code,z.waste_rate waste_rate,
            z.comm_catg_type comm_catg_type,z.comm_rate comm_rate,sum(z.supply_copy) supply_copy,sum(z.supply_copy) rate_supply,RETURNABLE from
            (select distinct comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,
            to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            (select sum(u.sup_copy) from cir_dbksup_dis u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate) rate_supply,
            0 as RETURNABLE
            from cir_dbksup_dis d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='R'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,
                d.sup_rate,d.comm_fix_auto_spl,d.comm_code)) z
                group by z.comp_code,z.unit_code,z.publ,z.publ_name,z.edtn,z.edtn_name,last_day(trunc(z.supply_date,'mm')),
                    z.copy_rate,z.comm_fix_auto_spl,z.comm_code,z.waste_rate,z.comm_catg_type,z.comm_rate,z.RETURNABLE;
        else
            open p_circuls for
            select comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,supply_date supply_datemon,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            /*(select sum(u.sup_copy) from cir_dbksup u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate)*/  
            sum(d.sup_copy) rate_supply,0 as RETURNABLE
            from cir_dbksup d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='D'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code)
            union
            select distinct z.comp_code comp_code,z.unit_code unit_code,z.publ publ,z.publ_name publ_name,z.edtn,z.edtn_name edtn_name,MAX(z.supply_date) supply_date,last_day(trunc(z.supply_date,'mm')) supply_datemon,
            z.copy_rate copy_rate,z.comm_fix_auto_spl comm_fix_auto_spl,z.comm_code comm_code,z.waste_rate waste_rate,
            z.comm_catg_type comm_catg_type,z.comm_rate comm_rate,sum(z.supply_copy) supply_copy,sum(z.supply_copy) rate_supply,RETURNABLE from
            (select distinct comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,
            to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            (select sum(u.sup_copy) from cir_dbksup u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate) rate_supply,
            0 as RETURNABLE
            from cir_dbksup d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='R'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,
                d.sup_rate,d.comm_fix_auto_spl,d.comm_code)) z
                group by z.comp_code,z.unit_code,z.publ,z.publ_name,z.edtn,z.edtn_name,last_day(trunc(z.supply_date,'mm')),
                    z.copy_rate,z.comm_fix_auto_spl,z.comm_code,z.waste_rate,z.comm_catg_type,z.comm_rate,z.RETURNABLE
                order by publ_name,edtn,supply_date;
        end if;
  End cir_unsold_supply_p;
    
  procedure cir_unsold_check_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl_code        in varchar2,
      pedtn_code        in varchar2,
      psup_date         in varchar2,
      pagcd_code        in varchar2,
      pdpcd_code        in varchar2,
      pdoc_type         in varchar2,
      precptno          in varchar2,
      pmissing_recpt    in varchar2,
      plate_recpt       in varchar2,
      pbnr_recpt        in varchar2,
      punsold           in varchar2,
      pcopy_rate        in varchar2,
      pcomm_per         in varchar2,
      pcomm_type        in varchar2,
      pwaste_flag       in varchar2,
      pwaste_rate       in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,--for damaged copies
      pextra2           in varchar2,
      p_circuls         out T_Circul_Cursor,
      p_circuls1        out T_Circul_Cursor)
  As
        v_supdt date;
        v_tot_copy    number;
        v_waste_amt number;
        v_gross_amt number;
        v_comm_amt     number;
        v_total_amt number;
        v_query     varchar2(2000);
  Begin
        v_supdt:=to_date(psup_date,''''||pdateformat||'''');
        if upper(pextra2)='D' then
            open p_circuls for
            select nvl(sum(nvl(nvl(apr_short_recpt,0),nvl(short_recpt,0))+nvl(apr_late_recpt,late_recpt)+nvl(nvl(apr_bnr,0),nvl(bnr,0))+nvl(nvl(apr_unsold,0),nvl(unsold,0))+nvl(nvl(apr_damage,0),nvl(damage,0))),0) as total from cir_unsold_dtl_dis
                where comp_code   =pcomp_code and
                      unit_code   =punit_code and
                      doctype     =pdoc_type and
                      publ        =ppubl_code and
                      edtn        =pedtn_code and
                      supdate     =v_supdt and
                      agcd        =pagcd_code and
                      dpcd        =pdpcd_code and
                      recptno     <>nvl(precptno,'/');
        else
            open p_circuls for
            select nvl(sum(nvl(nvl(apr_short_recpt,0),nvl(short_recpt,0))+nvl(apr_late_recpt,late_recpt)+nvl(nvl(apr_bnr,0),nvl(bnr,0))+nvl(nvl(apr_unsold,0),nvl(unsold,0))+nvl(nvl(apr_damage,0),nvl(damage,0))),0) as total from cir_unsold_dtl
                where comp_code   =pcomp_code and
                      unit_code   =punit_code and
                      doctype     =pdoc_type and
                      publ        =ppubl_code and
                      edtn        =pedtn_code and
                      supdate     =v_supdt and
                      agcd        =pagcd_code and
                      dpcd        =pdpcd_code and
                      recptno     <>nvl(precptno,'/');
         end if;

        if nvl(pwaste_flag,'N')='Y' then
            v_waste_amt:=round((nvl(punsold,0)*nvl(pwaste_rate,0)),2);
        else
            v_waste_amt:=0;
        end if;
        
        v_tot_copy:=nvl(pmissing_recpt,0)+nvl(plate_recpt,0)+nvl(pbnr_recpt,0)+nvl(punsold,0)+nvl(pextra1,0);
        
        v_gross_amt :=nvl(v_tot_copy,0)*nvl(pcopy_rate,0);
        
        if pcomm_type='C' then--for per copy rate
            v_comm_amt  :=round((v_tot_copy*nvl(pcomm_per,0)),2);
        else
            v_comm_amt  :=round((v_gross_amt*nvl(pcomm_per,0)/100),2);
        end if;
        
        v_total_amt :=round((v_gross_amt-v_comm_amt-v_waste_amt),2);
        
        --insert into test1(vstring,vstring2) values(' unsold_check_p '||v_tot_copy||' , '|| pcopy_rate , v_comm_amt||' , '||v_total_amt);commit;
        
        v_query:='SELECT '||v_tot_copy||'as "TOTAL_COPY" ,'||v_waste_amt||' as "WASTE_AMOUNT" ,'||v_comm_amt||' as "COMM_AMOUNT" ,'||v_total_amt||' as "TOTAL_AMOUNT" '||' FROM DUAL';
        open p_circuls1 for v_query;
  End cir_unsold_check_p;
    
  procedure cir_notapproval_list_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      pdoc_type     in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,
      pextra2       in varchar2,
      pextra3       in varchar2,
      p_circuls     out T_Circul_Cursor)
  As
  Begin
      if upper(pextra2)='D' then  
        open p_circuls for
        select distinct h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agency_name,
        cir_get_city(h.comp_code,m.city_code) city_name,h.publ publ,cir_get_publ_name(h.comp_code,h.publ) publ_name,h.edtn edtn,
        cir_get_edtn_name(h.comp_code,h.edtn) edtn_name,h.entrydt entrydt,h.frdt frdt,h.todt todt
        from cir_unsold_hdr_dis h,cir_agmast_dis m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=m.unit and h.unit_code=punit_code and h.doctype=pdoc_type and 
        h.agcd=m.agcd and h.dpcd=m.dpcd and (upper(m.ag_name) like upper(pextra1)||'%' or pextra1 is null) and h.app_userid is null
        and (h.recptno=pextra3 or pextra3 is null)
        order by recptdt,recptno,agency_name;
      else
        open p_circuls for
        select distinct h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agency_name,
        cir_get_city(h.comp_code,m.city_code) city_name,h.publ publ,cir_get_publ_name(h.comp_code,h.publ) publ_name,h.edtn edtn,
        cir_get_edtn_name(h.comp_code,h.edtn) edtn_name,h.entrydt entrydt,h.frdt frdt,h.todt todt
        from cir_unsold_hdr h,cir_agmast m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=m.unit and h.unit_code=punit_code and h.doctype=pdoc_type and 
        h.agcd=m.agcd and h.dpcd=m.dpcd and (upper(m.ag_name) like upper(pextra1)||'%' or pextra1 is null) and h.app_userid is null
        and (h.recptno=pextra3 or pextra3 is null)
        order by recptdt,recptno,agency_name;
      end if;
  End cir_notapproval_list_p;
    
  procedure cir_notapproval_unsold_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      pdoc_type     in varchar2,
      precptno      in varchar2,
      pagcd_code    in varchar2,
      pdpcd_code    in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,
      pextra2       in varchar2,
      p_circuls     out T_Circul_Cursor)
    As
    Begin
        if upper(pextra2)='D' then
        open p_circuls for
            select * from cir_unsold_dtl_dis
            where comp_code=pcomp_code and unit_code=punit_code and doctype=pdoc_type and
                        recptno=precptno and agcd=pagcd_code and dpcd=pdpcd_code
            order by recptdt,recptno,supdate;
        else
            open p_circuls for
            select * from cir_unsold_dtl
            where comp_code=pcomp_code and unit_code=punit_code and doctype=pdoc_type and
                        recptno=precptno and agcd=pagcd_code and dpcd=pdpcd_code
            order by recptdt,recptno,supdate;
        end if;
    End cir_notapproval_unsold_p;
    
  procedure cir_unsold_calculation_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl_code        in varchar2,
      pedtn_code        in varchar2,
      pmissing_recpt    in number,
      plate_recpt       in number,
      pbnr_recpt        in number,
      punsold           in number,
      pcopy_rate        in number,
      pcomm_per         in number,
      pcomm_type        in varchar2,
      pwaste_flag       in varchar2,
      pwaste_rate       in number,
      pdateformat       in varchar2,
      pextra1           in varchar2,--for damaged copies
      pextra2           in varchar2,
      p_circuls         out T_Circul_Cursor)
    As
        v_tot_copy    number;
        v_waste_amt number;
        v_gross_amt number;
        v_comm_amt     number;
        v_total_amt number;
        v_query varchar2(2000);
    Begin
        --pcomp_code,punit_code,ppubl_code,pedtn_code this parameter future use
        if nvl(pwaste_flag,'N')='Y' then
            v_waste_amt:=round((nvl(punsold,0)*nvl(pwaste_rate,0)),2);
        else
            v_waste_amt:=0;
        end if;
        
        v_tot_copy:=nvl(pmissing_recpt,0)+nvl(plate_recpt,0)+nvl(pbnr_recpt,0)+nvl(punsold,0)+nvl(pextra1,0);
        
        v_gross_amt :=nvl(v_tot_copy,0)*nvl(pcopy_rate,0);
        if pcomm_type='C' then--for per copy rate
            v_comm_amt  :=round((v_tot_copy*nvl(pcomm_per,0)),2);
        else
            v_comm_amt  :=round((v_gross_amt*nvl(pcomm_per,0)/100),2);
        end if;    
        v_total_amt :=round((v_gross_amt-v_comm_amt-v_waste_amt),2);
        
        v_query:='SELECT '||v_tot_copy||'as "TOTAL_COPY" ,'||v_waste_amt||' as "WASTE_AMOUNT" ,'||v_comm_amt||' as "COMM_AMOUNT" ,'||v_total_amt||' as "TOTAL_AMOUNT" '||' FROM DUAL';
        open p_circuls for v_query;
    End cir_unsold_calculation_p;

/*
var v1 refcursor;
exec cir_unsold_credit_note.cir_unsold_process_p('DB001','JA0','01-oct-2010','31-oct-2010','','','','SH0','dd/mm/yyyy','','',:v1);
*/
    procedure cir_unsold_process_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      prec_fromdate     in varchar2,
      prec_todate         in varchar2,
      pagtype_code      in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      puserid           in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor)
   As
        v_frdt date;
        v_todt date;
        v_doctype varchar2(5):='UCN';
        v_tot_amt NUMBER(15,2):=0;
        v_count number:=0;
        v_dsign number;
        v_recptdt date;
        v_amt   number(15,2);
        cursor c1 is
            select h.comp_code comp_code,h.unit_code unit_code,m.branch_code branch_code,h.agcd agcd,h.dpcd dpcd,
            nvl(sum(d.apr_unsold),0) unsold_copy,nvl(sum(d.apr_bnr),0) missing_copy ,
            nvl(sum(d.apr_late_recpt),0) late_copy,nvl(sum(d.apr_short_recpt),0) short_copy,nvl(sum(d.apr_damage),0) damage_copy,
            sum((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0)) gross_amt,
            nvl(sum(d.comm_amt),0) comm_amt,nvl(sum(d.waste_amt),0) waste_amt,
            sum(((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0))-nvl(d.comm_amt,0)-nvl(d.waste_amt,0)) amount
            from cir_unsold_hdr_DIS h,cir_unsold_dtl_DIS d,cir_agmast_DIS m
            where h.comp_code=pcomp_code and h.comp_code=d.comp_code and h.comp_code=m.comp_code and
            h.unit_code=punit_code and h.unit_code=d.unit_code and h.unit_code=m.unit and h.doctype=v_doctype and h.doctype=d.doctype and 
            h.recptno=d.recptno and h.recptdt=d.recptdt and h.agcd=nvl(pagcd_code,h.agcd) and h.dpcd=nvl(pdpcd_code,h.dpcd) and 
            h.agcd=d.agcd and h.dpcd=d.dpcd and h.agcd=m.agcd and h.dpcd=m.dpcd and (m.ag_type=pagtype_code or pagtype_code is null) and
            h.app_dt >= v_frdt and h.app_dt<=v_todt and h.app_userid is not null and h.process_crno is null and 
            (nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))>0 and upper(nvl(pextra2,'/'))='D'
            group by h.comp_code,h.unit_code,m.branch_code,h.agcd,h.dpcd
            union
            select h.comp_code comp_code,h.unit_code unit_code,m.branch_code branch_code,h.agcd agcd,h.dpcd dpcd,
            nvl(sum(d.apr_unsold),0) unsold_copy,nvl(sum(d.apr_bnr),0) missing_copy ,
            nvl(sum(d.apr_late_recpt),0) late_copy,nvl(sum(d.apr_short_recpt),0) short_copy,nvl(sum(d.apr_damage),0) damage_copy,
            sum((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0)) gross_amt,
            nvl(sum(d.comm_amt),0) comm_amt,nvl(sum(d.waste_amt),0) waste_amt,
            sum(((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0))-nvl(d.comm_amt,0)-nvl(d.waste_amt,0)) amount
            from cir_unsold_hdr h,cir_unsold_dtl d,cir_agmast m
            where h.comp_code=pcomp_code and h.comp_code=d.comp_code and h.comp_code=m.comp_code and
            h.unit_code=punit_code and h.unit_code=d.unit_code and h.unit_code=m.unit and h.doctype=v_doctype and h.doctype=d.doctype and 
            h.recptno=d.recptno and h.recptdt=d.recptdt and h.agcd=nvl(pagcd_code,h.agcd) and h.dpcd=nvl(pdpcd_code,h.dpcd) and 
            h.agcd=d.agcd and h.dpcd=d.dpcd and h.agcd=m.agcd and h.dpcd=m.dpcd and (m.ag_type=pagtype_code or pagtype_code is null) and
            h.app_dt >= v_frdt and h.app_dt<=v_todt and h.app_userid is not null and h.process_crno is null and 
            (nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))>0 and upper(nvl(pextra2,'/'))<>'D'
            group by h.comp_code,h.unit_code,m.branch_code,h.agcd,h.dpcd
            order by comp_code,unit_code,branch_code,agcd,dpcd;
    v1 c1%rowtype;
    v_recptno varchar2(20);
    v_remark varchar2(200);
    Begin
        v_frdt:=to_date(prec_fromdate,''''||pdateformat||'''');
        v_todt:=to_date(prec_todate,''''||pdateformat||'''');
        v_recptdt:=v_todt;
        
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            
            
            select Dsign into v_dsign from cir_docmst where Comp_code=pcomp_code AND doc_type=v_doctype;

            v_amt:=v1.amount*v_dsign;
            v_remark:='Being amount credited against unsold return';
            if nvl(v1.unsold_copy,0)>0 then
                v_remark:=v_remark||' Unsold Copy:- '||v1.unsold_copy;
            end if;
            if nvl(v1.missing_copy,0)>0 then
                v_remark:=v_remark||' Missing Copy:- '||v1.missing_copy;
            end if;
            if nvl(v1.late_copy,0)>0 then
                v_remark:=v_remark||' Late Copy:- '||v1.late_copy;
            end if;
            if nvl(v1.short_copy,0)>0 then
                v_remark:=v_remark||' Short Copy:- '||v1.short_copy;
            end if;
            if nvl(v1.damage_copy,0)>0 then
                v_remark:=v_remark||' Damage Copy:- '||v1.damage_copy;
            end if;
            
            --v_recptno:=cir_genrate_id.receipt_cndn_id_p (pcomp_code,punit_code,v_doctype,to_char(v_recptdt,''''||pdateformat||''''),pdateformat,pextra1,pextra2);
            Begin
                if upper(pextra2)='D' then
                select max(to_number(substr(recptno,-8)))+1 into v_recptno from cir_rcphdr_dis 
                    where comp_code=v1.comp_code  and doctype=v_doctype and to_char(recptdt,'yymm')=to_char(v_recptdt,'yymm') and 
                        branch_code=v1.branch_code;
                else
                select max(to_number(substr(recptno,-8)))+1 into v_recptno from cir_rcphdr 
                    where comp_code=v1.comp_code  and doctype=v_doctype and to_char(recptdt,'yymm')=to_char(v_recptdt,'yymm') and 
                        branch_code=v1.branch_code;                
                end if;
                Exception When Others Then
                    v_recptno:=null;
            End;
    
            If nvl(v_recptno,0)=0 Then
              v_recptno:=v1.branch_code||'-'||to_char(v_recptdt,'yymm')||'0001';
            Else
              v_recptno:=v1.branch_code||'-'||lpad(v_recptno,8,'0');
            End if;
            if upper(pextra2)='D' then
              if v_recptno is not null and nvl(v_amt,0)<>0 then
                  insert into cir_rcphdr_dis(comp_code,unit_code,agcd,dpcd,doctype,
                                         recptno,recptdt,amount,reason,remark,
                                         achd,voucherno,voucherdt,userid,creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v_amt,'UNSOLD CREDIT NOTE',v_remark,
                                         'NM',v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                  insert into cir_rcpdet_dis(comp_code,unit_code,agcd,dpcd,doctyp,
                                         recptno,recptdt,payfor,achd,amount,
                                         reason,remark,voucherno,voucherdt,usrid,
                                         creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v1.branch_code,'NM',v_amt,
                                         'UNSOLD CREDIT NOTE',v_remark,v_recptno,v_recptdt,puserid,
                                         sysdate,v1.branch_code);
                  insert into cir_outmast_dis(comp_code,unit_code,agcd,dpcd,doctyp,
                                          recptno,recptdt,achd,amount,reason,
                                          remark,voucherno,voucherdt,usrid,creation_date,branch_code)
                                   values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                          v_recptno,v_recptdt,'NM',v_amt,'UNSOLD CREDIT NOTE',
                                          v_remark,v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                    v_count     :=nvl(v_count,0)+1;
                    v_tot_amt   :=nvl(v_tot_amt,0)+nvl(v1.amount,0);

                    update cir_unsold_dtl_dis set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null and recptno in(select distinct recptno from cir_unsold_hdr_dis
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null);
                        
                    update cir_unsold_hdr_dis set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null;
              end if;
          else
              if v_recptno is not null and nvl(v_amt,0)<>0 then
                  insert into cir_rcphdr(comp_code,unit_code,agcd,dpcd,doctype,
                                         recptno,recptdt,amount,reason,remark,
                                         achd,voucherno,voucherdt,userid,creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v_amt,'UNSOLD CREDIT NOTE',v_remark,
                                         'NM',v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                  insert into cir_rcpdet(comp_code,unit_code,agcd,dpcd,doctyp,
                                         recptno,recptdt,payfor,achd,amount,
                                         reason,remark,voucherno,voucherdt,usrid,
                                         creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v1.branch_code,'NM',v_amt,
                                         'UNSOLD CREDIT NOTE',v_remark,v_recptno,v_recptdt,puserid,
                                         sysdate,v1.branch_code);
                  insert into cir_outmast(comp_code,unit_code,agcd,dpcd,doctyp,
                                          recptno,recptdt,achd,amount,reason,
                                          remark,voucherno,voucherdt,usrid,creation_date,branch_code)
                                   values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                          v_recptno,v_recptdt,'NM',v_amt,'UNSOLD CREDIT NOTE',
                                          v_remark,v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                    v_count     :=nvl(v_count,0)+1;
                    v_tot_amt   :=nvl(v_tot_amt,0)+nvl(v1.amount,0);

                    update cir_unsold_dtl set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null and recptno in(select distinct recptno from cir_unsold_hdr 
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null);
                        
                    update cir_unsold_hdr set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null;
              end if;
          end if;
        end loop;
        close c1;
        commit;
        open p_circuls for 
        select v_count as "TOTAL_CREDIT_NOTE",v_tot_amt as "TOTAL_CREDIT_NOTE_AMOUNT" from dual;
   End cir_unsold_process_p;
END cir_unsold_credit_note;
/


/*********************** 29 nov 2011 **********************/


/***************************29-nov-2011**********mimoh***************/
 
CREATE OR REPLACE PROCEDURE HT18JULY.cir_bank_guarantee_bind(
   pcomp_code   IN       VARCHAR2,
   pagcd        IN       VARCHAR2,
   pdpcd        IN       VARCHAR2,
   pexpiry_date IN       DATE,
   pexpiry_days IN       NUMBER,
   pextra       IN       VARCHAR2,
   pextra1      IN       VARCHAR2,
   pextra2      IN       VARCHAR2,
   p_accounts   OUT      cur_type_new1.cursor_type
)
IS
v_dt date;
BEGIN
   v_dt := pexpiry_date + nvl(pexpiry_days,0);
   OPEN p_accounts FOR
      SELECT * FROM cir_bank_guarantee
        where comp_code = pcomp_code
          and ((agcd    = pagcd) or (pagcd is null))
          and ((dpcd    = pdpcd) or (pdpcd is null))
          and bg_valid<=v_dt;
END;
/

/***************************29-nov-2011**********mimoh***************/

/**********************Start*****01-dec-2011**Issue no 5718********neha***************/

CREATE OR REPLACE PACKAGE cir_rep_agency_ledger IS
TYPE T_Accounts_Cursor is Ref Cursor;
PROCEDURE cir_agency_ledger_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pactype         in varchar2,
    pbranchcode     in varchar2,
    pagency_type    in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    pstatecode      in varchar2,
    pdistcode       in varchar2,
    pcitycode       in varchar2,
    ptalukacode     in varchar2,
    pfrom_date      in varchar2,
    ptill_date      in varchar2,
    pbilladj_flag   in varchar2,
    psortedby       in varchar2,
    puserid         in varchar2,
    prowbreak       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    P_Accounts      out T_Accounts_Cursor,
    P_Accounts1     out T_Accounts_Cursor);
END cir_rep_agency_ledger;
/
CREATE OR REPLACE PACKAGE BODY ht.cir_rep_agency_ledger IS
PROCEDURE cir_agency_ledger_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pactype         in varchar2,
    pbranchcode     in varchar2,
    pagency_type    in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    pstatecode      in varchar2,
    pdistcode       in varchar2,
    pcitycode       in varchar2,
    ptalukacode     in varchar2,
    pfrom_date      in varchar2,
    ptill_date      in varchar2,
    pbilladj_flag   in varchar2,
    psortedby       in varchar2,
    puserid         in varchar2,
    prowbreak       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,--it is use for agency class
    pextra2         in varchar2,
    P_Accounts      out T_Accounts_Cursor,
    P_Accounts1     out T_Accounts_Cursor)
As
    v_frdt          date;
    v_todt          date;
    v_opdate        date;

    v_opbal         number(15,2):=0;
    v_opbal_sec     number(15,2):=0;
    v_amt           number(15,2):=0;
    v_clbal         number(15,2):=0;
    v_runbal        number(15,2):=0;
    v_billamt       number:=0;
    v_dbcramt       number:=0;
    v_cramt         number(15,2) :=0;
    v_dbamt         number(15,2) :=0;
    v_rec_seqno     number:=0;
    v_remark_len    number:=0;
    v_divident      number:=0;
    v_narration     varchar2(1000);
    v_runbal_txt    varchar2(20);
        cursor c1 is
            select distinct comp_code,unit,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,dist_code,state_code,
            country_code,branch_code from cir_agmast
                where comp_code=pcompcode and (unit=punitcode or punitcode is null) and
                            (ag_type=pagency_type or pagency_type is null) and agcd||dpcd in(select distinct agcd||dpcd from cir_outmast
                            where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and achd=pactype) and
                            (agcd=pagcd or pagcd is null) and (dpcd=pdpcd or pdpcd is null) and (branch_code=pbranchcode or pbranchcode is null) and
                            (state_code=pstatecode or pstatecode is null) and (dist_code=pdistcode or pdistcode is null) and
                            (tehsil_taluka=ptalukacode or ptalukacode is null) and (ag_class=pextra1 or pextra1 is null)
                            order by branch_code,city_code,ag_name;
        v1 c1%rowtype;
       cursor c2 is
        select comp_code,unit_code,agcd,dpcd,doctype,recptno,recptdt,amount,chno,chdt,chbank,reason,narration,received_from from
        (select comp_code,unit_code,agcd,dpcd,doctype,recptno,recptdt,amount,chno,chdt,chbank,
        case when cir_rcphdr.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=cir_rcphdr.reason)
        else (select reason_name from cir_reason_mst where comp_code=cir_rcphdr.comp_code and reason_code=cir_rcphdr.reason) end as reason,
        remark narration,received_from from cir_rcphdr
            where comp_code=v1.comp_code and unit_code=v1.unit and agcd=v1.agcd and dpcd=v1.dpcd and recptdt
                between v_frdt and v_todt and nvl(achd,'NM')=pactype
        union
        select comp_code,unit_code,agcd,dpcd,'BIL' doctype,billno recptno,billdt recptdt,sum(bill_amount) amount,null chno,null chdt,null chbnk,'BILL' reason,
        'Bill Copy '||sum(bill_copy)||' Comm. Amount '||sum(comm_amount) narration,null received_from from cir_bill
            where comp_code=v1.comp_code and unit_code=v1.unit and agcd=v1.agcd and dpcd=v1.dpcd and
                billdt between v_frdt and v_todt and pactype='NM'
                group by comp_code,unit_code,agcd,dpcd,billno,billdt)
        order by recptdt,doctype,recptno;
        v2 c2%rowtype;
    Begin
        v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');--for financial date

        v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
        v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
        v_divident  :=nvl(prowbreak,35);
        delete from cir_ledger_report where sess_id=userenv('sessionid');
        --delete from test1;commit;
        --insert into test1(vstring,vstring2) values('unit outstanding monthwise vvar ',v_months);commit;
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            v_opbal        :=cir_accounts.cir_agency_opbal(pcompcode,punitcode,'',v1.agcd,v1.dpcd,v_opdate,pactype,pdateformat,'','');
            ----for secutiry outstanding---
            if pactype='NM' then
                v_opbal_sec :=cir_accounts.cir_agency_opbal(pcompcode,punitcode,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,'','');
                select sum(amount) into v_dbcramt from cir_rcphdr
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and
                            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>= v_opdate and recptdt<=v_todt and
                            achd='SC';
                v_opbal_sec:=nvl(v_opbal_sec,0)+nvl(v_dbcramt,0);

            else
                v_opbal_sec :=0;
            end if;
            ----for secutiry outstanding---
            v_dbcramt:=0;
            select sum(amount) into v_billamt from cir_outmast
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and
                            agcd=v1.agcd and dpcd=v1.dpcd and billdt >= v_opdate and billdt<v_frdt and
                            achd=pactype and recptno is null;
            select sum(amount) into v_dbcramt from cir_rcpdet
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and
                            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>= v_opdate and recptdt<v_frdt and
                            achd=pactype and billno is null;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);

            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
              insert into cir_ledger_report
                  (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                  exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                  billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
              values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_frdt,v_opbal_sec,
                     null,'Security Balance',null,null,null,null,null,null,
                     null,null,null,null,null,v1.ag_name,v_rec_seqno,1);

            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
            v_runbal:=v_opbal;
            if v_runbal>=0 then
                v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
            else
                v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
            end if;


              insert into cir_ledger_report
                  (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                  exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                  billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
              values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_frdt,v_opbal,
                     null,'Opening Balance',null,null,null,null,null,null,
                     null,null,null,null,null,v1.ag_name,v_rec_seqno,2);

            --------daily transactions------------
            open c2;
            loop
                fetch c2 into v2;
                exit when c2%notfound;
                if nvl(v2.amount,0)<>0 then
                    v_rec_seqno:=nvl(v_rec_seqno,0)+1;
                    v_narration:=null;
                    if v2.doctype='BIL' then
                        v_narration:=v2.narration;
                    else
                        if v2.narration is not null then
                           v_narration:=v2.narration;
                            if v2.chno is not null then
                                v_narration:=v_narration||' CHNO# '||v2.chno;
                            end if;
                            if v2.chdt is not null then
                                v_narration:=v_narration||' CHDT '||v2.chdt;
                            end if;
                            if v2.chbank is not null then
                                v_narration:=v_narration||' CHBNK '||v2.chbank;
                            end if;
                        else
                            if v2.chno is not null then
                                v_narration:='CHNO# '||v2.chno;
                            end if;
                            if v2.chdt is not null then
                                v_narration:=v_narration||' CHDT '||to_char(v2.chdt,''||pdateformat||'');
                            end if;
                            if v2.chbank is not null then
                                v_narration:=v_narration||' CHBANK '||v2.chbank;
                            end if;
                            if v2.reason='CASH' and v2.doctype='RCR' then
                                v_narration:='By Cash '||v_narration;
                            end if;
                        end if;
                    end if;
                    v_remark_len := length(nvl(ltrim(rtrim(v_narration)),'-'));
                    v_amt:=nvl(v_amt,0)+nvl(v2.amount,0);

                    v_runbal:=v_runbal+nvl(v2.amount,0);

                    if v_runbal>=0 then
                        v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
                    else
                        v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
                    end if;

                    if nvl(v2.amount,0)>=0 then
                        v_dbamt:=nvl(v_dbamt,0)+nvl(v2.amount,0);
                    elsif nvl(v2.amount,0)<0 then
                        v_cramt:=nvl(v_cramt,0)+abs(nvl(v2.amount,0));
                    end if;
                  insert into cir_ledger_report
                      (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                      exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                      billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
                  values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,v2.doctype,v2.recptno,v2.recptdt,v2.amount,
                         v2.received_from,nvl(ltrim(rtrim(v_narration)),'-'),v2.chno,v2.chdt,v2.chbank,v2.reason,null,v_runbal_txt,
                         null,null,null,null,v_runbal,v1.ag_name,v_rec_seqno,mod_function(v_remark_len,v_divident));

                end if;
            end loop;
            close c2;
            --------daily transactions------------

            v_clbal :=nvl(v_opbal,0)+nvl(v_amt,0);

            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
            if v_runbal>=0 then
                v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
            else
                v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
            end if;
      insert into cir_ledger_report
          (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
          exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
          billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
      values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_todt,nvl(v_clbal,0),
              null,'Closing Balance',null,null,null,null,null,null,
              null,null,null,null,null,v1.ag_name,v_rec_seqno,1);
        if nvl(v_opbal_sec,0)=0 and nvl(v_opbal,0)=0 and v_cramt=0 and v_dbamt=0 then
           delete from cir_ledger_report where comp_code=v1.comp_code and unit_code=v1.unit and
            agcd=v1.agcd and dpcd=v1.dpcd and sess_id=userenv('sessionid');
        end if;

        v_billamt:=0;v_dbcramt:=0;v_opbal:=0;v_clbal:=0;v_amt:=0;v_runbal:=0;v_cramt:=0;v_dbamt:=0;v_runbal_txt:=null;

        end loop;
        close c1;
        commit;

    open P_Accounts for
    select
    (select "Comp_Name" from comp_mst where "Comp_Code"=a.comp_code)  as "CNAME",
    comp_code,unit_code,branch_code,(select "Branch_Name" from branch_mst where "Branch_Code"=branch_code) branch_name,
    agcd,dpcd,agname,cir_get_agency_city(comp_code,unit_code,agcd,dpcd) city_name, 
    doctype,recptno,recptdt,
    decode(a.debit,'D',a.amount) as debit,decode(a.credit,'C',a.amount) as credit,exec_code,remarks,
    chqno,chqdt,chq_bank,reason,debit_head,credit_head,
    billno,billdt,billamt,adjamt,leftamt,rec_seqno,narr_line from
    (select comp_code,unit_code,branch_code,agcd,dpcd,agname,doctype,recptno,recptdt,
     decode(sign(amount),1,'D') as debit,decode(sign(amount),-1,'C') as credit,abs(amount) as amount,
     exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
     billno,billdt,billamt,adjamt,leftamt,rec_seqno,nvl(narr_line,1) as narr_line from cir_ledger_report
    where comp_code=pcompcode and unit_code=punitcode and sess_id=userenv('sessionid') ) a order by rec_seqno;

    open P_Accounts1 for
    select (select "Comp_Name" from comp_mst where "Comp_Code"=a.comp_code)  as "CNAME",comp_code,agcd,dpcd,agname,
    count(*),nvl(sum(narr_line),0) sum_narr from
    (select comp_code,unit_code,branch_code,agcd,dpcd,agname,doctype,recptno,recptdt,
    decode(sign(amount),1,'D') as debit,decode(sign(amount),-1,'C') as credit,abs(amount) as amount,rec_seqno,narr_line from cir_ledger_report
    where comp_code=pcompcode and unit_code=punitcode and sess_id=userenv('sessionid') ) a
    group by comp_code,agcd,dpcd,agname
    order by comp_code,agcd,dpcd,agname;
    
    delete from cir_ledger_report where sess_id=userenv('sessionid');
    End cir_agency_ledger_p;
END cir_rep_agency_ledger;
/



/**********************end*****01-dec-2011**********neha***************/

/***************************02-DEC-2011>=********NEHA**************/
CREATE OR REPLACE PROCEDURE AD_RETAIN_COMM_TARGET_INS 

(PCOMP_CODE      IN VARCHAR2,
                                            PRETAIN_CODE   IN VARCHAR2,
                                            PTEAM_CODE      IN VARCHAR2,
                                            PADCTG_CODE     IN VARCHAR2,
                                            PFROM_TGT       IN NUMBER,
                                            PTO_TGT         IN NUMBER,
                                            PCUST_TYPE      IN VARCHAR2,
                                            PAD_TYPE        IN VARCHAR2,
                                            PPUB_TYPE       IN VARCHAR2,
                                            PPUBL_CODE      IN VARCHAR2,
                                            PCREATED_BY     IN VARCHAR2,
                                            PCREATED_DT     IN DATE,
                                            PUPDATED_BY     IN VARCHAR2,
                                            PUPDATED_DT     IN DATE,
                                            PCOMM_TARGET_ID IN NUMBER,
                                            PDML_TYPE        IN VARCHAR) AS
BEGIN
 IF NVL(PDML_TYPE,'?')='I' THEN
     INSERT INTO RETAIN_COMM_TARGET 

(COMP_CODE,RETAIN_CODE,TEAM_CODE,ADCTG_CODE,FROM_TGT,
                                     

TO_TGT,CUST_TYPE,AD_TYPE,PUB_TYPE,PUBL_CODE,
                                     

CREATED_BY,CREATED_DT,UPDATED_BY,UPDATED_DT,COMM_TARGET_ID)
                            VALUES  

(PCOMP_CODE,PRETAIN_CODE,PTEAM_CODE,PADCTG_CODE,PFROM_TGT,
                                     

PTO_TGT,PCUST_TYPE,PAD_TYPE,PPUB_TYPE,PPUBL_CODE,
                                     

PCREATED_BY,PCREATED_DT,PUPDATED_BY,PUPDATED_DT,PCOMM_TARGE

T_ID);
     COMMIT;
 END IF;
 IF NVL(PDML_TYPE,'?')='U' THEN
     UPDATE RETAIN_COMM_TARGET SET TEAM_CODE = PTEAM_CODE, 

ADCTG_CODE = PADCTG_CODE, FROM_TGT = PFROM_TGT,
                                   TO_TGT = PTO_TGT, CUST_TYPE = PCUST_TYPE, 

AD_TYPE = PAD_TYPE,
                                   PUB_TYPE = PPUB_TYPE, PUBL_CODE = PPUBL_CODE, 

CREATED_BY = PCREATED_BY,
                                   CREATED_DT = PCREATED_DT,UPDATED_BY = 

PUPDATED_BY,UPDATED_DT = PUPDATED_DT
        WHERE COMP_CODE      = PCOMP_CODE
          AND RETAIN_CODE    = PRETAIN_CODE
          AND COMM_TARGET_ID = PCOMM_TARGET_ID;
     COMMIT;
 END IF;
 IF NVL(PDML_TYPE,'?')='D' THEN
     DELETE FROM RETAIN_COMM_TARGET
        WHERE COMP_CODE      = PCOMP_CODE
          AND RETAIN_CODE    = PRETAIN_CODE
          AND COMM_TARGET_ID = PCOMM_TARGET_ID;
     COMMIT;
 END IF;
END;
/


CREATE OR REPLACE PROCEDURE cir_bank_guarantee_bind(
   pcomp_code     IN       VARCHAR2,
   pagcd          IN       VARCHAR2,
   pdpcd          IN       VARCHAR2,
   pexpiry_date   IN       VARCHAR2,
   pexpiry_days   IN       NUMBER,
   pinstrument_ty IN       NUMBER,
   pdateformat    IN       VARCHAR2,
   pextra         IN       VARCHAR2,
   pextra1        IN       VARCHAR2,
   pextra2        IN       VARCHAR2,
   p_accounts     OUT      cur_type_new1.cursor_type
)
IS
v_dt date;
v_expdt date;
BEGIN
   v_expdt := to_date(pexpiry_date,''''||pdateformat||'''');
   v_dt    := v_expdt + nvl(pexpiry_days,0);
   OPEN p_accounts FOR
      SELECT * FROM cir_bank_guarantee
        where comp_code = pcomp_code
          and ((agcd    = pagcd) or (pagcd is null))
          and ((dpcd    = pdpcd) or (pdpcd is null))
          and ((bg_type = pinstrument_ty) or (pinstrument_ty is null))
          and bg_valid<=v_dt;
END;
/


CREATE OR REPLACE PACKAGE BODY cir_rep_agency_ledger IS
PROCEDURE cir_agency_ledger_p(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pactype         in varchar2,
    pbranchcode     in varchar2,
    pagency_type    in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    pstatecode      in varchar2,
    pdistcode       in varchar2,
    pcitycode       in varchar2,
    ptalukacode     in varchar2,
    pfrom_date      in varchar2,
    ptill_date      in varchar2,
    pbilladj_flag   in varchar2,
    psortedby       in varchar2,
    puserid         in varchar2,
    prowbreak       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,--it is use for agency class
    pextra2         in varchar2,
    P_Accounts      out T_Accounts_Cursor,
    P_Accounts1     out T_Accounts_Cursor)
As
    v_frdt          date;
    v_todt          date;
    v_opdate        date;
   
    v_opbal         number(15,2):=0;
    v_opbal_sec     number(15,2):=0;
    v_amt           number(15,2):=0;
    v_clbal         number(15,2):=0;
    v_runbal        number(15,2):=0;
    v_billamt       number:=0;
    v_dbcramt       number:=0;
    v_cramt         number(15,2) :=0;
    v_dbamt         number(15,2) :=0;
    v_rec_seqno     number:=0;
    v_remark_len    number:=0;
    v_divident      number:=0;
    v_narration     varchar2(1000);
    v_runbal_txt    varchar2(20);
        cursor c1 is 
            select distinct comp_code,unit,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,dist_code,state_code,
            country_code,branch_code from cir_agmast 
                where comp_code=pcompcode and (unit=punitcode or punitcode is null) and 
                            (ag_type=pagency_type or pagency_type is null) and agcd||dpcd in(select distinct agcd||dpcd from cir_outmast 
                            where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and achd=pactype) and 
                            (agcd=pagcd or pagcd is null) and (dpcd=pdpcd or pdpcd is null) and (branch_code=pbranchcode or pbranchcode is null) and
                            (state_code=pstatecode or pstatecode is null) and (dist_code=pdistcode or pdistcode is null) and 
                            (tehsil_taluka=ptalukacode or ptalukacode is null) and (ag_class=pextra1 or pextra1 is null)
                            order by branch_code,city_code,ag_name;
        v1 c1%rowtype;
       cursor c2 is
        select comp_code,unit_code,agcd,dpcd,doctype,recptno,recptdt,amount,chno,chdt,chbank,reason,narration,received_from from 
        (select comp_code,unit_code,agcd,dpcd,doctype,recptno,recptdt,amount,chno,chdt,chbank,reason,remark narration,received_from from cir_rcphdr
            where comp_code=v1.comp_code and unit_code=v1.unit and agcd=v1.agcd and dpcd=v1.dpcd and recptdt 
                between v_frdt and v_todt and nvl(achd,'NM')=pactype
        union
        select comp_code,unit_code,agcd,dpcd,'BIL' doctype,billno recptno,billdt recptdt,sum(bill_amount) amount,null chno,null chdt,null chbnk,'BILL' reason,
        'Bill Copy '||sum(bill_copy)||' Comm. Amount '||sum(comm_amount) narration,null received_from from cir_bill
            where comp_code=v1.comp_code and unit_code=v1.unit and agcd=v1.agcd and dpcd=v1.dpcd and 
                billdt between v_frdt and v_todt and pactype='NM'
                group by comp_code,unit_code,agcd,dpcd,billno,billdt)
        order by recptdt,doctype,recptno;
        v2 c2%rowtype;        
    Begin
        v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');--for financial date
        
        v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
        v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
        v_divident  :=nvl(prowbreak,35);
        delete from cir_ledger_report where sess_id=userenv('sessionid');
        --delete from test1;commit;
        --insert into test1(vstring,vstring2) values('unit outstanding monthwise vvar ',v_months);commit;    
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            v_opbal        :=cir_accounts.cir_agency_opbal(pcompcode,punitcode,'',v1.agcd,v1.dpcd,v_opdate,pactype,pdateformat,'','');
            ----for secutiry outstanding---
            if pactype='NM' then
                v_opbal_sec :=cir_accounts.cir_agency_opbal(pcompcode,punitcode,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,'','');
                select sum(amount) into v_dbcramt from cir_rcphdr
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and 
                            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>= v_opdate and recptdt<=v_todt and 
                            achd='SC';
                v_opbal_sec:=nvl(v_opbal_sec,0)+nvl(v_dbcramt,0);
                     
            else
                v_opbal_sec :=0;
            end if;    
            ----for secutiry outstanding---
            v_dbcramt:=0;
            select sum(amount) into v_billamt from cir_outmast
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and 
                            agcd=v1.agcd and dpcd=v1.dpcd and billdt >= v_opdate and billdt<v_frdt and 
                            achd=pactype and recptno is null;            
            select sum(amount) into v_dbcramt from cir_rcpdet
                where comp_code=pcompcode and (unit_code=punitcode or punitcode is null) and 
                            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>= v_opdate and recptdt<v_frdt and 
                            achd=pactype and billno is null;
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            
            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
              insert into cir_ledger_report
                  (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                  exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                  billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
              values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_frdt,v_opbal_sec,
                     null,'Security Balance',null,null,null,null,null,null,
                     null,null,null,null,null,v1.ag_name,v_rec_seqno,1);

            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
            v_runbal:=v_opbal;
            if v_runbal>=0 then
                v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
            else
                v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
            end if;
            
            
              insert into cir_ledger_report
                  (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                  exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                  billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line)
              values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_frdt,v_opbal,
                     null,'Opening Balance',null,null,null,null,null,null,
                     null,null,null,null,null,v1.ag_name,v_rec_seqno,2);
            
            --------daily transactions------------
            open c2;
            loop
                fetch c2 into v2;
                exit when c2%notfound;
                if nvl(v2.amount,0)<>0 then
                    v_rec_seqno:=nvl(v_rec_seqno,0)+1;
                    v_narration:=null;
                    if v2.doctype='BIL' then
                        v_narration:=v2.narration;
                    else
                        if v2.narration is not null then
                           v_narration:=v2.narration;
                            if v2.chno is not null then
                                v_narration:=v_narration||' CHNO# '||v2.chno;
                            end if;
                            if v2.chdt is not null then
                                v_narration:=v_narration||' CHDT '||v2.chdt;
                            end if;
                            if v2.chbank is not null then
                                v_narration:=v_narration||' CHBNK '||v2.chbank;
                            end if;
                        else
                            if v2.chno is not null then
                                v_narration:='CHNO# '||v2.chno;
                            end if;
                            if v2.chdt is not null then
                                v_narration:=v_narration||' CHDT '||to_char(v2.chdt,''||pdateformat||'');
                            end if;
                            if v2.chbank is not null then
                                v_narration:=v_narration||' CHBANK '||v2.chbank;
                            end if;
                            if v2.reason='CASH' and v2.doctype='RCR' then
                                v_narration:='By Cash '||v_narration;
                            end if;
                        end if;
                    end if;
                    v_remark_len := length(nvl(ltrim(rtrim(v_narration)),'-'));
                    v_amt:=nvl(v_amt,0)+nvl(v2.amount,0);
                    
                    v_runbal:=v_runbal+nvl(v2.amount,0);

                    if v_runbal>=0 then
                        v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
                    else
                        v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
                    end if;
                                        
                    if nvl(v2.amount,0)>=0 then
                        v_dbamt:=nvl(v_dbamt,0)+nvl(v2.amount,0);
                    elsif nvl(v2.amount,0)<0 then
                        v_cramt:=nvl(v_cramt,0)+abs(nvl(v2.amount,0));
                    end if;      
                  insert into cir_ledger_report
                      (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
                      exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
                      billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line,city_code)
                  values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,v2.doctype,v2.recptno,v2.recptdt,v2.amount,
                         v2.received_from,nvl(ltrim(rtrim(v_narration)),'-'),v2.chno,v2.chdt,v2.chbank,v2.reason,null,v_runbal_txt,
                         null,null,null,null,v_runbal,v1.ag_name,v_rec_seqno,mod_function(v_remark_len,v_divident),v1.city_code);
                    
                end if;
            end loop;
            close c2;    
            --------daily transactions------------
            
            v_clbal :=nvl(v_opbal,0)+nvl(v_amt,0);

            v_rec_seqno:=nvl(v_rec_seqno,0)+1;
            if v_runbal>=0 then
                v_runbal_txt:=to_char(v_runbal,'99999990.99')||' Dr.';
            else
                v_runbal_txt:=to_char(abs(v_runbal),'99999990.99')||' Cr.';
            end if;            
      insert into cir_ledger_report
          (comp_code,unit_code,branch_code,agcd,dpcd,doctype,recptno,recptdt,amount,
          exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
          billno,billdt,billamt,adjamt,leftamt,agname,rec_seqno,narr_line,city_code)
      values(v1.comp_code,v1.unit,v1.branch_code,v1.agcd,v1.dpcd,'',null,v_todt,nvl(v_clbal,0),
              null,'Closing Balance',null,null,null,null,null,null,
              null,null,null,null,null,v1.ag_name,v_rec_seqno,1,v1.city_code);
        if nvl(v_opbal_sec,0)=0 and nvl(v_opbal,0)=0 and v_cramt=0 and v_dbamt=0 then
           delete from cir_ledger_report where comp_code=v1.comp_code and unit_code=v1.unit and
            agcd=v1.agcd and dpcd=v1.dpcd and sess_id=userenv('sessionid');
        end if;    

        v_billamt:=0;v_dbcramt:=0;v_opbal:=0;v_clbal:=0;v_amt:=0;v_runbal:=0;v_cramt:=0;v_dbamt:=0;v_runbal_txt:=null;
            
        end loop;
        close c1;
        commit;

    open P_Accounts for
    select
    (select "Comp_Name" from comp_mst where "Comp_Code"=a.comp_code)  as "CNAME",
    comp_code,unit_code,branch_code,agcd,dpcd,agname,doctype,recptno,recptdt,
    decode(a.debit,'D',a.amount) as debit,decode(a.credit,'C',a.amount) as credit,exec_code,remarks,
    chqno,chqdt,chq_bank,reason,debit_head,credit_head,
    billno,billdt,billamt,adjamt,leftamt,rec_seqno,narr_line,city_name from
    (select comp_code,unit_code,branch_code,agcd,dpcd,agname,doctype,recptno,recptdt,
     decode(sign(amount),1,'D') as debit,decode(sign(amount),-1,'C') as credit,abs(amount) as amount,
     exec_code,remarks,chqno,chqdt,chq_bank,reason,debit_head,credit_head,
     billno,billdt,billamt,adjamt,leftamt,rec_seqno,nvl(narr_line,1) as narr_line,CIR_GET_CITY(comp_code,city_code) as city_name
 from cir_ledger_report
    where comp_code=pcompcode and unit_code=punitcode and sess_id=userenv('sessionid') ) a order by rec_seqno;

    open P_Accounts1 for
    select (select "Comp_Name" from comp_mst where "Comp_Code"=a.comp_code)  as "CNAME",comp_code,agcd,dpcd,agname,
    count(*),nvl(sum(narr_line),0) sum_narr,city_name from
    (select comp_code,unit_code,branch_code,agcd,dpcd,agname,doctype,recptno,recptdt,
    decode(sign(amount),1,'D') as debit,decode(sign(amount),-1,'C') as credit,abs(amount) as amount,rec_seqno,narr_line,CIR_GET_CITY(comp_code,city_code) as city_name from cir_ledger_report
    where comp_code=pcompcode and unit_code=punitcode and sess_id=userenv('sessionid') ) a
    group by comp_code,agcd,dpcd,agname,city_name
    order by comp_code,agcd,dpcd,agname;
    --delete from cir_ledger_report where sess_id=userenv('sessionid');
    End cir_agency_ledger_p;
END cir_rep_agency_ledger;
/


//===============================================issue no. 5798 06/12/2011=============================================

CREATE OR REPLACE PROCEDURE HT18JULY.cir_bank_guarantee_bind(
   pcomp_code     IN       VARCHAR2,
   pagcd          IN       VARCHAR2,
   pdpcd          IN       VARCHAR2,
   pexpiry_date   IN       VARCHAR2,
   pexpiry_days   IN       NUMBER,
   pinstrument_ty IN       VARCHAR2,
   pdateformat    IN       VARCHAR2,
   pextra         IN       VARCHAR2,
   pextra1        IN       VARCHAR2,
   pextra2        IN       VARCHAR2,
   p_accounts     OUT      cur_type_new1.cursor_type
)
IS
v_dt date;
v_expdt date;
BEGIN
   v_expdt := to_date(pexpiry_date,''''||pdateformat||'''');
   v_dt    := v_expdt + nvl(pexpiry_days,0);
   OPEN p_accounts FOR
      SELECT * FROM cir_bank_guarantee
        where comp_code = pcomp_code
          and ((agcd    = pagcd) or (pagcd is null))
          and ((dpcd    = pdpcd) or (pdpcd is null))
          and ((bg_type = pinstrument_ty) or (pinstrument_ty is null))
          and bg_valid<=v_dt;
END;
/


//////////////////////////////////////////end of issue 5798//////////////////////////////////////////////////////////


//================================= issue no. 5808 and 5809 06/12/2011============================================



////////////////////////////////////////////body//////////////////////////////////////////////////////////

CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_billing IS
  procedure cir_billing_agency_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

        open p_accounts for
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              ((upper(a.ag_name) like upper(pextra1)||'%') or (pextra1 is null))
        union
        select distinct a.agcd agcd,a.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,a.city_code city_code,cir_get_city(a.comp_code,a.city_code) city_name,a.tehsil_taluka tehsil_taluka,
        cir_get_taluka(a.comp_code,a.tehsil_taluka) taluka_name
        from cir_agmast a,cir_bill_det b
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit=b.unit_code and a.unit=punit_code and 
              b.billdt >=v_bill_frdt and b.billdt<=v_bill_todt and a.agcd=b.agcd and a.dpcd=b.dpcd and b.publ=nvl(ppubl,b.publ) and 
              upper(a.agcd) = upper(pextra1)
        order by ag_name,city_name;

    End cir_billing_agency_list_p;

    procedure cir_billno_list_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl             in varchar2,
      pbillagcd         in varchar2,
      pbilldpcd         in varchar2,
      pbill_freq        in varchar2,
      pfrom_billdt      in varchar2,
      ptill_billdt      in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      p_accounts        out t_accounts)
    As
      v_bill_frdt date;
      v_bill_todt date;
    Begin
      v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
      v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
      
      open p_accounts for
        select min(billno) MIN_BILLNO,max(billno) MAX_BILLNO from cir_bill_det
            where comp_code=pcomp_code and unit_code=punit_code and billdt >= v_bill_frdt and billdt<=v_bill_todt and
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and publ=nvl(ppubl,publ) and bill_flag=nvl(pbill_freq,bill_flag);
            
    End cir_billno_list_p;
 /*
set serveroutput on;
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
var v7 refcursor;
var v8 refcursor;
var v9 refcursor;
var v10 refcursor;
var v11 refcursor;
var v12 refcursor;
var v13 refcursor;
exec cir_rep_billing.cir_bill_print_punya('SP002','AUR','','M','01-jul-2011','31-jul-2011','AUR1107114','AUR1107114','L0012','0001','','','','','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11,:v12,:v13);
--*/

  procedure cir_bill_print_punya(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pbranchcode     in varchar2,
      pdistcode       in varchar2,  
      ptalukacode     in varchar2,
      pcitycode       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,
      pextra2         in varchar2,
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12    out t_accounts)
    As
      v_bill_frdt     date;
      v_bill_todt     date;
      v_dt            date;
      v_query1        varchar2(32000);
      v_query2        varchar2(32000);
    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ,*/a.agcd agcd,a.dpcd dpcd,a.billno billno,a.billdt billdt,
        min(a.bill_frdt) frdt,max(a.bill_todt) todt,nvl(sum(bill_sec_amt),0) bill_sec_amt  
        from cir_bill a,cir_agmast b
                where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                    a.agcd=b.agcd and a.dpcd=b.dpcd and ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                    /*((a.publ=ppubl) or (ppubl is null)) and*/ a.agcd=nvl(pbillagcd,a.agcd) and
                    a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                    (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                    (b.city_code =pcitycode or pcitycode is null) and a.bill_flag=pbill_freq and nvl(a.bill_copy,0)>0 
            group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,a.billno,a.billdt
            order by comp_code,unit_code,/*publ,*/billdt,billno,agcd,dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_det is
        select distinct publ,edtn from cir_bill_det
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and billdt=rec_bill.billdt and billno=rec_bill.billno and
              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd
        union
        select distinct publ,edtn
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and 
              recptdt>=v_bill_frdt and recptdt<=v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
              order by publ,edtn;
rec_det cur_det%rowtype;
              
    cursor cur_dbksup is
        select comp_code,unit_code,publ,edtn,supdate,copy_rate,
        sum(supply_copy) supply_copy from(select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        sum(d.sup_copy) supply_copy
        from cir_dbksup_resale d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        union all
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.supdate supdate,d.sup_rate copy_rate,
        0 supply_copy
        from cir_dbksup d,cir_supply_type_mast t 
        where d.comp_code=rec_bill.comp_code and d.comp_code=t.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_det.publ and d.edtn=rec_det.edtn and
              d.supdate=v_dt and d.sup_type_code=t.sup_ty_code and upper(t.bill_pay)='Y' and d.billagcd=rec_bill.agcd and 
              d.billdpcd=rec_bill.dpcd and nvl(d.sup_copy,0)>0
        group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate
        minus
        select comp_code comp_code,unit_code unit_code,publ publ,edtn edtn,recptdt supdate,copy_rate copy_rate,
        0 supply_copy
        from cir_unsold_dtl 
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate))
    group by comp_code,unit_code,publ,edtn,supdate,copy_rate
    order by comp_code,unit_code,publ,edtn,supdate;
rec_dbksup cur_dbksup%rowtype;

    cursor cur_unsold is
        select comp_code,unit_code,publ,edtn,recptdt,copy_rate,sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) return_copy
        from cir_unsold_dtl
        where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and publ=rec_det.publ and edtn=rec_det.edtn and
              recptdt=v_dt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
    group by comp_code,unit_code,recptdt,publ,edtn,copy_rate
    order by comp_code,unit_code,recptdt,publ,edtn,copy_rate;
rec_unsold cur_unsold%rowtype;

      cursor cur_publ_edtn is
            select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_bill_det a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
        ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null)
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.publ publ_code,b.publ_name publ_name,a.edtn edtn,c.edtn_name edtn_name,
            substr(c.edition_nick,1,5) edtn_nick
            from cir_unsold_dtl a,cir_publ_mast b,cir_edtn_mast c,cir_agmast d 
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=d.comp_code and a.unit_code=punit_code and a.unit_code=d.unit and 
        a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and
        a.agcd=d.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=d.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and
        a.publ=nvl(ppubl,a.publ) and a.publ=b.publ and a.publ=c.publ and a.edtn=c.edtn and  
        a.branch_code=nvl(pbranchcode,a.branch_code) and (d.dist_code =pdistcode or pdistcode is null) and 
        (d.tehsil_taluka =ptalukacode or ptalukacode is null) and (d.city_code =pcitycode or pcitycode is null) and
        (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0
        order by comp_code,unit_code,publ_code,edtn;

        v1 cur_publ_edtn%rowtype;

        v_edtn_cnt        number(5):=0;
        vvar              varchar2(8000);
        vvar_name         varchar2(8000);
        vvar1             varchar2(8000);
        vvar2             varchar2(8000);
        vvar3             varchar2(8000);
        vvar33            varchar2(8000);
        vvar4             varchar2(8000);
        vvar5             varchar2(8000);
        vvar6             varchar2(8000);
        vvar7             varchar2(8000);
        vvar8             varchar2(8000);
        vvar11            varchar2(8000);
        sum_vvar          varchar2(8000);
        sum_vvar1         varchar2(8000);
        sum_vvar2         varchar2(8000);
        sum_vvar3         varchar2(8000);
        sum_vvar33        varchar2(8000);
        sum_vvar4         varchar2(8000);
        sum_vvar5         varchar2(8000);
        sum_vvar6         varchar2(8000);
        sum_vvar7         varchar2(8000);
        sum_vvar8         varchar2(8000);
        sum_vvar11        varchar2(8000);
        vtot_publ         varchar2(8000);
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_sec_opbal        number(14,2):=0;
        v_sec_pbal       number(14,2):=0;
        v_sec_rcpt        number(14,2):=0;
        v_sec_dn          number(14,2):=0;
    cursor cur_exist_edtn is
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.billno billno,a.billdt billdt,a.edtn edtn 
        from cir_bill_det a,cir_agmast b
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and 
                a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and
                ((a.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                a.agcd=b.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
                (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
                (b.city_code =pcitycode or pcitycode is null) and 
                nvl(a.bill_copy,0)>0 and a.bill_flag=pbill_freq 
         union
        select distinct a.comp_code comp_code,a.unit_code unit_code,c.billno billno,c.billdt billdt,a.edtn edtn 
        from cir_unsold_dtl a,cir_agmast b,cir_bill c
            where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit_code=punit_code and a.unit_code=b.unit and
            a.unit_code=c.unit_code and 
            a.recptdt >= v_bill_frdt and a.recptdt<=v_bill_todt and c.billdt >= v_bill_frdt and c.billdt<=v_bill_todt and
            ((c.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
            a.agcd=b.agcd and a.agcd=c.agcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=b.dpcd and a.dpcd=c.dpcd and a.dpcd=nvl(pbilldpcd,a.dpcd) and a.branch_code=nvl(pbranchcode,a.branch_code) and 
            (b.dist_code =pdistcode or pdistcode is null) and (b.tehsil_taluka =ptalukacode or ptalukacode is null) and 
            (b.city_code =pcitycode or pcitycode is null) and 
            (nvl(a.apr_late_recpt,0)+nvl(a.apr_short_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0))>0 and 
            c.bill_flag=pbill_freq         
            order by comp_code,unit_code,billdt,billno;
    rec_exist_edtn cur_exist_edtn%rowtype;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date

        --delete from test1;commit;

        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        
        Open cur_bill;---main cursor bill
        Loop
          fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
              end if;
            open cur_det;
            loop
                fetch cur_det into rec_det;
                exit when cur_det%notfound;
                
                Open cur_dbksup;
                fetch cur_dbksup into rec_dbksup;
                if cur_dbksup%notfound then

                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select max(comm_rate) comm_rate,max(sur_rate) sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt between v_bill_frdt and v_bill_todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and  
                              publ=rec_det.publ and edtn=rec_det.edtn;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    v_gross_amt   :=0;
                    v_comm_amt    :=0;
                    v_sur_amt     :=0;

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 v_dt,0,0,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                else
                    /*select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) into v_return_copy
                    from cir_unsold_dtl
                    where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                          recptdt=rec_dbksup.supdate and publ=rec_det.publ and edtn=rec_det.edtn and agcd=rec_bill.agcd and
                          dpcd=rec_bill.dpcd and copy_rate=rec_dbksup.copy_rate and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;*/
                    begin
                        select comm_rate,sur_rate into v_comm_rate,v_sur_rate from cir_bill_det
                            where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                              billdt >= v_bill_frdt and billdt<=v_bill_todt and billdt=rec_bill.billno and
                              agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                              publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and
                              rec_dbksup.supdate >= fromdt and rec_dbksup.supdate<=todt;
                    exception when others then
                        v_comm_rate   :=0;v_sur_rate    :=0;
                    end;
                    
                        v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                        v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*(v_comm_rate/100)),2),0);
                        v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);
                    

                    insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               return_copy,return_amt,cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                                 nvl(v_return_copy,0),nvl(v_return_amt,0),userenv('sessionid'));
                                 v_return_copy:=0;v_return_amt:=0;
                end if;
            Close cur_dbksup;
            
            
            Open cur_unsold;
            loop
                fetch cur_unsold into rec_unsold;
                exit when cur_unsold%notfound;
                
                    insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                               receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                               cur_sessionid)
                     values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                                 rec_unsold.recptdt,rec_unsold.return_copy,rec_unsold.copy_rate,0,0,0,0,0,
                                 userenv('sessionid'));
                                 
                                 v_return_copy:=nvl(v_return_copy,0)+nvl(rec_unsold.return_copy,0);
                                 
                                 rec_unsold.recptdt:=null;rec_unsold.return_copy:=null;rec_unsold.copy_rate:=null;
                    

                    
            end loop;
            Close cur_unsold;
            if nvl(v_return_copy,0)=0 then
                insert into cir_bill_return_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           receipt_date,return_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_det.publ,rec_det.edtn,rec_bill.agcd,rec_bill.dpcd,
                             v_dt,0,0,0,0,0,0,0,
                             userenv('sessionid'));     
                    
            end if;
            v_return_copy:=0;v_return_amt:=0;            
            
            End loop;
            close cur_det;
            
        v_dt:=v_dt+1;
        End Loop;--close loop for date

            v_opbal     :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_dbcramt from
            (select sum(amount) amount from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctyp='BIL' and 
                    billdt>= v_opdate and billdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd 
            union all
            select sum(amount) amount from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and doctype<>'BIL' and 
                    recptdt>= v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd);

            select sum(amount) into v_dbamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount>0;

            select sum(amount) into v_cramt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype not in('RCR','UCN') and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and 
                      amount<0;

            select sum(amount) into v_recamt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='RCR' and achd='NM' and 
                      recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            select sum(amount) into v_sec_pbal from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and 
                recptdt>=v_opdate and recptdt<rec_bill.frdt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_sec_pbal:=nvl(v_sec_pbal,0)+nvl(v_sec_opbal,0);
            
            select sum(amount) into v_sec_rcpt from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype<>'DN' and 
                recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
                      
            select sum(amount) into v_sec_dn from cir_rcphdr
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and achd='SC' and doctype='DN' and
                      recptdt>=rec_bill.frdt and recptdt<=rec_bill.todt and agcd=rec_bill.agcd and dpcd=rec_bill.dpcd;
            
            v_dbamt:=nvl(v_dbamt,0)-nvl(rec_bill.bill_sec_amt,0);

            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,
            bill_amt,return_amt,country_code)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal,
            nvl(v_sec_rcpt,0),nvl(v_sec_pbal,0),v_sec_dn);
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));        
        End Loop;
        Close cur_bill;
        --delete from test1;delete searchtbl;commit;
    open cur_publ_edtn;
    loop
        fetch cur_publ_edtn into v1;
      exit when cur_publ_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
        if vvar is null then
            vvar        :='decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :='nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :='nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :='nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            sum_vvar3   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"';
            --sum_vvar33   :='nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :='nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :='nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :='decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :='nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :='nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :='decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :='nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :='sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :='"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN IF ',sum_vvar3);commit;
          else
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_SUPPLY"';
            --sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0) "'||v1.edtn||'_SUPPLY",nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_COPY_RATE"';
            sum_vvar    :=sum_vvar||',nvl(sum("'||v1.edtn||'_SUPPLY"),0)||''#''||nvl(sum("'||v1.edtn||'_COPY_RATE"),0) "'||v1.edtn||'_SUPPLY"';
            vvar_name   :=vvar_name||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'"';
            vvar1       :=vvar1||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_TOT_SUPPLY"';
            sum_vvar1   :=sum_vvar1||',nvl(sum("'||v1.edtn||'_TOT_SUPPLY"),0) "'||v1.edtn||'_TOT_SUPPLY"';
            vvar2       :=vvar2||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_copy*u.supply_rate))"'||v1.edtn||'_GROSS"';
            sum_vvar2   :=sum_vvar2||',nvl(sum("'||v1.edtn||'_GROSS"),0) "'||v1.edtn||'_GROSS"';
            vvar3       :=vvar3||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_copy))"'||v1.edtn||'_RETURN_COPY"';
            vvar33      :=vvar33||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',max(u.supply_rate))"'||v1.edtn||'_RETURN_RATE"';
            --sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            sum_vvar3   :=sum_vvar3||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) ||''#''||nvl(sum("'||v1.edtn||'_RETURN_COPY"),0) "'||v1.edtn||'_RETURN_COPY"'||sum_vvar33;
            --sum_vvar33  :=sum_vvar33||',nvl(max("'||v1.edtn||'_RETURN_RATE"),0) "'||v1.edtn||'_RETURN_RATE"';
            vvar4       :=vvar4||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.return_amt))"'||v1.edtn||'_RETURN_AMT"';
            sum_vvar4   :=sum_vvar4||',nvl(sum("'||v1.edtn||'_RETURN_AMT"),0) "'||v1.edtn||'_RETURN_AMT"';
            vvar5       :=vvar5||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt))"'||v1.edtn||'_TOTAL_AMT"';
            sum_vvar5   :=sum_vvar5||',nvl(sum("'||v1.edtn||'_TOTAL_AMT"),0) "'||v1.edtn||'_TOTAL_AMT"';
            --vvar6       :=vvar6||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn_name||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            vvar6       :=vvar6||',decode(u.edtn,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn||'",decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.comm_amt))"'||v1.edtn||'_TOT_COMM"';
            sum_vvar6   :=sum_vvar6||',nvl(sum("'||v1.edtn||'_TOT_COMM"),0) "'||v1.edtn||'_TOT_COMM"';
            vvar7       :=vvar7||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.sur_amt))"'||v1.edtn||'_TOT_SURCHARGE"';
            sum_vvar7   :=sum_vvar7||',nvl(sum("'||v1.edtn||'_TOT_SURCHARGE"),0) "'||v1.edtn||'_TOT_SURCHARGE"';
            vvar8       :=vvar8||',decode(u.edtn_code,'||''''||v1.edtn||''''||','||''''||v1.edtn||''''||')"'||v1.edtn_name||'",decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.gross_amt-u.return_amt-u.comm_amt+sur_amt))"'||v1.edtn||'_NET"';
            sum_vvar8   :=sum_vvar8||',nvl(sum("'||v1.edtn||'_NET"),0) "'||v1.edtn||'_NET"';
            --vvar    :=vvar||',decode(u.edtn,'||''''||v1.edtn||''''||',sum(u.supply_copy))"'||v1.edtn||'_Supply"';
            vvar        :=vvar||',decode(u.edtn_code,'||''''||v1.edtn||''''||',sum(u.supply_rate))"'||v1.edtn||'_COPY_RATE"';
            vvar11      :=vvar1||',sum("'||v1.edtn||'_SUPPLY") "'||v1.edtn||'_SUPPLY",sum("'||v1.edtn||'_COPY_RATE") "'||v1.edtn||'_COPY_RATE"';
            vtot_publ   :=vtot_publ||',"'||v1.edtn||'"';
            --insert into test1(vstring,vstring2) values(' billing IN ELSE ',sum_vvar3);commit;
          end if;
          v_edtn_cnt:=nvl(v_edtn_cnt,0)+1;
            
          insert into cir_temp_suppliment(comp_code,unit_code,seq_no,edition_code,sess_id)
          values(v1.comp_code,v1.unit_code,v_edtn_cnt,v1.edtn,userenv('sessionid'));
           
        end loop;
        close cur_publ_edtn;
        
        open cur_exist_edtn;
        loop
            fetch cur_exist_edtn into rec_exist_edtn;
            exit when cur_exist_edtn%notfound;

            --select seq_no into v_exist_edtn from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            --edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid');  
            
            update cir_temp_bill_collection set remarks=remarks||'#'||(select seq_no from cir_temp_suppliment where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and 
            edition_code=rec_exist_edtn.edtn and sess_id=userenv('sessionid'))
            where comp_code=rec_exist_edtn.comp_code and unit_code=rec_exist_edtn.unit_code and billno=rec_exist_edtn.billno and billdt=rec_exist_edtn.billdt and
                  cur_sessionid=userenv('sessionid');
        end loop;
        close cur_exist_edtn;
        update cir_temp_bill_collection set remarks=substr(remarks,2,length(remarks)) where cur_sessionid=userenv('sessionid');        
        --COMMIT;
        
        --insert into test1(vstring,vstring2) values(' billing var3 ',vvar3);commit;
       
        --insert into searchtbl(search) values(' billing first '||pcomp_code||' , '||punit_code||' , '||pbill_freq||' , '||pfrom_billno||' , '||ptill_billno||' , '||v_bill_frdt||' , '||v_bill_todt||' , '||pbillagcd||' , '||pbilldpcd||' , '||ppubl );commit;
        open p_accounts  for
        select z.comp_code comp_code,z.unit_code unit_code,z.agcd agcd,z.dpcd dpcd,z.ag_name ag_name,z.ag_name_oth_lang ag_name_oth_lang,
        z.addr1 addr1,z.addr2 addr2,z.addr3 addr3,z.city_name city_name,
        initcap(z.taluka_name) taluka_name,initcap(z.dist_name) dist_name,
        z.state_name state_name,z.pin_code pin_code,z.billno billno,z.billdt billdt,
        z.bill_copy bill_copy,z.gross_amount gross_amount,
        z.sur_amount sur_amount,z.comm_amount comm_amount,z.bill_amount bill_amount,z.bill_sec_amt bill_sec_amt,
        z.edtn_remark edtn_remark,z.return_amt return_amt,
        (select name from cir_ag_con_per where comp_code=z.comp_code and unit=z.unit_code and agcd=z.agcd and dpcd=z.dpcd and rownum<2) contact_person_name
        from(select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,
        cir_get_taluka(b.comp_code,a.tehsil_taluka) taluka_name,cir_get_dist(b.comp_code,a.state_code,a.dist_code) dist_name,
        cir_get_state(b.comp_code,a.country_code,a.state_code) state_name,a.pin_code pin_code,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,sum(b.bill_sec_amt) bill_sec_amt,
        min(c.remarks) edtn_remark,(select nvl(sum(d.copy_amt),0) return_amt from cir_unsold_dtl d 
        where b.comp_code=d.comp_code and b.unit_code=d.unit_code and d.doctype='UCN' and d.recptdt >= v_bill_frdt and d.recptdt<=v_bill_todt and
        b.agcd=d.agcd and b.dpcd=d.dpcd and (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0) return_amt        
        --,bill_frdt,bill_todt,bill_flag,bill_remark
        from cir_agmast a,cir_bill b,cir_temp_bill_collection c
        where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.unit=b.unit_code and a.unit=c.unit_code and 
        b.unit_code=punit_code and b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and  
        b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        /*((b.publ=ppubl) or (ppubl is null)) and */a.agcd=b.agcd and a.dpcd=b.dpcd and b.branch_code=nvl(pbranchcode,b.branch_code) and 
        (a.dist_code =pdistcode or pdistcode is null) and (a.tehsil_taluka =ptalukacode or ptalukacode is null) and 
        (a.city_code =pcitycode or pcitycode is null) and b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and 
        c.billno=b.billno and c.billdt=b.billdt and c.cur_sessionid=userenv('sessionid')
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,
        a.city_code,a.tehsil_taluka,a.dist_code,a.country_code,a.state_code,a.pin_code,b.billno,b.billdt) z
        order by z.comp_code,z.unit_code,z.billdt,z.billno,z.agcd,z.dpcd;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day,'||sum_vvar||' from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,to_char(supply_date,''dd'') sup_day ,'||vvar||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,sup_day
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts1'||v_query1);commit;

        open p_accounts1 for v_query1;
                
        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar1||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar1||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts2  '||v_query1);commit;

        open p_accounts2 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar2||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar2||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into searchtbl(search) values(' billing before p_accounts3  '||v_query1);commit;

        open p_accounts3 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO,'||sum_vvar3||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,SRLNO,'||vvar3||','||vvar33||'
        from (select comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate, sum(return_copy) return_copy ,
        ROW_NUMBER( ) OVER (PARTITION BY
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code ORDER BY 
        comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code) SRLNO
        from cir_bill_return_print 
        where comp_code='||''''||pcomp_code||''''||' and unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,supply_rate) u
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,publ_code,edtn_code,SRLNO)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,SRLNO
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts4 ',v_query1);commit;
        open p_accounts4 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar4||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar4||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts5',v_query1);commit;

        open p_accounts5 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar5||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar5||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts6',v_query1);commit;

        open p_accounts6 for v_query1;

        v_query1:='select comp_code,unit,billno,billdt,agcd,dpcd,'||sum_vvar6||' 
        from (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.publ publ,u.edtn edtn,u.agcd agcd,u.dpcd dpcd,'||vvar6||'
        from cir_bill_det u,cir_agmast m
        where u.comp_code='||''''||pcomp_code||''''||' and u.comp_code=m.comp_code and u.unit_code=m.unit and u.unit_code='||''''||punit_code ||''''||' and u.billdt >='||''''||v_bill_frdt||''''||' and u.billdt <='||''''||v_bill_todt||''''||' and ((billno between '||''''||pfrom_billno||''''||' and '||''''||ptill_billno||''''||') or ('||''''||pfrom_billno||''''||' is null)) and
        u.agcd=m.agcd and u.agcd=nvl('||''''||pbillagcd||''''||',u.agcd) and u.dpcd=nvl('||''''||pbilldpcd||''''||',u.dpcd) and 
        u.bill_flag='||''''||pbill_freq||''''||' and u.branch_code=nvl('||''''||pbranchcode||''''||',u.branch_code) and (m.dist_code ='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka ='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and (m.city_code ='||''''||pcitycode||''''||' or '||''''||pcitycode||''''||'is null)
        group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts7',v_query1);commit;
        open p_accounts7 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar7||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar7||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts8',v_query1);commit;
        open p_accounts8 for v_query1;

        v_query1:='select comp_code,unit_code,billno,billdt,agcd,dpcd,'||sum_vvar8||' 
        from (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.publ_code publ_code,u.edtn_code edtn_code,u.agcd agcd,u.dpcd dpcd,'||vvar8||'
        from cir_bill_print u
        where u.comp_code='||''''||pcomp_code||''''||' and u.unit_code='||''''||punit_code ||''''||' and cur_sessionid='||userenv('sessionid')||'
        group by u.comp_code,u.unit_code,u.publ_code,u.edtn_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd';

        --insert into test1(vstring,vstring2) values(' billing before p_accounts9',v_query1);commit;

        open p_accounts9 for v_query1;

        open p_accounts10 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance",
        nvl(return_amt,0) as "Deposit Previous Balance",nvl(bill_amt,0) as "Cuurent Deposit",to_number(country_code) as "Deposit Debit Amt",
        abs(nvl(return_amt,0)+nvl(bill_amt,0)+nvl(to_number(country_code),0)) as "Deposit Balance"
        from cir_temp_outstanding
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts11 for 
        select distinct h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
        h.agcd agcd,h.dpcd dpcd,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        m.billno billno,m.billdt billdt, h.remark remark 
        from cir_rcphdr h,cir_bill_print m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=punit_code  and h.unit_code=m.unit_code and 
        h.doctype in('CN','DN') and h.recptdt >=v_bill_frdt and h.recptdt<=v_bill_todt and h.achd='NM' and h.amount<>0 and
        h.agcd=m.agcd and h.dpcd=m.dpcd and h.reason!='SEC DEBIT' and cur_sessionid=userenv('sessionid') 
        order by m.billdt,m.billno,agcd,dpcd,h.recptdt,recptno;
        
        open p_accounts12 for select sysdate from dual;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_temp_suppliment where sess_id=userenv('sessionid');commit;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');commit;
        --delete from cir_temp_outstanding; commit;
                
    End cir_bill_print_punya;


  procedure cir_bill_print_bhaskar(
      pcomp_code      in varchar2,
      punit_code      in varchar2,
      ppubl           in varchar2,
      pbill_freq      in varchar2,
      pfrom_billdt    in varchar2,
      ptill_billdt    in varchar2,
      pfrom_billno    in varchar2,
      ptill_billno    in varchar2,
      pbillagcd       in varchar2,
      pbilldpcd       in varchar2,
      pdateformat     in varchar2,
      pextra1         in varchar2,--for Agency Class
      pextra2         in varchar2,--for Agency Type
      p_accounts      out t_accounts,
      p_accounts1     out t_accounts,
      p_accounts2     out t_accounts,
      p_accounts3     out t_accounts,
      p_accounts4     out t_accounts,
      p_accounts5     out t_accounts,
      p_accounts6     out t_accounts,
      p_accounts7     out t_accounts,
      p_accounts8     out t_accounts,
      p_accounts9     out t_accounts,
      p_accounts10    out t_accounts,
      p_accounts11    out t_accounts,
      p_accounts12     out t_accounts)
    As
      v_bill_frdt         date;
      v_bill_todt         date;
          v_dt            date;
         v_query1        varchar2(8000);
      v_query2        varchar2(8000);
    cursor cur_bill is
        select distinct b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt,min(b.bill_frdt) frdt,max(b.bill_todt) todt from cir_bill b,cir_agmast m
                where b.comp_code=m.comp_code and b.comp_code=pcomp_code and b.unit_code=nvl(punit_code,b.unit_code) and b.unit_code=m.unit and 
                b.billdt between v_bill_frdt and v_bill_todt and
                b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                            b.publ=nvl(ppubl,b.publ) and b.agcd=nvl(pbillagcd,b.agcd) and b.agcd=m.agcd and
                            b.dpcd=nvl(pbilldpcd,b.dpcd) and b.dpcd=m.dpcd and (m.ag_class=pextra1 or pextra1 is null) and
                            (m.ag_type=pextra2 or pextra2 is null) 
            group by b.comp_code,b.unit_code,b.publ,b.agcd,b.dpcd,b.billno,b.billdt
            order by b.comp_code,b.unit_code,b.publ,b.billdt,b.billno,b.agcd,b.dpcd;
rec_bill cur_bill%rowtype;

    cursor cur_dbksup is
        select d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate copy_rate,d.comm_fix_auto_spl,d.comm_code,sum(d.sup_copy) supply_copy
        from cir_dbksup d,cir_supply_type_mast s
        where d.comp_code=s.comp_code and d.comp_code=rec_bill.comp_code and d.unit_code=rec_bill.unit_code and d.publ=rec_bill.publ and
              d.supdate=v_dt and d.billagcd=rec_bill.agcd and d.billdpcd=rec_bill.dpcd and
              d.sup_type_code=s.sup_ty_code and upper(s.bill_pay)='Y'
    group by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code
    order by d.comp_code,d.unit_code,d.publ,d.edtn,d.supdate;
rec_dbksup cur_dbksup%rowtype;

      cursor cur_publ_edtn is
            select distinct comp_code,unit_code,publ_code,cir_get_publ_name(comp_code,publ_code) publ_name,edtn_code edtn,cir_get_edtn_name(comp_code,edtn_code) edtn_name
            from cir_bill_print
        where cur_sessionid=userenv('sessionid') and comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
                    ((publ_code=ppubl) or (ppubl is null)) and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbillagcd or pbillagcd is null)
        order by comp_code,unit_code,publ_code,edtn_code;

        v1 cur_publ_edtn%rowtype;
        v_cnt             number:=0;
        v_return_copy     number;
        v_return_amt      number(14,2):=0;
        v_gross_amt       number(14,2):=0;
        v_comm_rate       number;
        v_comm_amt        number(14,2):=0;
        v_sur_rate        number;
        v_sur_amt         number(14,2):=0;
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;        
  Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        v_opdate       :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');--for financial date
        --delete from test1;commit;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into rec_bill;
          exit when cur_bill%notfound;

            v_dt:=rec_bill.frdt;
            Loop
              if v_dt>rec_bill.todt then
                exit;
            end if;

            Open cur_dbksup;
                Loop
              fetch cur_dbksup into rec_dbksup;
              exit when cur_dbksup%notfound;

                select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),0 return_amt into v_return_copy,v_return_amt
                from cir_unsold_dtl
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and doctype='UCN' and
                      recptdt=rec_dbksup.supdate and publ=rec_dbksup.publ and edtn=rec_dbksup.edtn and agcd=rec_bill.agcd and
                      dpcd=rec_bill.dpcd and (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;

                v_gross_amt   :=nvl(round((rec_dbksup.supply_copy*rec_dbksup.copy_rate),2),0);
                v_comm_rate   :=0;
                v_comm_amt    :=nvl(round((rec_dbksup.supply_copy*v_comm_rate),2),0);
                v_sur_rate    :=0;
                v_sur_amt     :=nvl(round((rec_dbksup.supply_copy*v_sur_rate),2),0);

                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                           supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                           return_copy,return_amt,cur_sessionid)
                 values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,rec_dbksup.publ,rec_dbksup.edtn,rec_bill.agcd,rec_bill.dpcd,
                             rec_dbksup.supdate,rec_dbksup.supply_copy,rec_dbksup.copy_rate,v_gross_amt,v_comm_rate,v_comm_amt,v_sur_rate,v_sur_amt,
                             v_return_copy,v_return_amt,userenv('sessionid'));
               End loop;
            Close cur_dbksup;

            v_dt:=v_dt+1;
            End Loop;--close loop for date
            v_opbal :=cir_accounts.cir_agency_opbal(rec_bill.comp_code,rec_bill.unit_code,null,rec_bill.agcd,rec_bill.dpcd,v_opdate,'NM',pdateformat,'','')+
                      cir_accounts.cir_agency_ytodt(rec_bill.comp_code,rec_bill.unit_code,NULL,rec_bill.agcd,rec_bill.dpcd,v_opdate,rec_bill.frdt,'NM',pdateformat,'','');

            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and billdt >= rec_bill.frdt and billdt<=rec_bill.todt/* and
                      publ=rec_bill.publ*/;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                            agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.todt and
                            doctyp<>'BIL' and achd='NM' /*and publ=rec_bill.publ*/;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp not in('BIL','RCR') and achd='NM' and /*publ=rec_bill.publ and */amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_bill.comp_code and unit_code=rec_bill.unit_code and
                      agcd=rec_bill.agcd and dpcd=rec_bill.dpcd and recptdt>= rec_bill.frdt and recptdt<=rec_bill.billdt and
                      doctyp='RCR' and achd='NM' /*and publ=rec_bill.publ*/;

            v_opbal:=nvl(v_opbal,0)+NVL(V_recamt,0);--nvl(v_billamt,0)+nvl(v_dbcramt,0);

            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billdt,rec_bill.billno,'',/*rec_bill.publ,*/
            rec_bill.agcd,rec_bill.dpcd,v_dbamt,v_cramt,v_recamt,v_opbal);
        
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,remarks,cur_sessionid)
            values(rec_bill.comp_code,rec_bill.unit_code,rec_bill.billno,rec_bill.billdt,'',userenv('sessionid'));
            v_opbal:=0;v_billamt:=0;v_dbcramt:=0;v_dbamt:=0;v_cramt:=0;v_recamt:=0;            
        End Loop;
        Close cur_bill;
     --delete from test1;commit;

      --insert into test1(vstring,vstring2) values(' billing ',vvar);commit;

        open p_accounts  for
        select b.comp_code comp_code,b.unit_code unit_code,b.agcd agcd,b.dpcd dpcd,a.ag_name ag_name,a.ag_name_oth_lang ag_name_oth_lang,
        a.addr1 addr1,a.addr2 addr2,a.addr3 addr3,cir_get_city(b.comp_code,a.city_code) city_name,b.billno billno,b.billdt billdt,
        sum(b.bill_copy) bill_copy,sum(b.gross_amount) gross_amount,
        sum(b.sur_amount) sur_amount,sum(b.comm_amount) comm_amount,sum(b.bill_amount) bill_amount,
        (select max(d.comm_rate) from cir_bill_det d where d.comp_code=b.comp_code and d.unit_code=b.unit_code and d.agcd=b.agcd and 
        d.dpcd=b.dpcd and d.billno=b.billno and d.billdt=b.billdt) comm_rate   
        --,bill_frdt,bill_todt,bill_flag,bill_remark
                    from cir_agmast a,cir_bill b
        where a.comp_code=pcomp_code and a.unit=b.unit_code and b.unit_code=nvl(punit_code,b.unit_code) and b.billdt between v_bill_frdt and v_bill_todt and
                    b.bill_flag=pbill_freq and ((b.billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
                    b.publ=nvl(ppubl,b.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.agcd=nvl(pbillagcd,b.agcd) and b.dpcd=nvl(pbilldpcd,b.dpcd) and (a.ag_class=pextra1 or pextra1 is null) and
                            (a.ag_type=pextra2 or pextra2 is null) 
        group by b.comp_code,b.unit_code,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.addr1,a.addr2,a.addr3,a.city_code,b.billno,b.billdt
        order by b.comp_code,b.unit_code,b.billdt,b.billno,b.agcd,b.dpcd;

        open p_accounts1 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate copy_rate,sum(supply_copy) supply from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,u.supply_date supdate,u.supply_rate supply_rate,sum(u.supply_copy) supply_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.supply_date,u.billno,u.billdt,u.supply_rate)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd,supdate,supply_rate
        order by comp_code,unit_code,billdt,billno,supdate,agcd,dpcd;

        open p_accounts2 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(supply_copy) tot_supply,sum(gross) gross_amt,sum(return_copy) return_copy,sum(return_amt) return_amt,
        sum(tot_amt) tot_amt,sum(tot_comm) tot_comm ,sum(tot_surcharge) tot_surcharge,sum(net_amt) net_amt
        from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.supply_copy) supply_copy,
        sum(u.gross_amt) gross,sum(u.return_copy) return_copy,sum(u.return_amt) return_amt,sum(u.gross_amt-u.return_amt) tot_amt,sum(u.comm_amt) tot_comm,
        sum(u.sur_amt) tot_surcharge,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts3 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(gross) gross_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt) gross
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts4 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_copy) return_copy from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_copy) return_copy
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts5 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(return_amt) return_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.return_amt) return_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts6 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_amt) tot_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt) tot_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts7 for 
        select comp_code,unit,billno,billdt,agcd,dpcd,sum(tot_comm) tot_comm from 
        (select u.comp_code comp_code,u.unit_code unit,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.comm_amt) tot_comm
        from cir_bill_det u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit,billno,billdt,agcd,dpcd
        order by comp_code,unit,billdt,billno,agcd,dpcd;

        open p_accounts8 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(tot_surcharge) tot_surcharge from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.sur_amt) tot_surcharge
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;

        open p_accounts9 for 
        select comp_code,unit_code,billno,billdt,agcd,dpcd,sum(net_amt) net_amt from 
        (select u.comp_code comp_code,u.unit_code unit_code,u.billno billno,u.billdt billdt,u.agcd agcd,u.dpcd dpcd,sum(u.gross_amt-u.return_amt-u.comm_amt+u.sur_amt) net_amt
        from cir_bill_print u
        where u.comp_code=pcomp_code and u.unit_code=punit_code and cur_sessionid=userenv('sessionid')
        group by u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billno,u.billdt)
        group by comp_code,unit_code,billno,billdt,agcd,dpcd
        order by comp_code,unit_code,billdt,billno,agcd,dpcd;
        
        open p_accounts10 for 
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",cn_amt as "Credit Amt",rec_amt as "Receipt Amount",op_amt as "Previous Balance"
        from cir_temp_outstanding
        where comp_code=pcomp_code and (unit_code=punit_code or punit_code is null) and
        dt between v_bill_frdt and v_bill_todt;
        
        open p_accounts11 for
        select comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate,sum(bill_copy) bill_copy,sum(nvl(copy_rate,0)*nvl(bill_copy,0)) gross_amt 
        from cir_bill_det 
        where comp_code=pcomp_code and unit_code=punit_code and billdt between v_bill_frdt and v_bill_todt and bill_flag=pbill_freq and 
        ((billno between pfrom_billno and ptill_billno) or (pfrom_billno is null)) and
        (agcd=pbillagcd or pbillagcd is null) and (dpcd=pbilldpcd or pbilldpcd is null)
         group by comp_code,unit_code,billno,billdt,agcd,dpcd,copy_rate
         order by comp_code,unit_code,billdt,billno,agcd,dpcd;
         
        open p_accounts12 for
        select distinct b.comp_code comp_code,b.unit_code unit_code,b.billno billno,b.billdt billdt,b.agcd agcd,b.dpcd dpcd,
        (select nvl(sum(a.sup_copy),0) from cir_dbksup a,cir_supply_type_mast s 
        where b.comp_code=a.comp_code and s.comp_code=a.comp_code and a.unit_code=b.unit_code and b.publ=a.publ and
        a.edtn =b.edtn and a.sup_type_code=s.sup_ty_code and s.bill_pay='N' and 
        a.supdate between v_bill_frdt and v_bill_todt and --between b.fromdt and  b.todt and 
        a.billagcd =b.agcd and a.billdpcd=b.dpcd) unpaid_copy
        from cir_bill_det b
        where b.comp_code=pcomp_code and b.unit_code=punit_code and 
        (b.publ=ppubl or ppubl is null) and
        (b.agcd=pbillagcd or pbillagcd is null) and (b.dpcd=pbilldpcd or pbilldpcd is null) and
        b.billdt between trunc(v_bill_frdt,'MM') and v_bill_todt
        order by b.comp_code,b.unit_code,b.billno,b.billdt,b.agcd,b.dpcd;

    End cir_bill_print_bhaskar;
    
  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt  date;
    v_todt  date;
    v_start_date    date;
        cursor cur_not_supply is
            select distinct u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date>= v_start_date  and d.supply_date<=v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;        
                
    rec_agcd cur_agcd%rowtype;

        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;

   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
    if v_frdt=v_start_date then
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_rep_billing.cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;
    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;
        --insert into test1(vstring,vstring2) values('Weekly bill1 ',rec_not_supply.agcd||rec_not_supply.dpcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;    

    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            --insert into test1(vstring,vstring2) values('Weekly bill1 ',v_opbal||' , '||rec_agcd.billagcd||' , '||rec_agcd.comp_code||','||rec_agcd.unit_code||','||v_opdate);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and
                      agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and billdt >= v_opdate and billdt<v_frdt;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and 
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            --insert into test1(vstring,vstring2) values('Weekly bill ',v_opbal||' , '||rec_agcd.billagcd);
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,abs(v_recamt),v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;
        
     open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",
        sum(nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)) as "TOTAL_COPY",sum(nvl(p01,0)*nvl(sup_rate,0)+nvl(p02,0)*nvl(sup_rate,0)+nvl(p03,0)*nvl(sup_rate,0)+nvl(p04,0)*nvl(sup_rate,0)+nvl(p05,0)*nvl(sup_rate,0)+nvl(p06,0)*nvl(sup_rate,0)+nvl(p07,0)*nvl(sup_rate,0)) as "TOTAL_AMT",
        sum(daily_return) as "DAILY_RETURN",sum(sun_return) as "SUN_RETURN"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        d.supply_rate sup_rate,d.comm_rate,
        case when to_char(d.supply_date,'d')='1' then SUM(return_copy) else 0  end sun_return,
        case when to_char(d.supply_date,'d')<>'1' then SUM(return_copy) else 0 end daily_return  
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate,d.comm_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,publ,edtn;
    
    open p_accounts1 for
    select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
    dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
    return_amt as "Deposit Balance"
    from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
    in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')) 
    order by comp_code,unit_code,agname;    

    open p_accounts2 for 
    select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,
    h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
    case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
    else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
    h.remark remark 
    from cir_rcphdr h,cir_agmast m
    where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and 
    h.doctype in('CN','DN') and h.recptdt >=v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
    h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
    (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
    (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
    (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
    order by m.ag_name,h.recptdt,h.recptno;
    
    open p_accounts3 for 
    select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
    sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
    where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and 
    supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid')
    group by comp_code,unit_code,agcd,dpcd
    order by comp_code,unit_code,agency_name,agcd,dpcd;

    open p_accounts4 for select sysdate from dual;

    open p_accounts5 for select sysdate from dual;
    open p_accounts6 for select sysdate from dual;
    open p_accounts7 for select sysdate from dual;
    open p_accounts8 for select sysdate from dual;
    open p_accounts9 for select sysdate from dual;
    
    open p_accounts10 for select sysdate from dual;
    
    --delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
    --delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p1 error ');commit;
    
    
   End cir_before_bill_print_p1;

/*
  set serveroutput on;
  var v1 refcursor;
  var v2 refcursor;
  var v3 refcursor;
  var v4 refcursor;
  var v5 refcursor;
  var v6 refcursor;
  var v7 refcursor;
  var v8 refcursor;
  var v9 refcursor;
  var v10 refcursor;
  var v11 refcursor;
  exec cir_rep_billing.cir_before_bill_print_p2('SP002','AUR','','','','','','','','B0052','0001','01-nov-2010','07-nov-2010','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6,:v7,:v8,:v9,:v10,:v11);
  */
  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts)
   As
    v_frdt          date;
    v_todt          date;
    v_start_date    date;
    
    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit and d.unit_code=punitcode and 
                d.app_dt >= v_start_date  and d.app_dt<=v_todt and d.agcd=m.agcd  and d.dpcd=m.dpcd and 
                d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
                (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and 
                (m.tehsil_taluka=ptaluka or ptaluka is null) and d.supply_copy>0 and (m.branch_code=pbranchcode or pbranchcode is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date  and supply_date<=v_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
        
        cursor cur_agcd is
        select distinct d.comp_code comp_code,d.unit_code unit_code,'' publ,d.agcd billagcd,d.dpcd billdpcd  
        from cir_bill_print d 
        where d.comp_code=pcompcode and d.unit_code=punitcode and d.supply_date between v_start_date and v_todt and 
        d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and --(d.publ_code=ppubl or ppubl is null) and 
        d.cur_sessionid=userenv('sessionid') and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd
        order by d.comp_code,d.unit_code,d.agcd,d.dpcd;       
    rec_agcd cur_agcd%rowtype;
    
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX';
            
        v_opdate          date;
        v_opbal           number(14,2):=0;
        v_billamt         number(14,2):=0;
        v_dbcramt         number(14,2):=0;
        v_dbamt           number(14,2):=0;
        v_cramt           number(14,2):=0;
        v_recamt          number(14,2):=0;   
        v_secamt          number(14,2):=0;
        v_psecamt          number(14,2):=0;
        v_csecamt          number(14,2):=0;
   Begin
    v_frdt      :=to_date(pfrom_date,''''||pdateformat||'''');
    v_todt      :=to_date(ptill_date,''''||pdateformat||'''');
    v_opdate    :=cir_get_finandt(pcompcode,to_date(pfrom_date,''''||pdateformat||''''),pdateformat,'','');
    v_start_date:=trunc(v_frdt,'mm');
    
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p2 ', pbillagcd||pbilldpcd);commit; 
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');
    --cir_before_bill_process_p(pcomp_code, punit_code,ppubl_freq, ppubl, pfrdt, ptodt, pbillagcd ,pbilldpcd, pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka , pdateformat , puserid , pextra1 ,  pextra2);
        
    if v_frdt=v_start_date then
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,pfrom_date,ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
        cir_before_bill_process_p(pcompcode,punitcode,ppubl_freq,ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_date,pbillagcd,pbilldpcd,pagencytype,pagencyclass ,pbranchcode, pdistcode , ptaluka,pdateformat,'','','');
    end if;

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcompcode and unit_code=punitcode and supply_date>= v_start_date and supply_date<=v_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcompcode and unit_code=punitcode and 
                supply_date>= v_start_date and supply_date<=v_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                app_dt=rec_not_supply.supply_date and publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and 
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;
    end loop;
    close cur_not_supply;
    
    open cur_agcd;
    loop
        fetch cur_agcd into rec_agcd;
        exit when cur_agcd%notfound;
            v_opbal:=0;v_billamt:=0;v_dbcramt :=0;v_dbamt :=0; v_cramt :=0; v_recamt :=0; v_secamt :=0;v_psecamt :=0;v_csecamt :=0;
            
            v_opbal :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            
            select sum(bill_amount) into v_billamt from cir_bill
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code  and billdt >= v_opdate and 
                billdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbcramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp<>'BIL' and 
                      recptdt>= v_opdate and recptdt<v_frdt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            select sum(amount) into v_dbamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount>0;

            select sum(amount) into v_cramt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp not in('BIL','RCR') and
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and amount<0;

            select sum(amount) into v_recamt from cir_outmast
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='NM' and doctyp='RCR' and 
                      recptdt>= v_frdt and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;

            v_opbal:=nvl(v_opbal,0)+nvl(v_billamt,0)+nvl(v_dbcramt,0);
            v_dbcramt:=0;
            ----for secutiry opening balance---
            v_dbcramt :=cir_accounts.cir_agency_opbal(rec_agcd.comp_code,rec_agcd.unit_code,'',rec_agcd.billagcd,rec_agcd.billdpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);
            
            select sum(amount) into v_psecamt from cir_rcphdr
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and achd='SC' and
                      recptdt>=v_opdate and recptdt<=v_todt and agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd;
            
            v_secamt:=nvl(v_dbcramt,0)+nvl(v_psecamt,0);
            
            select abs(SUM(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<=v_todt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');
            
            v_secamt:=nvl(v_secamt,0)-nvl(v_csecamt,0);
            v_dbcramt:=0;
            select SUM(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)+nvl(sec_amt,0)) into v_dbcramt from cir_bill_print
                where comp_code=rec_agcd.comp_code and unit_code=rec_agcd.unit_code and  
                supply_date >= trunc(v_frdt,'mm') and supply_date<v_frdt and 
                agcd=rec_agcd.billagcd and dpcd=rec_agcd.billdpcd and cur_sessionid=userenv('sessionid');            
            
            v_opbal:=nvl(v_opbal,0)+nvl(v_dbcramt,0);
            
            insert into cir_temp_outstanding(comp_code,unit_code,dt,agname,publ_code,
            agcd,dpcd,dn_amt,cn_amt,rec_amt,op_amt,return_amt)
            values(rec_agcd.comp_code,rec_agcd.unit_code,v_todt,cir_get_name.cir_agname(rec_agcd.comp_code,rec_agcd.unit_code,rec_agcd.billagcd,rec_agcd.billdpcd,1,pdateformat,'','') ,rec_agcd.publ,
            rec_agcd.billagcd,rec_agcd.billdpcd,v_dbamt,v_cramt,v_recamt,v_opbal,v_secamt);
        End Loop;
        Close cur_agcd;    
        
        open p_accounts for
        select comp_code,unit_code,publ,edtn,cir_get_name.cir_edtn(comp_code,unit_code,edtn,plangtype,''''||pdateformat||'''','','') edition_name,min(sup_rate) edtn_rate,billagcd,billdpcd,
        cir_get_name.cir_agname(comp_code,unit_code,billagcd,billdpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(p01) as "SUN",sum(p02) as "MON",sum(p03) as "TUE",sum(p04) as "WED",sum(p05) as "THU",sum(p06) as "FRI",sum(p07) as "SAT",sum(gross_amt) as "TOTAL_AMT",
        sum(u01) as "SUN_RET",sum(u02) as "MON_RET",sum(u03) as "TUE_RET",sum(u04) as "WED_RET",sum(u05) as "THU_RET",sum(u06) as "FRI_RET",sum(u07) as "SAT_RET",sum(return_gross_amt) as "RETURN_TOTAL_AMT"
        from(select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.edtn_code edtn,d.agcd billagcd,d.dpcd billdpcd,
        d.supply_date supdate,d.supply_rate sup_rate,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.supply_copy,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.supply_copy,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.supply_copy,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.supply_copy,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.supply_copy,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.supply_copy,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.supply_copy,0)) else 0 end p07,
        sum(nvl(d.supply_copy,0)*nvl(d.supply_rate,0)) gross_amt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.return_copy,0)) else 0 end u01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.return_copy,0)) else 0 end u02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.return_copy,0)) else 0 end u03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.return_copy,0)) else 0 end u04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.return_copy,0)) else 0 end u05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.return_copy,0)) else 0 end u06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.return_copy,0)) else 0 end u07,        
        sum(nvl(d.return_copy,0)*nvl(d.supply_rate,0)) return_gross_amt
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date <=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and (nvl(d.supply_copy,0)+nvl(return_copy,0))>0 and 
        (m.branch_code=pbranchcode or pbranchcode is null) and d.cur_sessionid=userenv('sessionid')
        group by d.comp_code,d.unit_code,d.publ_code,d.edtn_code,d.agcd,d.dpcd,d.supply_date,d.supply_rate)
        group by comp_code,unit_code,publ,edtn,billagcd,billdpcd
        order by comp_code,unit_code,agency_name,billagcd,billdpcd,publ,edtn;
    
        open p_accounts1 for
        select comp_code,unit_code,dt billdt,agname billno,publ_code publ,agcd,dpcd,
        dn_amt as "Debit Amt",abs(cn_amt) as "Credit Amt",abs(rec_amt) as "Receipt Amount",op_amt as "Previous Balance",
        return_amt as "Deposit Balance"
        from cir_temp_outstanding where comp_code||unit_code||agcd||dpcd 
        in(select distinct comp_code||unit_code||agcd||dpcd from cir_bill_print where comp_code=pcompcode and unit_code=punitcode and agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and
        supply_date >= v_frdt and supply_date<=v_todt and cur_sessionid=userenv('sessionid'))
        order by comp_code,unit_code,agname,agcd,dpcd;    

        open p_accounts2 for 
        select h.comp_code comp_code,h.unit_code unit_code,h.doctype||'\'||h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agname,h.amount amount,
        case when h.doctype='RCR' then (select "Payment_Mode_Name" from payment_mode_mast where "Pay_Mode_Code"=h.reason)
        else (select reason_name from cir_reason_mst where comp_code=h.comp_code and reason_code=h.reason) end as reason,
        h.remark remark 
        from cir_rcphdr h,cir_agmast m
        where h.comp_code=m.comp_code and h.comp_code=pcompcode and h.unit_code=punitcode  and h.unit_code=m.unit and h.recptdt >= v_frdt and h.recptdt<=v_todt and h.achd='NM' and h.amount<>0 and
        h.doctype in('CN','DN') and h.agcd=m.agcd and h.dpcd=m.dpcd and h.agcd=nvl(pbillagcd,h.agcd) and h.dpcd=nvl(pbilldpcd,h.dpcd) and h.branch_code=nvl(pbranchcode,h.branch_code) and 
        (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and
        (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and nvl(m.to_bill,'N')='Y' 
        order by m.ag_name,h.agcd,h.dpcd,h.recptdt,h.recptno;
    
        open p_accounts3 for 
        select comp_code,unit_code,agcd billagcd,dpcd billdpcd,cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,plangtype,''''||pdateformat||'''','','') agency_name,
        sum(nvl(supply_copy,0)*nvl(supply_rate,0)) gross_amt,nvl(sum(comm_amt),0) comm_amt,nvl(sum(return_amt),0) return_amt,abs(sum(nvl(sec_amt,0))) sec_amt from cir_bill_print
        where comp_code=pcompcode and unit_code=punitcode and supply_date >= v_frdt and supply_date<=v_todt and 
        agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid')
        group by comp_code,unit_code,agcd,dpcd
        order by comp_code,unit_code,agency_name,agcd,dpcd;
        
        open p_accounts4 for 
        select comp_code,unit_code,billagcd,billdpcd,agency_name,
        abs(sum(p01)) as "SUN",abs(sum(p02)) as "MON",abs(sum(p03)) as "TUE",abs(sum(p04)) as "WED",abs(sum(p05)) as "THU",abs(sum(p06)) as "FRI",abs(sum(p07)) as "SAT",
        abs(sum(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0))) as "TOT_RECEIPT_AMT"
        from(
        select d.comp_code comp_code,d.unit_code unit_code,d.agcd billagcd,d.dpcd billdpcd,case when plangtype='1' then m.ag_name else m.ag_name_oth_lang  end agency_name,d.supply_date recptdt,
        case when to_char(d.supply_date,'DY')='SUN' then sum(nvl(d.rec_amt,0)) else 0 end p01,
        case when to_char(d.supply_date,'DY')='MON' then sum(nvl(d.rec_amt,0)) else 0 end p02,
        case when to_char(d.supply_date,'DY')='TUE' then sum(nvl(d.rec_amt,0)) else 0 end p03,
        case when to_char(d.supply_date,'DY')='WED' then sum(nvl(d.rec_amt,0)) else 0 end p04,
        case when to_char(d.supply_date,'DY')='THU' then sum(nvl(d.rec_amt,0)) else 0 end p05,
        case when to_char(d.supply_date,'DY')='FRI' then sum(nvl(d.rec_amt,0)) else 0 end p06,
        case when to_char(d.supply_date,'DY')='SAT' then sum(nvl(d.rec_amt,0)) else 0 end p07
        from cir_agmast m,cir_bill_print d 
        where d.comp_code=pcompcode and d.comp_code=m.comp_code and d.unit_code=m.unit and d.unit_code=punitcode and d.supply_date >= v_frdt and d.supply_date<=v_todt and 
        m.agcd=d.agcd and m.dpcd=d.dpcd and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and (m.ag_type=pagencytype or pagencytype is null) and 
        (m.ag_class=pagencyclass or pagencyclass is null) and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
        (m.branch_code=pbranchcode or pbranchcode is null) and cur_sessionid=userenv('sessionid') 
        group by d.comp_code,d.unit_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.supply_date)
        group by comp_code,unit_code,billagcd,billdpcd,agency_name
        order by comp_code,unit_code,agency_name,billagcd,billdpcd;

        open p_accounts5 for select sysdate from dual;
        open p_accounts6 for select sysdate from dual;
        open p_accounts7 for select sysdate from dual;
        open p_accounts8 for select sysdate from dual;
        open p_accounts9 for select sysdate from dual;
        open p_accounts10 for select sysdate from dual;
            
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;

    insert into ERRORMESSAGE(message) values('Weekly bill print p2 Complete ');commit;
    exception when others then
    insert into ERRORMESSAGE(message) values('Weekly bill print p2 error ');commit;        
   End cir_before_bill_print_p2;
       
    procedure cir_bill_register_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      ppubl         in varchar2,
      repty         in varchar2,--Is is used State(1)/District(2)/Taluka(3)
      pbill_freq    in varchar2,
      pfrom_billdt  in varchar2,
      ptill_billdt  in varchar2,
      pbillagcd     in varchar2,
      pbilldpcd     in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,--State or district or Taluka Code
      pextra2       in varchar2,
      p_accounts    out t_accounts)
    As
        vfrdt date;
        vtodt date;
        v_statecode   varchar2(20);
        v_distcode    varchar2(20);
        v_citycode    varchar2(20);
        v_taluka      varchar2(20);        
    Begin
        --delete from test1;insert into test1(vstring,vstring2) values('cir bill register ','pcomp_code '||pcomp_code||','||punit_code||','||ppubl||','||repty||','||pbill_freq||','||pfrom_billdt||','||ptill_billdt||','||pbillagcd||','||pbilldpcd||','||pdateformat||','||pextra1||','||pextra2);commit;
        if repty='1' then--State
            v_statecode:=pextra1;
        elsif repty='2' then    --District
            v_distcode:=pextra1;
        elsif repty='3' then    --Taluka
            v_taluka:=pextra1;
        else--City
            v_citycode:=pextra1;
        end if;        
        vfrdt:=to_date(pfrom_billdt,''''||pdateformat||'''');
        vtodt:=to_date(ptill_billdt,''''||pdateformat||'''');

        if nvl(repty,'N')='1' then--for state
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,agency_name,billdt,billno;
        elsif nvl(repty,'N')='2' then --for district
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_dist(b.comp_code,m.state_code,m.dist_code) AS "DIST_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.dist_code
            order by comp_code, state_name,dist_name,agency_name,billdt,billno;        
        elsif nvl(repty,'N')='3' then---for taluka
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME",
            cir_get_taluka(b.comp_code,m.tehsil_taluka) as "TALUKA_NAME"
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code,m.tehsil_taluka
            order by comp_code, state_name,taluka_name,agency_name,billdt,billno;        
        else---for city
            open p_accounts for
            select b.comp_code comp_code, b.unit_code unit_code, b.billno billno, b.billdt billdt, b.agcd agcd, b.dpcd dpcd, 
            min(b.publ) publ, sum(b.bill_copy) bill_copy, sum(b.gross_amount) gross_amount, sum(b.sur_amt) sur_amount, sum(b.comm_amt) comm_amount, 
            sum(b.bill_amount) bill_amount,max(b.bill_flag) bill_flag,null as  bill_remark, max(b.userid) userid, max(b.creation_date) creation_date, 
            b.branch_code branch_code,m.ag_name agency_name,cir_get_city(b.comp_code,m.city_code) as "CITY NAME",
            cir_get_state(b.comp_code,m.country_code,m.state_code) as "STATE_NAME" 
            from cir_bill_det b,cir_agmast m
            where b.comp_code = pcomp_code and m.comp_code=b.comp_code and b.unit_code = nvl(punit_code,b.unit_code) and 
            m.unit=b.unit_code and b.agcd = nvl(pbillagcd,b.agcd) and m.agcd=b.agcd and b.dpcd = nvl(pbilldpcd,b.dpcd) and  
            m.dpcd=b.dpcd and b.billdt >= vfrdt and billdt <=vtodt and b.bill_flag = nvl(pbill_freq,b.bill_flag) and 
            b.publ = nvl(ppubl,b.publ) and (m.state_code=v_statecode or v_statecode is null) and (m.dist_code=v_distcode or v_distcode is null) and 
            (m.tehsil_taluka=v_taluka or v_taluka is null) and (m.city_code=v_citycode or v_citycode is null)
            group by b.comp_code, b.unit_code, b.billno ,b.billdt,b.agcd, b.dpcd,m.ag_name,b.branch_code,m.city_code,m.country_code,m.state_code
            order by comp_code, state_name,"CITY NAME",agency_name,billdt,billno;        
        end if;
        
     End cir_bill_register_p;

/*
var v1 refcursor;
exec cir_rep_billing.cir_billing_outstanding_p('SP002','AUR','','M','01-nov-2010','30-nov-2010','','','','dd/mm/yyyy','','',:v1);
*/
        procedure cir_billing_outstanding_p(
            pcomp_code      in varchar2,
            punit_code      in varchar2,
            repty           in varchar2,
            pbill_freq      in varchar2,
            pfrom_billdt    in varchar2,
            ptill_billdt    in varchar2,
            ppubl           in varchar2,
            pbillagcd       in varchar2,
            pbilldpcd       in varchar2,
            pdateformat     in varchar2,
            pbrancode       in varchar2,
            pdistcode       in varchar2,
            pagclass        in varchar2,
            pextra1         in varchar2,--for executive code
            pextra2         in varchar2,
            p_accounts      out t_accounts,
            p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);

    cursor cur_bill is
        select distinct a.comp_code comp_code,a.unit_code unit_code,/*a.publ publ,*/a.agcd agcd,a.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        /*a.billno billno,a.billdt billdt,*/sum(a.bill_copy) supply_copy,sum(a.gross_amount) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        c.bill_sec_amt bill_sec_amt,b.station_code drop_point
        from cir_bill_det a,cir_agmast b,cir_bill c
            where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and
                  a.unit_code=b.unit and a.unit_code=c.unit_code and
                  a.unit_code=nvl(punit_code,a.unit_code) and
                  a.billdt=c.billdt and a.billdt >= v_bill_frdt and a.billdt<=v_bill_todt and a.billno=c.billno and
                  (a.bill_flag=pbill_freq or pbill_freq is null) and a.publ=nvl(ppubl,a.publ) and a.agcd=b.agcd and a.dpcd=b.dpcd and
                  a.agcd=c.agcd and a.dpcd=c.dpcd and a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  (b.ag_class=pagclass or pagclass is null) and
                  (b.state_code=v_statecode or v_statecode is null) and (b.dist_code=v_distcode or v_distcode is null) and
                  (b.tehsil_taluka=v_taluka or v_taluka is null) and (b.branch_code=pbrancode or pbrancode is null) and
                  (b.city_code=v_citycode or v_citycode is null) and (b.executive_code = pextra1 or pextra1 is null)
                  group by a.comp_code,a.unit_code,/*a.publ,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka,c.bill_sec_amt,b.station_code /*,a.billno,a.billdt*/
                  order by a.comp_code,a.unit_code,/*a.billdt,a.billno,*/a.agcd,a.dpcd/*,a.publ*/;
        v1 cur_bill%rowtype;

      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_billno          varchar2(20);
        v_bildt           date;
        v_frdt            date;
        v_todt            date;
        v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_opdate          date;
        v_state_name      varchar2(200);
        v_dist_name       varchar2(200);
        v_taluka_name     varchar2(200);
        v_city_name       varchar2(200);
        v_drop_point_name varchar2(200);
    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');

    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then
        v_distcode:=pdistcode;
    elsif repty='C' then
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;

    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;

            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt into
            v_ret_copy,v_ret_gross,v_ret_comm from cir_unsold_dtl
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                doctype='UCN' and process_crdt >= v_bill_frdt and process_crdt<=v_bill_todt and agcd=v1.agcd and
                dpcd=v1.dpcd and process_crno is not null/*and publ=v1.publ*/;

            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_rcphdr
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and doctype<>'BIL' and recptdt>=v_opdate and recptdt<v_bill_frdt and achd='NM') ;

            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);

            v_rec_amt:=0;

            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
            agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC';

            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);

            v_rec_amt:=0;
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                else
                    if v2.doctyp='RCR' then
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;

            v_state_name        :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            v_drop_point_name   :=cir_get_drop_point_name(v1.comp_code,v1.unit_code,v1.drop_point,1);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            /*v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
            begin
                v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
            exception when others then
                v_taluka_name   :='N/A';
            end;
            v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);*/

            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd,
                                supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,
                                agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
            values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v_drop_point_name,
            v1.bill_sec_amt,v_sec_bal);
            

            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name:=null;v_dist_name:=null;v_taluka_name:=null;v_city_name:=null;
        End Loop;
        Close cur_bill;
        commit;
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance,a.remarks drop_point
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.state_code,a.remarks
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0))  net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.state_code
            order by comp_code,unit_code,state_name;
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance,a.remarks drop_point
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.state_code,a.dist_code,a.remarks
            order by comp_code,unit_code,state_name,district_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,
            a.state_code state_name,
            sum(a.supply_copy) supply_code,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(a.return_copy) return_copy,sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;

        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance,a.remarks drop_point
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.state_code,a.dist_code,a.city_code,a.remarks
            order by comp_code,unit_code,state_name,district_name,city_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,a.comm_amt comm_amt,(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0)) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance,a.remarks drop_point
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(a.return_amt) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)-nvl(a.bill_sec_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)-nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;
        end if;

        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    End cir_billing_outstanding_p;    

    procedure cir_unitwise_p(
        pcomp_code    in varchar2,
        punit_code    in varchar2,
        ppubl_code    in varchar2,
        pbill_freq    in varchar2,
        pfrom_billdt  in varchar2,
        ptill_billdt  in varchar2,
        pdateformat   in varchar2,
        pextra1       in varchar2,
        pextra2       in varchar2,
        p_accounts    out t_accounts) as
        vquery varchar2(4000);
        vquery_all varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
        cursor cur_mon is select distinct mon_date,to_char(mon_date,'Mon-YY') mon  from col_dates;
        rec_mon cur_mon%rowtype;
      Begin
        vquery:=null;
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');
        delete from col_dates;commit;
        insert into col_dates (mon_date) (select distinct trunc(billdt,'MM') from cir_bill
                                                where comp_code=pcomp_code and
                                                      ((unit_code=punit_code) or (punit_code is null)) and
                                                      ((publ     =ppubl_code) or (ppubl_code is null)) and
                                                      ((bill_flag=pbill_freq) or (pbill_freq is null)) and
                                                      billdt between v_bill_frdt and v_bill_todt);
         open cur_mon;
           loop
              fetch cur_mon into rec_mon;
                /*vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||',
                          to_date('||''''||rec_mon.mon_date||''''||','||''''||pdateformat||''''||'))'||'"'||rec_mon.mon||'",';*/
                exit when cur_mon%notfound;
                vquery:=vquery||'cir_get_unit_billamt(a.comp_code,a.unit_code,'||''''||ppubl_code||''''||','||''''||pbill_freq||''''||','||''''||rec_mon.mon_date||''''||') "'||rec_mon.mon||'",';
           end loop;
         close cur_mon;
         vquery:=substr(vquery,1,length(vquery)-1);
         if vquery is null then
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name from cir_bill a,pub_cent_mast b
                    where a.comp_code=b."Comp_Code" and a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         else
            vquery_all:='select distinct a.unit_code,b."Pub_Cent_name" unit_name,'||vquery||' from cir_bill a,pub_cent_mast b
                    where /*a.comp_code=b."Comp_Code" and */a.unit_code=b."Pub_cent_Code" and comp_code='||''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                                                      ((publ     ='||''''||ppubl_code||''''||') or ('||''''||ppubl_code||''''||' is null)) and
                                                      ((bill_flag='||''''||pbill_freq||''''||') or ('||''''||pbill_freq||''''||' is null)) and
                                                      billdt between '||''''||v_bill_frdt||''''||' and '||''''||v_bill_todt||'''';
         end if;                                                         
          --insert into test1(vstring) values(vquery_all);commit;
          open p_accounts for vquery_all;
      End cir_unitwise_p;

      procedure cir_billing_rate_p (
        pcomp_code            in varchar2,
        punit_code            in varchar2,
        ppubl                 in varchar2,
        pagcd                 in varchar2,
        pdpcd                 in varchar2,
        BILLNO_FROM           in varchar2,
        BILLNO_TO             in varchar2,
        pfrom_billdt          in varchar2,
        ptill_billdt          in varchar2,
        pdateformat           in varchar2,
        pextra1               in varchar2,
        pextra2               in varchar2,
        p_accounts            out t_accounts,
        p_accounts1           out t_accounts,
        p_accounts2           out t_accounts,
        p_accounts3           out t_accounts)
    AS
        vquery   varchar2(4000);
        vquery1  varchar2(4000);
        vquery2  varchar2(4000);
        vquery3  varchar2(4000);
        v_bill_frdt date;
        v_bill_todt date;
    Begin
        v_bill_frdt    :=to_date(pfrom_billdt,''''||pdateformat||'''');
        v_bill_todt    :=to_date(ptill_billdt,''''||pdateformat||'''');

           open p_accounts for
           select comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy,(copy_rate*bill_copy) AS "TOTAL"
               from cir_bill_det
                where comp_code=pcomp_code and unit_code=punit_code
                and BILLDT  between v_bill_frdt and v_bill_todt
                and ((publ=ppubl ) or (ppubl is null))
                and ((agcd=pagcd) or (pagcd is null))
                and ((dpcd=pdpcd) or (pdpcd is null))
                group by comp_code,unit_code,billno,publ,agcd,dpcd,copy_rate,bill_copy;

          vquery1 := vquery1||'SELECT SUM(a.SUP_COPY),a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd
                            from cir_dbksup a,cir_bill_det b
                            where a.COMP_CODE='''||pcomp_code||'''
                            and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                            and ((a.publ='''||ppubl||''' ) or ('''||ppubl||'''  is null))
                            and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||'''  is null))
                            and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||'''  is null))   AND
                            a.AGCD || a.DPCD =b.AGCD || b.DPCD  AND
                            a.UNIT_CODE=b.UNIT_CODE AND
                            b.COMP_CODE=a.COMP_CODE
                            AND (b.PUBL='''||ppubl||''' OR '''||ppubl||''' IS NULL)
                            and b.BILLDT  between '''||v_bill_frdt||''' and '''||v_bill_todt||'''
                            AND a.SUPDATE BETWEEN  b.FROMDT AND  b.TODT
                            AND a.EDTN =b.EDTN
                            and a.SUP_TYPE_CODE IN
                            (SELECT cir_supply_type_mast.SUP_TY_CODE FROM cir_supply_type_mast WHERE cir_supply_type_mast.BILL_PAY=''N''
                            AND cir_supply_type_mast.COMP_CODE=a.COMP_CODE AND a.SUP_TYPE_CODE=cir_supply_type_mast.SUP_TY_CODE )
                            group by a.comp_code,a.unit_code,b.billno,a.agcd,a.dpcd';
                        --   INSERT INTO SEARCHTBL VALUES(vquery1);COMMIT;
                        open p_accounts1 for
                       vquery1;

        vquery2 := vquery2||'SELECT SUM(a.AMOUNT) as "CREDIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                             from cir_outmast a
                             where a.COMP_CODE='''||PCOMP_CODE||'''
                             and( a.unit_code='''||punit_code||'''  or '''||punit_code||'''  IS NULL)
                             and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                             and ((a.publ='''||ppubl||''' ) or ('''||ppubl||''' is null))
                             and ((a.agcd='''||pagcd||''' ) or ('''||pagcd||''' is null))
                             and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                             a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                             WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                           --AND b.PUBL=a.PUBL
                             AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                             and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                             a.DOCTYP in(''UCN'',''CN'') and a.achd<>''SC''
                             group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

                             open p_accounts2 for
                                  vquery2;

         vquery3 := vquery3||'SELECT SUM(a.AMOUNT) as "DEBIT_AMT",a.comp_code comp_code,a.BILLNO BILLNO, a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd
                                from cir_outmast a
                                where a.COMP_CODE='''||PCOMP_CODE||'''
                                and( a.unit_code='''||punit_code||''' or '''||punit_code||''' IS NULL)
                                and (a.BILLNO between  '''||BILLNO_FROM||''' AND '''||BILLNO_TO||''')
                                and ((a.publ='''||ppubl||'''  ) or ('''||ppubl||'''  is null))
                                and ((a.agcd='''||pagcd||'''  ) or ('''||pagcd||'''  is null))
                                and ((a.dpcd='''||pdpcd||''') or ('''||pdpcd||''' is null)) AND
                                a.AGCD || a.DPCD IN(SELECT b.AGCD || b.DPCD FROM cir_bill b
                                WHERE a.UNIT_CODE=b.UNIT_CODE AND b.COMP_CODE=a.COMP_CODE
                                --AND b.PUBL=a.PUBL
                                AND b.billdt between '''||v_bill_frdt||''' and '''||v_bill_todt||''')
                                and a.RECPTDT between '''||v_bill_frdt||''' and '''||v_bill_todt||''' AND
                                a.DOCTYP in(''DN'') and a.achd<>''SC''
                                group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.BILLNO';

        open p_accounts3 for vquery3;

     End  cir_billing_rate_p;

  Procedure cir_before_bill_process_p(
    pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2)
  As
       ln_count           number;
       vsrch_amt           number;                                
       --bill_no               varchar2(20) ;
       daily_gross_amount number(15,2);
       daily_net_amount   number(15,2);
       tot_surcharge_amt  number(15,2);
       vcomm_per           number;
       vcomm_amt           number(15,2);
       curr_bilagcd           varchar2(30) := 'DUMMY_CURR';
       prev_bilagcd       varchar2(30) := 'DUMMY_PREV';
       curr_record           varchar2(100):= 'DUMMY_CURR'; --new add
       prev_record           varchar2(100):= 'DUMMY_PREV'; --new add
       tot_copy           number := 0;
       vbill_no            varchar2(20);
       vid                   number;
       v_frdt               date;
       v_todt               date;
       v_billdt           date;
        
       v_agcd_sec_per  number:=0;v_agcd_sec_amt_limt number:=0;
        
        v_sec_limit     number(10,2);
        v_bill_dbn_amt  number(10,2);
        v_bill_sec_amt  number(10,2);
        v_remark varchar2(200);
        v_reptno varchar2(25);
        v_rec_no            number(10);
        v_daily_comm_amt    number(15,2);
        v_daily_sur_amt     number(15,2);
        v_daily_gross_amt   number(15,2);
        v_daily_bill_amt    number(15,2);
        v_return_copy       number(10);
        v_return_amt        number(10,2);
      cursor agency_cur is
            /*select distinct m.comp_code comp_code,m.unit unit,m.agcd bill_agcd,m.dpcd bill_dpcd from 
            (select distinct a.comp_code,a.unit,a.bill_agcd,a.bill_dpcd
            from cir_agmast a
            where  a.comp_code = pcomp_code and a.unit     = punit_code and 
            a.agcd||a.dpcd in (select distinct agcd||dpcd agcdpdcd from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct agcd||dpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) and 
            a.bill_agcd=nvl(pbillagcd,a.bill_agcd) and a.bill_dpcd=nvl(pbilldpcd,a.bill_dpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y') u,cir_agmast m
            where u.comp_code = m.comp_code and u.comp_code = pcomp_code and u.unit=m.unit and u.unit = punit_code and 
            u.bill_agcd=m.agcd and u.bill_dpcd=m.dpcd and
            (m.ag_type=pagencytype or pagencytype is null) and (m.ag_class=pagencyclass or pagencyclass is null) and 
            (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptaluka or ptaluka is null) and 
            (m.branch_code=pbranchcode or pbranchcode is null)
            order by m.comp_code,m.unit,m.agcd,m.dpcd;*/
            select distinct x.comp_code comp_code,x.unit_code unit,x.billagcd bill_agcd,x.billdpcd bill_dpcd 
            from(select u.comp_code,u.unit_code,u.agcd,u.dpcd,u.billagcd,u.billdpcd 
            from(select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd  from cir_dbksup 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0
            union
            select distinct comp_code,unit_code,agcd,dpcd,billagcd,billdpcd from cir_dbksup_resale 
            where comp_code = pcomp_code and unit_code = punit_code and publ = nvl(ppubl,publ) and
            supdate >= v_frdt and supdate <=v_todt and nvl(sup_copy,0)>0) u,cir_agmast a
            where a.comp_code=u.comp_code and a.unit=u.unit_code and a.agcd=u.agcd and a.dpcd=u.dpcd and
            u.billagcd=nvl(pbillagcd,u.billagcd) and u.billdpcd=nvl(pbilldpcd,u.billdpcd) and
            a.bill_agcd is not null and a.bill_dpcd is not null and nvl(a.to_bill,'N')='Y' and
            (a.ag_type=pagencytype or pagencytype is null) and (a.ag_class=pagencyclass or pagencyclass is null) and 
            (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and 
            (a.branch_code=pbranchcode or pbranchcode is null))x
            order by x.comp_code,x.unit_code,x.billagcd,x.billdpcd; 

    agency_rec agency_cur%rowtype;
    
        cursor cur_supply is 
        select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.comm_fix_auto_spl comm_fix_auto_spl,
        u.comm_code comm_code,u.sup_rate sup_rate,u.supdate supdate,u.surch_cd surch_cd,sum(u.sup_copy) sup_copy from 
        (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
        d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0
            union all
             select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,d.edtn edtn,d.comm_fix_auto_spl comm_fix_auto_spl,
                    d.comm_code comm_code,d.sup_rate sup_rate,d.supdate supdate,d.surch_cd surch_cd,d.billagcd agcd,d.billdpcd dpcd,d.sup_copy sup_copy 
                   from cir_dbksup_resale d,cir_supply_type_mast s,cir_publ_mast p
                    where d.comp_code = pcomp_code and d.comp_code = s.comp_code and d.comp_code = p.comp_code and
                        d.unit_code = punit_code and d.sup_type_code=s.sup_ty_code and nvl(s.bill_pay,'N') = 'Y' and 
                        d.publ =p.publ /* and p.period    = ppubl_freq*/ and
                        d.supdate >= v_frdt and d.supdate <=v_todt and nvl(d.sup_copy,0)>0) u 
        where u.comp_code = agency_rec.comp_code and u.unit_code = agency_rec.unit and 
                u.agcd=agency_rec.bill_agcd and u.dpcd=agency_rec.bill_dpcd/*u.agcd||u.dpcd in (select agcd||dpcd from cir_agmast 
                        where comp_code = agency_rec.comp_code and unit = agency_rec.unit and
                              bill_agcd = agency_rec.bill_agcd and
                              bill_dpcd = agency_rec.bill_dpcd)*/
       group by u.comp_code,u.unit_code,u.publ,u.edtn,u.comm_fix_auto_spl,u.comm_code,u.sup_rate,u.supdate,u.surch_cd;
       rec_supply cur_supply%rowtype;

       avg_sup number;
       
       cursor comm_auto is select * from cir_comm_mast
            where comp_code = pcomp_code and
                  unit_code = punit_code and
                  publ = rec_supply.publ and
                  edtn = rec_supply.edtn and
                  comm_type = rec_supply.comm_fix_auto_spl and
                  comm_catg_code = rec_supply.comm_code and  
                  valid_from = (select max(valid_from) from cir_comm_mast
                                     where comp_code = pcomp_code and
                                           unit_code = punit_code and
                                           publ = rec_supply.publ and
                                           edtn = rec_supply.edtn and
                                           comm_type = rec_supply.comm_fix_auto_spl and
                                           comm_catg_code = rec_supply.comm_code and  
                                           valid_from <= v_billdt and
                                           avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0)) and
                  avg_sup between nvl(sup_copy_from,0) and nvl(sup_copy_to,0);
        rec_comm_auto comm_auto%rowtype;          
       
       cursor comm_fix_spl is select * from cir_comm_mast
                                where comp_code = pcomp_code and
                                      unit_code = punit_code and
                                      publ = rec_supply.publ and
                                      edtn = rec_supply.edtn and
                                      comm_type = rec_supply.comm_fix_auto_spl and
                                      comm_catg_code = rec_supply.comm_code and  
                                      valid_from = (select max(valid_from) from cir_comm_mast
                                                         where comp_code = pcomp_code and
                                                               unit_code = punit_code and
                                                               publ = rec_supply.publ and
                                                               edtn = rec_supply.edtn and
                                                               comm_type = rec_supply.comm_fix_auto_spl and
                                                               comm_catg_code = rec_supply.comm_code and  
                                                               valid_from <= rec_supply.supdate);
        rec_comm_fix_spl comm_fix_spl%rowtype;          
                  
       cursor cur_surcharge is select * from cir_surcharge_mast 
                where comp_code  = pcomp_code and 
                      unit       = punit_code and
                      publ       = rec_supply.publ and
                      edtn       = rec_supply.edtn and
                      surch_cd   = rec_supply.surch_cd and 
                      valid_from = (select max(valid_from) from cir_surcharge_mast 
                                                where comp_code  = pcomp_code and 
                                                      unit       = punit_code and
                                                      publ       = rec_supply.publ and
                                                      edtn       = rec_supply.edtn and
                                                      surch_cd   = rec_supply.surch_cd and
                                                      valid_from<= rec_supply.supdate);
       rec_surcharge cur_surcharge%rowtype;
       
       v_bran_code cir_agmast.branch_code%type;
       v_rec_amt number:=0;
       v_rcp_count number:=0;

    Begin
        v_frdt         :=to_date(pfrdt,''''||pdateformat||'''');
        v_todt         :=to_date(ptodt,''''||pdateformat||'''');
        v_billdt     :=v_todt;
    Begin

        open agency_cur; 
        loop 
            fetch agency_cur into agency_rec;
            exit when agency_cur%notfound;
            
            curr_bilagcd := agency_rec.bill_agcd ||agency_rec.bill_dpcd;
            curr_record  := agency_rec.bill_agcd ||agency_rec.bill_dpcd/*||agency_rec.publ*/;
       ---------------------------------------------- add new code ------------------------------------------------------
            if curr_record <> prev_record then
                daily_gross_amount  := 0;
                tot_copy            := 0;
                tot_surcharge_amt   := 0;
                vsrch_amt           :=0;
                vcomm_amt           :=0;
            end if;

            open cur_supply;
            loop 
                fetch cur_supply into rec_supply;
                exit when cur_supply%notfound;
                tot_copy := nvl(tot_copy,0) + nvl(rec_supply.sup_copy,0) ;
                daily_gross_amount := nvl(daily_gross_amount,0)  + nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                v_daily_gross_amt:=nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0);
                if rec_supply.comm_fix_auto_spl!='A' then
                    open comm_fix_spl;
                    fetch comm_fix_spl into rec_comm_fix_spl;
                    
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vcomm_per:= rec_comm_fix_spl.sun_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vcomm_per:= rec_comm_fix_spl.mon_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday commition rate
                        vcomm_per:= rec_comm_fix_spl.tue_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday commition rate
                        vcomm_per:= rec_comm_fix_spl.wed_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday commition rate
                        vcomm_per:= rec_comm_fix_spl.thu_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday commition rate
                        vcomm_per:= rec_comm_fix_spl.fri_comm_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday commition rate
                        vcomm_per:= rec_comm_fix_spl.sat_comm_rate;
                    else
                        vcomm_per:=    0;
                    end if;
                    rec_comm_fix_spl.sun_comm_rate:=0; rec_comm_fix_spl.mon_comm_rate:=0; rec_comm_fix_spl.tue_comm_rate:=0;
                    rec_comm_fix_spl.wed_comm_rate:=0;rec_comm_fix_spl.thu_comm_rate:=0; rec_comm_fix_spl.fri_comm_rate:=0;
                    rec_comm_fix_spl.sat_comm_rate:=0;                                     
                    if nvl(rec_comm_fix_spl.comm_catg_type,'N')='P' then
                        vcomm_amt:=nvl(vcomm_amt,0) + (nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                        v_daily_comm_amt:=(nvl(rec_supply.sup_copy,0) * nvl(rec_supply.sup_rate,0))*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_fix_spl.comm_catg_type,'N')='C' then
                        vcomm_amt:= nvl(vcomm_amt,0) + nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                        v_daily_comm_amt:=nvl(rec_supply.sup_copy,0)*nvl(vcomm_per,0);
                    else
                        vcomm_amt:=0;
                        v_daily_comm_amt:=0;
                    end if;
                    close comm_fix_spl;   
                end if; 
                            
                open cur_surcharge;
                fetch cur_surcharge into rec_surcharge;
                    if to_char(rec_supply.supdate,'DY') = 'SUN' then          ---for sunday commition rate
                        vsrch_amt:= rec_surcharge.sun_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'MON' then      ---for monday commition rate
                        vsrch_amt:= rec_surcharge.mon_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'TUE' then      ---for tueday surcharge rate
                        vsrch_amt:= rec_surcharge.tue_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'WED' then      ---for wednesday surcharge rate
                        vsrch_amt:= rec_surcharge.wed_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'THU' then      ---for Thursday surcharge rate
                        vsrch_amt:= rec_surcharge.thu_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'FRI' then      ---for friday surcharge rate
                        vsrch_amt:= rec_surcharge.fri_rate;
                    elsif to_char(rec_supply.supdate,'DY') = 'SAT' then      ---for saturday surcharge rate
                        vsrch_amt:= rec_surcharge.sat_rate;
                    else
                        vsrch_amt:=    0;
                    end if;
                close cur_surcharge;    
                
                tot_surcharge_amt   :=  nvl(tot_surcharge_amt,0) + nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_sur_amt     :=  nvl(rec_supply.sup_copy,0) * nvl(vsrch_amt,0);
                v_daily_bill_amt    :=  nvl(v_daily_gross_amt,0)+nvl(v_daily_sur_amt,0)-nvl(v_daily_comm_amt,0);
                
                If pextra1 is null then
                    select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
                        from cir_unsold_dtl
                        where comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and doctype='UCN' and
                            app_dt=rec_supply.supdate and publ=rec_supply.publ and edtn=rec_supply.edtn and agcd=agency_rec.bill_agcd and
                            dpcd=agency_rec.bill_dpcd and copy_rate=rec_supply.sup_rate and
                             (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                                
                    select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
                        where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and
                            agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and recptdt = rec_supply.supdate and
                            doctype='RCR' and achd='NM';
                            
                    select count(*) into v_rcp_count from cir_bill_return_print
                        where cur_sessionid=userenv('sessionid') and comp_code=rec_supply.comp_code and unit_code=rec_supply.unit_code and 
                            receipt_date=rec_supply.supdate and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd;
                    if nvl(v_rcp_count,0)>0 then
                        v_rec_amt:=0; 
                    else
                        insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
                        values(rec_supply.comp_code,rec_supply.unit_code,agency_rec.bill_agcd,agency_rec.bill_dpcd,rec_supply.supdate,v_rec_amt);
                    end if;
                End if;
        
                insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                   supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                   return_copy,return_amt,cur_sessionid,rec_amt)
                                        values(rec_supply.comp_code,rec_supply.unit_code,null,v_billdt,rec_supply.publ,rec_supply.edtn,agency_rec.bill_agcd,agency_rec.bill_dpcd,
                             rec_supply.supdate,rec_supply.sup_copy,rec_supply.sup_rate,nvl(v_daily_gross_amt,0),nvl(vcomm_per,0),nvl(v_daily_comm_amt,0),nvl(vsrch_amt,0),nvl(v_daily_sur_amt,0),
                             v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                v_rec_amt:=0;v_rcp_count:=0;
            end loop; 
            avg_sup:=nvl(tot_copy,0);

            if rec_supply.comm_fix_auto_spl = 'A' then
                 --cal_avg_copy(agency_rec.bilagcd,agency_rec.bildpcd,agency_rec.publ);
                if tot_copy > 0 then 
                    open comm_auto;
                    fetch comm_auto into rec_comm_auto;
                    vcomm_per :=  rec_comm_auto.sun_comm_rate;
                    if nvl(rec_comm_auto.comm_catg_type,'N')='P' then
                          vcomm_amt:=nvl(daily_gross_amount,0)*nvl(vcomm_per,0)/100;
                    elsif nvl(rec_comm_auto.comm_catg_type,'N')='C' then
                          vcomm_amt:=nvl(tot_copy,0)*nvl(vcomm_per,0);
                    else
                          vcomm_amt:=0;
                    end if;      
                    close comm_auto;
                end if;
            end if;
           
           close cur_supply;
           daily_net_amount := nvl(daily_gross_amount,0) + nvl(tot_surcharge_amt,0) - nvl(vcomm_amt,0);
           vbill_no         :=nvl(vbill_no,0)+1;
           --vbill_no:=cir_generate_billno(agency_rec.comp_code,agency_rec.unit,v_billdt,pdateformat,'','');

           if nvl(tot_copy,0) > 0 then
             Begin
                 select abs(sum(amount)) into v_sec_limit from cir_rcphdr 
                      where comp_code=  agency_rec.comp_code and
                            unit_code=  agency_rec.unit and
                            agcd     =  agency_rec.bill_agcd and
                            dpcd     =  agency_rec.bill_dpcd and
                            recptdt  <= v_todt and
                            achd     =  'SC';
                      exception when others then
                            v_sec_limit:=0;
             End;

            select distinct security_per,sec_amt_limt,branch_code into v_agcd_sec_per,v_agcd_sec_amt_limt,v_bran_code from cir_agmast 
              where comp_code = pcomp_code and unit = punit_code and agcd=agency_rec.bill_agcd and 
                    dpcd=agency_rec.bill_dpcd;
             
             if nvl(v_agcd_sec_per,0)>0 then
                 if nvl(v_agcd_sec_amt_limt,0)>nvl(v_sec_limit,0) then
                    v_bill_dbn_amt:=nvl(v_agcd_sec_per,0)*nvl(daily_net_amount,0)/100;
                 end if;
                 if nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0)<nvl(v_bill_dbn_amt,0) then
                    v_bill_sec_amt:=nvl(v_agcd_sec_amt_limt,0)-nvl(v_sec_limit,0);
                 else
                    v_bill_sec_amt:=nvl(v_bill_dbn_amt,0);
                 end if;
                if nvl(v_bill_sec_amt,0)<0 then
                    v_bill_sec_amt:=0;
                end if;
             end if;
            
            update cir_bill_print set billno=vbill_no,sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;

            /*update cir_bill_print set sec_amt=v_bill_sec_amt
            where comp_code=agency_rec.comp_code and unit_code=agency_rec.unit and 
            billdt=v_billdt and agcd=agency_rec.bill_agcd and dpcd=agency_rec.bill_dpcd and cur_sessionid=userenv('sessionid') and rownum<2;*/
           
            v_sec_limit      :=0; v_bill_dbn_amt:=0; v_bill_sec_amt   :=0;
            v_remark         :='';v_reptno      :='';v_rec_no         :=0; 
            v_daily_comm_amt :=0; v_daily_sur_amt:=0;v_daily_gross_amt:=0;
            v_daily_bill_amt :=0;
           end if;
       end loop;
    close agency_cur;
    commit;
    End;  
  
  End cir_before_bill_process_p;
  
  procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,--for executive code
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts)
    As
      v_bill_frdt   date;
      v_bill_todt   date;
      v_start_date  date;
      v_dt          date;
      v_query1      varchar2(8000);
      v_query2      varchar2(8000);
      v_statecode   varchar2(20);
      v_distcode    varchar2(20);
      v_citycode    varchar2(20);
      v_taluka      varchar2(20);

    cursor cur_not_supply is
            select u.comp_code comp_code,u.unit_code unit_code,u.agcd agcd,u.dpcd dpcd,u.publ publ,u.edtn edtn,
            u.supply_date supply_date,u.copy_rate copy_rate from
            (select d.comp_code,d.unit_code,d.agcd,d.dpcd,d.publ,d.edtn,d.recptdt supply_date,d.copy_rate 
            from cir_agmast m,cir_unsold_dtl d
            where d.comp_code=m.comp_code and d.comp_code=pcomp_code and d.unit_code=m.unit and d.unit_code=punit_code and 
                d.doctype='UCN' and d.agcd=m.agcd  and d.dpcd=m.dpcd and d.app_dt >= v_start_date  and d.agcd=nvl(pbillagcd,d.agcd) and d.dpcd=nvl(pbilldpcd,d.dpcd) and 
                d.app_dt<=v_bill_todt and  (m.ag_class=pagclass or pagclass is null) and (m.dist_code=v_distcode or v_distcode is null) and 
                (m.tehsil_taluka=v_taluka or v_taluka is null) and d.supply_copy>0 and (m.branch_code=pbrancode or pbrancode is null) and
                (m.executive_code = pextra1 or pextra1 is null) and 
                (nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_bnr,0)+nvl(d.apr_unsold,0))>0
             minus
            select comp_code,unit_code,agcd,dpcd,publ_code publ,edtn_code edtn,supply_date,supply_rate copy_rate from cir_bill_print
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date  and supply_date<=v_bill_todt and 
            agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and supply_copy>0 and cur_sessionid=userenv('sessionid')) u;
    rec_not_supply  cur_not_supply%rowtype;
    
    cursor cur_bill is
        select distinct x.comp_code comp_code,x.unit_code unit_code,x.agcd agcd,x.dpcd dpcd,b.ag_name ag_name,b.ag_name_oth_lang ag_name_oth_lang,
        b.city_code city_code,b.country_code country_code,b.state_code state_code,b.dist_code dist_code,b.tehsil_taluka taluka_code,
        sum(x.supply_copy) supply_copy,sum(x.gross_amount) gross_amount,sum(x.sur_amount) sur_amount,sum(x.comm_amount) comm_amount,
        sum(x.bill_sec_amt) bill_sec_amt from
        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        sum(a.supply_copy) supply_copy,sum(a.gross_amt) gross_amount,sum(a.sur_amt) sur_amount,sum(a.comm_amt) comm_amount,
        sum(a.sec_amt) bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_bill_frdt and a.supply_date<=v_bill_todt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.publ_code=nvl(ppubl,a.publ_code) and a.cur_sessionid=userenv('sessionid')
                  group by a.comp_code,a.unit_code,a.agcd,a.dpcd
        union
        select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,
        0 supply_copy,0 gross_amount,0 sur_amount,0 comm_amount,0 bill_sec_amt
        from cir_bill_print a
            where a.comp_code=pcomp_code and a.unit_code=nvl(punit_code,a.unit_code) and
                  a.supply_date >= v_start_date and a.supply_date<v_bill_frdt and 
                  a.agcd=nvl(pbillagcd,a.agcd) and a.dpcd=nvl(pbilldpcd,a.dpcd) and
                  a.cur_sessionid=userenv('sessionid') and a.publ_code=nvl(ppubl,a.publ_code)) x,cir_agmast b
                  where x.comp_code=b.comp_code and x.unit_code=b.unit and x.agcd=b.agcd and x.dpcd=b.dpcd
                  group by x.comp_code,x.unit_code,x.agcd,x.dpcd,b.ag_name,b.ag_name_oth_lang,
                  b.city_code,b.country_code,b.state_code,b.dist_code,b.tehsil_taluka
                  order by x.comp_code,x.unit_code,x.agcd,x.dpcd;
        v1 cur_bill%rowtype;
      
      cursor cur_type is
        select doctyp,sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
                achd='NM' and doctyp not in('BIL','UCN') and recptdt>=v_bill_frdt and recptdt<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd
            group by doctyp;
        v2 cur_type%rowtype;
        v_dsign           number(2);
        v_comp_code       varchar2(8);
        v_unit_code       varchar2(8);
        v_publ_code       varchar2(8);
        v_agcode          varchar2(20);
        v_depo_code       varchar2(20);
        v_agname          varchar2(200);
        v_agname_oth_lang varchar2(250);
        v_city_name       varchar2(100);
        --v_billno          varchar2(20);
        --v_bildt           date;
        
        v_return_copy     number(10);
        v_return_amt      number(10,2);
        vbill_no          varchar2(20);
        --v_rec_amt         number:=0;
        v_rcp_count       number:=0;
        v_prev_agcd       varchar2(30):='XX';  
        v_cur_agcd        varchar2(30):='XX'; 

       v_ret_gross       number(15,2):=0;
        v_ret_comm        number(15,2):=0;
        v_ret_copy        number(15):=0;
        v_dn_amt          number(15,2):=0;
        v_cn_amt          number(15,2):=0;
        v_rec_amt         number(15,2):=0;
        v_prev_bal        number(15,2):=0;
        v_sec_bal         number(15,2):=0;
        v_psecamt         number(15,2):=0;
        v_csecamt         number(15,2):=0;  
        v_opdate          date;
        v_bill_exist      number(5);

        v_pbillret        number(15,2):=0;
        v_state_name        varchar2(200);
        v_dist_name         varchar2(200);
        v_taluka_name       varchar2(200);

    Begin
    v_bill_frdt     :=to_date(pfrom_billdt,''''||pdateformat||'''');
    v_bill_todt     :=to_date(ptill_billdt,''''||pdateformat||'''');
    v_opdate        :=cir_get_finandt(pcomp_code,to_date(pfrom_billdt,''''||pdateformat||''''),pdateformat,'','');
    v_start_date    :=trunc(v_bill_frdt,'mm');
    
    if repty='S' then
        v_statecode:=pdistcode;
    elsif repty='D' then
        v_distcode:=pdistcode;
    elsif repty='C' then
        v_citycode:=pdistcode;
    else
        v_taluka:=pdistcode;
    end if;
    --delete test1;commit;insert into test1(vstring,vstring2) values(' cir_before_bill_print_p1 ', pbillagcd||pbilldpcd);commit;
    delete from cir_temp_outstanding;
    delete from cir_bill_print where cur_sessionid=userenv('sessionid');
    delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');

    
    select count(*) into v_bill_exist from cir_bill_det b,cir_publ_mast p 
        where b.comp_code=pcomp_code and b.comp_code = p.comp_code and b.unit_code=punit_code and 
            b.billdt >= v_bill_frdt and b.billdt<=v_bill_todt and b.publ =p.publ and 
            (b.agcd=nvl(pbillagcd,b.agcd) or pbillagcd='') and (b.dpcd=nvl(pbilldpcd,b.dpcd) or pbilldpcd='');
    
    if v_bill_frdt=v_start_date then
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    else
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),to_char(v_bill_frdt-1,''''||pdateformat||''''),pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        --cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,pfrom_billdt,ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
        cir_before_bill_process_p(pcomp_code,punit_code,'',ppubl,to_char(v_start_date,''''||pdateformat||''''),ptill_billdt,pbillagcd,pbilldpcd,'',pagclass ,pbrancode, v_distcode , v_taluka,pdateformat,'','','');
    end if;    
    --delete from test1;commit;
    --insert into test1(vstring,vstring2) values('cir_billing_outstanding ','pfrom_billdt '||pfrom_billdt||' ptill_billdt '||ptill_billdt||' repty '||repty||' pextra1 '||pextra1);commit; 
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');

    open cur_not_supply;
    loop
        fetch cur_not_supply into rec_not_supply;
        exit when cur_not_supply%notfound;

        v_cur_agcd  :=rec_not_supply.agcd||rec_not_supply.dpcd;
        
        if v_prev_agcd<>v_cur_agcd then--XX & A0002
            v_prev_agcd :=v_cur_agcd;
        
        select max(to_number(billno)) into vbill_no from cir_bill_print 
            where comp_code=pcomp_code and unit_code=punit_code and supply_date>= v_start_date and supply_date<=v_bill_todt and 
                agcd=nvl(pbillagcd,agcd) and dpcd=nvl(pbilldpcd,dpcd) and cur_sessionid=userenv('sessionid');            
        if to_number(vbill_no)=0 then
            select max(to_number(billno)) into vbill_no from cir_bill_print 
                where comp_code=pcomp_code and unit_code=punit_code and 
                supply_date>= v_start_date and supply_date<=v_bill_todt and 
                    cur_sessionid=userenv('sessionid');
        end if;
            
        end if;
        
        select sum(nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)),sum(nvl(copy_amt,0)-nvl(waste_amt,0)) return_amt into v_return_copy,v_return_amt
            from cir_unsold_dtl
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and doctype='UCN' and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and app_dt=rec_not_supply.supply_date and 
                publ=rec_not_supply.publ and edtn=rec_not_supply.edtn and copy_rate=rec_not_supply.copy_rate and
                (nvl(apr_late_recpt,0)+nvl(apr_short_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0;
                            
        select abs(sum(amount)) into v_rec_amt from cir_rcphdr 
            where comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and
                doctype='RCR' and recptdt = rec_not_supply.supply_date and
                agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd and achd='NM';
                        
        select count(*) into v_rcp_count from cir_bill_return_print
            where cur_sessionid=userenv('sessionid') and comp_code=rec_not_supply.comp_code and unit_code=rec_not_supply.unit_code and 
                receipt_date=rec_not_supply.supply_date and agcd=rec_not_supply.agcd and dpcd=rec_not_supply.dpcd;
        if nvl(v_rcp_count,0)>0 then
            v_rec_amt:=0; 
        else
            insert into cir_bill_return_print(comp_code,unit_code,agcd,dpcd,receipt_date,sur_amt)
            values(rec_not_supply.comp_code,rec_not_supply.unit_code,rec_not_supply.agcd,rec_not_supply.dpcd,rec_not_supply.supply_date,v_rec_amt);
        end if;           
                        
        insert into cir_bill_print(comp_code,unit_code,billno,billdt,publ_code,edtn_code,agcd,dpcd,
                                supply_date,supply_copy,supply_rate,gross_amt,comm_rate,comm_amt,sur_rate,sur_amt,
                                return_copy,return_amt,cur_sessionid,rec_amt)
                  values(rec_not_supply.comp_code,rec_not_supply.unit_code,vbill_no,v_bill_todt,rec_not_supply.publ,rec_not_supply.edtn,rec_not_supply.agcd,rec_not_supply.dpcd,
                                rec_not_supply.supply_date,0,rec_not_supply.copy_rate,0,0,0,0,0,
                                v_return_copy,v_return_amt,userenv('sessionid'),v_rec_amt);
                             
    v_return_copy:=0;v_return_amt:=0;v_rcp_count:=0;v_rec_amt:=0;
    end loop;
    close cur_not_supply;
    
        Open cur_bill;---main cursor bill
        Loop
            fetch cur_bill into v1;
            exit when cur_bill%notfound;

            select sum(u.tot_return),sum(u.gross_amt),sum(u.comm_amt) into v_ret_copy,v_ret_gross,v_ret_comm from
            (select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt  
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and process_crno is null/*and publ=v1.publ*/
            union
            select sum(nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0)) tot_return,
            nvl(sum(copy_amt),0) gross_amt,
            sum((nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))*nvl(copy_rate,0))-nvl(sum(copy_amt),0) comm_amt 
            from cir_unsold_dtl 
            where comp_code=v1.comp_code and unit_code=v1.unit_code and 
                doctype='UCN' and agcd=v1.agcd and dpcd=v1.dpcd and app_dt >= v_bill_frdt and app_dt<=v_bill_todt and 
                process_crno is not null /*and publ=v1.publ*/) u;
                
            v_prev_bal  :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'NM',pdateformat,pextra1,pextra2);
            v_sec_bal   :=cir_accounts.cir_agency_opbal(v1.comp_code,v1.unit_code,'',v1.agcd,v1.dpcd,v_opdate,'SC',pdateformat,pextra1,pextra2);

            select sum(amount) into v_rec_amt from
            (select sum(amount) amount  from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp='BIL' and billdt>=v_opdate and billdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp <>'BIL' and recptdt>=v_opdate and recptdt<v_start_date and agcd=v1.agcd and dpcd=v1.dpcd
            union all
            select sum(amount) amount from cir_outmast
            where comp_code=v1.comp_code and unit_code=v1.unit_code and
            achd='NM' and doctyp<>'UCN' and recptdt>=v_start_date and recptdt<v_bill_frdt and agcd=v1.agcd and dpcd=v1.dpcd);
            
            v_prev_bal  :=nvl(v_prev_bal,0)+nvl(v_rec_amt,0);
            
            v_rec_amt:=0;
            
            select sum(amount) into v_rec_amt from cir_rcphdr where comp_code=v1.comp_code and unit_code=v1.unit_code and
             agcd=v1.agcd and dpcd=v1.dpcd and recptdt>=v_opdate and recptdt<=v_bill_todt and achd='SC' ;
            
            v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_rec_amt,0);

            select sum(nvl(gross_amt,0)-nvl(comm_amt,0)+nvl(sur_amt,0)-nvl(return_amt,0)),abs(sum(sec_amt)) into v_pbillret,v_psecamt 
            from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date>=v_start_date and supply_date<v_bill_frdt and  
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                            
            select abs(sum(sec_amt)) into v_csecamt from cir_bill_print
                where comp_code=v1.comp_code and unit_code=v1.unit_code and supply_date >= v_bill_frdt and supply_date<=v_bill_todt and 
                agcd=v1.agcd and dpcd=v1.dpcd and cur_sessionid=userenv('sessionid');
                
            if nvl(v_bill_exist,0)=0 then
                v_sec_bal   :=nvl(v_sec_bal,0)-nvl(v_psecamt,0)-nvl(v_csecamt,0);
            else
                v_sec_bal   :=nvl(v_sec_bal,0)+nvl(v_psecamt,0);
            end if;
            
            v_prev_bal      :=nvl(v_prev_bal,0)+nvl(v_pbillret,0)+nvl(v_psecamt,0);
                        
            v_rec_amt:=0;v_pbillret:=0;v_csecamt:=0;v_psecamt:=0;
            
            open cur_type;
            loop
                fetch cur_type into v2;
                exit when cur_type%notfound;
                begin
                    select dsign into v_dsign from cir_docmst where comp_code=v1.comp_code and doc_type=v2.doctyp;
                exception when others then
                    v_dsign:=1;
                end;
                if v_dsign>0 then
                    if v_bill_exist=0 then
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0)+nvl(v_csecamt,0);
                    else
                        v_dn_amt:=nvl(v_dn_amt,0)+nvl(v2.amount,0);
                    end if;    
                else
                    if v2.doctyp='RCR' then   
                        v_rec_amt:=nvl(v_rec_amt,0)+nvl(v2.amount,0);
                    else
                        v_cn_amt:=nvl(v_cn_amt,0)+nvl(v2.amount,0);
                    end if;
                end if;
            end loop;
            close cur_type;

            v_state_name    :=cir_get_state(v1.comp_code,v1.country_code,v1.state_code);
            if repty='S' then
                null;
            else
                v_dist_name     :=cir_get_name.cir_district(v1.comp_code,v1.dist_code,'1','','','');
                if repty='D' then
                    null;           
                elsif repty='C' then
                    v_city_name     :=cir_get_city(v1.comp_code,v1.city_code);
                else
                    begin
                        v_taluka_name   :=cir_get_name.cir_taluka(v1.comp_code,v1.taluka_code,'1','','','');
                    exception when others then
                        v_taluka_name   :='N/A';
                    end;
                end if;
            end if;
            
            insert into cir_temp_bill_collection(comp_code,unit_code,billno,billdt,publ_code,agcd,dpcd, 
            supply_copy, gross_amt, comm_amt, sur_amt, return_copy, return_amt,ret_comm_amt, dn_amt, rec_amt, prev_bal,cn_amt,cur_sessionid,        
            agname, agname_oth_lang, city_code, taluka_code, dist_code, state_code, remarks,bill_sec_amt,sec_opbal)
               values(v1.comp_code,  v1.unit_code  , null   ,null  , ''    ,v1.agcd,v1.dpcd,
            v1.supply_copy,v1.gross_amount,nvl(v1.comm_amount,0),v1.sur_amount,v_ret_copy,v_ret_gross,v_ret_comm,
            v_dn_amt,v_rec_amt,v_prev_bal,v_cn_amt,userenv('sessionid'),
            v1.ag_name,v1.ag_name_oth_lang,v_city_name,v_taluka_name,v_dist_name,v_state_name,v1.country_code,v1.bill_sec_amt,v_sec_bal);
    
            v_dsign:=0;v_ret_gross:=0;v_ret_comm:=0; v_ret_copy:=0; v_dn_amt:=0; v_cn_amt:=0; v_rec_amt:=0; v_prev_bal:=0;v_sec_bal:=0;
            v_state_name    :=null;v_dist_name     :=null;v_taluka_name   :=null; v_city_name:=null; 
        End Loop;
        Close cur_bill;
        commit;
        
        if repty='S' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,ag_name;

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name;            
        elsif repty='D' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,district_name,ag_name;     

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.remarks,a.state_code,a.dist_code
            order by comp_code,unit_code,state_name,district_name;
            
        elsif repty='C' then
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,a.city_code city_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.remarks,a.state_code,a.dist_code,a.city_code
            order by comp_code,unit_code,city_name,ag_name;  
            
            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.city_code city_name,
            a.dist_code district_name,a.state_code state_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.city_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,city_name;
        else
            open p_accounts for
            select a.comp_code comp_code,a.unit_code unit_code,a.agcd agcd,a.dpcd dpcd,a.agname ag_name,a.agname_oth_lang ag_name_oth_lang,
            a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.agcd,a.dpcd,a.agname,a.agname_oth_lang,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name,ag_name;   

            open p_accounts1 for
            select a.comp_code comp_code,a.unit_code unit_code,a.state_code state_name,a.dist_code district_name,
            a.taluka_code||'('||a.dist_code||')' taluka_name,
            sum(nvl(a.gross_amt,0)+nvl(a.sur_amt,0)) bill_amt,sum(a.comm_amt) comm_amt,sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))) net_bill,
            sum(nvl(a.return_amt,0)+nvl(ret_comm_amt,0)) return_amt,sum(nvl(a.return_amt,0)) net_return_amt,
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)) total_bill,abs(sum(nvl(a.bill_sec_amt,0))) dep_adj, 
            sum((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.bill_sec_amt,0)) total_net,
            sum(a.prev_bal) prev_bal, abs(sum(a.rec_amt)) rec_amt,sum(nvl(a.dn_amt,0)) dn_amt, sum(a.cn_amt) cn_amt,sum(nvl(a.dn_amt,0)+nvl(a.cn_amt,0)) dr_cr_amt,
            sum(((nvl(a.gross_amt,0)+nvl(a.sur_amt,0)-nvl(a.comm_amt,0))-nvl(a.return_amt,0)+nvl(a.prev_bal,0)+nvl(a.rec_amt,0)+nvl(a.dn_amt,0)+nvl(a.cn_amt,0)+nvl(a.bill_sec_amt,0))) net_bal,
            abs(sum(nvl(a.sec_opbal,0))) deposit_balance
            from cir_temp_bill_collection a
            where cur_sessionid=userenv('sessionid')
            group by a.comp_code,a.unit_code,a.taluka_code,a.dist_code,a.remarks,a.state_code
            order by comp_code,unit_code,state_name,district_name,taluka_name;            
        end if;
        
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        delete from cir_temp_outstanding;
        delete from cir_bill_print where cur_sessionid=userenv('sessionid');commit;
        delete from cir_bill_return_print where cur_sessionid=userenv('sessionid');commit;        
    End cir_weekly_bill_summary_p;         
End cir_rep_billing;
/


/////////////////////////////////////////////////////description////////////////////////////////////////////////


CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_billing IS
  type t_accounts is ref cursor;
  procedure cir_billing_agency_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_billno_list_p(
    pcomp_code         in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts);

  procedure cir_bill_print_punya(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,  
    ptalukacode      in varchar2,
    pcitycode        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);  
  
  procedure cir_bill_print_bhaskar(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppubl            in varchar2,
    pbill_freq       in varchar2,
    pfrom_billdt     in varchar2,
    ptill_billdt     in varchar2,
    pfrom_billno     in varchar2,
    ptill_billno     in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts,
    p_accounts11     out t_accounts,
    p_accounts12     out t_accounts);

  procedure cir_before_bill_print_p1(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);

  procedure cir_before_bill_print_p2(
    pcompcode        in varchar2,
    punitcode        in varchar2,
    ppubl_freq       in varchar2,
    ppubl            in varchar2,
    pagencytype      in varchar2,
    pagencyclass     in varchar2,
    pbranchcode      in varchar2,
    pdistcode        in varchar2,
    ptaluka          in varchar2,
    pbillagcd        in varchar2,
    pbilldpcd        in varchar2,
    pfrom_date       in varchar2,
    ptill_date       in varchar2,
    plangtype        in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,
    pextra2          in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts,
    p_accounts3      out t_accounts,
    p_accounts4      out t_accounts,
    p_accounts5      out t_accounts,
    p_accounts6      out t_accounts,
    p_accounts7      out t_accounts,
    p_accounts8      out t_accounts,
    p_accounts9      out t_accounts,
    p_accounts10     out t_accounts);
        
  procedure cir_bill_register_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_outstanding_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);

  procedure cir_unitwise_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts);

  procedure cir_billing_rate_p (
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    BILLNO_FROM     in varchar2,
    BILLNO_TO       in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    pdateformat     in varchar2,  
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts,
    p_accounts2     out t_accounts,
    p_accounts3     out t_accounts);

  Procedure cir_before_bill_process_p(
      pcomp_code         in varchar2,
    punit_code         in varchar2,
    ppubl_freq         in varchar2,
    ppubl             in varchar2,
    pfrdt             in varchar2,
    ptodt             in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pagencytype     in varchar2,
    pagencyclass    in varchar2,
    pbranchcode     in varchar2,
    pdistcode       in varchar2,
    ptaluka         in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2);

procedure cir_weekly_bill_summary_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    repty           in varchar2,
    pbill_freq      in varchar2,
    pfrom_billdt    in varchar2,
    ptill_billdt    in varchar2,
    ppubl           in varchar2,
    pbillagcd       in varchar2,
    pbilldpcd       in varchar2,
    pdateformat     in varchar2,
    pbrancode       in varchar2,
    pdistcode       in varchar2,
    pagclass        in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts,
    p_accounts1     out t_accounts);    
End cir_rep_billing;
/
////////////////////////////////////////////////////end of issue no. 5808 and 5809//////////////////////////////////////
