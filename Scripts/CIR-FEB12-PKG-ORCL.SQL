////======================================Issue no. 6586 11\02\2012======================


/////////////////////////////////////////////body////////////////////////////////////////////////


CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_unsold_credit_note IS
  procedure cir_unsold_supply_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_fromdate     in varchar2,
      psup_todate         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,--it is use for datewise or ratewise
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor)
    As
        v_frdt date;
        v_todt date;
    Begin
        v_frdt:=to_date(psup_fromdate,''''||pdateformat||'''');
        v_todt:=to_date(psup_todate,''''||pdateformat||'''');
        if upper(pextra2)='D' then
            open p_circuls for
            select comp_code,unit_code,publ,publ_name,edtn, edtn_name,supply_date, supply_date supply_datemon,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, 
            sum(d.sup_copy) supply_copy,
            /*(select sum(u.sup_copy) from cir_dbksup_dis u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate)*/  sum(d.sup_copy) rate_supply,
            0 as RETURNABLE
            from cir_dbksup_dis d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='D'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code)
            union
            select distinct z.comp_code comp_code,z.unit_code unit_code,z.publ publ,z.publ_name publ_name,z.edtn,z.edtn_name edtn_name,MAX(z.supply_date) supply_date,last_day(trunc(z.supply_date,'mm')) supply_datemon,
            z.copy_rate copy_rate,z.comm_fix_auto_spl comm_fix_auto_spl,z.comm_code comm_code,z.waste_rate waste_rate,
            z.comm_catg_type comm_catg_type,z.comm_rate comm_rate,sum(z.supply_copy) supply_copy,sum(z.supply_copy) rate_supply,RETURNABLE from
            (select distinct comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,
            to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            (select sum(u.sup_copy) from cir_dbksup_dis u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate) rate_supply,
            0 as RETURNABLE
            from cir_dbksup_dis d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='R'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,
                d.sup_rate,d.comm_fix_auto_spl,d.comm_code)) z
                group by z.comp_code,z.unit_code,z.publ,z.publ_name,z.edtn,z.edtn_name,last_day(trunc(z.supply_date,'mm')),
                    z.copy_rate,z.comm_fix_auto_spl,z.comm_code,z.waste_rate,z.comm_catg_type,z.comm_rate,z.RETURNABLE;
        else
            open p_circuls for
            select comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,supply_date supply_datemon,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            /*(select sum(u.sup_copy) from cir_dbksup u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate)*/  
            sum(d.sup_copy) rate_supply,0 as RETURNABLE
            from cir_dbksup d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='D'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,d.sup_rate,d.comm_fix_auto_spl,d.comm_code)
            union
            select distinct z.comp_code comp_code,z.unit_code unit_code,z.publ publ,z.publ_name publ_name,z.edtn,z.edtn_name edtn_name,MAX(z.supply_date) supply_date,last_day(trunc(z.supply_date,'mm')) supply_datemon,
            z.copy_rate copy_rate,z.comm_fix_auto_spl comm_fix_auto_spl,z.comm_code comm_code,z.waste_rate waste_rate,
            z.comm_catg_type comm_catg_type,z.comm_rate comm_rate,sum(z.supply_copy) supply_copy,sum(z.supply_copy) rate_supply,RETURNABLE from
            (select distinct comp_code,unit_code,publ,publ_name,edtn,edtn_name,supply_date,
            copy_rate,comm_fix_auto_spl,comm_code,waste_rate,
            substr(comm_rate,1,1) comm_catg_type,substr(comm_rate,2,length(comm_rate)-1) comm_rate,supply_copy,rate_supply,RETURNABLE from--P30,C0.5
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,p.publ_name publ_name,
            d.edtn edtn,edition_nick edtn_name,d.supdate supply_date,
            d.sup_rate copy_rate,d.comm_fix_auto_spl comm_fix_auto_spl,d.comm_code comm_code,cir_get_waste_rate(d.comp_code,d.unit_code,d.edtn,to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''') waste_rate,
            cir_get_commission(d.comp_code,d.unit_code,d.publ,d.edtn,d.comm_fix_auto_spl ,d.comm_code,
            to_char(d.supdate,''''||pdateformat||''''),''''||pdateformat||'''',sum(d.sup_copy),'','') comm_rate,'P' comm_catg_type, sum(d.sup_copy) supply_copy,
            (select sum(u.sup_copy) from cir_dbksup u where u.comp_code=d.comp_code and u.unit_code=d.unit_code and 
            (u.publ=d.publ) and u.edtn=d.edtn and u.supdate between v_frdt and v_todt and 
            u.billagcd=pagcd_code and u.billdpcd=pdpcd_code and u.sup_rate=d.sup_rate) rate_supply,
            0 as RETURNABLE
            from cir_dbksup d,cir_publ_mast p,cir_edtn_mast e
            where d.comp_code=pcomp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and
                  d.unit_code=punit_code and d.publ=p.publ and d.publ=e.publ and
                  (d.publ=ppubl_code or ppubl_code is null) and
                  d.edtn=e.edtn and (d.edtn = pedtn_code or pedtn_code is null) and
                d.supdate between v_frdt and v_todt and
                d.billagcd=pagcd_code and d.billdpcd=pdpcd_code and upper(nvl(pextra1,'D'))='R'
                group by d.comp_code,d.unit_code,d.publ,p.publ_name,e.edition_nick,d.edtn,d.supdate,
                d.sup_rate,d.comm_fix_auto_spl,d.comm_code)) z
                group by z.comp_code,z.unit_code,z.publ,z.publ_name,z.edtn,z.edtn_name,last_day(trunc(z.supply_date,'mm')),
                    z.copy_rate,z.comm_fix_auto_spl,z.comm_code,z.waste_rate,z.comm_catg_type,z.comm_rate,z.RETURNABLE
                order by publ_name,edtn,supply_date;
        end if;
  End cir_unsold_supply_p;
    
  procedure cir_unsold_check_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl_code        in varchar2,
      pedtn_code        in varchar2,
      psup_date         in varchar2,
      pagcd_code        in varchar2,
      pdpcd_code        in varchar2,
      pdoc_type         in varchar2,
      precptno          in varchar2,
      pmissing_recpt    in varchar2,
      plate_recpt       in varchar2,
      pbnr_recpt        in varchar2,
      punsold           in varchar2,
      pcopy_rate        in varchar2,
      pcomm_per         in varchar2,
      pcomm_type        in varchar2,
      pwaste_flag       in varchar2,
      pwaste_rate       in varchar2,
      pdateformat       in varchar2,
      pextra1           in varchar2,--for damaged copies
      pextra2           in varchar2,
      p_circuls         out T_Circul_Cursor,
      p_circuls1        out T_Circul_Cursor)
  As
        v_supdt date;
        v_tot_copy    number;
        v_waste_amt number;
        v_gross_amt number;
        v_comm_amt     number;
        v_total_amt number;
        v_query     varchar2(2000);
  Begin
        v_supdt:=to_date(psup_date,''''||pdateformat||'''');
        if upper(pextra2)='D' then
            open p_circuls for
            select nvl(sum(nvl(nvl(apr_short_recpt,0),nvl(short_recpt,0))+nvl(apr_late_recpt,late_recpt)+nvl(nvl(apr_bnr,0),nvl(bnr,0))+nvl(nvl(apr_unsold,0),nvl(unsold,0))+nvl(nvl(apr_damage,0),nvl(damage,0))),0) as total from cir_unsold_dtl_dis
                where comp_code   =pcomp_code and
                      unit_code   =punit_code and
                      doctype     =pdoc_type and
                      publ        =ppubl_code and
                      edtn        =pedtn_code and
                      supdate     =v_supdt and
                      agcd        =pagcd_code and
                      dpcd        =pdpcd_code and
                      recptno     <>nvl(precptno,'/');
        else
            open p_circuls for
            select nvl(sum(nvl(nvl(apr_short_recpt,0),nvl(short_recpt,0))+nvl(apr_late_recpt,late_recpt)+nvl(nvl(apr_bnr,0),nvl(bnr,0))+nvl(nvl(apr_unsold,0),nvl(unsold,0))+nvl(nvl(apr_damage,0),nvl(damage,0))),0) as total from cir_unsold_dtl
                where comp_code   =pcomp_code and
                      unit_code   =punit_code and
                      doctype     =pdoc_type and
                      publ        =ppubl_code and
                      edtn        =pedtn_code and
                      supdate     =v_supdt and
                      agcd        =pagcd_code and
                      dpcd        =pdpcd_code and
                      recptno     <>nvl(precptno,'/');
         end if;

        if nvl(pwaste_flag,'N')='Y' then
            v_waste_amt:=round((nvl(punsold,0)*nvl(pwaste_rate,0)),2);
        else
            v_waste_amt:=0;
        end if;
        
        v_tot_copy:=nvl(pmissing_recpt,0)+nvl(plate_recpt,0)+nvl(pbnr_recpt,0)+nvl(punsold,0)+nvl(pextra1,0);
        
        v_gross_amt :=nvl(v_tot_copy,0)*nvl(pcopy_rate,0);
        
        if pcomm_type='C' then--for per copy rate
            v_comm_amt  :=round((v_tot_copy*nvl(pcomm_per,0)),2);
        else
            v_comm_amt  :=round((v_gross_amt*nvl(pcomm_per,0)/100),2);
        end if;
        
        v_total_amt :=round((v_gross_amt-v_comm_amt-v_waste_amt),2);
        
        --insert into test1(vstring,vstring2) values(' unsold_check_p '||v_tot_copy||' , '|| pcopy_rate , v_comm_amt||' , '||v_total_amt);commit;
        
        v_query:='SELECT '||v_tot_copy||'as "TOTAL_COPY" ,'||v_waste_amt||' as "WASTE_AMOUNT" ,'||v_comm_amt||' as "COMM_AMOUNT" ,'||v_total_amt||' as "TOTAL_AMOUNT" '||' FROM DUAL';
        open p_circuls1 for v_query;
  End cir_unsold_check_p;
    
  procedure cir_notapproval_list_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      pdoc_type     in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,
      pextra2       in varchar2,
      pextra3       in varchar2,
      p_circuls     out T_Circul_Cursor)
  As
  Begin
      if upper(pextra2)='D' then  
        open p_circuls for
        select distinct h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agency_name,
        cir_get_city(h.comp_code,m.city_code) city_name,h.publ publ,cir_get_publ_name(h.comp_code,h.publ) publ_name,h.edtn edtn,
        cir_get_edtn_name(h.comp_code,h.edtn) edtn_name,h.entrydt entrydt,h.frdt frdt,h.todt todt
        from cir_unsold_hdr_dis h,cir_agmast_dis m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=m.unit and h.unit_code=punit_code and h.doctype=pdoc_type and 
        h.agcd=m.agcd and h.dpcd=m.dpcd and (upper(m.ag_name) like upper(pextra1)||'%' or pextra1 is null) and h.app_userid is null
        and (h.recptno=pextra3 or pextra3 is null)
        order by recptdt,recptno,agency_name;
      else
        open p_circuls for
        select distinct h.recptno recptno,h.recptdt recptdt,h.agcd agcd,h.dpcd dpcd,m.ag_name agency_name,
        cir_get_city(h.comp_code,m.city_code) city_name,h.publ publ,cir_get_publ_name(h.comp_code,h.publ) publ_name,h.edtn edtn,
        cir_get_edtn_name(h.comp_code,h.edtn) edtn_name,h.entrydt entrydt,h.frdt frdt,h.todt todt
        ,H.sup_agcd SUP_AGCD,H.sup_dpcd SUP_DPCD,M.ag_name SUP_AGENCY, CIR_GET_CITY(H.comp_code,M.city_code) SUP_CITY_NAME
        from cir_unsold_hdr h,cir_agmast m
        where h.comp_code=m.comp_code and h.comp_code=pcomp_code and h.unit_code=m.unit and h.unit_code=punit_code and h.doctype=pdoc_type and 
        h.agcd=m.agcd and h.dpcd=m.dpcd and (upper(m.ag_name) like upper(pextra1)||'%' or pextra1 is null) and h.app_userid is null
        and (h.recptno=pextra3 or pextra3 is null)
        order by recptdt,recptno,agency_name;
      end if;
  End cir_notapproval_list_p;
    
  procedure cir_notapproval_unsold_p(
      pcomp_code    in varchar2,
      punit_code    in varchar2,
      pdoc_type     in varchar2,
      precptno      in varchar2,
      pagcd_code    in varchar2,
      pdpcd_code    in varchar2,
      pdateformat   in varchar2,
      pextra1       in varchar2,
      pextra2       in varchar2,
      p_circuls     out T_Circul_Cursor)
    As
    Begin
        if upper(pextra2)='D' then
        open p_circuls for
            select * from cir_unsold_dtl_dis
            where comp_code=pcomp_code and unit_code=punit_code and doctype=pdoc_type and
                        recptno=precptno and agcd=pagcd_code and dpcd=pdpcd_code
            order by recptdt,recptno,supdate;
        else
            open p_circuls for
            select * from cir_unsold_dtl
            where comp_code=pcomp_code and unit_code=punit_code and doctype=pdoc_type and
                        recptno=precptno and agcd=pagcd_code and dpcd=pdpcd_code
            order by recptdt,recptno,supdate;
        end if;
    End cir_notapproval_unsold_p;
    
  procedure cir_unsold_calculation_p(
      pcomp_code        in varchar2,
      punit_code        in varchar2,
      ppubl_code        in varchar2,
      pedtn_code        in varchar2,
      pmissing_recpt    in number,
      plate_recpt       in number,
      pbnr_recpt        in number,
      punsold           in number,
      pcopy_rate        in number,
      pcomm_per         in number,
      pcomm_type        in varchar2,
      pwaste_flag       in varchar2,
      pwaste_rate       in number,
      pdateformat       in varchar2,
      pextra1           in varchar2,--for damaged copies
      pextra2           in varchar2,
      p_circuls         out T_Circul_Cursor)
    As
        v_tot_copy    number;
        v_waste_amt number;
        v_gross_amt number;
        v_comm_amt     number;
        v_total_amt number;
        v_query varchar2(2000);
    Begin
        --pcomp_code,punit_code,ppubl_code,pedtn_code this parameter future use
        if nvl(pwaste_flag,'N')='Y' then
            v_waste_amt:=round((nvl(punsold,0)*nvl(pwaste_rate,0)),2);
        else
            v_waste_amt:=0;
        end if;
        
        v_tot_copy:=nvl(pmissing_recpt,0)+nvl(plate_recpt,0)+nvl(pbnr_recpt,0)+nvl(punsold,0)+nvl(pextra1,0);
        
        v_gross_amt :=nvl(v_tot_copy,0)*nvl(pcopy_rate,0);
        if pcomm_type='C' then--for per copy rate
            v_comm_amt  :=round((v_tot_copy*nvl(pcomm_per,0)),2);
        else
            v_comm_amt  :=round((v_gross_amt*nvl(pcomm_per,0)/100),2);
        end if;    
        v_total_amt :=round((v_gross_amt-v_comm_amt-v_waste_amt),2);
        
        v_query:='SELECT '||v_tot_copy||'as "TOTAL_COPY" ,'||v_waste_amt||' as "WASTE_AMOUNT" ,'||v_comm_amt||' as "COMM_AMOUNT" ,'||v_total_amt||' as "TOTAL_AMOUNT" '||' FROM DUAL';
        open p_circuls for v_query;
    End cir_unsold_calculation_p;

/*
var v1 refcursor;
exec cir_unsold_credit_note.cir_unsold_process_p('DB001','JA0','01-oct-2010','31-oct-2010','','','','SH0','dd/mm/yyyy','','',:v1);
*/
    procedure cir_unsold_process_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      prec_fromdate     in varchar2,
      prec_todate         in varchar2,
      pagtype_code      in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      puserid           in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor)
   As
        v_frdt date;
        v_todt date;
        v_doctype varchar2(5):='UCN';
        v_tot_amt NUMBER(15,2):=0;
        v_count number:=0;
        v_dsign number;
        v_recptdt date;
        v_amt   number(15,2);
        cursor c1 is
            select h.comp_code comp_code,h.unit_code unit_code,m.branch_code branch_code,h.agcd agcd,h.dpcd dpcd,
            nvl(sum(d.apr_unsold),0) unsold_copy,nvl(sum(d.apr_bnr),0) missing_copy ,
            nvl(sum(d.apr_late_recpt),0) late_copy,nvl(sum(d.apr_short_recpt),0) short_copy,nvl(sum(d.apr_damage),0) damage_copy,
            sum((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0)) gross_amt,
            nvl(sum(d.comm_amt),0) comm_amt,nvl(sum(d.waste_amt),0) waste_amt,
            sum(((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0))-nvl(d.comm_amt,0)-nvl(d.waste_amt,0)) amount
            from cir_unsold_hdr_DIS h,cir_unsold_dtl_DIS d,cir_agmast_DIS m
            where h.comp_code=pcomp_code and h.comp_code=d.comp_code and h.comp_code=m.comp_code and
            h.unit_code=punit_code and h.unit_code=d.unit_code and h.unit_code=m.unit and h.doctype=v_doctype and h.doctype=d.doctype and 
            h.recptno=d.recptno and h.recptdt=d.recptdt and h.agcd=nvl(pagcd_code,h.agcd) and h.dpcd=nvl(pdpcd_code,h.dpcd) and 
            h.agcd=d.agcd and h.dpcd=d.dpcd and h.agcd=m.agcd and h.dpcd=m.dpcd and (m.ag_type=pagtype_code or pagtype_code is null) and
            h.app_dt >= v_frdt and h.app_dt<=v_todt and h.app_userid is not null and h.process_crno is null and 
            (nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))>0 and upper(nvl(pextra2,'/'))='D'
            group by h.comp_code,h.unit_code,m.branch_code,h.agcd,h.dpcd
            union
            select h.comp_code comp_code,h.unit_code unit_code,m.branch_code branch_code,h.agcd agcd,h.dpcd dpcd,
            nvl(sum(d.apr_unsold),0) unsold_copy,nvl(sum(d.apr_bnr),0) missing_copy ,
            nvl(sum(d.apr_late_recpt),0) late_copy,nvl(sum(d.apr_short_recpt),0) short_copy,nvl(sum(d.apr_damage),0) damage_copy,
            sum((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0)) gross_amt,
            nvl(sum(d.comm_amt),0) comm_amt,nvl(sum(d.waste_amt),0) waste_amt,
            sum(((nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))*nvl(d.copy_rate,0))-nvl(d.comm_amt,0)-nvl(d.waste_amt,0)) amount
            from cir_unsold_hdr h,cir_unsold_dtl d,cir_agmast m
            where h.comp_code=pcomp_code and h.comp_code=d.comp_code and h.comp_code=m.comp_code and
            h.unit_code=punit_code and h.unit_code=d.unit_code and h.unit_code=m.unit and h.doctype=v_doctype and h.doctype=d.doctype and 
            h.recptno=d.recptno and h.recptdt=d.recptdt and h.agcd=nvl(pagcd_code,h.agcd) and h.dpcd=nvl(pdpcd_code,h.dpcd) and 
            h.agcd=d.agcd and h.dpcd=d.dpcd and h.agcd=m.agcd and h.dpcd=m.dpcd and (m.ag_type=pagtype_code or pagtype_code is null) and
            h.app_dt >= v_frdt and h.app_dt<=v_todt and h.app_userid is not null and h.process_crno is null and 
            (nvl(d.apr_unsold,0)+nvl(d.apr_bnr,0)+nvl(d.apr_late_recpt,0)+nvl(d.apr_short_recpt,0)+nvl(d.apr_damage,0))>0 and upper(nvl(pextra2,'/'))<>'D'
            group by h.comp_code,h.unit_code,m.branch_code,h.agcd,h.dpcd
            order by comp_code,unit_code,branch_code,agcd,dpcd;
    v1 c1%rowtype;
    v_recptno varchar2(20);
    v_remark varchar2(200);
    Begin
        v_frdt:=to_date(prec_fromdate,''''||pdateformat||'''');
        v_todt:=to_date(prec_todate,''''||pdateformat||'''');
        v_recptdt:=v_todt;
        
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            
            
            select Dsign into v_dsign from cir_docmst where Comp_code=pcomp_code AND doc_type=v_doctype;

            v_amt:=v1.amount*v_dsign;
            v_remark:='Being amount credited against unsold return';
            if nvl(v1.unsold_copy,0)>0 then
                v_remark:=v_remark||' Unsold Copy:- '||v1.unsold_copy;
            end if;
            if nvl(v1.missing_copy,0)>0 then
                v_remark:=v_remark||' Missing Copy:- '||v1.missing_copy;
            end if;
            if nvl(v1.late_copy,0)>0 then
                v_remark:=v_remark||' Late Copy:- '||v1.late_copy;
            end if;
            if nvl(v1.short_copy,0)>0 then
                v_remark:=v_remark||' Short Copy:- '||v1.short_copy;
            end if;
            if nvl(v1.damage_copy,0)>0 then
                v_remark:=v_remark||' Damage Copy:- '||v1.damage_copy;
            end if;
            
            --v_recptno:=cir_genrate_id.receipt_cndn_id_p (pcomp_code,punit_code,v_doctype,to_char(v_recptdt,''''||pdateformat||''''),pdateformat,pextra1,pextra2);
            Begin
                if upper(pextra2)='D' then
                select max(to_number(substr(recptno,-8)))+1 into v_recptno from cir_rcphdr_dis 
                    where comp_code=v1.comp_code  and doctype=v_doctype and to_char(recptdt,'yymm')=to_char(v_recptdt,'yymm') and 
                        branch_code=v1.branch_code;
                else
                select max(to_number(substr(recptno,-8)))+1 into v_recptno from cir_rcphdr 
                    where comp_code=v1.comp_code  and doctype=v_doctype and to_char(recptdt,'yymm')=to_char(v_recptdt,'yymm') and 
                        branch_code=v1.branch_code;                
                end if;
                Exception When Others Then
                    v_recptno:=null;
            End;
    
            If nvl(v_recptno,0)=0 Then
              v_recptno:=v1.branch_code||'-'||to_char(v_recptdt,'yymm')||'0001';
            Else
              v_recptno:=v1.branch_code||'-'||lpad(v_recptno,8,'0');
            End if;
            if upper(pextra2)='D' then
              if v_recptno is not null and nvl(v_amt,0)<>0 then
                  insert into cir_rcphdr_dis(comp_code,unit_code,agcd,dpcd,doctype,
                                         recptno,recptdt,amount,reason,remark,
                                         achd,voucherno,voucherdt,userid,creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v_amt,'UNSOLD CREDIT NOTE',v_remark,
                                         'NM',v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                  insert into cir_rcpdet_dis(comp_code,unit_code,agcd,dpcd,doctyp,
                                         recptno,recptdt,payfor,achd,amount,
                                         reason,remark,voucherno,voucherdt,usrid,
                                         creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v1.branch_code,'NM',v_amt,
                                         'UNSOLD CREDIT NOTE',v_remark,v_recptno,v_recptdt,puserid,
                                         sysdate,v1.branch_code);
                  insert into cir_outmast_dis(comp_code,unit_code,agcd,dpcd,doctyp,
                                          recptno,recptdt,achd,amount,reason,
                                          remark,voucherno,voucherdt,usrid,creation_date,branch_code)
                                   values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                          v_recptno,v_recptdt,'NM',v_amt,'UNSOLD CREDIT NOTE',
                                          v_remark,v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                    v_count     :=nvl(v_count,0)+1;
                    v_tot_amt   :=nvl(v_tot_amt,0)+nvl(v1.amount,0);

                    update cir_unsold_dtl_dis set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null and recptno in(select distinct recptno from cir_unsold_hdr_dis
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null);
                        
                    update cir_unsold_hdr_dis set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null;
              end if;
          else
              if v_recptno is not null and nvl(v_amt,0)<>0 then
                  insert into cir_rcphdr(comp_code,unit_code,agcd,dpcd,doctype,
                                         recptno,recptdt,amount,reason,remark,
                                         achd,voucherno,voucherdt,userid,creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v_amt,'UNSOLD CREDIT NOTE',v_remark,
                                         'NM',v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                  insert into cir_rcpdet(comp_code,unit_code,agcd,dpcd,doctyp,
                                         recptno,recptdt,payfor,achd,amount,
                                         reason,remark,voucherno,voucherdt,usrid,
                                         creation_date,branch_code)
                                  values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                         v_recptno,v_recptdt,v1.branch_code,'NM',v_amt,
                                         'UNSOLD CREDIT NOTE',v_remark,v_recptno,v_recptdt,puserid,
                                         sysdate,v1.branch_code);
                  insert into cir_outmast(comp_code,unit_code,agcd,dpcd,doctyp,
                                          recptno,recptdt,achd,amount,reason,
                                          remark,voucherno,voucherdt,usrid,creation_date,branch_code)
                                   values(v1.comp_code, v1.unit_code,v1.agcd, v1.dpcd,v_doctype,
                                          v_recptno,v_recptdt,'NM',v_amt,'UNSOLD CREDIT NOTE',
                                          v_remark,v_recptno,v_recptdt,puserid,sysdate,v1.branch_code);
                    v_count     :=nvl(v_count,0)+1;
                    v_tot_amt   :=nvl(v_tot_amt,0)+nvl(v1.amount,0);

                    update cir_unsold_dtl set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null and recptno in(select distinct recptno from cir_unsold_hdr 
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null);
                        
                    update cir_unsold_hdr set process_crno=v_recptno,process_crdt=v_recptdt
                        where comp_code=v1.comp_code and unit_code=v1.unit_code and doctype=v_doctype and 
                        app_dt >= v_frdt and app_dt <=v_todt and app_userid is not null and agcd=v1.agcd and dpcd=v1.dpcd and 
                        process_crno is null;
              end if;
          end if;
        end loop;
        close c1;
        commit;
        open p_circuls for 
        select v_count as "TOTAL_CREDIT_NOTE",v_tot_amt as "TOTAL_CREDIT_NOTE_AMOUNT" from dual;
   End cir_unsold_process_p;
END cir_unsold_credit_note;
/


//////////////////////////////////////////description////////////////////////////////////////////

CREATE OR REPLACE PACKAGE HT18JULY.cir_unsold_credit_note IS
  TYPE T_Circul_Cursor is Ref Cursor;
  procedure cir_unsold_supply_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_fromdate     in varchar2,
      psup_todate         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
  procedure cir_unsold_check_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      psup_date         in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdoc_type         in varchar2,
      precptno             in varchar2,
      pmissing_recpt    in varchar2,
      plate_recpt        in varchar2,
      pbnr_recpt        in varchar2,
      punsold            in varchar2,
      pcopy_rate        in varchar2,
      pcomm_per            in varchar2,
      pcomm_type        in varchar2,
      pwaste_flag        in varchar2,
      pwaste_rate         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor,
      p_circuls1         out T_Circul_Cursor);

  procedure cir_unsold_calculation_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      ppubl_code         in varchar2,
      pedtn_code         in varchar2,
      pmissing_recpt    in number,
      plate_recpt        in number,
      pbnr_recpt        in number,
      punsold            in number,
      pcopy_rate        in number,
      pcomm_per            in number,
      pcomm_type        in varchar2,
      pwaste_flag        in varchar2,
      pwaste_rate         in number,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
      
  procedure cir_notapproval_list_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      pdoc_type         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      pextra3               in varchar2,
      p_circuls         out T_Circul_Cursor);
      
  procedure cir_notapproval_unsold_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      pdoc_type         in varchar2,
      precptno             in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);

  procedure cir_unsold_process_p(
      pcomp_code         in varchar2,
      punit_code         in varchar2,
      prec_fromdate     in varchar2,
      prec_todate         in varchar2,
      pagtype_code      in varchar2,
      pagcd_code         in varchar2,
      pdpcd_code         in varchar2,
      puserid           in varchar2,
      pdateformat         in varchar2,
      pextra1             in varchar2,
      pextra2             in varchar2,
      p_circuls         out T_Circul_Cursor);
END cir_unsold_credit_note;
/

///////////////////////////////////////////////////////end //////////////////////////////////////////////////////////////




////////////////////////////////////////////Issue no. 6654,6653//////////////////////////////////////////////////////

////////////////////////////////////////////body///////////////////////////////////////////////////////////////////

CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_rep_challan IS

Procedure cir_rep_route_challan(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     ppublcode          in varchar2,
     proutemode         in varchar2,
     proutetype         in varchar2,---1 for route,2 for subroute & 3 for sub subroute
     proutecode         in varchar2,
     psupdate           in varchar2,
     pchallan_type      in varchar2,---1 for bundle , 2 for supply and 3 for both
     plangtype          in varchar2,---1 for enlish and 2 for other language
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
        select distinct x.comp_code comp_code,x.publ publ,x.publ_seqno publ_seqno,x.publ_name publ_name
        from(select distinct p.comp_code,p.publ,p.publ_seqno,
        case when plangtype='1' then substr(p.publ_name,1,15) else substr(p.publ_name_oth_lang,1,25) end publ_name 
        from cir_publ_mast p,cir_lblmast l ,cir_route_mast r
        where p.comp_code=l.comp_code and p.comp_code=pcompcode and p.comp_code =r.comp_code and p.publ=l.publ and
        l.unit_code = r.unit and l.unit_code = punitcode and p.publ = nvl(ppublcode,p.publ) and l.lbl_dt   = vsupdate and 
        l.route =r.route_code and r.route_code = nvl(proutecode,r.route_code) and r.route_mode = nvl(proutemode,r.route_mode)  and 
        proutetype='1' 
        union
        select distinct p.comp_code,p.publ,p.publ_seqno,
        case when plangtype='1' then substr(p.publ_name,1,15) else substr(p.publ_name_oth_lang,1,25) end publ_name 
        from cir_publ_mast p,cir_lblmast l ,cir_sub_route_mast r
        where p.comp_code=l.comp_code and p.comp_code=pcompcode and p.comp_code =r.comp_code and p.publ=l.publ and
        l.unit_code = r.unit and l.unit_code = punitcode and p.publ = nvl(ppublcode,p.publ) and l.lbl_dt = vsupdate and 
        r.route_code=l.route and r.subrt_code=l.subrt and r.route_code||r.subrt_code = nvl(proutecode,r.route_code||r.subrt_code) and 
        r.subrt_mode = nvl(proutemode,r.subrt_mode) and proutetype='2'        
        union
        select distinct p.comp_code,p.publ,p.publ_seqno,
        case when plangtype='1' then substr(p.publ_name,1,15) else substr(p.publ_name_oth_lang,1,25) end publ_name 
        from cir_publ_mast p,cir_lblmast l ,cir_sub_subroute_mast r
        where p.comp_code=l.comp_code and p.comp_code=pcompcode and p.comp_code =r.comp_code and p.publ=l.publ and
        l.unit_code = r.unit and l.unit_code = punitcode and p.publ = nvl(ppublcode,p.publ) and l.lbl_dt = vsupdate and 
        r.route_code=l.route and r.subrt_code=l.subrt and r.sub_subrt_code=l.sub_subrt and
        r.route_code||r.subrt_code||r.sub_subrt_code = nvl(proutecode,r.route_code||r.subrt_code||r.sub_subrt_code) and 
        r.sub_subrt_mode = nvl(proutemode,r.sub_subrt_mode) and proutetype='3') x
        order by publ_seqno,publ;

     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vvar_sum2  varchar2(4000);
     vquery     varchar2(20000);
  Begin
    insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
      fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
        if vvar is null then
            if pchallan_type =1 then-- for bundle 
                vvar    :=' case when publ='||''''||rec_edtn.publ||''''||' then lbl_tno else 0 end "'||rec_edtn.publ_name||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.publ_name||'") "'||rec_edtn.publ_name||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.publ_name||'"';
            elsif pchallan_type =2 then-- for supply
                vvar    :=' case when publ='||''''||rec_edtn.publ||''''||' then sum(supply_1) else 0 end "'||rec_edtn.publ_name||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.publ_name||'") "'||rec_edtn.publ_name||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.publ_name||'"';
            else-- for both
                vvar        :=' case when publ='||''''||rec_edtn.publ||''''||' then lbl_tno else 0 end "'||'B#'||rec_edtn.publ_name||'"';
                vvar        :=vvar||','||' case when publ='||''''||rec_edtn.publ||''''||' then sum(supply_1) else 0 end "'||'S#'||rec_edtn.publ_name||'"';                            
                vvar_sum    :='sum('||'"'||'B#'||rec_edtn.publ_name||'") "'||'B#'||rec_edtn.publ_name||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||'S#'||rec_edtn.publ_name||'") "'||'S#'||rec_edtn.publ_name||'"';
                vvar_sum1   :='sum('||'"'||'B#'||rec_edtn.publ_name||'"';
                vvar_sum2   :='sum('||'"'||'S#'||rec_edtn.publ_name||'"';
            end if;
        else
            if pchallan_type =1 then-- for bundle 
                vvar        :=vvar||','||'case when publ='||''''||rec_edtn.publ||''''||' then lbl_tno else 0 end "'||rec_edtn.publ_name||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.publ_name||'") "'||rec_edtn.publ_name||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.publ_name||'"';
            elsif pchallan_type =2 then-- for supply
                vvar        :=vvar||','||'case when publ='||''''||rec_edtn.publ||''''||' then sum(supply_1) else 0 end "'||rec_edtn.publ_name||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.publ_name||'") "'||rec_edtn.publ_name||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.publ_name||'"';
            else-- for both
                vvar        :=vvar||','||'case when publ='||''''||rec_edtn.publ||''''||' then lbl_tno else 0 end "'||'B#'||rec_edtn.publ_name||'"';
                vvar        :=vvar||','||'case when publ='||''''||rec_edtn.publ||''''||' then sum(supply_1) else 0 end "'||'S#'||rec_edtn.publ_name||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||'B#'||rec_edtn.publ_name||'") "'||'B#'||rec_edtn.publ_name||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||'S#'||rec_edtn.publ_name||'") "'||'S#'||rec_edtn.publ_name||'"';
                vvar_sum1   :=vvar_sum1||'+"'||'B#'||rec_edtn.publ_name||'"';
                vvar_sum2   :=vvar_sum2||'+"'||'S#'||rec_edtn.publ_name||'"';                
            end if;
        end if;
    end loop;
    close cur_edtn;
    if pchallan_type =1 then
        vvar_sum1:=vvar_sum1||') "TOTAL"';
    elsif pchallan_type =2 then
        vvar_sum1:=vvar_sum1||') "TOTAL"';
    else
        vvar_sum1:=vvar_sum1||')"'||'B#TOTAL"';
        vvar_sum2:=vvar_sum2||')"'||'S#TOTAL"';
    end if;    
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate||' vvar_sum '||vvar_sum||' vvar_sum1 '||vvar_sum1);commit;
    if proutetype='1' then
        if vvar is null then
            if pchallan_type=1 then-- for bundle 
                vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                        agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,print_seq,0 total_packet 
                        from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                        a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,
                        max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,a.distname distname,a.distoname distoname
                        from cir_lblmast a,cir_agmast b
                        where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                        a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                        a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code = nvl('||''''||proutecode||''''||',route_code) and 
                        route_mode = nvl('||''''||proutemode||''''||',route_mode)) and nvl(a.supply_1,0)>0
                        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                        a.distname,a.distoname)
                        group by comp_code,unit_code,route_code,route_oname,route_name,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname, 
                        order by route_seqno,route_name,print_seq,agency_name';
            else
                vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                        agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,print_seq,0 total_packet 
                        from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                        a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,
                        max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,a.distname distname,a.distoname distoname
                        from cir_lblmast a,cir_agmast b
                        where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                        a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                        a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code = nvl('||''''||proutecode||''''||',route_code) and 
                        route_mode = nvl('||''''||proutemode||''''||',route_mode)) and nvl(a.supply_1,0)>0
                        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,a.distname,a.distoname)
                        group by comp_code,unit_code,route_code,route_oname,route_name,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname 
                        order by route_seqno,route_name,print_seq,agency_name';
            end if;          
        else
            if pchallan_type=1 then-- for bundle 
                vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                        agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                        vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                        a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                        max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                        from cir_lblmast a,cir_agmast b
                        where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                        a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                        a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code = nvl('||''''||proutecode||''''||',route_code) and 
                        route_mode = nvl('||''''||proutemode||''''||',route_mode)) and nvl(a.supply_1,0)>0
                        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                        a.distname,a.distoname)
                        group by comp_code,unit_code,route_code,route_oname,route_name,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                        distname,distoname 
                        order by route_seqno,route_name,print_seq,agency_name';
            elsif pchallan_type=2 then-- for supply
                vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                        agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                        vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                        a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                        max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                        from cir_lblmast a,cir_agmast b
                        where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                        a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                        a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code = nvl('||''''||proutecode||''''||',route_code) and 
                        route_mode = nvl('||''''||proutemode||''''||',route_mode)) and nvl(a.supply_1,0)>0
                        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                        a.distname,a.distoname)
                        group by comp_code,unit_code,route_code,route_oname,route_name,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                        distname,distoname, 
                        order by route_seqno,route_name,print_seq,agency_name';
            else-- for both
                vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                        agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                        vvar_sum||','||vvar_sum1||','||vvar_sum2||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                        a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                        max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                        from cir_lblmast a,cir_agmast b
                        where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                        a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                        a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code = nvl('||''''||proutecode||''''||',route_code) and 
                        route_mode = nvl('||''''||proutemode||''''||',route_mode)) and nvl(a.supply_1,0)>0
                        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                        a.distname,a.distoname)
                        group by comp_code,unit_code,route_code,route_oname,route_name,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                        distname,distoname 
                        order by route_seqno,route_name,print_seq,agency_name';            
            end if;
        end if;
     elsif proutetype='2' then
        if vvar is null then
            if pchallan_type=1 then-- for bundle 
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq
                    from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt in (select route_code||subrt_code from cir_sub_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code) and 
                    subrt_mode = nvl('||''''||proutemode||''''||',subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                    distname,distoname, 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,print_seq,agency_name';
            else
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq
                    from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt in (select route_code||subrt_code from cir_sub_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code) and 
                    subrt_mode = nvl('||''''||proutemode||''''||',subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                    distname,distoname, 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,print_seq,agency_name';
            end if;         
        else
            if pchallan_type=1 then-- for bundle 
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,publ,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt in (select route_code||subrt_code from cir_sub_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code) and 
                    subrt_mode = nvl('||''''||proutemode||''''||',subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                    distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,print_seq,agency_name';
            elsif pchallan_type=2 then-- for supply
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,publ,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt in (select route_code||subrt_code from cir_sub_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code) and 
                    subrt_mode = nvl('||''''||proutemode||''''||',subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                    distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,print_seq,agency_name';
            else-- for both
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||','||vvar_sum2||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,publ,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt in (select route_code||subrt_code from cir_sub_route_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code) and 
                    subrt_mode = nvl('||''''||proutemode||''''||',subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,
                    distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,print_seq,agency_name';
            end if;
        end if;
     else
        if vvar is null then
            if pchallan_type=1 then-- for bundle 
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    subsubrt_code,subsubrt_name,subsubrt_oname,cir_get_subsubroute_seqno(comp_code,unit_code,route_code,subroute_code,subsubrt_code) subsubrt_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq
                    from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.sub_subrt subsubrt_code,a.subsubrtnm subsubrt_name,a.subsubrtonm subsubrt_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt||a.sub_subrt in (select route_code||subrt_code||sub_subrt_code from cir_sub_subroute_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code||sub_subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code||sub_subrt_code) and 
                    sub_subrt_mode = nvl('||''''||proutemode||''''||',sub_subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,subsubrt_code,subsubrt_name,subsubrt_oname,
                    agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,subsubrt_seqno,subsubrt_name,print_seq,agency_name';
            else
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    subsubrt_code,subsubrt_name,subsubrt_oname,cir_get_subsubroute_seqno(comp_code,unit_code,route_code,subroute_code,subsubrt_code) subsubrt_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq
                    from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.sub_subrt subsubrt_code,a.subsubrtnm subsubrt_name,a.subsubrtonm subsubrt_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt||a.sub_subrt in (select route_code||subrt_code||sub_subrt_code from cir_sub_subroute_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code||sub_subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code||sub_subrt_code) and 
                    sub_subrt_mode = nvl('||''''||proutemode||''''||',sub_subrt_mode is null)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,subsubrt_code,subsubrt_name,subsubrt_oname,
                    agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname ,distname,distoname
                    order by route_seqno,route_name,subroute_seqno,subroute_name,subsubrt_seqno,subsubrt_name,print_seq,agency_name';
            end if;
        else
            if pchallan_type=1 then-- for bundle 
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    subsubrt_code,subsubrt_name,subsubrt_oname,cir_get_subsubroute_seqno(comp_code,unit_code,route_code,subroute_code,subsubrt_code) subsubrt_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.sub_subrt subsubrt_code,a.subsubrtnm subsubrt_name,a.subsubrtonm subsubrt_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt||a.sub_subrt in (select route_code||subrt_code||sub_subrt_code from cir_sub_subroute_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code||sub_subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code||sub_subrt_code) and 
                    sub_subrt_mode = nvl('||''''||proutemode||''''||',sub_subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,subsubrt_code,subsubrt_name,subsubrt_oname,
                    agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,subsubrt_seqno,subsubrt_name,print_seq,agency_name';
            elsif pchallan_type=2 then-- for supply
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    subsubrt_code,subsubrt_name,subsubrt_oname,cir_get_subsubroute_seqno(comp_code,unit_code,route_code,subroute_code,subsubrt_code) subsubrt_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.sub_subrt subsubrt_code,a.subsubrtnm subsubrt_name,a.subsubrtonm subsubrt_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt||a.sub_subrt in (select route_code||subrt_code||sub_subrt_code from cir_sub_subroute_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code||sub_subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code||sub_subrt_code) and 
                    sub_subrt_mode = nvl('||''''||proutemode||''''||',sub_subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.edtn,/*a.supply_1,*/a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,subsubrt_code,subsubrt_name,subsubrt_oname,
                    agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,subsubrt_seqno,subsubrt_name,print_seq,agency_name';
            else-- for both
            vquery:='select comp_code,unit_code,route_code,route_name,route_oname,cir_get_route_seqno(comp_code,unit_code,route_code) route_seqno,
                    subroute_code,subroute_name,subroute_oname,cir_get_subroute_seqno(comp_code,unit_code,route_code,subroute_code) subroute_seqno,
                    subsubrt_code,subsubrt_name,subsubrt_oname,cir_get_subsubroute_seqno(comp_code,unit_code,route_code,subroute_code,subsubrt_code) subsubrt_seqno,
                    agcd,dpcd,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname,0 total_packet,print_seq,'||
                    vvar_sum||','||vvar_sum1||','||vvar_sum2||' from(select a.comp_code comp_code,unit_code unit_code,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
                    a.subrt subroute_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
                    a.sub_subrt subsubrt_code,a.subsubrtnm subsubrt_name,a.subsubrtonm subsubrt_oname,
                    a.agcd agcd,a.dpcd dpcd,b.ag_name agency_name,b.ag_name_oth_lang agency_oname,a.city_name city_name,a.city_oname city_oname,a.station_name station_name,a.station_oname station_oname,a.distname distname,a.distoname distoname,
                    max(a.lbl_print_no) print_seq,a.publ publ,a.edtn edtn,'||vvar||'
                    from cir_lblmast a,cir_agmast b
                    where a.comp_code = b.comp_code and a.comp_code = '||''''||pcompcode||''''||' and a.unit_code = b.unit and a.unit_code = '||''''||punitcode||''''||' and 
                    a.publ = nvl('||''''||ppublcode||''''||',a.publ) and a.agcd = b.agcd and a.dpcd = b.dpcd  and a.lbl_dt = '||''''||vsupdate||''''||' and  
                    a.route||a.subrt||a.sub_subrt in (select route_code||subrt_code||sub_subrt_code from cir_sub_subroute_mast where comp_code = '||''''||pcompcode||''''||' and unit = '||''''||punitcode||''''||' and route_code||subrt_code||sub_subrt_code = nvl('||''''||proutecode||''''||',route_code||subrt_code||sub_subrt_code) and 
                    sub_subrt_mode = nvl('||''''||proutemode||''''||',sub_subrt_mode)) and nvl(a.supply_1,0)>0
                    group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.edtn,a.lbl_tno,a.agcd,a.dpcd,b.ag_name,b.ag_name_oth_lang,a.city_name,a.city_oname,a.station_name,a.station_oname,
                    a.distname,a.distoname)
                    group by comp_code,unit_code,route_code,route_oname,route_name,subroute_code,subroute_name,subroute_oname,subsubrt_code,subsubrt_name,subsubrt_oname,
                    agcd,dpcd,print_seq,agency_name,agency_oname,city_name,city_oname,station_name,station_oname,distname,distoname 
                    order by route_seqno,route_name,subroute_seqno,subroute_name,subsubrt_seqno,subsubrt_name,print_seq,agency_name';
            end if;
        end if;
     end if;   
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;

  End cir_rep_route_challan;
  
  Procedure cir_rep_route_tripsheet(
      pcompcode          in varchar2,
      punitcode          in varchar2,
      ppublcode          in varchar2,
      proutemode         in varchar2,
      proutetype         in varchar2,---1 for route,2 for subroute & 3 for sub subroute
      proutecode         in varchar2,
      psupdate           in varchar2,
      pchallan_type      in varchar2,---1 for bundle and 2 for supply  
      plangtype          in varchar2,---1 for enlish and 2 for other language
      pdateformat        in varchar2,
      pextra1            in varchar2,
      pextra2            in varchar2,
      p_accounts         out t_accounts,
      p_accounts1        out t_accounts)
  As
      vsupdate date;  
  Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    
    if proutetype='1' then
        open p_accounts for
        select a.comp_code comp_code,a.unit_code unit_code,a.lbl_print_no lbl_print_no,
        min(seq_no) lbl_sseqno,max(seq_no) lbl_tseqno,
        a.agcd agcd,a.dpcd dpcd,a.agname agname,a.agoname agoname,
        a.station_name station_name,a.station_oname station_oname,a.city_seqno city_seqno,a.city_name city_name,a.city_oname city_oname,
        a.dist_seqno dist_seqno,a.distname dist_name,a.distoname dist_oname,
        b.route_mode route_mode,d.mode_desc mode_name,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        a.subrt subrt_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
        a.sub_subrt sub_subrt_code,a.subsubrtnm sub_subrtname,a.subsubrtonm sub_subrtoname,
        a.publ publ,a.publ_name publname,a.edtn edtn,a.sup_rate sup_rate,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and 
        a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and (a.route =proutecode or proutecode is null) and 
        b.route_mode=d.mode_code and b.route_mode=nvl(proutemode,b.route_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.lbl_print_no,a.agcd,a.dpcd,a.agname,a.agoname,
        a.station_name,a.station_oname,a.city_seqno,a.city_name,a.city_oname,
        a.dist_seqno,a.distname,a.distoname,a.route_seqno,b.route_mode,d.mode_desc,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,
        a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.publ_name,a.edtn,a.sup_rate 
        order by route_seqno,route_name,lbl_sseqno,lbl_print_no;
        
        open p_accounts1 for
        select a.comp_code comp_code,a.unit_code unit_code,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,
        nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and 
        a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and (a.route =proutecode or proutecode is null) and 
        b.route_mode=d.mode_code and b.route_mode=nvl(proutemode,b.route_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.route_seqno,a.route,a.rtnm,a.rtonm 
        order by route_seqno,route_name;
    elsif proutetype='2' then
        open p_accounts for
        select a.comp_code comp_code,a.unit_code unit_code,a.lbl_print_no lbl_print_no,
        min(seq_no) lbl_sseqno,max(seq_no) lbl_tseqno,
        a.agcd agcd,a.dpcd dpcd,a.agname agname,a.agoname agoname,
        a.station_name station_name,a.station_oname station_oname,a.city_seqno city_seqno,a.city_name city_name,a.city_oname city_oname,
        a.dist_seqno dist_seqno,a.distname dist_name,a.distoname dist_oname,
        b.route_mode route_mode,d.mode_desc mode_name,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        a.subrt subrt_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
        a.sub_subrt sub_subrt_code,a.subsubrtnm sub_subrtname,a.subsubrtonm sub_subrtoname,
        a.publ publ,a.publ_name publname,a.edtn edtn,a.sup_rate sup_rate,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d,cir_sub_route_mast e 
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=e.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and a.unit_code=e.unit and 
        a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and a.route=e.route_code and (e.route_code||e.subrt_code =proutecode or proutecode is null) and 
        e.subrt_mode=d.mode_code and e.subrt_mode=nvl(proutemode,e.subrt_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.lbl_print_no,a.agcd,a.dpcd,a.agname,a.agoname,
        a.station_name,a.station_oname,a.city_seqno,a.city_name,a.city_oname,
        a.dist_seqno,a.distname,a.distoname,a.route_seqno,b.route_mode,d.mode_desc,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,
        a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.publ_name,a.edtn,a.sup_rate 
        order by route_seqno,route_name,subroute_name,lbl_sseqno,lbl_print_no;
        
        open p_accounts1 for
        select a.comp_code comp_code,a.unit_code unit_code,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        a.subrt subrt_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d,cir_sub_route_mast e 
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=e.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and a.unit_code=e.unit and 
        a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and a.route=e.route_code and (e.route_code||e.subrt_code =proutecode or proutecode is null) and 
        e.subrt_mode=d.mode_code and e.subrt_mode=nvl(proutemode,e.subrt_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm
        order by route_seqno,route_name,subroute_name;
    else
        open p_accounts for
        select a.comp_code comp_code,a.unit_code unit_code,a.lbl_print_no lbl_print_no,
        min(seq_no) lbl_sseqno,max(seq_no) lbl_tseqno,
        a.agcd agcd,a.dpcd dpcd,a.agname agname,a.agoname agoname,
        a.station_name station_name,a.station_oname station_oname,a.city_seqno city_seqno,a.city_name city_name,a.city_oname city_oname,
        a.dist_seqno dist_seqno,a.distname dist_name,a.distoname dist_oname,
        b.route_mode route_mode,d.mode_desc mode_name,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        a.subrt subrt_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
        a.sub_subrt sub_subrt_code,a.subsubrtnm sub_subrtname,a.subsubrtonm sub_subrtoname,
        a.publ publ,a.publ_name publname,a.edtn edtn,a.sup_rate sup_rate,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d,cir_sub_route_mast e,cir_sub_subroute_mast f 
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=e.comp_code and a.comp_code=f.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and a.unit_code=e.unit and
        a.unit_code=f.unit and a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and a.route=e.route_code and a.route=f.route_code and 
        a.subrt=e.subrt_code and a.subrt=f.subrt_code and a.sub_subrt=f.sub_subrt_code and (f.route_code||f.subrt_code||f.sub_subrt_code =proutecode or proutecode is null) and 
        f.sub_subrt_mode=d.mode_code and f.sub_subrt_mode=nvl(proutemode,f.sub_subrt_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.lbl_print_no,a.agcd,a.dpcd,a.agname,a.agoname,
        a.station_name,a.station_oname,a.city_seqno,a.city_name,a.city_oname,
        a.dist_seqno,a.distname,a.distoname,a.route_seqno,b.route_mode,d.mode_desc,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,
        a.sub_subrt,a.subsubrtnm,a.subsubrtonm,a.publ,a.publ_name,a.edtn,a.sup_rate 
        order by route_seqno,route_name,subroute_name,sub_subrtname,lbl_sseqno,lbl_print_no;
        
        open p_accounts1 for
        select a.comp_code comp_code,a.unit_code unit_code,
        a.route_seqno route_seqno,a.route route_code,a.rtnm route_name,a.rtonm route_oname,
        a.subrt subrt_code,a.subrtnm subroute_name,a.subrtonm subroute_oname,
        a.sub_subrt sub_subrt_code,a.subsubrtnm sub_subrtname,a.subsubrtonm sub_subrtoname,
        max(a.lbl_tno) tot_bundle,sum(nvl(supply_1,0)-nvl(unpaid_copy,0)) paid_copy,
        nvl(sum(unpaid_copy),0) unpaid_copy
        from cir_lblmast a,cir_route_mast b ,cir_route_mode_mast d,cir_sub_route_mast e,cir_sub_subroute_mast f 
        where a.comp_code=b.comp_code and a.comp_code=d.comp_code and a.comp_code=e.comp_code and a.comp_code=f.comp_code and a.comp_code=pcompcode and a.unit_code=b.unit and a.unit_code=e.unit and
        a.unit_code=f.unit and a.unit_code=punitcode and a.lbl_dt=vsupdate and a.route=b.route_code and a.route=e.route_code and a.route=f.route_code and 
        a.subrt=e.subrt_code and a.subrt=f.subrt_code and a.sub_subrt=f.sub_subrt_code and (f.route_code||f.subrt_code||f.sub_subrt_code =proutecode or proutecode is null) and 
        f.sub_subrt_mode=d.mode_code and f.sub_subrt_mode=nvl(proutemode,f.sub_subrt_mode) and a.publ=nvl(ppublcode,a.publ) 
        group by a.comp_code,a.unit_code,a.route,a.rtnm,a.rtonm,a.subrt,a.subrtnm,a.subrtonm,
        a.sub_subrt,a.subsubrtnm,a.subsubrtonm 
        order by route_seqno,route_name,subroute_name,sub_subrtname;        
    end if;
    
  End cir_rep_route_tripsheet;
END cir_rep_challan;
/

///////////////////////////////////////////////////////description//////////////////////////////////////////////////////

CREATE OR REPLACE PACKAGE HT18JULY.cir_rep_challan IS
  type t_accounts is ref cursor;
     
  procedure cir_rep_route_challan(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     ppublcode          in varchar2,
     proutemode         in varchar2,
     proutetype         in varchar2,---1 for route,2 for subroute & 3 for sub subroute
     proutecode         in varchar2,
     psupdate           in varchar2,
     pchallan_type      in varchar2,---1 for bundle and 2 for supply  
     plangtype          in varchar2,---1 for enlish and 2 for other language
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_route_tripsheet(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     ppublcode          in varchar2,
     proutemode         in varchar2,
     proutetype         in varchar2,---1 for route,2 for subroute & 3 for sub subroute
     proutecode         in varchar2,
     psupdate           in varchar2,
     pchallan_type      in varchar2,---1 for bundle and 2 for supply  
     plangtype          in varchar2,---1 for enlish and 2 for other language
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts); 
End cir_rep_challan;
/
//////////////////////////////////////////end///////////////////////////////////////////////////////////////////


/******************mimoh 17/feb/2012*****************6736***********/
CREATE OR REPLACE procedure cir_agency_unblock_approval (
    pcomp_code         in varchar2,
    punit_code         in varchar2,
    pbran_code         in varchar2,
    pstatus            in varchar2,
    pfrdt              in date,
    ptodt              in date,
    pagcd              in varchar2,
    pdpcd              in varchar2,
    psuspty            in varchar2,
    puserid            in varchar2,
    p_accounts         OUT cur_type_new1.cursor_type) as
Begin

open p_accounts for
  select s.comp_code as "COMP_CODE",s.unit as "UNIT",s.agcd as "AGCD",s.dpcd as "DPCD",m.ag_name as "AGENCY_NAME",
  cir_get_drop_point_name(s.comp_code,s.unit,m.station_code,1) as "DROP_POINT_NAME",cir_get_city(s.comp_code,m.city_code) as "CITY_NAME",
  s.SUSP_DATE as "BLOCK_UNBLOCK_DATE",TO_CHAR(s.CREATION_DATE,'hh:mi:ss') as "BLOCK_UNBLOCK_TIME",
         (SELECT SUSPEND_DESC FROM CIR_SUSPEND_TYPE_MAST WHERE COMP_CODE=s.COMP_CODE AND SUSPEND_TYPE_CODE=s.suspty) AS "BLOCK_REASON",s.suspty as "SUSPTY",
         (SELECT max("username") from login where com_code = s.comp_code  and "userid"=s.userid) as unblock_by,s.suspty as "SUSPEND_TYPE",
         s.agency_unblock_approval as "AGENCY_UNBLOCK_APPROVAL",s.userid as "USERID",nvl(s.trn_date,trunc(s.creation_date)) as "TRN_DATE" 
         from cir_suspend_tran s,cir_agmast m
      where s.comp_code = m.comp_code and s.comp_code = pcomp_code
      and s.SUSPTY=nvl(psuspty,s.SUSPTY)
      and m.BRANCH_CODE=nvl(pbran_code,m.BRANCH_CODE)
        and s.unit=m.unit and s.unit      = nvl(punit_code,s.unit)
        and s.susp      = pstatus
        and s.trn_date between pfrdt and ptodt
        and s.agcd=m.agcd and s.agcd    = nvl(pagcd,s.agcd)
        and s.dpcd=m.dpcd and s.dpcd    = nvl(pdpcd,s.dpcd)
        and s.userid  = nvl(puserid,s.userid)
        and nvl(s.agency_unblock_approval,'N')='N';
    
  
End cir_agency_unblock_approval;
/

/******************mimoh 17/feb/2012*****************6736***********/


////////////////////////////////////////////Issue no. 6590/////////////////////////////////////

CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_branch_received is
    procedure cir_branch_received_p1 (
        pcompcode       in varchar2,
        punitcode       in varchar2,
        pbranchcode     in varchar2,
        pfrombranch     in varchar2,
        pdoctypeout     in varchar2,
        pdoctypein      in varchar2,
        pfromdate       in varchar2,
        ptilldate       in varchar2,
        pdateformat     in varchar2,
        pextra1         in varchar2,
        pextra2         in varchar2,
        pextra3         in varchar2,
        pextra4         in varchar2,        
        pextra5         in varchar2,
        pextra6         in varchar2,
        pextra7         in varchar2,
        pextra8         in varchar2,
        pextra9         in varchar2,
        pextra10        in varchar2,                        
        p_circuls       out T_Circul_Cursor) 
    As
    v_frdt  date;
    v_todt  date;
   Begin
        v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
        v_todt:=to_date(pfromdate,''''||pdateformat||'''');
        
        open p_circuls for
        select distinct h.comp_code as "COMP_CODE",h.unit_code as "UNIT_CODE",d.branch_code as "BRANCH_CODE",(select "Branch_Name" from branch_mst where "Branch_Code"=d.branch_code) as "BRANCH_NAME",
        d.oth_branch_code as "OTH_BRANCH",(select "Branch_Name" from branch_mst where "Branch_Code"=d.oth_branch_code) as "OTH_BRANCH_NAME",
        d.recptno as "REF_RECPTNO" ,d.recptdt as "REF_RECPTDT",h.taxi_route_name as "TAXI_ROUTE_NAME", h.taxi_no as "TAXI_NO"
        from cir_branch_return_det d,cir_branch_return_hdr h 
        where h.comp_code=pcompcode and h.comp_code=d.comp_code and h.unit_code=punitcode and h.unit_code=d.unit_code and 
        h.doctype=d.doctype and ((h.recptdt between v_frdt and v_todt) or (v_frdt is null)) and h.recptno=d.recptno and d.branch_code=nvl(pfrombranch,d.branch_code) and 
        d.oth_branch_code=nvl(pbranchcode,d.oth_branch_code) and d.doctype=pdoctypeout and d.recptno||d.recptdt not in(select branch_refno||branch_refdt from cir_branch_return_hdr 
        where comp_code=pcompcode and unit_code=punitcode and doctype=pdoctypein)
        order by comp_code,unit_code,ref_recptdt,ref_recptno;
 
   End cir_branch_received_p1;

    procedure cir_branch_received_p2 (
        pcompcode    in varchar2,
        punitcode    in varchar2,
        pbranchcode  in varchar2,
        pfrombranch  in varchar2,
        pdoctypeout  in varchar2,
        pdoctypein   in varchar2,
        precptno     in varchar2,
        precptdt     in varchar2,        
        pdateformat  in varchar2,
        pextra1      in varchar2,
        pextra2      in varchar2,
        p_circuls    out T_Circul_Cursor) 
    As
    v_recptdt date;
   Begin
        v_recptdt:=to_date(precptdt,''''||pdateformat||'''');
        open p_circuls for
        select comp_code as "COMP_CODE",unit_code as "UNIT_CODE",branch_code as "OTH_BRANCH",recptno as "REF_RECPTNO",recptdt as "REF_RECPTDT",slno as "SLNO",
        publ_code as "PUBL_CODE",edtn_code as "EDTN_CODE",
        edtn_rate as "EDTN_RATE",edtn_copy as "EDTN_COPY",nvl(copy_weight,0) as "COPY_WEIGHT",oth_branch_code as "BRANCH",no_of_packet as "NO_OF_PACKET" 
        from cir_branch_return_det 
        where comp_code=pcompcode and unit_code=punitcode and branch_code=pfrombranch and 
        oth_branch_code=pbranchcode and doctype=pdoctypeout and recptno||recptdt not in(select branch_refno||branch_refdt from cir_branch_return_hdr 
        where comp_code=pcompcode and unit_code=punitcode and doctype=pdoctypein) and recptno=precptno and recptdt=v_recptdt
        order by comp_code,unit_code,recptdt,recptno,slno;
 
   End cir_branch_received_p2;   
End cir_branch_received;
/
//////////////////////////////////////////////////description//////////////////////////////////////////////////////

CREATE OR REPLACE PACKAGE HT18JULY.cir_branch_received is
   TYPE T_Circul_Cursor is Ref Cursor;
   procedure cir_branch_received_p1 (
        pcompcode       in varchar2,
        punitcode       in varchar2,
        pbranchcode     in varchar2,
        pfrombranch     in varchar2,
        pdoctypeout     in varchar2,
        pdoctypein      in varchar2,
        pfromdate       in varchar2,
        ptilldate       in varchar2,
        pdateformat     in varchar2,
        pextra1         in varchar2,
        pextra2         in varchar2,
        pextra3         in varchar2,
        pextra4         in varchar2,        
        pextra5         in varchar2,
        pextra6         in varchar2,
        pextra7         in varchar2,
        pextra8         in varchar2,
        pextra9         in varchar2,
        pextra10        in varchar2,                        
        p_circuls       out T_Circul_Cursor);

   procedure cir_branch_received_p2 (
   pcompcode    in varchar2,
   punitcode    in varchar2,
   pbranchcode  in varchar2,
   pfrombranch  in varchar2,
   pdoctypeout  in varchar2,
   pdoctypein   in varchar2,
   precptno     in varchar2,
   precptdt     in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   p_circuls    out T_Circul_Cursor);
End cir_branch_received;
/


////////////////////////////////////////////End of procedure////////////////////////////////////////////////////////////

//////////////////////////////Start By Garima/
CREATE OR REPLACE PROCEDURE cir_rep_inst_overall(
      pcompcode         in varchar2,
      punitcode         in varchar2,
      pbrancode         in varchar2,
      pagcd             in varchar2,
      pdpcd             in varchar2,
      pac_type          in varchar2,
      pfrom_dt          in varchar2,
      ptill_dt          in varchar2,
      ppaymode          in varchar2,
      preptype          in varchar2,--D for Detail ,S for Summary
      pdateformat       in varchar2,
      puserid           in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      pextra3           in varchar2,
      pextra4           in varchar2,
      pextra5           in varchar2,
      pextra6           in varchar2,
      pextra7           in varchar2,
      pextra8           in varchar2,
      pextra9           in varchar2,
      pextra10          in varchar2,     
      p_accounts        OUT Cur_Type_New1.cursor_type,
      p_accounts1       OUT Cur_Type_New1.cursor_type)
As
      v_frdt         date;
      v_todt         date;
Begin
    v_frdt    :=to_date(pfrom_dt,''''||pdateformat||'''');
    v_todt    :=to_date(ptill_dt,''''||pdateformat||'''');
open p_accounts for
                    select x.comp_code as "COMP_CODE", x.unit_code as "UNIT_CODE",x.branch_code as "BRANCH_CODE",
                    (select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=x.unit_code) as "PUB_CENT_NAME",
                    (select "Branch_Name" from branch_mst where "Branch_Code"=x.branch_code) as "BRANCH_NAME",
                    sum(x.tot_instamt) as "TOT_INSTAMT",
                    sum(x.inst_amt) as "INST_AMT",sum(x.paid_amt) as "PAID_AMT",(sum(nvl(x.inst_amt,0))-sum(abs(nvl(x.paid_amt,0)))) as "INST_BAL"
                    FROM(select d.comp_code, d.unit_code, m.inst_date, d.inst_code,
                    a.branch_code ,(select "Branch_Name" from branch_mst where "Branch_Code"=a.branch_code) as "BRANCH_NAME",
                    m.tot_instamt ,d.inst_amt,(select abs(sum(inst_due_amt)) from cir_inst_bill_det
                    where comp_code=m.comp_code and inst_code=m.inst_code and agcd=m.agcd and dpcd=m.dpcd and
                    recptno is not null ) as "PAID_AMT"
                    from cir_installment_mast m,cir_installment_det d,cir_agmast a
                    where d.comp_code=m.comp_code and d.comp_code=a.comp_code
                    and d.comp_code=pcompcode
                    and d.unit_code=m.unit_code and d.unit_code=a.unit
                    and  d.unit_code=nvl(punitcode,d.unit_code)
                    and m.inst_date between v_frdt and v_todt
                    ) x group by  x.comp_code, x.unit_code,x.branch_code ;
                    
                    
      open p_accounts1 for select sysdate as "CUR_DATE" from dual;
End cir_rep_inst_overall;
/

////////////////////////////end by Garima

////////////////////////////////////////////////////////////////////////////////////////////////////////

CREATE OR REPLACE PROCEDURE cir_rep_inst_agency_wise(
      pcompcode         in varchar2,
      punitcode         in varchar2,
      pbrancode         in varchar2,
      pagcd             in varchar2,
      pdpcd             in varchar2,
      pac_type          in varchar2,
      pfrom_dt          in varchar2,
      ptill_dt          in varchar2,
      ppaymode          in varchar2,
      preptype          in varchar2,--D for Detail ,S for Summary
      pdateformat       in varchar2,
      puserid           in varchar2,
      pextra1           in varchar2,
      pextra2           in varchar2,
      pextra3           in varchar2,
      pextra4           in varchar2,
      pextra5           in varchar2,
      pextra6           in varchar2,
      pextra7           in varchar2,
      pextra8           in varchar2,
      pextra9           in varchar2,
      pextra10          in varchar2,      
      p_accounts        OUT Cur_Type_New1.cursor_type,
      p_accounts1       OUT Cur_Type_New1.cursor_type)
As
      v_frdt         date;
      v_todt         date;
Begin
    v_frdt    :=to_date(pfrom_dt,''''||pdateformat||'''');
    v_todt    :=to_date(ptill_dt,''''||pdateformat||'''');
        
        
    if preptype='D' then--details
                    
        open p_accounts for
        select x.comp_code as "COMP_CODE", x.unit_code as "UNIT_CODE", x.inst_date as "INST_DATE", x.inst_code as "INST_CODE",
        x.agcd as "AGCD", x.dpcd as "DPCD",x.ag_name as "AG_NAME",x.branch_code as "BRANCH_CODE",(select "Branch_Name" from branch_mst where "Branch_Code"=x.branch_code) as "BRANCH_NAME",
        x.drop_point_name as "DROP_POINT_NAME", x.city_name as "CITY_NAME",x.state_name as "STATE_NAME",
        x.dist_name as "DIST_NAME",x.ag_type as "AG_TYPE",x.agency_type_name as "AGENCY_TYPE_NAME",
        x.inst_no as "INST_NO",x.inst_duedt as "INST_DUEDT" ,x.inst_enddt as "INST_ENDDT",
        x.inst_chqno as "INST_CHQNO",x.inst_chqdt as "INST_CHQDT",x.inst_chqamt as "INST_CHQAMT",x.inst_status as "INST_STATUS",
        x.inst_stdt as "INST_STDT", x.no_of_inst as "NO_OF_INST", x.tot_instamt as "TOT_INSTAMT", x.inst_freq as "INST_FREQ",
        x.inst_amt as "INST_AMT",x.paid_amt as "PAID_AMT",(nvl(x.inst_amt,0)-abs(nvl(x.paid_amt,0))) as "INST_BAL"
        FROM(select d.comp_code, d.unit_code, m.inst_date, d.inst_code,
        d.agcd, d.dpcd ,a.ag_name ,a.branch_code ,(select "Branch_Name" from branch_mst where "Branch_Code"=a.branch_code) as "BRANCH_NAME",
        cir_get_drop_point_name(d.comp_code,d.unit_code,a.station_code,1) as "DROP_POINT_NAME", 
        cir_get_city(d.comp_code,a.city_code) as "CITY_NAME",cir_get_state(d.comp_code,a.country_code, a.state_code) as "STATE_NAME",
        cir_get_dist(d.comp_code,a.state_code,a.dist_code) as "DIST_NAME",
        a.ag_type ,(select agency_type_desc from cir_agency_typ_mast where comp_code=d.comp_code and agency_type_code=a.ag_type) as "AGENCY_TYPE_NAME",
        d.inst_no,d.inst_duedt ,d.inst_enddt,
        d.inst_chqno ,d.inst_chqdt,d.inst_chqamt ,d.inst_status ,m.inst_stdt , m.no_of_inst , m.tot_instamt , m.inst_freq ,
        d.inst_amt,(select abs(sum(inst_due_amt)) from cir_inst_bill_det where comp_code=m.comp_code and inst_code=m.inst_code and agcd=m.agcd and dpcd=m.dpcd and
        recptno is not null and recptdt<=v_todt) as "PAID_AMT"
        from cir_installment_mast m,cir_installment_det d,cir_agmast a
        where d.comp_code=m.comp_code and d.comp_code=a.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit_code and d.unit_code=a.unit and 
        d.unit_code=nvl(punitcode,d.unit_code) and 
        d.agcd=m.agcd and d.agcd=a.agcd and d.agcd=nvl(pagcd,d.agcd) and d.dpcd=m.dpcd and d.dpcd=a.dpcd and d.dpcd=nvl(pdpcd,d.dpcd) and m.achd=nvl(pac_type,m.achd) and 
        m.inst_date between v_frdt and v_todt and (m.paymode=ppaymode or ppaymode is null)) x
          
        order by comp_code,unit_code,branch_name,ag_name,inst_date,inst_no;
     else--for summrey
        open p_accounts for
        select x.comp_code as "COMP_CODE", x.unit_code as "UNIT_CODE", x.agcd as "AGCD", x.dpcd as "DPCD",
        x.ag_name as "AG_NAME",x.branch_code as "BRANCH_CODE",x.branch_code as "BRANCH_NAME",
        x.drop_point_name as "DROP_POINT_NAME", x.city_name as "CITY_NAME",x.state_name as "STATE_NAME",x.dist_name as "DIST_NAME",
        x.ag_type as "AG_TYPE",x.agency_type_name as "AGENCY_TYPE_NAME",
        x.inst_freq as "INST_FREQ",x.inst_stdt as "INST_STDT",x.inst_enddt as "INST_ENDDT",
        x.inst_amt as "INST_AMT",x.paid_amt as "PAID_AMT",nvl(x.inst_amt,0)-nvl(x.paid_amt,0) as "BAL_AMT" from
        (select d.comp_code as "COMP_CODE", d.unit_code as "UNIT_CODE", d.agcd as "AGCD", d.dpcd as "DPCD",
        a.ag_name as "AG_NAME",a.branch_code as "BRANCH_CODE",(select "Branch_Name" from branch_mst where "Branch_Code"=a.branch_code) as "BRANCH_NAME",
        cir_get_drop_point_name(d.comp_code,d.unit_code,a.station_code,1) as "DROP_POINT_NAME", 
        cir_get_city(d.comp_code,a.city_code) as "CITY_NAME",cir_get_state(d.comp_code,a.country_code, a.state_code) as "STATE_NAME",
        cir_get_dist(d.comp_code,a.state_code,a.dist_code) as "DIST_NAME",
        a.ag_type as "AG_TYPE",(select agency_type_desc from cir_agency_typ_mast where comp_code=d.comp_code and agency_type_code=a.ag_type) as "AGENCY_TYPE_NAME",
        m.inst_freq as "INST_FREQ",min(m.inst_stdt) as "INST_STDT",max(d.inst_enddt) as "INST_ENDDT",
        sum(d.inst_amt) as "INST_AMT",(select abs(sum(inst_due_amt)) from cir_inst_bill_det where comp_code=m.comp_code and inst_code=m.inst_code and agcd=m.agcd and dpcd=m.dpcd and
        recptno is not null and recptdt<=v_todt) as "PAID_AMT"
        from cir_installment_mast m,cir_installment_det d,cir_agmast a
        where d.comp_code=m.comp_code and d.comp_code=a.comp_code and d.comp_code=pcompcode and d.unit_code=m.unit_code and d.unit_code=a.unit and 
        d.unit_code=nvl(punitcode,d.unit_code) and 
        d.agcd=m.agcd and d.agcd=a.agcd and d.agcd=nvl(pagcd,d.agcd) and d.dpcd=m.dpcd and d.dpcd=a.dpcd and d.dpcd=nvl(pdpcd,d.dpcd) and m.achd=nvl(pac_type,m.achd) and 
        m.inst_date<=v_todt and (m.paymode=ppaymode or ppaymode is null)  
        group by 
        
        
           m.comp_code,m.INST_CODE,m.AGCD,m.DPCD,      
        d.comp_code, d.unit_code, d.agcd, d.dpcd,a.ag_name,a.branch_code,a.station_code,
        a.city_code,a.country_code, a.state_code,a.dist_code,a.ag_type,m.inst_freq) x
        where nvl(x.inst_amt,0)-nvl(x.paid_amt,0)>0
        order by comp_code,unit_code,branch_name,ag_name;
     end if;               
    open p_accounts1 for select sysdate as "CUR_DATE" from dual;
End cir_rep_inst_agency_wise;
/
////////////////////////////////////////////End  By Garima

//------------------------issue no 6319------------------------------//

/* Formatted on 2012/02/20 16:41 (Formatter Plus v4.8.8) */
CREATE OR REPLACE PACKAGE BODY ht18july.wesp_modultprevdisp
IS
   PROCEDURE wesp_modultprevdisp_p (
      compcode     IN       VARCHAR2,
      userid       IN       VARCHAR2 := NULL,
      userhome     IN       VARCHAR2 := NULL,
      admin1       IN       VARCHAR2 := NULL,
      retainer     IN       VARCHAR2,
      p_accounts   OUT      t_account_cursor
   )
   AS
      agename   VARCHAR2 (15);
   BEGIN
--select distinct a.username,b.userid from module_detail b,login a where a.userid=b.userid
      IF (admin1 = 'yes' AND userhome = 'Agency')
      THEN
         SELECT "Agency_code"
           INTO agename
           FROM login
          WHERE "userid" = userid;

         OPEN p_accounts FOR
            SELECT DISTINCT "username", "userid",
                            (SELECT "Agency_Role_Name"
                               FROM agency_role_master
                              WHERE "Agency_Role_Code" =
                                                        roleid)
                                                               AS "ROLE_NAME"
                       FROM login
                      WHERE "COM_CODE" = compcode
                        AND "Company_user" = 'Agency'
                        AND "Agency_code" = agename
                   ORDER BY "username";
      ELSE
         OPEN p_accounts FOR
            SELECT DISTINCT "username", "userid", "Admin", "Company_user",
                            (SELECT "Agency_Role_Name"
                               FROM agency_role_master
                              WHERE "Agency_Role_Code" =
                                                        roleid)
                                                              AS "ROLE_NAME"
                       FROM login
                      WHERE "COM_CODE" = compcode
                        AND "retainer_code" = retainer
                   ORDER BY "username";
      END IF;
   END wesp_modultprevdisp_p;
END wesp_modultprevdisp;
/

//-----------------------------end of issue 6319---------------------//


////////////////////////////////////sent By ashok sahani sir////////////////////////////////////////////////

CREATE OR REPLACE Function cir_get_edtn_rate(
pcomp_code    in varchar2,
punit_code    in varchar2,
pedtn_code    in varchar2,
psup_date     in varchar2,
pdateformat   in varchar2) return number is
v_publ      varchar2(10);
vsup_date   date;
v_supday    varchar2(10);
v_sun_rate  number(10,4);
v_mon_rate  number(10,4);
v_tue_rate  number(10,4);
v_wed_rate  number(10,4);
v_thu_rate  number(10,4);
v_fri_rate  number(10,4);
v_sat_rate  number(10,4);
v_edtn_rate number(10,4);

begin
    vsup_date:=to_date(psup_date,''''||pdateformat||'''');

    select distinct publ into v_publ from cir_edtn_mast
        where comp_code=pcomp_code and edtn=pedtn_code;
        
    select spl_day_rate into v_edtn_rate from cir_special_rate_mast
		where comp_code=pcomp_code and unit=punit_code and
		publ=v_publ and edtn=pedtn_code and spl_day_date=vsup_date;        

    If nvl(v_edtn_rate,0)=0 then
        select distinct sun_rate,mon_rate,tue_rate,wed_rate,thu_rate,fri_rate,sat_rate into
            v_sun_rate,v_mon_rate,v_tue_rate,v_wed_rate,v_thu_rate,v_fri_rate,v_sat_rate from cir_rate_mast
            where comp_code=pcomp_code and unit=punit_code and publ=v_publ and edtn=pedtn_code and
               valid_from=(select max(valid_from) from cir_rate_mast where comp_code=pcomp_code and
               unit=punit_code and publ=v_publ and edtn=pedtn_code and valid_from<=vsup_date);


        v_supday:=to_char(vsup_date,'DY');
        
        if v_supday = 'SUN' then   ---for sunday edition rate
          v_edtn_rate  := v_sun_rate;
        elsif v_supday = 'MON' then ---for monday edition rate
            v_edtn_rate  := v_mon_rate;
        elsif v_supday = 'TUE' then ---for tueday edition rate
            v_edtn_rate  := v_tue_rate;
        elsif v_supday = 'WED' then ---for wednesday edition rate
            v_edtn_rate  := v_wed_rate;
        elsif v_supday = 'THU' then ---for Thursday edition rate
            v_edtn_rate  := v_thu_rate;
        elsif v_supday = 'FRI' then ---for friday edition rate
            v_edtn_rate  := v_fri_rate;
        elsif v_supday = 'SAT' then ---for saturday edition rate
            v_edtn_rate  := v_sat_rate;
        else
            v_edtn_rate  := 0;
        end if;
    End if;        
    --dbms_output.put_line('v_edtn_rate '||v_edtn_rate|| pcomp_code||' ,'||punit_code||' , '|| pedtn_code||' , '||psup_date||' , '||pdateformat );
    --dbms_output.put_line('v_edtn_rate '||v_edtn_rate|| pcomp_code||' ,'||punit_code||' , '|| pedtn_code||' , '||psup_date||' , '||pdateformat );
     --INSERT INTO TEST1(VSTRING,VSTRING2) VALUES(' cir_get_waste_rate '||v_edtn_rate,pcomp_code||' ,'||punit_code||' , '|| pedtn_code||' , '||psup_date||' , '||pdateformat);--COMMIT;
    return v_edtn_rate;
END cir_get_edtn_rate;
/
//////////////////////////////////////////////end///////////////////////////////////////////////////////////////////////

//////////////////////////////////////////SENT BY LAXMAN SIR 21/02/2012///////////////////////////////////////////////////
CREATE OR REPLACE PACKAGE CIR_SUPPLY_POST_FOR_NEXT_DAY IS
  TYPE T_Circul_Cursor is Ref Cursor;
  procedure cir_supply_posting_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pedtn_code      in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    puserid         in varchar2,
    psup_date       in varchar2,
    psup_ty         in varchar2,-----------means Regular or Special day1 or Special Day2 Supply--
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_circul        out T_Circul_Cursor);

  procedure cir_supply_posting_resale_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pedtn_code      in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    puserid         in varchar2,
    psup_date       in varchar2,
    psup_ty         in varchar2,-----------means Regular or Special day1 or Special Day2 Supply--
    pissue_date     in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,    
    p_circul        out T_Circul_Cursor);    
    
  procedure cir_check_supply_posting_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pedtn_code      in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    psup_date       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_circul        out T_Circul_Cursor);    
END CIR_SUPPLY_POST_FOR_NEXT_DAY;
/
CREATE OR REPLACE PACKAGE BODY CIR_SUPPLY_POST_FOR_NEXT_DAY IS
  Procedure cir_supply_posting_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pedtn_code      in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    puserid         in varchar2,
    psup_date       in varchar2,
    psup_ty         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_circul        out T_Circul_Cursor)
   As
    vsup_date       date;
    v_holi_count    number(5);
    
    cursor cir_edtn_cur is
        select distinct edtn,edtn_name from cir_edtn_mast 
            where comp_code=pcomp_code and publ = ppubl_code and
                main_edtn = nvl(pedtn_code,main_edtn) and nvl(freeze_flag,'N')='N' and 
                main_edtn not in(select distinct h_main_edtn from cir_holiday_mast 
                    where comp_code = pcomp_code and unit = punit_code and
                        h_publ = ppubl_code and h_date = vsup_date and nvl(freeze_flag,'N')='N' and h_main_edtn is not null);
                    
    cir_edtn_rec cir_edtn_cur%rowtype;

    v_spl_rate number(10,4):=0;

    cursor cur_supply is
              select a.unit unit,a.agcd agcd,a.dpcd dpcd,a.publ publ,a.edtn edtn,a.supply_type_code supply_type_code,a.base_supply base_supply,a.supply_sun supply_sun,a.supply_mon supply_mon,a.supply_tue supply_tue,a.supply_wed supply_wed,
              a.supply_thu supply_thu,a.supply_fri supply_fri,a.supply_sat supply_sat,a.supply_spl1 supply_spl1,a.supply_spl2 supply_spl2, b.ag_type ag_type,b.supply_start_dt    supply_start_dt,b.suspend_date suspend_date, nvl(a.packet_size,0) packet_size,
                 a.comm_code comm_code,a.comm_flag comm_flag,b.bill_agcd bill_agcd,b.bill_dpcd bill_dpcd,a.route_code route_code,a.subroute_code subroute_code,a.sub_subroute_code sub_subroute_code,
                 a.surch_cd surch_cd
                 from cir_supply a,cir_agmast b
                 where a.comp_code=b.comp_code and a.unit=b.unit and
                              a.agcd=b.agcd and a.dpcd=b.dpcd and a.agcd=nvl(pagcd,a.agcd) and a.dpcd=nvl(pdpcd,a.dpcd) and
                              a.unit=punit_code and (a.publ=ppubl_code) and nvl(base_supply,0)>0 and
                              a.edtn=cir_edtn_rec.edtn and nvl(a.supply_flag,'N')='Y' and nvl(b.suspend,'N')='N'
                 order by a.agcd,a.dpcd,a.edtn,a.supply_type_code;
vcur_supply        cur_supply%rowtype;

    cursor cur_rate is
        select sun_rate,mon_rate,tue_rate,wed_rate,thu_rate,fri_rate,sat_rate from cir_rate_mast
            where comp_code=pcomp_code and unit=punit_code and publ=ppubl_code and edtn=cir_edtn_rec.edtn and
              valid_from=(select max(valid_from) from cir_rate_mast where comp_code=pcomp_code and
              unit=punit_code and publ=ppubl_code and edtn=cir_edtn_rec.edtn and valid_from<=vsup_date and
              nvl(freeze_flag,'N')='N');
cur_rate_rec cur_rate%rowtype;

cursor cur_surcharge is select * from cir_surcharge_mast
            where comp_code  =pcomp_code and
                  unit       =punit_code and
                  publ       =ppubl_code and
                  edtn       =cir_edtn_rec.edtn and
                  surch_cd   =vcur_supply.surch_cd and
                  valid_from = (select max(valid_from) from cir_surcharge_mast
                                            where comp_code  =pcomp_code and
                                                  unit       =punit_code and
                                                  publ       =ppubl_code and
                                                  edtn       =cir_edtn_rec.edtn and
                                                  surch_cd   =vcur_supply.surch_cd and
                                                  valid_from<=vsup_date);
    v_sup_copy      number(7);
    v_edtn_rate     number(10,4);
    vreccnt         number(5);
    v_old_sup_copy  number(7);
    v_supply_copy_dt date;
begin

    vsup_date:=to_date(psup_date,''''||pdateformat||'''');
    
    if pextra1 is not null then
        v_supply_copy_dt:=to_date(pextra1,''''||pdateformat||'''');
    end if;
    
    select count(*) into v_holi_count from cir_holiday_mast
        where comp_code = pcomp_code and unit = punit_code and
              h_publ = ppubl_code and h_date = vsup_date and nvl(freeze_flag,'N')='N' and 
              h_main_edtn is null and h_edtn is null and dist_code is null and state_code is null;

    if v_holi_count=0 then
        open cir_edtn_cur; --cursor open for edition
        loop
            fetch cir_edtn_cur into cir_edtn_rec;
            exit when cir_edtn_cur%notfound;
            --deletion record for already exists data

            delete from cir_dbksup where comp_code=pcomp_code and unit_code=punit_code and
                    publ=ppubl_code and edtn=cir_edtn_rec.edtn and supdate=vsup_date and
                    agcd=nvl(pagcd,agcd) and dpcd=nvl(pdpcd,dpcd);
            
            --for if special day of date on supply date
            Begin
                select spl_day_rate into v_spl_rate from cir_special_rate_mast
                    where comp_code=pcomp_code and unit=punit_code and
                          publ=ppubl_code and edtn=cir_edtn_rec.edtn and spl_day_date=vsup_date;
            Exception when no_data_found then
                v_spl_rate:=0;
            End;
                            
        if nvl(v_spl_rate,0)=0 then
            open cur_rate;--cursor open for regular rate
            fetch cur_rate into cur_rate_rec;


              if to_char(vsup_date,'DY') = 'SUN' then            ---for sunday edition rate
                  v_edtn_rate        :=    cur_rate_rec.sun_rate;
              elsif to_char(vsup_date,'DY') = 'MON' then    ---for monday edition rate
                  v_edtn_rate        :=    cur_rate_rec.mon_rate;
              elsif to_char(vsup_date,'DY') = 'TUE' then    ---for tueday edition rate
                  v_edtn_rate        :=    cur_rate_rec.tue_rate;
              elsif to_char(vsup_date,'DY') = 'WED' then    ---for wednesday edition rate
                  v_edtn_rate        :=    cur_rate_rec.wed_rate;
              elsif to_char(vsup_date,'DY') = 'THU' then    ---for Thursday edition rate
                  v_edtn_rate        :=    cur_rate_rec.thu_rate;
              elsif to_char(vsup_date,'DY') = 'FRI' then    ---for friday edition rate
                  v_edtn_rate        :=    cur_rate_rec.fri_rate;
              elsif to_char(vsup_date,'DY') = 'SAT' then    ---for saturday edition rate
                  v_edtn_rate        :=    cur_rate_rec.sat_rate;
              else
                  v_edtn_rate        :=    0;
              end if;
           close cur_rate;
        else
            v_edtn_rate:=v_spl_rate;
        end if;

        if v_edtn_rate=0 then
            dbms_output.put_line('Please Check,The Rate Today Is not Define for '||' '||    cir_edtn_rec.edtn_name);
        end if;

        open cur_supply; ---- cursor open for supply type wise
        loop
          fetch cur_supply into vcur_supply;
            exit when cur_supply%notfound;
            if (vsup_date>=vcur_supply.supply_start_dt or vcur_supply.supply_start_dt is null) and
                    (vsup_date<=vcur_supply.suspend_date or vcur_supply.suspend_date is null) then

              if psup_ty='R' and to_char(vsup_date,'DY') = 'SUN' then            ---for sunday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sun,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sun,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'MON' then    ---for monday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_mon,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_mon,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'TUE' then    ---for tueday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_tue,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_tue,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'WED' then    ---for wednesday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_wed,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_wed,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'THU' then    ---for Thursday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_thu,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_thu,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'FRI' then    ---for friday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_fri,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_fri,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'SAT' then    ---for saturday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sat,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sat,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='S1' then    ---for Special Day supply
                --dbms_output.put_line('Please Check The  speicla Today Is  '||' '||vcur_supply.agcd||','||vcur_supply.base_supply||','||vcur_supply.supply_spl1);
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl1,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl1,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='S2' then    ---for Special Day supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl2,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl2,0);
                else
                    v_sup_copy        := 0;
                 end if;
            end if;

            --------change for supply copy--------
            if psup_ty='R' and v_supply_copy_dt is not null then
                v_old_sup_copy:=0;
                select sum(sup_copy) into v_old_sup_copy from cir_dbksup where comp_code=pcomp_code and unit_code=punit_code and publ=ppubl_code and edtn=vcur_supply.edtn and
                    agcd=vcur_supply.agcd and dpcd=vcur_supply.dpcd and supdate=v_supply_copy_dt and sup_type_code=vcur_supply.supply_type_code;

            end if;

            if nvl(v_old_sup_copy,0)>0 then
                v_sup_copy:=v_old_sup_copy;
            end if;
            --------change for supply copy--------

          if nvl(v_sup_copy,0)>0 and nvl(v_edtn_rate,0)>0 then

               Begin
                insert into cir_dbksup (comp_code,unit_code,publ,edtn,agcd,dpcd,supdate,sup_type_code,sup_copy,agency_ty_code,
                                                                    agency_pkt_size,comm_code,comm_fix_auto_spl,sup_rate,billagcd,billdpcd,
                                                                    route_code,subroute_code,subsubroute_code,userid,surch_cd)
                 values (pcomp_code,punit_code,ppubl_code,vcur_supply.edtn,vcur_supply.agcd,vcur_supply.dpcd,vsup_date,vcur_supply.supply_type_code,
                                 v_sup_copy,vcur_supply.ag_type,vcur_supply.packet_size,vcur_supply.comm_code,vcur_supply.comm_flag,
                                 v_edtn_rate,vcur_supply.bill_agcd,vcur_supply.bill_dpcd,vcur_supply.route_code,
                                     vcur_supply.subroute_code,vcur_supply.sub_subroute_code,puserid,vcur_supply.surch_cd);
                          exception when others then
                               /*insert into test1(vstring) values ('Exp'||pcomp_code||','||punit_code||','||ppubl_code||','||vcur_supply.edtn||','||vcur_supply.agcd||','||vcur_supply.dpcd||','||vsup_date||','||vcur_supply.supply_type_code||','||
                                 v_sup_copy||','||vcur_supply.ag_type||','||vcur_supply.packet_size||','||vcur_supply.comm_code||','||vcur_supply.comm_flag||','||
                                 v_edtn_rate||','||vcur_supply.bill_agcd||','||vcur_supply.bill_dpcd||','||vcur_supply.route_code||','||
                                     vcur_supply.subroute_code||','||vcur_supply.sub_subroute_code||','||puserid);commit;*/
                         null;
               End;
               select count(*) into vreccnt from cir_dbksup
               where comp_code=pcomp_code and unit_code=punit_code and publ=ppubl_code and edtn=vcur_supply.edtn and
               supdate=vsup_date and agcd=nvl(pagcd,agcd) and dpcd=nvl(pdpcd,dpcd);


         end if;
        end if;
        end loop;
        close cur_supply;
        v_edtn_rate:=0;v_spl_rate:=0;cir_edtn_rec.edtn:=NULL;
    end loop;
    close cir_edtn_cur;
    commit;
  end if;

  open p_circul for
  select decode(b.bill_pay,'Y','PAID','N','UNPAID','UNPAID') bill_pay,sum(a.sup_copy) sup_copy
    from cir_dbksup a,cir_supply_type_mast b,cir_edtn_mast e
    where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=e.comp_code and a.unit_code=punit_code and
          a.publ=e.publ and a.publ=ppubl_code and a.edtn=e.edtn and e.main_edtn = nvl(pedtn_code,e.main_edtn) and
          a.sup_type_code=b.sup_ty_code and a.supdate=vsup_date and
          a.agcd=nvl(pagcd,a.agcd) and a.dpcd=nvl(pdpcd,a.dpcd)
    group by b.bill_pay
    order by b.bill_pay desc;

  End cir_supply_posting_p;

  Procedure cir_supply_posting_resale_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl_code      in varchar2,
    pedtn_code      in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    puserid         in varchar2,
    psup_date       in varchar2,
    psup_ty         in varchar2,-----------means Regular or Special day1 or Special Day2 Supply--
    pissue_date     in varchar2,---from preiodical issue master---
    pdateformat     in varchar2,
    pextra1         in varchar2,--for supply type code
    pextra2         in varchar2,--for supply copy
    pextra3         in varchar2,--for login branch code
    pextra4         in varchar2,
    pextra5         in varchar2,
    p_circul        out T_Circul_Cursor) 
   As
        vsup_date  date;
        viss_date  date;
        
        cursor cur_holiday is
            select h_date,h_name from cir_holiday_mast
                where comp_code=pcomp_code and 
                      unit=punit_code and 
                      h_publ=ppubl_code and
                      h_date=vsup_date and nvl(freeze_flag,'N')='N';
    vcur_holiday cur_holiday%rowtype;

        cursor cir_edtn_cur is
                    select distinct edtn,edtn_name from cir_edtn_mast
                    where comp_code=pcomp_code and publ = ppubl_code and
                    ((edtn = pedtn_code) or (pedtn_code is null)) and
                      nvl(freeze_flag,'N')='N';
         cir_edtn_rec cir_edtn_cur%rowtype;
        
        cursor cur_spl_rate is
            select spl_day_rate from cir_special_rate_mast
                where comp_code=pcomp_code and unit=punit_code and
                      publ=ppubl_code and edtn=cir_edtn_rec.edtn and spl_day_date=vsup_date;

    v_spl_rate number(10,4):=0;

    cursor cur_supply is
              select a.unit unit,a.agcd agcd,a.dpcd dpcd,a.publ publ,a.edtn edtn,a.supply_type_code supply_type_code,a.base_supply base_supply,a.supply_sun supply_sun,a.supply_mon supply_mon,a.supply_tue supply_tue,a.supply_wed supply_wed,
              a.supply_thu supply_thu,a.supply_fri supply_fri,a.supply_sat supply_sat,a.supply_spl1 supply_spl1,a.supply_spl2 supply_spl2, b.ag_type ag_type,b.supply_start_dt    supply_start_dt,b.suspend_date suspend_date, nvl(a.packet_size,0) packet_size,
                 a.comm_code comm_code,a.comm_flag comm_flag,b.bill_agcd bill_agcd,b.bill_dpcd bill_dpcd,a.route_code route_code,a.subroute_code subroute_code,a.sub_subroute_code sub_subroute_code,
                 a.surch_cd surch_cd
                 from cir_supply a,cir_agmast b
                 where a.comp_code=b.comp_code and a.unit=b.unit and 
                              a.agcd=b.agcd and a.dpcd=b.dpcd and a.agcd=pagcd and a.dpcd=pdpcd and 
                              a.unit=punit_code and (a.publ=ppubl_code) and
                              nvl(base_supply,0)>0 and
                              a.edtn=cir_edtn_rec.edtn and
                              nvl(a.supply_flag,'N')='Y' and nvl(b.suspend,'N')='N'
                 order by a.agcd,a.dpcd,a.edtn,a.supply_type_code;
vcur_supply        cur_supply%rowtype;

    cursor cur_rate is
        select sun_rate,mon_rate,tue_rate,wed_rate,thu_rate,fri_rate,sat_rate from cir_rate_mast
            where comp_code=pcomp_code and unit=punit_code and publ=ppubl_code and edtn=cir_edtn_rec.edtn and
              valid_from=(select max(valid_from) from cir_rate_mast where comp_code=pcomp_code and
              unit=punit_code and publ=ppubl_code and edtn=cir_edtn_rec.edtn and valid_from<=vsup_date and 
              nvl(freeze_flag,'N')='N');
cur_rate_rec cur_rate%rowtype;

cursor cur_surcharge is select * from cir_surcharge_mast 
            where comp_code  =pcomp_code and 
                  unit       =punit_code and
                  publ       =ppubl_code and
                  edtn       =cir_edtn_rec.edtn and
                  surch_cd   =vcur_supply.surch_cd and 
                  valid_from = (select max(valid_from) from cir_surcharge_mast 
                                            where comp_code  =pcomp_code and 
                                                  unit       =punit_code and
                                                  publ       =ppubl_code and
                                                  edtn       =cir_edtn_rec.edtn and
                                                  surch_cd   =vcur_supply.surch_cd and
                                                  valid_from<=vsup_date);
            v_sup_copy     number(7);
            v_edtn_rate    number(10,4);
            vreccnt number(5);
begin

    vsup_date:=to_date(psup_date,''''||pdateformat||'''');
    viss_date:=to_date(pissue_date,''''||pdateformat||'''');
    insert into test1(vstring,vstring2) values('vsup_dat '||vsup_date,'viss_date '||viss_date);commit;
    /* Holiday Checking */
    open cur_holiday;
      fetch cur_holiday into vcur_holiday;
    close cur_holiday;
    
    if vsup_date=vcur_holiday.h_date then
        dbms_output.put_line('Please Check The  Holiday Today Is  '||' '||    vcur_holiday.h_name);
        dbms_output.put_line('Please Check The  Holiday Today Is  '||' '||    vcur_holiday.h_name);
    end if;
    
  if (vsup_date<>vcur_holiday.h_date) or vcur_holiday.h_date is null then
    open cir_edtn_cur; --cursor open for edition
    loop
        fetch cir_edtn_cur into cir_edtn_rec;
        exit when cir_edtn_cur%notfound;
            --deletion record for already exists data

            delete from cir_dbksup_resale where comp_code=pcomp_code and unit_code=punit_code and
                    publ=ppubl_code and edtn=cir_edtn_rec.edtn and supdate=vsup_date and 
                    (agcd=pagcd or pagcd is null) and (dpcd=pdpcd or pdpcd is null);

        /*open cur_spl_rate;----cursor open for if special day of date on supply date
        fetch cur_spl_rate into v_spl_rate;
        close cur_spl_rate;

        if nvl(v_spl_rate,0)=0 then
            open cur_rate;--cursor open for regular rate
            fetch cur_rate into cur_rate_rec;
            close cur_rate;
            
      if to_char(vsup_date,'DY') = 'SUN' then            ---for sunday edition rate
          v_edtn_rate        :=    cur_rate_rec.sun_rate;
      elsif to_char(vsup_date,'DY') = 'MON' then    ---for monday edition rate
          v_edtn_rate        :=    cur_rate_rec.mon_rate;
      elsif to_char(vsup_date,'DY') = 'TUE' then    ---for tueday edition rate
          v_edtn_rate        :=    cur_rate_rec.tue_rate;
      elsif to_char(vsup_date,'DY') = 'WED' then    ---for wednesday edition rate
          v_edtn_rate        :=    cur_rate_rec.wed_rate;
      elsif to_char(vsup_date,'DY') = 'THU' then    ---for Thursday edition rate
          v_edtn_rate        :=    cur_rate_rec.thu_rate;
      elsif to_char(vsup_date,'DY') = 'FRI' then    ---for friday edition rate
          v_edtn_rate        :=    cur_rate_rec.fri_rate;
      elsif to_char(vsup_date,'DY') = 'SAT' then    ---for saturday edition rate
          v_edtn_rate        :=    cur_rate_rec.sat_rate;
      else
          v_edtn_rate        :=    0;
      end if;
        else
            v_edtn_rate:=v_spl_rate;
        end if;*/
        begin
            select nvl(issue_price,0) into v_edtn_rate from cir_priodical_issue_mast 
                where comp_code=pcomp_code and unit_code=punit_code and publ_code=ppubl_code and edtn_code=cir_edtn_rec.edtn and issue_date=viss_date;
        exception when no_data_found then
            v_edtn_rate:=0;
        end;         

        if v_edtn_rate=0 then
            dbms_output.put_line('Please Check,The Rate Today Is not Define for '||' '||    cir_edtn_rec.edtn_name);
        end if;
        
        open cur_supply; ---- cursor open for supply type wise
        loop
          fetch cur_supply into vcur_supply;
            exit when cur_supply%notfound;
            if (vsup_date>=vcur_supply.supply_start_dt or vcur_supply.supply_start_dt is null) and
                    (vsup_date<=vcur_supply.suspend_date or vcur_supply.suspend_date is null) then

              if psup_ty='R' and to_char(vsup_date,'DY') = 'SUN' then            ---for sunday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sun,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sun,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'MON' then    ---for monday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_mon,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_mon,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'TUE' then    ---for tueday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_tue,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_tue,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'WED' then    ---for wednesday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_wed,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_wed,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'THU' then    ---for Thursday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_thu,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_thu,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'FRI' then    ---for friday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_fri,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_fri,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='R' and to_char(vsup_date,'DY') = 'SAT' then    ---for saturday supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sat,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_sat,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='S1' then    ---for Special Day supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl1,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl1,0);
                else
                    v_sup_copy        := 0;
                 end if;
            elsif psup_ty='S2' then    ---for Special Day supply
                if nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl2,0)>0 then
                    v_sup_copy        :=     nvl(vcur_supply.base_supply,0)+nvl(vcur_supply.supply_spl2,0);
                else
                    v_sup_copy        := 0;
                 end if;
            end if;
            
            v_sup_copy:=pextra2;
            
          if nvl(v_sup_copy,0)>0 then
               
               Begin
                insert into cir_dbksup_resale (comp_code,unit_code,publ,edtn,agcd,dpcd,supdate,sup_type_code,sup_copy,agency_ty_code,
                                                                    agency_pkt_size,comm_code,comm_fix_auto_spl,sup_rate,billagcd,billdpcd,
                                                                    route_code,subroute_code,subsubroute_code,userid,surch_cd,issue_date,return_copy_sale,resale_branch)
                 values (pcomp_code,punit_code,ppubl_code,vcur_supply.edtn,vcur_supply.agcd,vcur_supply.dpcd,vsup_date,/*vcur_supply.SUPPLY_TYPE_CODE,*/pextra1,
                                 v_sup_copy,vcur_supply.ag_type,vcur_supply.packet_size,vcur_supply.comm_code,vcur_supply.comm_flag,
                                 v_edtn_rate,vcur_supply.bill_agcd,vcur_supply.bill_dpcd,vcur_supply.route_code,
                                     vcur_supply.subroute_code,vcur_supply.sub_subroute_code,puserid,vcur_supply.surch_cd,viss_date,'Y',v_sup_copy);
               Exception when others then
                   null;
               End;                     
               select count(*) into vreccnt from cir_dbksup_resale 
                where comp_code=pcomp_code and unit_code=punit_code and publ=ppubl_code and edtn=vcur_supply.edtn and supdate=vsup_date and 
                (agcd=pagcd or pagcd is null) and (dpcd=pdpcd or pdpcd is null);
                 --end if;
         end if;
        end if;
        end loop;
        close cur_supply;
    end loop;
    close cir_edtn_cur;
    commit;
  end if;  
  
  open p_circul for
  select decode(b.bill_pay,'Y','PAID','N','UNPAID','UNPAID') bill_pay,sum(a.sup_copy) sup_copy
    from cir_dbksup_resale a,cir_supply_type_mast b
    where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.unit_code=punit_code and 
          a.publ=ppubl_code and (a.edtn = pedtn_code or pedtn_code is null) and 
          a.sup_type_code=b.sup_ty_code and a.supdate=vsup_date and 
          (a.agcd=pagcd or pagcd is null) and (a.dpcd=pdpcd or pdpcd is null)
    group by b.bill_pay
    order by b.bill_pay desc;
  
  End cir_supply_posting_resale_p;

  procedure cir_check_supply_posting_p(
    pcomp_code  in varchar2,
    punit_code  in varchar2,
    ppubl_code  in varchar2,
    pedtn_code  in varchar2,
    pagcd       in varchar2,
    pdpcd       in varchar2,
    psup_date   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    p_circul    out T_Circul_Cursor)
  As
    vsup_date date;
    v_many_time_posting varchar2(1);
    v_backdays_posting  number(10);
    v_days              number(10);
    v_bill_exist        number(10);
    v_sup_copy          number(1);
  Begin
    vsup_date:=to_date(psup_date,''''||pdateformat||'''');
    
    select to_date(sysdate)-vsup_date into v_days from dual;

    select count(*) into v_bill_exist from cir_bill_det d,cir_publ_mast p,cir_edtn_mast e
        where d.comp_code = p.comp_code and d.comp_code = e.comp_code and d.comp_code=pcomp_code and d.unit_code=punit_code and
        vsup_date between fromdt and todt and d.publ=p.publ and d.publ = ppubl_code and d.edtn=e.edtn and e.main_edtn = nvl(pedtn_code,e.main_edtn);

    
    select cir_many_time_posting,cir_backdays_posting into v_many_time_posting,v_backdays_posting from preferrences 
        where "comp_code"=pcomp_code;
        
    If v_bill_exist=0 then--for bill checking
        if vsup_date-1>trunc(sysdate) then
            if nvl(v_many_time_posting,'N')='N' then
                select nvl(sum(a.sup_copy),0) sup_copy into v_sup_copy
                from cir_dbksup a,cir_edtn_mast e
                where a.comp_code=pcomp_code and a.comp_code=e.comp_code and a.unit_code=punit_code and 
                      a.publ=ppubl_code and a.publ = e.publ and a.edtn= e.edtn and 
                      a.supdate=vsup_date and a.agcd=nvl(pagcd,a.agcd) and a.dpcd=nvl(pdpcd,a.dpcd) and
                      e.main_edtn = nvl(pedtn_code,e.main_edtn);
            else
                v_sup_copy:=0;                
            end if;
        else
            if nvl(v_many_time_posting,'N')='N' then
                select nvl(sum(a.sup_copy),0) sup_copy into v_sup_copy
                    from cir_dbksup a,cir_edtn_mast e
                    where a.comp_code=pcomp_code and a.comp_code=e.comp_code and a.unit_code=punit_code and 
                          a.publ=ppubl_code and a.publ = e.publ and a.edtn= e.edtn and 
                          a.supdate=vsup_date and a.agcd=nvl(pagcd,a.agcd) and a.dpcd=nvl(pdpcd,a.dpcd) and
                          e.main_edtn = nvl(pedtn_code,e.main_edtn);
            else
                if nvl(v_backdays_posting,0)>0 then
                    if v_days>=v_backdays_posting then
                        v_sup_copy:=0;
                    else
                       v_sup_copy:=1;
                    end if;
                else
                    v_sup_copy:=0;                
                end if;
            end if;
        end if;
    Else
        v_sup_copy:=1;    
    End if;
    
    open p_circul for
    select v_sup_copy from dual;
    
  End cir_check_supply_posting_p;
  
  procedure cir_check_supply_posting_p(
    pcomp_code  in varchar2,
    punit_code  in varchar2,
    ppubl_code  in varchar2,
    pedtn_code  in varchar2,
    psup_date   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    p_circul    out T_Circul_Cursor)
  As
    vsup_date date;
  Begin
    vsup_date:=to_date(psup_date,''''||pdateformat||'''');
    
    if /*vsup_date-1>trunc(sysdate) and */1=2 then
        open p_circul for
        select nvl(sum(a.sup_copy),0) sup_copy
        from cir_dbksup_resale a
        where a.comp_code=pcomp_code and a.unit_code=punit_code and 
              a.publ=ppubl_code and a.edtn in (select distinct edtn from cir_edtn_mast
                        where comp_code=pcomp_code and publ = ppubl_code and
                        (nvl(main_edtn,edtn) = pedtn_code or pedtn_code is null)) and 
              a.supdate=vsup_date /*and (a.agcd=pagcd or pagcd is null) and (a.dpcd=pdpcd or pdpcd is null)*/;
    else
        open p_circul for
        select 0 sup_copy from dual;
    end if;
  End cir_check_supply_posting_p;  
END CIR_SUPPLY_POST_FOR_NEXT_DAY;
/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//-----------------------------issue no 6440------------------------------//

CREATE OR REPLACE PACKAGE HT18JULY.cir_agency_bind is
   type t_accounts_cursor is ref cursor;
procedure cir_agency_bind_p (
    pcompcode   in varchar2,
    punit       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdistcode   in varchar2:=null,
    p_accounts  out t_accounts_cursor);
procedure cir_branch_billagency_p (
    pcompcode   in varchar2,
    punit       in varchar2,
    pbranchcode in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdistcode   in varchar2,
    p_accounts  out t_accounts_cursor);
procedure cir_agency_bind_p (
    pcompcode   in varchar2,
    punit       in varchar2,
    pagcd       in varchar2,
    pdpcd       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,    
    p_accounts  out t_accounts_cursor);
procedure cir_agency_listing_p (
    pcompcode   in varchar2,
    punit       in varchar2,
    pagty       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,    
    p_accounts  out t_accounts_cursor);
procedure cir_agency_area_p (
    pcompcode   in varchar2,
    punit       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,    
    p_accounts  out t_accounts_cursor);
procedure cir_agency_extraLabel_p(
    pcompcode     in varchar2,
    punit         in varchar2,
    pdateformat   in varchar2,
    pextra1       in varchar2,
    pextra2       in varchar2,
    p_accounts    out t_accounts_cursor);
procedure cir_agency_bind_pd (
    pcompcode       in varchar2,
    punit           in varchar2,
    pname           in varchar2,
    pdateformat     in varchar2,
    -- pextra1 in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts_cursor);
procedure cir_agency_bind_pgoogle (
    pcompcode   in varchar2,
    punit       in varchar2,
    pagcd       in varchar2,
    pdpcd       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,    
    p_accounts  out t_accounts_cursor);
End cir_agency_bind;
/



CREATE OR REPLACE PACKAGE BODY HT18JULY.cir_agency_bind is
    procedure cir_agency_bind_p (
        pcompcode         in varchar2,
        punit             in varchar2,
        pdateformat     in varchar2,
        pextra1         in varchar2,
        pextra2         in varchar2,
		pdistcode       in varchar2:=null,
        p_accounts         out t_accounts_cursor)
        As
  Begin
      if upper(pextra2)='D' then
        open p_accounts for
        select cir_agmast_dis.*,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME",
        cir_get_agency(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.agcd,cir_agmast_dis.dpcd) "BILL_AGENCY",
        cir_get_agency_city(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.agcd,cir_agmast_dis.dpcd) "BILL_AGENCY_CITY",
        cir_get_drop_point_name(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.station_code,1) as "DROP_POINT_NAME" from cir_agmast_dis
            where comp_code = pcompcode and unit = punit and(dist_code =pdistcode or pdistcode is null) and 
            ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) /*and nvl(freeze_flag,'N')='N'*/
        union
        select cir_agmast_dis.*,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME",
        cir_get_agency(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.agcd,cir_agmast_dis.dpcd) "BILL_AGENCY",
        cir_get_agency_city(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.agcd,cir_agmast_dis.dpcd) "BILL_AGENCY_CITY",
        cir_get_drop_point_name(cir_agmast_dis.comp_code,cir_agmast_dis.unit,cir_agmast_dis.station_code,1) as "DROP_POINT_NAME" from cir_agmast_dis
            where comp_code = pcompcode and unit = punit and(dist_code =pdistcode or pdistcode is null) and 
            ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null)) /*and nvl(freeze_flag,'N')='N'*/    
        order by 5;
      else
        open p_accounts for
        select cir_agmast.*,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME",
        cir_get_agency(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.agcd,cir_agmast.dpcd) "BILL_AGENCY",
        cir_get_agency_city(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.agcd,cir_agmast.dpcd) "BILL_AGENCY_CITY",
        cir_get_drop_point_name(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.station_code,1) as "DROP_POINT_NAME" from cir_agmast
          where comp_code = pcompcode and unit = punit and (dist_code =pdistcode or pdistcode is null) and 
                    ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) 
            /*and  nvl(freeze_flag,'N')='N'*/
        union
        select cir_agmast.*,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME",
        cir_get_agency(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.agcd,cir_agmast.dpcd) "BILL_AGENCY",
        cir_get_agency_city(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.agcd,cir_agmast.dpcd) "BILL_AGENCY_CITY",
        cir_get_drop_point_name(cir_agmast.comp_code,cir_agmast.unit,cir_agmast.station_code,1) as "DROP_POINT_NAME" from cir_agmast
          where comp_code = pcompcode and unit = punit and(dist_code =pdistcode or pdistcode is null) and 
                ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null)) 
              /*and nvl(freeze_flag,'N')='N'*/      
        order by 5;
      end if;
  End cir_agency_bind_p;
  procedure cir_branch_billagency_p (
        pcompcode         in varchar2,
        punit             in varchar2,
        pbranchcode     in varchar2,
        pdateformat     in varchar2,
        pextra1         in varchar2,
        pextra2         in varchar2,
        pdistcode       in varchar2,
        p_accounts         out t_accounts_cursor)
        As
  Begin
      if upper(pextra2)='D' then
          open p_accounts for
            select cir_agmast_dis.* ,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
              where comp_code = pcompcode and
                        unit = punit and
                        (branch_code=pbranchcode or pbranchcode is null) and(dist_code =pdistcode or pdistcode is null) and 
                        ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and
                  nvl(freeze_flag,'N')='N'
            union
            select cir_agmast_dis.* ,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
              where comp_code = pcompcode and
                        unit = punit and
                        (branch_code=pbranchcode or pbranchcode is null) and(dist_code =pdistcode or pdistcode is null) and 
                        ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null)) and
                  nvl(freeze_flag,'N')='N'      
            order by 5;
       else
          open p_accounts for
            select cir_agmast.* ,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
              where comp_code = pcompcode and
                        unit = punit and
                        (branch_code=pbranchcode or pbranchcode is null) and(dist_code =pdistcode or pdistcode is null) and 
                        ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and
                  nvl(freeze_flag,'N')='N'
            union
            select cir_agmast.* ,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
              where comp_code = pcompcode and
                        unit = punit and
                        (branch_code=pbranchcode or pbranchcode is null) and(dist_code =pdistcode or pdistcode is null) and 
                        ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null)) and
                  nvl(freeze_flag,'N')='N'      
            order by 5;
       end if;
  End cir_branch_billagency_p;
procedure cir_agency_bind_pd (
    pcompcode   in varchar2,
    punit       in varchar2,
    pname       in varchar2,
    pdateformat in varchar2,
    -- pextra1 in varchar2,
    pextra2     in varchar2,
    p_accounts  out t_accounts_cursor) as
  Begin
      open p_accounts for
        select * from cir_agmast
           where comp_code = pcompcode and
                 unit = punit and
              ((upper(ag_name)=upper(pname)) or (upper(ag_name) like upper(pname||'%'))) and
              nvl(freeze_flag,'N')='N'
        union
        select * from cir_agmast
           where comp_code = pcompcode and
                 unit = punit and
              ((upper(agcd)=upper(pname)) or (upper(ag_name) like upper(pname||'%'))) and
              nvl(freeze_flag,'N')='N'      
         order by 5;
  End cir_agency_bind_pd;
procedure cir_agency_bind_p (
    pcompcode       in varchar2,
    punit           in varchar2,
    pagcd           in varchar2,
    pdpcd           in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts_cursor) as
Begin
    if upper(pextra2)='D' then
        open p_accounts for
            select * from cir_agmast_dis
             where comp_code = pcompcode and
                   unit = punit and
                   agcd=pagcd and
                   dpcd=pdpcd and
                   nvl(freeze_flag,'N')='N'
             order by ag_name;
     else
        open p_accounts for
            select * from cir_agmast
             where comp_code = pcompcode and
                   unit = punit and
                   agcd=pagcd and
                   dpcd=pdpcd and
                   nvl(freeze_flag,'N')='N'
             order by ag_name;
     end if;
End cir_agency_bind_p;
procedure cir_agency_listing_p (--Agency Master Listing
    pcompcode       in varchar2,
    punit           in varchar2,
    pagty           in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts_cursor) as
Begin
    open p_accounts for
    select A.COMP_CODE,A.UNIT,A.BRANCH_CODE,C."Branch_Name" BRANCH_NAME, A.AGCD,A.DPCD,A.AG_NAME,A.AG_NAME_OTH_LANG,
        A.AG_CLASS,(SELECT CLASS_DESC FROM CIR_AGENCY_CLASS_MAST WHERE CIR_AGENCY_CLASS_MAST.COMP_CODE=A.COMP_CODE AND CIR_AGENCY_CLASS_MAST.CLASS_CODE=A.AG_CLASS) AG_CLASS_NAME,
        A.AG_TYPE,CIR_GET_AGENCY_TYPE(A.COMP_CODE,A.AG_TYPE) AG_TYPE_NAME, A.SUPPLY_START_DT,
        A.ADDR1, A.ADDR2, A.ADDR3,A.PIN_CODE, A.CITY_CODE,CIR_GET_CITY(A.COMP_CODE,A.CITY_CODE) CITY_NAME, A.DIST_CODE,CIR_GET_DIST(A.COMP_CODE,A.STATE_CODE,A.DIST_CODE) DIST_NAME,
        A.STATE_CODE,CIR_GET_STATE(A.COMP_CODE,A.COUNTRY_CODE,A.STATE_CODE) STATE_NAME, A.TEHSIL_TALUKA TALUKA_CODE,CIR_GET_TALUKA(A.COMP_CODE,A.TEHSIL_TALUKA) TALUKA_NAME, 
        A.STATION_CODE,CIR_GET_DROP_POINT_NAME(A.COMP_CODE,A.UNIT,A.STATION_CODE,1) DROP_POINT_NAME,
        A.AREA_CODE,CIR_GET_AREA(A.COMP_CODE,A.AREA_CODE) AREA_NAME, A.PHONE_NO1, A.PHONE_NO2, A.MOBILE_NO1, A.MOBILE_NO2,A.FAX_NO, A.EMAIL_ID, A.SUSPEND, A.SUSPEND_TYPE, A.SUSPEND_DATE, 
        A.TO_BILL, A.BILL_AGCD, A.BILL_DPCD,CIR_GET_AGENCY(A.COMP_CODE,A.UNIT,A.BILL_AGCD,A.BILL_DPCD) BILL_AGENCY, A.PAYMODE, A.CREDIT_DAYS, A.PRINT_LABEL, A.PIN_PACKET, 
        A.PIN_AGCD, A.PIN_DPCD,CIR_GET_AGENCY(A.COMP_CODE,A.UNIT,A.PIN_AGCD,A.PIN_DPCD) PIN_AGENCY, A.PIN_OPEN_INSIDE,
        A.NAME_ON_LABEL, A.PRINT_SEQ,CASE WHEN A.UNSOLD_VALID_FLAG='D' THEN 'Daily' WHEN A.UNSOLD_VALID_FLAG='W' THEN 'Weekly' ELSE 'Monthly' END BILL_CYCLE, 
        A.SECURITY_PER, A.SEC_AMT_LIMT, A.SUPPLY_STOP_FLAG, A.SUPPLY_STOP_PER, A.ABC_CITYCODE,CIR_GET_CITY(A.COMP_CODE,A.ABC_CITYCODE) ABC_CITY_NAME,
        B.NAME CON_PER_NAME,B.DESIG CON_PER_DESIG,B.PER_ROLE CON_PER_PER_ROLE,B.DATE_OF_BIRTH DATE_OF_BIRTH, B.PHONE_NO1 CON_PER_PHONE_NO1, B.PHONE_NO2 CON_PER_PHONE_NO2, 
        B.MOBILE_NO1 CON_PER_MOBILE_NO1, B.MOBILE_NO2 CON_PER_MOBILE_NO2, B.FAX_NO CON_PER_FAX_NO, B.EMAIL_ID CON_PER_EMAIL_ID
    from cir_agmast a,cir_ag_con_per b,branch_mst c
        where a.comp_code=b.comp_code(+) and a.comp_code = pcompcode and a.unit=b.unit(+) and (a.unit = punit or punit is null) and 
        a.agcd=b.agcd(+) and a.dpcd=b.dpcd(+) and a.branch_code=c."Branch_Code" and (ag_type = pagty or pagty is null)
    order by a.comp_code,a.unit,a.ag_name, b.name;
End cir_agency_listing_p;
procedure cir_agency_area_p (
    pcompcode       in varchar2,
    punit           in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    p_accounts      out t_accounts_cursor) as
Begin
    if upper(pextra2)='D' then
        open p_accounts for
            select cir_agmast_dis.*,cir_get_area(cir_agmast_dis.comp_code,cir_agmast_dis.area_code) "AREA_NAME",cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
                where comp_code = pcompcode and
                        unit      = punit and
                        ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null))
            union            
            select cir_agmast_dis.*,cir_get_area(cir_agmast_dis.comp_code,cir_agmast_dis.area_code) "AREA_NAME",cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
                where comp_code = pcompcode and
                        unit      = punit and
                        ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null))                        
                           order by 7,5;
    else
        open p_accounts for
            select cir_agmast.*,cir_get_area(cir_agmast.comp_code,cir_agmast.area_code) "AREA_NAME",cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
                where comp_code = pcompcode and
                          unit      = punit and
                        ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null))
            union
            select cir_agmast.*,cir_get_area(cir_agmast.comp_code,cir_agmast.area_code) "AREA_NAME",cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
                where comp_code = pcompcode and
                          unit      = punit and
                        ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null))            
                           order by 7,5;
    end if;
End cir_agency_area_p;
procedure cir_agency_extraLabel_p(
    pcompcode     in varchar2,
    punit         in varchar2,
    pdateformat   in varchar2,
    pextra1       in varchar2,
    pextra2       in varchar2,
    p_accounts    out t_accounts_cursor) as
Begin
    open p_accounts for
    select cir_agmast.*,cir_get_area(cir_agmast.comp_code,cir_agmast.area_code) "AREA_NAME",cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
        where comp_code = pcompcode and
              unit      = punit and
              (PRINT_LABEL= 'N' or PRINT_LABEL is null ) and
              (SUSPEND_TYPE='N' or SUSPEND_TYPE is null) and
            ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null))
    union
    select cir_agmast.*,cir_get_area(cir_agmast.comp_code,cir_agmast.area_code) "AREA_NAME",cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
        where comp_code = pcompcode and
              unit      = punit and
              (PRINT_LABEL= 'N' or PRINT_LABEL is null ) and
              (SUSPEND_TYPE='N' or SUSPEND_TYPE is null) and
            ((upper(agcd) like upper(pextra1||'%')) or (pextra1 is null))        
               order by 7,5;
End cir_agency_extraLabel_p;
procedure cir_agency_bind_pgoogle (
    pcompcode   in varchar2,
    punit       in varchar2,
    pagcd       in varchar2,
    pdpcd       in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,    
    p_accounts  out t_accounts_cursor)
As
Begin
      if upper(pextra2)='D' then
        open p_accounts for
        select cir_agmast_dis.*,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
            where comp_code = pcompcode and unit = punit and
            ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and nvl(freeze_flag,'N')='N' AND ROWNUM<=10
        union
        select cir_agmast_dis.*,cir_get_city(cir_agmast_dis.comp_code,cir_agmast_dis.city_code) "CITY_NAME" from cir_agmast_dis
            where comp_code = pcompcode and unit = punit and
            ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and nvl(freeze_flag,'N')='N' AND ROWNUM<=10    
        order by 5;
      else
        open p_accounts for
        select cir_agmast.*,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
          where comp_code = pcompcode and
                    unit = punit and
                    ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and
              nvl(freeze_flag,'N')='N' AND ROWNUM<=10
        union
        select cir_agmast.*,cir_get_city(cir_agmast.comp_code,cir_agmast.city_code) "CITY_NAME" from cir_agmast
          where comp_code = pcompcode and
                    unit = punit and
                    ((upper(ag_name) like upper(pextra1||'%')) or (pextra1 is null)) and
              nvl(freeze_flag,'N')='N' AND ROWNUM<=10              
        order by 5;
      end if;
End cir_agency_bind_pgoogle;
End cir_agency_bind;
/


//-------------------------------end of 6440------------------------//
//////////////////////////update by Garima
CREATE OR REPLACE PACKAGE cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/
//////////////////////////
CREATE OR REPLACE PACKAGE BODY cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt,u.damage damage from 
                   (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt, sum(nvl(b.damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;
  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;
     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;
  End cir_publ_unsold_supply;
    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
    v1 c1%rowtype;
  Begin
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));
        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                order by state_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",case when nvl(sum(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/sum(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER", 
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS", 0 AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",comm_amt as "COPY_RATE", sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",case when nvl(max(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/max(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd,comm_amt order by publ_name,main_edtn_name,edtn_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                comm_amt as "COPY_RATE",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code,comm_amt order by state_name,dist_name,taluka_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
  End cir_monthly_net_paid_sale;
  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.apr_damage),0) damage 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.damage),0) damage  
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;
/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/
    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      v_opbal           number(10):=0;
  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);
            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;
            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            open p_accounts3 for v_query1;
            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            open p_accounts5 for v_query1; 
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        open p_accounts5 for select sysdate from dual; 
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/


/////////////////////////
CREATE OR REPLACE PACKAGE cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/
CREATE OR REPLACE PACKAGE BODY cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt,u.damage damage from 
                   (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt, sum(nvl(b.damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;
  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;
     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;
  End cir_publ_unsold_supply;
    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
    v1 c1%rowtype;
  Begin
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));
        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                order by state_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",case when nvl(sum(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/sum(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER", 
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS", 0 AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",comm_amt as "COPY_RATE", sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",case when nvl(max(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/max(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd,comm_amt order by publ_name,main_edtn_name,edtn_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                comm_amt as "COPY_RATE",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code,comm_amt order by state_name,dist_name,taluka_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
  End cir_monthly_net_paid_sale;
  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.apr_damage),0) damage 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.damage),0) damage  
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;
/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/
    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      v_opbal           number(10):=0;
  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);
            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;
            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            open p_accounts3 for v_query1;
            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            open p_accounts5 for v_query1; 
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        open p_accounts5 for select sysdate from dual; 
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/
///////////////////////////
CREATE OR REPLACE PACKAGE cir_rep_unsold_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     pcity                in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,     
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
  
  procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);

  procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
      procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     
  procedure cir_rep_unsold_slip(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pbrancode             in varchar2,
     pdoctype            in varchar2,
     pdistcode            in varchar2,
     ptalukacode        in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);

  procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type            in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts);

    procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);     
END cir_rep_unsold_supply;
/
CREATE OR REPLACE PACKAGE BODY cir_rep_unsold_supply IS
  procedure cir_rep_unsold_detail(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin  
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
           open p_accounts for
               select u.comp_code comp_code,u.unit_code unit_code,u.doctype doctype,u.recptno recptno,u.recptdt recptdt,
                    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_name city_name,
                    u.supdate supdate,u.supply_copy supply_copy,
                    u.short_recpt short_recpt,u.late_recpt late_recpt,u.bnr bnr,u.unsold unsold,
                    u.copy_rate copy_rate,u.comm_rate comm_rate,u.waste_alw waste_alw,u.waste_rate waste_rate,u.copy_amt copy_amt,
                    u.comm_amt comm_amt,u.waste_amt waste_amt,u.total_amt total_amt,u.damage damage from 
                   (select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='Y'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate
               union
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                    b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                    b.supdate supdate,sum(b.supply_copy) supply_copy,
                    sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                    b.copy_rate copy_rate,b.comm_rate comm_rate,b.waste_alw waste_alw,b.waste_rate waste_rate,
                    sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                    sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt, sum(nvl(b.damage,0)) damage
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code =pcomp_code and 
                     b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code=punit_code and 
                     b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                     a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and b.dpcd=nvl(pdepocode,b.dpcd) and 
                     b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
                     a.city_code=nvl(pcity,a.city_code) and
                     (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and 
                     e.main_edtn=nvl(pmainedtn,e.main_edtn) and upper(nvl(papproved_flag,'N'))='N'
                     group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,
                     a.city_code,b.supdate,b.copy_rate,b.comm_rate,b.waste_alw,b.waste_rate) u 
                     order by u.comp_code,u.unit_code,u.recptdt,u.recptno,u.agname;
  End cir_rep_unsold_detail;
  procedure cir_rep_unsold_summary(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pcity              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
     v_frdt     date;
     v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
       if upper(nvl(papproved_flag,'N'))='Y' then
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                        sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.apr_damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.app_dt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and 
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           ((a.city_code=pcity) or (pcity is null)) and
                           (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                           group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       else
           open p_accounts for
           select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.recptno recptno,b.recptdt recptdt,
                        b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                        sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                        sum(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))*b.copy_rate copy_amt,
                        sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,sum(nvl(b.copy_amt,0)) total_amt,sum(nvl(b.damage,0)) damage  
               from cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =pcomp_code and 
                           b.unit_code=a.unit and b.unit_code=punit_code and 
                           b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                           a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and
                           ((b.dpcd=pdepocode) or (pdepocode is null)) and
                           ((b.publ=ppubl) or (ppubl is null)) and ((b.edtn=pedtn) or (pedtn is null)) and
                           (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                           b.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))
                            group by b.comp_code,b.unit_code,b.doctype,b.recptno,b.recptdt,b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code                           
                           order by b.comp_code,b.unit_code,b.recptdt,b.recptno,city_name,agname;
       end if;    
  End cir_rep_unsold_summary;
   procedure cir_publ_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     pbranchcode        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(8000);
      cursor cur_publ is
          select distinct p.publ publ,p.publ_name publ_name from cir_publ_mast p,cir_agmast a,cir_unsold_dtl b
               where b.comp_code    =a.comp_code and b.comp_code    =p.comp_code and b.comp_code = pcomp_code and 
                    b.unit_code=a.unit and b.unit_code=punit_code and 
                   b.doctype=pdoc_type and b.recptdt between v_frdt and v_todt and 
                   b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and 
                   a.agcd=b.agcd and b.agcd=nvl(pagcode,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdepocode,b.dpcd) and 
                   (a.tehsil_taluka=ptaluka or ptaluka is null) and
                   (a.state_code=pstatecode or pstatecode is null) and (a.dist_code=pdistcode or pdistcode is null) and
                   (a.branch_code=pbranchcode or pbranchcode is null) and
                   (upper(nvl(papproved_flag,'N'))='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0) or
                   (upper(nvl(papproved_flag,'N'))='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0)
                   order by publ;
     v1 cur_publ%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vtot_publ  varchar2(2000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
        --delete from test1;
    open cur_publ;
    loop
        fetch cur_publ into v1;
      exit when cur_publ%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :='decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :='"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :='sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=v1.publ_name;
          else
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||','||''''||v1.publ_name||''''||')"'||v1.publ_name||'",decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_SUPPLY"';
              --vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy))"'||v1.publ||'_Supply"';
              vvar        :=vvar||',decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))"'||v1.publ||'_RETURN"';
              vvar        :=vvar||',round((decode(u.publ,'||''''||v1.publ||''''||',sum(u.return_copy))*100)/decode(u.publ,'||''''||v1.publ||''''||',sum(u.supply_copy)),2)"'||v1.publ||'_RETURN_PER"';
              --vvar1        :=vvar1||',"'||v1.publ_name||'"'||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vvar1        :=vvar1||',sum("'||v1.publ||'_SUPPLY") "'||v1.publ||'_SUPPLY",sum("'||v1.publ||'_RETURN") "'||v1.publ||'_RETURN",sum("'||v1.publ||'_RETURN_PER") "'||v1.publ||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||v1.publ_name;
          end if;    
    end loop;
    close cur_publ;
        --insert into test1(vstring,vstring2) values('unsold var ',vvar);commit;
        --insert into test1(vstring,vstring2) values('unsold var1 ',vvar1);commit;
        --insert into test1(vstring,vstring2) values('unsold vtot_publ ',vtot_publ);commit;
       if vvar is not null and vvar1 is not null then
           If upper(nvl(papproved_flag,'N'))='Y' Then
               v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
               u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and (a.tehsil_taluka='||''''||ptaluka||''''||' or '||''''||ptaluka||''''||' is null) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                                nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name 
                               order by comp_code,unit_code,taluka_name,agname';
                               --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);commit;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;        
               v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
               nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                               group by comp_code,unit_code,taluka_name
                               order by comp_code,unit_code,taluka_name';
                --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);commit;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then
                          p_accounts1:=null;
                  End;  
               v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                               (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ)
                               group by comp_code,unit_code 
                               order by comp_code,unit_code';
               --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);commit;
               --open p_accounts2 for v_query1;
               Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           Else
               if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
                   nvl(cir_get_city(u.comp_code,u.city_code),''NA'') city_name,nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,
                   u.publ publ,cir_get_publ_name(comp_code,publ) publ_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                                            nvl(cir_get_city(u.comp_code,u.city_code),''NA''),nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA''))
                                   group by comp_code,unit_code,agcd,dpcd,agname,agname_oth_lang,city_name,taluka_name                  
                                   order by comp_code,unit_code,taluka_name,agname';
               end if;    
                --insert into test1(vstring,vstring2) values('unsold vquery1 ',v_query1);COMMIT;
               --open p_accounts for v_query1;
               Begin
                  open p_accounts for v_query1;           
                     exception when others then 
                          p_accounts:=null;
                  End;
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,taluka_name,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,
                   nvl(cir_get_taluka(u.comp_code,u.taluka_code),''NA'') taluka_name,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ,cir_get_taluka(u.comp_code,u.taluka_code))
                                   group by comp_code,unit_code,taluka_name
                                   order by comp_code,unit_code,taluka_name';
                   --insert into test1(vstring,vstring2) values('unsold vquery2 ',v_query1);COMMIT;
              end if;
               --open p_accounts1 for v_query1;
               Begin
                  open p_accounts1 for v_query1;           
                     exception when others then 
                          p_accounts1:=null;
                  End; 
                if vvar1 is not null then
                   v_query1:='select comp_code,unit_code,'||vvar1 ||' from (select u.comp_code comp_code,u.unit_code unit_code,'||vvar
                   ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,
                                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                                a.city_code city_code,a.tehsil_taluka taluka_code,
                                (select sum(sup_copy) from cir_dbksup 
                                where comp_code=b.comp_code and unit_code=b.unit_code and 
                                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                       from cir_agmast a,cir_unsold_dtl b
                       where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                                   b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                                   ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                                   a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                                   ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                                   (a.state_code='||''''||pstatecode||''''||' or '||''''||pstatecode||''''||' is null) and (a.dist_code='||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and
                                   (a.branch_code='||''''||pbranchcode||''''||' or '||''''||pbranchcode||''''||' is null) and
                                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                                   b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                                   where u.supply_copy>0
                                   group by u.comp_code,u.unit_code,u.publ)
                                   group by comp_code,unit_code
                                   order by comp_code,unit_code';--,'||vtot_publ;
                   end if;
                --insert into test1(vstring,vstring2) values('unsold vquery3 ',v_query1);COMMIT;
              --open p_accounts2 for v_query1;
              Begin
                  open p_accounts2 for v_query1;           
                     exception when others then 
                          p_accounts2:=null;
                  End;
           End if;
             v_query1:='select '||''''||vtot_publ||''''||' from dual';
             --open p_accounts3 for v_query1;
                    Begin
                  open p_accounts3 for v_query1;           
                     exception when others then 
                          p_accounts3:=null;
                  End;
        End if;
  End cir_publ_unsold_supply;
    procedure cir_edtn_unsold_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag     in varchar2,
     ptaluka            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1  varchar2(32000);
      cursor cur_edtn is
          select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seq_no edtn_seq_no from
          (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
          union
          select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seq_no from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
          where b.comp_code = a.comp_code and b.comp_code = e.comp_code and b.comp_code=pcomp_code and
          b.unit_code = a.unit and b.unit_code = e.unit_code and b.unit_code = punit_code and 
          b.doctype=pdoc_type and b.recptdt>= v_frdt and b.recptdt <= v_todt and 
          b.publ=e.publ and b.publ=nvl(ppubl,e.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
          a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
          b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
          nvl(papproved_flag,'N')='N' and (nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))>0) u
          order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(10000);
     tot_vvar   varchar2(10000);
     vtot_publ  varchar2(8000);
     v_cnt      number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.taluka_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.taluka_code taluka_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.taluka_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.tehsil_taluka taluka_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.tehsil_taluka='||''''||ptaluka||''''||') or ('||''''||ptaluka||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
            open p_accounts3 for v_query1;            
        End if;
  End cir_edtn_unsold_supply;
    procedure cir_edtn_unsold_supply_dist(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn             in varchar2,
     pedtn              in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     papproved_flag        in varchar2,
     pdistcd            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3         out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
       v_query1     varchar2(32000);
      cursor cur_edtn is
        select distinct u.publ publ,u.edtn edtn,u.edtn_name edtn_name,u.edtn_seqno edtn_seq_no from
        (select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='Y' and (nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))>0
        union
        select distinct e.publ publ,e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno 
        from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e 
        where a.comp_code=b.comp_code and b.comp_code=e.comp_code and b.comp_code=pcomp_code and
        a.unit=b.unit_code and b.unit_code=e.unit_code and b.unit_code=punit_code and b.doctype=pdoc_type and 
        b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ=e.publ and b.publ=nvl(ppubl,b.publ) and 
        b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
        b.dpcd=nvl(pdepocode,b.dpcd) and (a.dist_code=pdistcd or pdistcd is null) and
        nvl(papproved_flag,'N')='N' and (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
        order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(10000);
     tot_vvar varchar2(10000);
     vtot_publ varchar2(8000);
     v_cnt     number:=0;
  Begin
       v_frdt:=to_date(pfromdate,''''||pdateformat||'''');
       v_todt:=to_date(ptilldate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar        :='decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=rec_edtn.edtn_name;
          else
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy))"'||rec_edtn.edtn||'_SUPPLY"';
              vvar        :=vvar||',decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_RETURN"';
              vvar        :=vvar||',round((decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.return_copy))*100)/decode(u.edtn,'||''''||rec_edtn.edtn||''''||',sum(u.supply_copy)),2)"'||rec_edtn.edtn||'_RETURN_PER"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_SUPPLY") "'||rec_edtn.edtn||'_SUPPLY"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN") "'||rec_edtn.edtn||'_RETURN"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_RETURN_PER") "'||rec_edtn.edtn||'_RETURN_PER"';
              vtot_publ:=vtot_publ||''''||','||''''||rec_edtn.edtn_name;
          end if;    
    end loop;
    close cur_edtn;
        --delete test1;
        --insert into test1(vstring,vstring2) values('unsold edtn vvar ',vvar);COMMIT;
        --insert into test1(vstring,vstring2) values('unsold edtn TOT_vvar ',tot_vvar);COMMIT;
        if vvar is not null then
           If nvl(papproved_flag,'N')='Y' Then
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts ',v_query1);COMMIT;
               open p_accounts for v_query1;           
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                            agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
                open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           Else
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
               nvl(cir_get_city(c.comp_code,c.city_code),''NA'') city_name,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                               u.city_code,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,nvl(cir_get_city(c.comp_code,c.city_code),''NA''),
                               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA''),c.agname';
                    --insert into test1(vstring,vstring2) values('unsold edtn p_accounts',v_query1);COMMIT;
               open p_accounts for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
               nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'') dist_name '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,
               u.state_code state_code,u.dist_code dist_code,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.state_code,u.dist_code) c
                               group by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')
                               order by c.comp_code,c.unit_code,nvl(cir_get_dist(c.comp_code,c.state_code,c.dist_code),''NA'')';
               --insert into test1(vstring,vstring2) values('unsold edtn p_accounts1 ',v_query1);COMMIT;
               open p_accounts1 for v_query1;
               v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
               from
               (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,'||vvar
               ||'    from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,b.edtn edtn,
                            b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                            a.city_code city_code,a.state_code state_code,a.dist_code dist_code,
                            (select sum(sup_copy) from cir_dbksup 
                            where comp_code=b.comp_code and unit_code=b.unit_code and 
                                        agcd=b.agcd and dpcd=b.dpcd and publ=b.publ and supdate=b.supdate) supply_copy,
                            nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
                   from cir_agmast a,cir_unsold_dtl b
                   where b.comp_code    =a.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                               b.unit_code=a.unit and b.unit_code='||''''||punit_code||''''||' and 
                               b.doctype='||''''||pdoc_type||''''||' and b.recptdt between '||''''||v_frdt||''''||' and '||''''||v_todt||''''||' and 
                               ((b.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and 
                               ((b.edtn='||''''||pedtn||''''||') or ('||''''||pedtn||''''||' is null)) and 
                               a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd='||''''||pagcode||''''||') or ('||''''||pagcode||''''||' is null)) and 
                               ((b.dpcd='||''''||pdepocode||''''||') or ('||''''||pdepocode||''''||' is null)) and ((a.dist_code='||''''||pdistcd||''''||') or ('||''''||pdistcd||''''||' is null)) and
                               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0 and
                               b.edtn in(select distinct edtn from cir_edtn_mast where comp_code='||''''||pcomp_code||''''||' and (edtn = '||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))) u
                               where u.supply_copy>0
                               group by u.comp_code,u.unit_code,u.publ,u.edtn,cir_get_edtn_name(u.comp_code,u.edtn))c
                               group by c.comp_code,c.unit_code
                               order by c.comp_code,c.unit_code';
                --insert into test1(vstring,vstring2) values('unsold edtn p_accounts2 ',v_query1);COMMIT;
               open p_accounts2 for v_query1;
           End if;
                 v_query1:='select '||''''||vtot_publ||''''||' from dual';
                 open p_accounts3 for v_query1;
        Else
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn vquery p_accounts',v_query1);COMMIT;
            open p_accounts for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts1 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
            v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
            --insert into test1(vstring,vstring2) values('unsold else edtn p_accounts2 ',v_query1);COMMIT;
            open p_accounts2 for v_query1;
                 v_query1:='select null from dual';
             open p_accounts3 for v_query1;
        End if;
  End cir_edtn_unsold_supply_dist;  
procedure cir_monthly_net_paid_sale(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfromdate          in varchar2,
     ptilldate          in varchar2,
     pagency_type       in varchar2,
     pagency_class      in varchar2,
     pstatecode         in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pbranch            in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     preptype           in number,--1 for Agency Wise,2 for Main Edition wise,3 for District Taluka wise
     pbreak_on          in varchar2,--Region R/State S/District D/Branch B
     preturn_based      in varchar2,--it is use for return date or supply date(R/S)
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts)
  As
     v_frdt    date;
     v_todt    date;
     v_reg_code varchar2(200);
     v_avg_sale number(10);
cursor c1 is
    select u.comp_code,u.unit_code,
    u.branch_code branch_code,(select distinct "Branch_Name" from branch_mst where "Branch_Code"=u.branch_code) branch_name,
    u.publ,u.publ_name,u.main_edtn,
    cir_get_edtn_name(u.comp_code,u.main_edtn) main_edtn_name,u.edtn edtn,u.edtn_name,u.copy_rate,
    u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,
    u.state_code,cir_get_state(u.comp_code,u.country_code,u.state_code) state_name,
    u.dist_code ,cir_get_name.cir_district(u.comp_code,u.dist_code,plangtype,null,null,null) dist_name,
    u.city_code city_code,cir_get_name.cir_city(u.comp_code,u.city_code,plangtype,null,null,null) city_name,
    u.tehsil_taluka,cir_get_name.cir_taluka(u.comp_code,u.tehsil_taluka,plangtype,null,null,null) taluka_name,
    sum(supply_copy) supply_copy,sum(return_copy) return_copy,
    sum(supply_copy)-sum(return_copy) net_sale_copy,sum(no_of_days) no_of_days
    from (
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    sum(nvl(b.sup_copy,0)) supply_copy,0 return_copy, count(distinct supdate) no_of_days
    from cir_agmast a,cir_dbksup b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and 
    b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and
    b.supdate >= v_frdt and b.supdate <=v_todt and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.sup_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka
    union all
    select b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
    a.branch_code,a.city_code,a.dist_code, a.state_code,a.country_code,a.tehsil_taluka, 
    0 supply_copy,sum(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0)) return_copy,0 no_of_days
    from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e,cir_publ_mast p
    where b.comp_code =a.comp_code and b.comp_code=e.comp_code and b.comp_code=p.comp_code and b.comp_code =pcomp_code and 
    b.unit_code=a.unit and b.unit_code=punit_code and 
    b.doctype='UCN' and b.recptdt >= v_frdt and b.recptdt <=v_todt and 
    b.publ=e.publ and b.publ=p.publ and b.publ=nvl(ppubl,b.publ) and b.edtn=e.edtn and b.edtn=nvl(pedtn,b.edtn) and 
    a.agcd=b.agcd and b.agcd=nvl(pagcd,b.agcd) and a.dpcd=b.dpcd and b.dpcd=nvl(pdpcd,b.dpcd) and 
    (a.ag_type=pagency_type or pagency_type is null) and(a.ag_class=pagency_class or pagency_class is null) and
    (a.branch_code=pbranch or pbranch is null) and (a.state_code=pstatecode or pstatecode is null) and
    (a.dist_code=pdistcode or pdistcode is null) and (a.tehsil_taluka=ptaluka or ptaluka is null) and
    (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0 and
    (e.main_edtn=pmainedtn or pmainedtn is null)
    group by b.comp_code,b.unit_code,b.publ,p.publ_name,e.main_edtn,b.edtn,e.edtn_name,b.copy_rate,
    b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.branch_code,a.city_code,a.dist_code, a.state_code,
    a.country_code,a.tehsil_taluka) u
    where (u.supply_copy+u.return_copy)>0
    group by u.comp_code,u.unit_code,
    u.branch_code,u.publ,u.publ_name,u.main_edtn,u.edtn,u.edtn_name,u.copy_rate,
    u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
    u.state_code,u.dist_code ,u.city_code,u.tehsil_taluka,u.country_code;
    v1 c1%rowtype;
  Begin
        v_frdt         :=to_date(pfromdate,''''||pdateformat||'''');
        v_todt         :=to_date(ptilldate,''''||pdateformat||'''');
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
        open c1;
        loop
            fetch c1 into v1;
            exit when c1%notfound;
            /*select count(*) into v_hdays from cir_holiday_mast 
                where comp_code=v1.comp_code and unit=v1.unit_code and (h_publ=ppubl or ppubl is null) and 
                    trunc(h_date,'mm')=v1.mon;*/
            if nvl(v1.no_of_days,0)>0 then
                v_avg_sale:=round(nvl(v1.net_sale_copy,0)/(nvl(v1.no_of_days,0)));
            else
                v_avg_sale:=nvl(v1.net_sale_copy,0);
            end if;
            begin
                select distinct region_code into v_reg_code from cir_city_mast where comp_code=v1.comp_code and city_code=v1.city_code;
            exception when others then
             v_reg_code:=null;
            end;
            v_reg_code:=cir_get_region_name(v1.comp_code,v_reg_code); 
            insert into cir_temp_bill_collection
            (comp_code, unit_code, billno, publ_code, agcd, dpcd,agname,agname_oth_lang, city_code, 
            taluka_code, dist_code, state_code, remarks,supply_copy, return_copy ,comm_amt,gross_amt,cur_sessionid)
            values(v1.comp_code,v1.unit_code,v1.branch_name,v1.publ_name,v1.main_edtn_name,v1.edtn_name,v1.agname,v1.agname_oth_lang,v1.city_name,
            v1.taluka_name,v1.dist_name,v1.state_name,v_reg_code,v1.supply_copy,v1.return_copy,v1.copy_rate,v1.no_of_days,userenv('sessionid'));
        end loop;
        close c1;
        commit;
        if preptype=1 then
            if pbreak_on='R' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                remarks AS "REGION_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by remarks,agname,city_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                remarks AS "REGION_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,remarks order by region_name;            
            elsif pbreak_on='S' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                order by state_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS",case when nvl(sum(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/sum(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code order by state_name;                
            elsif pbreak_on='D' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by state_name,dist_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER", 
                0 AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
            elsif pbreak_on='B' then
                open p_accounts for
                select comp_code AS "COMP_CODE", unit_code AS "UNIT",agname AS "AGNAME",agname_oth_lang AS "AGNAME_OTH_LANG",city_code as "CITY_NAME", 
                billno AS "BRANCH_NAME",comm_amt as "COPY_RATE",supply_copy AS "SUPPLY_COPY", return_copy AS "RETURN_COPY" ,(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(supply_copy,0)>0 then round((return_copy/supply_copy)*100,2) else 0 end as "NET_PER",
                gross_amt AS "NO_OF_DAYS",case when nvl(gross_amt,0)>0 then round((supply_copy-return_copy)/gross_amt) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') order by branch_name,agname,city_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  
                billno AS "BRANCH_NAME",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                0 AS "NO_OF_DAYS", 0 AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,billno order by branch_name;                
            end if;
        elsif preptype=2 then--for edition wise
                open p_accounts for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",dpcd AS "EDTN_NAME",comm_amt as "COPY_RATE", sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",case when nvl(max(gross_amt),0)>0 then round(sum(supply_copy-return_copy)/max(gross_amt)) else 0 end AS "AVG_NET_SALE"
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd,dpcd,comm_amt order by publ_name,main_edtn_name,edtn_name,copy_rate;
                open p_accounts1 for
                select comp_code AS "COMP_CODE",  publ_code AS "PUBL_NAME",agcd AS "MAIN_EDTN_NAME",sum(supply_copy) AS "SUPPLY_COPY", 
                sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') group by comp_code,publ_code,agcd order by publ_name,main_edtn_name;
        else
                open p_accounts for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",taluka_code AS "TALUKA_NAME",
                comm_amt as "COPY_RATE",sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code,taluka_code,comm_amt order by state_name,dist_name,taluka_name,comm_amt;
                open p_accounts1 for
                select comp_code AS "COMP_CODE", 
                state_code AS "STATE_NAME",dist_code AS "DIST_NAME",
                sum(supply_copy) AS "SUPPLY_COPY", sum(return_copy) AS "RETURN_COPY" ,sum(supply_copy-return_copy) AS "NET_SALE",
                case when nvl(sum(supply_copy),0)>0 then round((sum(return_copy)/sum(supply_copy))*100,2) else 0 end as "NET_PER",
                max(gross_amt) AS "NO_OF_DAYS",0 AS "AVG_NET_SALE" 
                from cir_temp_bill_collection where cur_sessionid=userenv('sessionid') 
                group by comp_code,state_code,dist_code order by state_name,dist_name;
        end if;
        --open p_accounts1 for select sysdate as "CUR_DATE" from dual;
        open p_accounts2 for select sysdate as "CUR_DATE" from dual;
        open p_accounts3 for select sysdate as "CUR_DATE" from dual;
        delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
  End cir_monthly_net_paid_sale;
  procedure cir_rep_unsold_slip(
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pbrancode       in varchar2,
    pdoctype        in varchar2,
    pdistcode       in varchar2,
    ptalukacode     in varchar2,
    pagcode         in varchar2,
    pagsubcode      in varchar2,
    pfrom_recdate   in varchar2,
    ptill_recdate   in varchar2,
    papproved_flag  in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,--Blank for Agency and 'D' for Distribution
    p_accounts      out t_accounts)
  As
       v_frdt    date;
       v_todt    date;
  Begin
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
        if upper(nvl(papproved_flag,'N'))='Y' then
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.apr_damage),0) damage 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,
                      b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.apr_short_recpt) short_recpt,sum(b.apr_late_recpt) late_recpt,sum(b.apr_bnr) bnr,sum(b.apr_unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0))) gross_amt,
                      sum(b.comm_amt) comm_amt,sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0)net_amt,nvl(sum(b.damage),0) damage  
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;            
        else
            if pextra2='D' then
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_unsold_hdr_dis h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;
            else
               open p_accounts for
               select b.comp_code comp_code,b.unit_code unit_code,b.doctype doctype,b.publ publ,cir_get_name.cir_publ(b.comp_code,b.publ,'1','dd/mm/yyyy','','') publ_name,
                      b.edtn edtn,cir_get_name.cir_edtn(b.comp_code,b.unit_code,b.edtn,'1','dd/mm/yyyy','','') edtn_name,b.recptno recptno,b.recptdt recptdt,
                      b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,cir_get_city(b.comp_code,a.city_code) city_name,
                      b.copy_rate copy_rate,h.frdt frdt,h.todt todt,
                      sum(b.short_recpt) short_recpt,sum(b.late_recpt) late_recpt,sum(b.bnr) bnr,sum(b.unsold) unsold,
                      sum(nvl(b.copy_rate,0)*(nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0))) gross_amt,sum(b.comm_amt) comm_amt,
                      sum(b.waste_amt) waste_amt,nvl(sum(b.copy_amt),0) amount,
                      nvl(sum(b.copy_amt),0)-nvl(sum(b.waste_amt),0) net_amt 
                   from cir_agmast a,cir_unsold_dtl b,cir_unsold_hdr h
                   where b.comp_code =a.comp_code and b.comp_code =pcompcode and b.comp_code =h.comp_code and 
                        b.unit_code=a.unit and b.unit_code=h.unit_code and b.unit_code=punitcode and 
                        b.doctype=pdoctype and b.doctype=h.doctype and b.recptdt between v_frdt and v_todt and
                        b.recptno=h.recptno and a.agcd=b.agcd and a.dpcd=b.dpcd and ((b.agcd=pagcode) or (pagcode is null)) and 
                        ((b.dpcd=pagsubcode) or (pagsubcode is null)) and ((a.dist_code=pdistcode) or (pdistcode is null)) and
                        ((a.tehsil_taluka=ptalukacode) or (ptalukacode is null)) and a.branch_code=nvl(pbrancode,a.branch_code) and
                        (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0
                        group by b.comp_code,b.unit_code,b.doctype,b.publ,b.edtn,b.recptno,b.recptdt,h.frdt,h.todt,
                                 b.agcd,b.dpcd,a.ag_name,a.ag_name_oth_lang,a.city_code,b.copy_rate 
                        order by b.agcd,b.dpcd,b.recptdt,b.recptno,b.publ,b.edtn;            
            end if;             
       end if;
  End cir_rep_unsold_slip;
/*
var v1 refcursor;
var v2 refcursor;
var v3 refcursor;
var v4 refcursor;
var v5 refcursor;
var v6 refcursor;
exec cir_rep_unsold_supply.cir_unsold_return_punya('SP002','AUR','','UCN','','','','','','','','01-jun-2010','30-sep-2010','N','1','dd/mm/yyyy','','',:v1,:v2,:v3,:v4,:v5,:v6);
*/
    procedure cir_unsold_return_punya(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pbran_code         in varchar2,
     pdoc_type          in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pcitycode          in varchar2,
     pagcode            in varchar2,
     pdepocode          in varchar2,
     pfrom_recdate      in varchar2,
     ptill_recdate      in varchar2,
     papproved_flag     in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts5        out t_accounts,
     p_accounts6        out t_accounts)
   As
    v_frdt     date;
    v_todt    date;
    v_query1  varchar2(32000); 
       cursor cur_edtn is
           select distinct u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.main_edtn edtn,u.copy_rate copy_rate,
            cir_get_edtn_seqno(u.comp_code,u.main_edtn) edtn_seqno from
         (select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_branch_return_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,c.publ publ,c.main_edtn main_edtn,b.copy_rate copy_rate 
         from cir_agmast_dis a,cir_unsold_dtl_dis b,cir_edtn_mast c
         where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
         b.unit_code = a.unit and b.unit_code = punit_code and 
         b.doctype=pdoc_type and b.recptdt <=v_todt and 
         b.publ=nvl(ppubl,b.publ) and c.main_edtn=nvl(pmainedtn,c.main_edtn) and
         b.publ=c.publ and b.edtn=c.edtn and     
         a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
         b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_agmast a,cir_return_sale_det b,cir_edtn_mast c 
         where a.comp_code=b.comp_code and a.comp_code=c.comp_code and b.comp_code = pcomp_code and 
         a.unit=b.unit_code and a.unit=c.unit_code and b.unit_code = punit_code and 
         b.doctype='RET' and b.recptdt >= v_frdt and b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
         (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,c.main_edtn main_edtn,b.edtn_rate copy_rate 
         from cir_physical_ver_det b,cir_edtn_mast c
            where b.comp_code = pcomp_code and 
            b.unit_code=c.unit_code and b.unit_code = punit_code and 
         b.recptdt<=v_todt and b.publ_code=nvl(ppubl,b.publ_code) and 
         c.main_edtn=nvl(pmainedtn,c.main_edtn) and b.publ_code=c.publ and b.edtn_code=c.edtn and     
         b.branch_code=nvl(pbran_code,b.branch_code)
         union
         select distinct b.comp_code comp_code,b.unit_code unit_code,b.publ publ,c.main_edtn main_edtn,b.sup_rate copy_rate 
         from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast c
            where b.comp_code = a.comp_code and b.comp_code = c.comp_code and b.comp_code = pcomp_code and 
                  b.unit_code = a.unit and b.unit_code = punit_code and 
                  b.publ=nvl(ppubl,b.publ) and 
                  c.main_edtn=nvl(pmainedtn,c.main_edtn) and
                  b.publ=c.publ and b.edtn=c.edtn and
                  b.supdate >= v_frdt and b.supdate<=v_todt and 
                  a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl(pagcode,b.agcd) and 
                  b.dpcd=nvl(pdepocode,b.dpcd) and (a.tehsil_taluka=ptalukacode or ptalukacode is null) and
                  (a.dist_code=pdistcode or pdistcode is null) and a.city_code=nvl(pcitycode,a.city_code) and
                  b.resale_branch=nvl(pbran_code,b.resale_branch) and
                  nvl(b.sup_copy,0)>0 and nvl(b.return_copy_sale,'N')='Y') u                  
         order by publ,edtn_seqno,edtn,copy_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     tot_vvar   varchar2(8000);
     vtot_publ  varchar2(4000);
     v_cnt      number:=0;
     v_opbal_unsold    number(10):=0;v_op_branch_rec   number(10):=0;v_op_branch_trf   number(10):=0;v_op_sale number(10):=0;
      v_op_resale number(10):=0;v_op_comp_ret number(10):=0;v_op_short_excess number(10):=0;
      v_opbal           number(10):=0;
  Begin
       --insert into aaa_test values (pcomp_code||'-'||punit_code ||'-'||pbran_code||'-'||pdoc_type||'-'||ppubl||'-'||pmainedtn||'-'||pdistcode||'-'||ptalukacode||'-'||pcitycode||'-'||pagcode||'-'||pdepocode||'-'||pfrom_recdate||'-'||ptill_recdate||'-'||papproved_flag||'-'||plangtype||'-'||pdateformat||'-'||pextra1||'-'||pextra2||'*'||'pcomp_code'||'-'||'punit_code'||'-'||'pbran_code'||'-'||'pdoc_type'||'-'||'ppubl'||'-'||'pmainedtn'||'-'||'pdistcode'||'-'||'ptalukacode'||'-'||'pcitycode'||'-'||'pagcode'||'-'||'pdepocode'||'-'||'pfrom_recdate'||'-'||'ptill_recdate'||'-'||'papproved_flag'||'-'||'plangtype'||'-'||'pdateformat'||'-'||'pextra1'||'-'||'pextra2');commit;
       --delete from test1;
       delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');
       v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
       v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
          v_cnt :=nvl(v_cnt,0)+1;
          if vvar is null then
              vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          else
              vvar    :=vvar||',decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
              tot_vvar:=tot_vvar||',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
          end if;    
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_opbal_unsold 
            from cir_unsold_dtl a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_rec from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='TI' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and 
                a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(a.edtn_copy),0) into v_op_branch_trf from cir_branch_return_det a,cir_edtn_mast b 
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='TRF' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.no_of_copy,0)),0) into v_op_sale from cir_return_sale_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
                a.doctype='RET' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (branch_code=pbran_code or pbran_code is null);
            select nvl(sum(nvl(a.apr_short_recpt,0)+nvl(a.apr_late_recpt,0)+nvl(a.apr_bnr,0)+nvl(a.apr_unsold,0)),0) into v_op_comp_ret
            from cir_unsold_dtl_dis a,cir_edtn_mast b 
            where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and 
            a.doctype='UCN' and a.recptdt<v_frdt and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
            a.copy_rate=rec_edtn.copy_rate and a.branch_code=NVL(pbran_code,a.branch_code);
            select nvl(sum(a.sup_copy),0) into v_op_resale from cir_dbksup_resale a,cir_edtn_mast b,cir_agmast c
                where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=c.unit and a.unit_code=punit_code and 
                a.agcd=c.agcd and a.dpcd=c.dpcd and a.publ=b.publ and a.publ=rec_edtn.publ and a.edtn=b.edtn and b.main_edtn=rec_edtn.edtn and
                      supdate<v_todt and sup_rate=rec_edtn.copy_rate and nvl(return_copy_sale,'N')='Y' and (a.resale_branch=pbran_code or pbran_code is null); 
            select nvl(sum(nvl(a.short_excess,1)*nvl(a.no_of_copy,0)),0) into v_op_short_excess from cir_physical_ver_det a,cir_edtn_mast b
                where a.comp_code=b.comp_code and a.comp_code=pcomp_code and a.unit_code=b.unit_code and a.unit_code=punit_code and a.doctype='VR' and a.recptdt<v_frdt and
                a.publ_code=b.publ and a.publ_code=rec_edtn.publ and a.edtn_code=b.edtn and b.main_edtn=rec_edtn.edtn and a.edtn_rate=rec_edtn.copy_rate and (a.branch_code=pbran_code or pbran_code is null);
            /*-------for opening balance ----------*/
            v_opbal:=nvl(v_opbal_unsold,0)+nvl(v_op_branch_rec,0)-nvl(v_op_comp_ret,0)-nvl(v_op_branch_trf,0)-nvl(v_op_sale,0)-nvl(v_op_resale,0)+nvl(v_op_short_excess,0);
            insert into cir_temp_unsold_stock(comp_code,unit_code,branch_code,publ_code,edtn_code,ason_dt,copy_rate,
                    opbal,sess_id)
                    values(pcomp_code,punit_code,pbran_code,rec_edtn.publ,rec_edtn.edtn,v_todt,rec_edtn.copy_rate,v_opbal,userenv('sessionid'));
    end loop;
    close cur_edtn;
    commit;
   -- insert into test1(vstring,vstring2) values(' vvar '||vvar,'tot_vvar '||tot_vvar); --commit;
    if vvar is not null then
       If nvl(papproved_flag,'N')='Y' Then
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
           --insert into test1(vstring,vstring2) values('unsold edtn YY ',v_query1);COMMIT;
           open p_accounts for v_query1;           
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
            open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(apr_short_recpt,0)+nvl(apr_late_recpt,0)+nvl(apr_bnr,0)+nvl(apr_unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       Else
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.agcd agcd,c.dpcd dpcd,c.agname agname,c.agname_oth_lang agname_oth_lang,
           nvl(cir_get_name.cir_city(c.comp_code,c.city_code,'||''||plangtype||''||','''','''',''''),''NA'') city_name,
           nvl(cir_get_name.cir_taluka(c.comp_code,c.taluka_code,'||''||plangtype||''||','''','''',''''),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,
           u.copy_rate copy_rate,u.agcd agcd,u.dpcd dpcd,u.agname agname,u.agname_oth_lang agname_oth_lang,u.city_code city_code,u.taluka_code taluka_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
               b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
               a.city_code city_code,a.tehsil_taluka taluka_code,
               nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
                   b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                   b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
                   (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.agcd,u.dpcd,u.agname,u.agname_oth_lang,
                   u.city_code,u.taluka_code,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.agcd,c.dpcd,c.agname,c.agname_oth_lang,c.city_code,c.taluka_code
                   order by c.comp_code,c.unit_code,taluka_name,c.agname';
                --insert into test1(vstring,vstring2) values('unsold edtn v_query1 ',v_query1);COMMIT;
           open p_accounts for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,
           nvl(cir_get_taluka(c.comp_code,c.taluka_code),''NA'') taluka_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,cir_get_edtn_name(u.comp_code,u.edtn) edtn_name,u.copy_rate copy_rate,
           u.taluka_code taluka_code,'||vvar
           ||'  from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate,u.taluka_code) c
               group by c.comp_code,c.unit_code,c.taluka_code
               order by c.comp_code,c.unit_code,taluka_name';
           --insert into test1(vstring,vstring2) values('unsold edtn v_query2 ',v_query1);COMMIT;
           open p_accounts1 for v_query1;
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                b.agcd agcd,b.dpcd dpcd,a.ag_name agname,a.ag_name_oth_lang agname_oth_lang,
                a.city_code city_code,a.tehsil_taluka taluka_code,
                nvl(b.short_recpt,0)+nvl(b.late_recpt,0)+nvl(b.bnr,0)+nvl(b.unsold,0) return_copy
               from cir_agmast a,cir_unsold_dtl b,cir_edtn_mast e
               where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
               b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
               b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
               a.agcd=b.agcd and a.dpcd=b.dpcd and b.agcd=nvl('||''''||pagcode||''''||',b.agcd) and 
               b.dpcd=nvl('||''''||pdepocode||''''||',b.dpcd) and b.publ=nvl('||''''||ppubl||''''||',b.publ) and
               b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
               (a.tehsil_taluka='||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
               b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code) and
               (nvl(short_recpt,0)+nvl(late_recpt,0)+nvl(bnr,0)+nvl(unsold,0))>0) u
               where u.return_copy>0
               group by u.comp_code,u.unit_code,u.publ,u.edtn,u.copy_rate)c
               group by c.comp_code,c.unit_code
               order by c.comp_code,c.unit_code';
            --insert into test1(vstring,vstring2) values('unsold edtn v_query3 ',v_query1);COMMIT;
           open p_accounts2 for v_query1;
       End if;
            /*Branch Received */
           v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.branch_code branch_code,d."Branch_Name" branch_name'||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.branch_code branch_code,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               b.oth_branch_code branch_code,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TI'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)) u
                   where u.return_copy>0
                   group by u.comp_code,u.unit_code,u.publ,u.edtn,u.branch_code,u.copy_rate) c,branch_mst d
                   where c.branch_code=d."Branch_Code"
                   group by c.comp_code,c.unit_code,c.branch_code,d."Branch_Name"
                   order by c.comp_code,c.unit_code,c.branch_code, branch_name';
            --insert into test1(vstring,vstring2) values('unsold edtn branch received v_query4 ',v_query1);COMMIT;
            open p_accounts3 for v_query1;
            v_query1:='select c.comp_code comp_code,c.unit_code unit_code,c.rec_type rec_type,c.branch_name branch_name '||tot_vvar||'
           from
           (select u.comp_code comp_code,u.unit_code unit_code,u.branch_name branch_name,u.publ publ,u.edtn edtn,u.copy_rate copy_rate,u.rec_type,'||vvar
           ||' from (select b.comp_code comp_code,b.unit_code unit_code,b.branch_code branch_code,f."Branch_Name" branch_name, b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
               1 rec_type,nvl(b.edtn_copy,0) return_copy
               from cir_branch_return_det b,cir_edtn_mast e,branch_mst f
               where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''TRF'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=f."Branch_Code" and b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Company Return'' branch_name,b.publ publ,e.main_edtn edtn,b.copy_rate copy_rate,
                    2 rec_type,nvl(b.apr_short_recpt,0)+nvl(b.apr_late_recpt,0)+nvl(b.apr_bnr,0)+nvl(b.apr_unsold,0) return_copy
                    from cir_unsold_dtl_dis b,cir_edtn_mast e
                    where b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.doctype='||''''||pdoc_type||''''||' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Raddi Sale'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   3 rec_type,nvl(b.no_of_copy,0) return_copy
                   from cir_return_sale_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.doctype=''RET'' and b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Resale Supply'' branch_name,b.publ publ,e.main_edtn edtn,b.sup_rate copy_rate,
                    4 rec_type,nvl(b.sup_copy,0) return_copy
                    from cir_agmast a,cir_dbksup_resale b,cir_edtn_mast e
                    where b.comp_code =a.comp_code and b.comp_code =e.comp_code and b.comp_code ='||''''||pcomp_code||''''||' and 
                    b.unit_code=a.unit and b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                    b.supdate >= '||''''||v_frdt||''''||' and b.supdate<='||''''||v_todt||''''||' and a.agcd=b.agcd and a.dpcd=b.dpcd and
                    b.publ=nvl('||''''||ppubl||''''||',b.publ) and
                    b.publ=e.publ and b.edtn=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                    b.resale_branch=nvl('||''''||pbran_code||''''||',b.resale_branch)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Short\Excess'' branch_name,b.publ_code publ,e.main_edtn edtn,b.edtn_rate copy_rate,
                   5 rec_type,nvl(b.short_excess,1)*nvl(b.no_of_copy,0) return_copy
                   from cir_physical_ver_det b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.comp_code    ='||''''||pcomp_code||''''||' and 
                   b.unit_code=e.unit_code and b.unit_code='||''''||punit_code||''''||' and 
                   b.recptdt >= '||''''||v_frdt||''''||' and b.recptdt<='||''''||v_todt||''''||' and 
                   b.publ_code=nvl('||''''||ppubl||''''||',b.publ_code) and
                   b.publ_code=e.publ and b.edtn_code=e.edtn and e.main_edtn=nvl('||''''||pmainedtn||''''||',e.main_edtn) and
                   b.branch_code=nvl('||''''||pbran_code||''''||',b.branch_code)
                   union all
                   select b.comp_code comp_code,b.unit_code unit_code,NULL branch_code,''Privious Balance'' branch_name,b.publ_code publ,e.main_edtn edtn,b.copy_rate copy_rate,
                   6 rec_type,nvl(b.opbal,0) return_copy
                   from cir_temp_unsold_stock b,cir_edtn_mast e
                   where b.comp_code =e.comp_code and b.unit_code=e.unit_code and  
                   b.publ_code=e.publ and b.edtn_code=e.edtn and sess_id=userenv(''sessionid'')) u
                   where u.return_copy<>0
                   group by u.comp_code,u.unit_code,u.branch_name,u.publ,u.edtn,u.rec_type,u.copy_rate) c
                   group by c.comp_code,c.unit_code,c.rec_type,c.branch_name
                   order by c.comp_code,c.unit_code,c.rec_type,c.branch_name';
             --insert into test1(vstring,vstring2) values('unsold edtn branch comp return v_query5 ',v_query1);COMMIT;
            open p_accounts5 for v_query1; 
            open p_accounts6 for select sysdate from dual;
    Else
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null agcd,null dpcd,null agname,null agname_oth_lang,null city_name,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery ',v_query1);COMMIT;
        open p_accounts for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,null taluka_name,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery2 ',v_query1);COMMIT;
        open p_accounts1 for v_query1;
        v_query1:='select '||''''||pcomp_code||''''||' comp_code,'||''''||punit_code||''''||' unit_code,0 supply_copy,0 return_copy from dual';
        --insert into test1(vstring,vstring2) values('unsold else edtn vquery3 ',v_query1);COMMIT;
        open p_accounts2 for v_query1;
             v_query1:='select null from dual';
        open p_accounts3 for v_query1;    
        open p_accounts5 for select sysdate from dual; 
        open p_accounts6 for select sysdate from dual;         
    End if;
    delete from cir_temp_unsold_stock where sess_id=userenv('sessionid');commit;
   End cir_unsold_return_punya; 
  procedure cir_rep_unsold_challan(
     pcompcode             in varchar2,
     punitcode             in varchar2,
     pdoctype            in varchar2,
     pagcode            in varchar2,
     pagsubcode            in varchar2,
     pfrom_recdate         in varchar2,
     ptill_recdate      in varchar2,
     precptno           in varchar2,
     papproved_flag     in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts)
  As
    v_frdt date;
    v_todt date;
  Begin
    v_frdt:=to_date(pfrom_recdate,''''||pdateformat||'''');
    v_todt:=to_date(ptill_recdate,''''||pdateformat||'''');
    open p_accounts for
    select u.comp_code as comp_code,u.unit_code as unit_code,u.branch_code branch_code,
    u.branch_name branch_name,u.agcd agcd,u.dpcd dpcd,
    u.ag_name AS ag_name,u.recptdt recptdt,u.recptno recptno ,u.publ publ,u.publ_name publ_name, 
    u.main_edtn main_edtn, u.main_edtnname main_edtnname,u.edtn edtn,u.edtn_name edtn_name,
    u.copy_rate copy_rate,
    u.return_copy return_copy 
    from(select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name AS ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast_dis m, cir_unsold_hdr_dis h,cir_unsold_dtl_dis d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and pextra2='D'
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name
    union
    select d.comp_code as comp_code,d.unit_code as unit_code,d.branch_code branch_code,
    get_branch_name(d.branch_code) branch_name,d.agcd agcd,d.dpcd dpcd,
    m.ag_name ag_name,d.recptdt recptdt,d.recptno recptno ,d.publ publ,cir_get_name.cir_publ(d.comp_code,d.publ,1,'','','') publ_name, 
    e.main_edtn main_edtn,cir_get_name.cir_edtn(d.comp_code,d.unit_code,e.main_edtn,1,'','','') main_edtnname,d.edtn edtn,e.edtn_name edtn_name,
    d.copy_rate copy_rate,
    sum(nvl(d.short_recpt,0)+nvl(d.late_recpt,0)+nvl(d.bnr,0)+nvl(d.unsold,0)) return_copy
    from cir_agmast m, cir_unsold_hdr h,cir_unsold_dtl d,cir_edtn_mast e
    where m.comp_code=d.comp_code and d.comp_code=h.comp_code and m.comp_code=e.comp_code and m.comp_code=pcompcode and 
    m.unit=d.unit_code and d.unit_code=h.unit_code and m.unit=e.unit_code and m.unit=punitcode and 
    m.agcd=d.agcd and m.agcd=nvl(pagcode,m.agcd) and m.dpcd=d.dpcd and m.dpcd=nvl(pagsubcode,m.dpcd) and 
    d.doctype=h.doctype and d.doctype=nvl(pdoctype,d.doctype) and d.recptdt=h.recptdt and d.recptdt between v_frdt and v_todt and 
    d.recptno=h.recptno and d.recptno =nvl(precptno,d.recptno) and 
    d.publ=e.publ and d.edtn=e.edtn and (pextra2!='D' or pextra2='' or pextra2 is null)
    group by d.comp_code,d.unit_code,d.agcd,d.dpcd ,m.ag_name,d.recptdt,d.recptno ,d.publ,d.edtn,
    d.copy_rate,e.main_edtn,d.branch_code,e.edtn_name) u
    order by comp_code,unit_code,recptdt,recptno,publ_name,main_edtnname,edtn_name;
  End cir_rep_unsold_challan;     
END cir_rep_unsold_supply;
/

////////////////////////////////////////end by Garima

/////////////////////////////////////////////////////////////////////////////////////////////
CREATE OR REPLACE PACKAGE cir_rep_supply IS
  type t_accounts is ref cursor;
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl                 in varchar2,
     pmainedtn             in varchar2,
     pedtn                 in varchar2,
     proute                in varchar2,
     pfrom_supdate         in varchar2,
     ptill_supdate         in varchar2,
     pdateformat         in varchar2,
     pextra1             in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);
   procedure cir_rep_supply_po(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);
  procedure cir_rep_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
  procedure cir_rep_dist_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
  procedure cir_rep_taluka_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);  
  procedure cir_rep_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
  procedure cir_rep_dist_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);     
  procedure cir_rep_taluka_day_daybook(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pedtn              in varchar2,
     pcitycd            in varchar2,
     pstatecd           in varchar2,
     pmonth             in varchar2,
     pyear              in number,
     pday               in varchar2,
     pdateformat        in varchar2,
     pbranch            in varchar2,
     pdistcode          in varchar2,
     ptaluka            in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcode            in varchar2,
     pdpcode            in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
  procedure cir_rep_route_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
    procedure cir_rep_dist_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
    procedure cir_rep_taluka_challan(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     pperiod            in number,
     prmode             in varchar2,
     psupdate           in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
     procedure cir_route_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     procedure cir_dist_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     procedure cir_taluka_wise_supply(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
     procedure cir_dist_taluka_wise_sup(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts);
    procedure cir_supply_comp(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     psupdate           in varchar2,
     psupdate1          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts);
    procedure cir_route_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
        pextra3             in varchar2,--agency type
    pextra4             in varchar2,-- agency class
    pextra5             in varchar2,--final.unfinal
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
    procedure cir_dist_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pdist              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3             in varchar2,--agency type
    pextra4             in varchar2,-- agency class
    pextra5             in varchar2,--final.unfinal
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
    procedure cir_taluka_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     ptaluka            in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    pextra3             in varchar2,--agency type
    pextra4             in varchar2,-- agency class
    pextra5             in varchar2,--final.unfinal
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
    procedure cir_edition_supply_variance_p(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppublication       in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     pfirstdate         in varchar2,
     pseconddate        in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts);
    procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts);
     procedure cir_dist_taluka_publ_wise(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);
procedure cir_datewise_resale(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     ppublcode          in varchar2,
     pmainedtn          in varchar2,
     pedtncode          in varchar2,
     pdistcode          in varchar2,
     ptalukacode        in varchar2,
     pagtypecode        in varchar2,
     pagclasscode       in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     plangtype          in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts);              
END;
/
//////////////////////////////////////////////


CREATE OR REPLACE PACKAGE BODY cir_rep_supply IS
  procedure cir_rep_supply1(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pmainedtn          in varchar2,
     pedtn              in varchar2,
     proute             in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,----this is use to final and unfinal po
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts,
     p_accounts2        out t_accounts,
     p_accounts3        out t_accounts,
     p_accounts4        out t_accounts)
     As
     vfrom_supdate    date;
     vtill_supdate    date;
     cursor cur_sup_type is
         select 'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) "'||sup_ty_name||'",' vty,
         'sum(decode(sup_type_code,'||''''||sup_ty_code||''''||',sup_copy,0)) +' vty_sum
      from cir_supply_type_mast
      where comp_code=pcomp_code /*and sup_ty_code in(select distinct sup_type_code from cir_dbksup
      where comp_code=pcomp_code and unit_code=punit_code and
                  ((publ=ppubl) or (ppubl is null)) and ((edtn=pedtn) or (pedtn is null)) and
                  supdate between vfrom_supdate and vtill_supdate)*/
      order by sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;
     vvar         varchar2(4000);
     vvar_sum    varchar2(4000);
     vquery     varchar2(4000);
     vquery1     varchar2(4000);
     vquery2     varchar2(4000);
     vquery3     varchar2(4000);
     vquery4     varchar2(4000);
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;
    vvar    :=substr(vvar,1,length(vvar)-1);
    vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);commit;
    vquery:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code,cir_get_route_name(d.comp_code,d.unit_code,d.route_code) route_name,d.agcd "AGENCY CODE",d.dpcd "AGENCY SUBCODE",
    substr(m.ag_name,1,50) "AGENCY NAME",substr(m.ag_name_oth_lang,1,50) "AGENCY ONAME",cir_get_city(d.comp_code,m.city_code) "CITY NAME",
    nvl(CIR_GET_NAME.CIR_CITY(d.comp_code,m.city_code,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) "DROP_POINT", cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) "ODROP_POINT", '||vvar||','||vvar_sum||' TOTAL 
	from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||' or '||''''||ppubl||''''||' is null) 
				and (d.final_supply_flag='||''''||pextra3||''''||' or '||''''||pextra3||''''||' is null) and
				and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code,d.agcd,d.dpcd';
     insert into test1(vstring) values ('1'||vquery);commit;
      open p_accounts for vquery;
      vquery2:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn,cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,d.route_code route_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code order by d.comp_code,d.unit_code,d.publ,d.edtn,d.route_code';
        insert into test1(vstring) values ('22'||vquery2);commit;
      open p_accounts2 for vquery2;
      vquery3:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ,d.edtn';
      open p_accounts3 for vquery3;
      vquery4:=' select d.comp_code comp_code,d.unit_code unit_code,d.publ publ, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code,d.publ';
      open p_accounts4 for vquery4;
      vquery1:=' select d.comp_code comp_code,d.unit_code unit_code, '||vvar||','||vvar_sum||' TOTAL from cir_dbksup d,cir_agmast m where m.comp_code=d.comp_code and d.comp_code='|| 
                ''''||pcomp_code||''''||' and m.unit=d.unit_code and d.unit_code='||''''||punit_code||''''||' and (d.publ='||''''||ppubl||''''||
                ' or '||''''||ppubl||''''||' is null) and (d.edtn='||''''||pedtn||''''||' or '||''''||pedtn||''''||' is null) and m.agcd=d.agcd and m.dpcd=d.dpcd and d.supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||') and ((route_code='||''''||proute||''''||') or ('||''''||proute||''''||' is null)) and
               d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn='||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null))
                group by d.comp_code,d.unit_code,d.publ,d.edtn order by d.comp_code,d.unit_code';
        --insert into test1(vstring) values ('2'||vquery);commit;
     open p_accounts1 for vquery1;
  End cir_rep_supply1;
procedure cir_rep_supply_po(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--finalize and unfinalize
     pextra2        in varchar2,--final and unfinal
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts) as
     /*cursor cur_sup_type is
         /*select distinct 'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) "'||sup_ty_name||'",' vty,
             'sum(decode(d.sup_type_code,'||''''||sup_ty_code||''''||',d.sup_copy,0)) +' vty_sum
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by sup_seq_no;*/
         /*select distinct s.sup_ty_code vty,s.sup_ty_name vty_name,s.sup_seq_no sup_seq_no
             from cir_supply_type_mast s,cir_dbksup d
             where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.sup_type_code=s.sup_ty_code and
             d.unit_code=punit_code and (d.publ=ppubl or ppubl is null) and
             d.supdate=to_date(psupdate,''''||pdateformat||'''') order by s.sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;
     vvar       varchar2(4000);
     vvar1      varchar2(4000);
     vvar_sum   varchar2(4000);
     vquery     varchar2(4000);
     vquery1    varchar2(4000);
  Begin
    delete from test1;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar    :=' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :='sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=' sum('||'"'||rec_sup_type.vty_name||'"';
        else
            vvar    :=vvar||','||' case when d.sup_type_code='||''''||rec_sup_type.vty||''''||' then d.sup_copy else 0 end '||'"'||rec_sup_type.vty_name||'"';
            vvar1   :=vvar1||','||'sum("'||rec_sup_type.vty_name||'")'||' as "'||rec_sup_type.vty_name||'"';
            vvar_sum:=vvar_sum||'+'||'"'||rec_sup_type.vty_name||'"';
        end if;
    end loop;
    close cur_sup_type;
    --vvar    :=substr(vvar,1,length(vvar)-1);
    --vvar_sum:=substr(vvar_sum,1,length(vvar_sum)-1);
    vvar_sum:=vvar_sum||') '||' as "TOTAL"';
    --insert into test1(vstring,vstring2) values ('PO Report ',vvar1||','||vvar_sum);commit;
    vquery:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,
            x.edtn_name "EDITION NAME",x.supdate supdate,'||vvar1||','||vvar_sum||',x.mainedtn_name mainedtn_name,
            x.edtn_seqno edtn_seqno,x.main_edtn_seqno main_edtn_seqno FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name,x.edtn,
            x.edtn_name ,x.supdate,x.mainedtn_name,x.edtn_seqno,x.main_edtn_seqno
            order by x.comp_code,x.unit_code,x.publ,main_edtn_seqno,mainedtn_name,edtn_seqno,x.edtn,x.supdate';
        --insert into test1(vstring,vstring2) values ('PO Report vquery',vquery);commit;
    open p_accounts for vquery;
    vquery1:= 'select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,'||vvar1||','||vvar_sum||' FROM
            (select d.comp_code comp_code,d.unit_code unit_code,d.publ publ,cir_get_publ_name(d.comp_code,d.publ) publ_name,d.edtn edtn,
            cir_get_edtn_name(d.comp_code,d.edtn) edtn_name,to_char(d.supdate'||','||''''||pdateformat||''''||') supdate, '||vvar||',
            cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,d.edtn) edtn_seqno,cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno
            from cir_dbksup d,cir_edtn_mast e
            where d.comp_code='||''''||pcomp_code||''''||' and d.comp_code=e.comp_code and d.unit_code='||''''||punit_code||''''||' and d.unit_code=e.unit_code and
            ((d.publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and d.publ=e.publ and
            d.supdate='|| 'to_date('||''''||psupdate||''''||','||''''||pdateformat||''''||') and d.edtn=e.edtn) x
            group by x.comp_code,x.unit_code ,x.publ,x.publ_name
            order by x.comp_code,x.unit_code,x.publ,x.publ_name';
        --insert into test1(vstring,vstring2) values ('PO Report vquery1',vquery1);commit;
    open p_accounts1 for vquery1;*/
v_date             date;
     cursor cur_sup_type is
        select distinct 'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) "'||agname||'",' vty,
            'sum(decode(d.agname,'||''''||agname||''''||',d.supply_copy,0)) +' vty_sum,rec_amt sup_seq_no,agname supply_type_name
            from cir_temp_bill_collection
            where cur_sessionid=userenv('sessionid') 
        order by rec_amt,agname;
     rec_sup_type cur_sup_type%rowtype;
    cursor cur_dbk is
            select x.comp_code comp_code,x.unit_code unit_code,x.supdate supdate,x.publ_name publ_name,x.mainedtn_name mainedtn_name,
            x.main_edtn_seqno main_edtn_seqno,x.edtn_name||to_char(x.sup_rate,'990.99') edtn_name,x.edtn_seqno edtn_seqno,x.sup_ty_name sup_ty_name,
            x.sup_seqno sup_seqno,x.sup_rate sup_rate,x.supply_copy supply_copy,x.supl_name supl_name,x.pgno pgno from
            (select d.comp_code comp_code,d.unit_code unit_code,d.supdate supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,d.sup_rate sup_rate, sum(d.sup_copy) supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit_code,e.edtn,d.supdate,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(d.supdate,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(d.supdate,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(d.supdate,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(d.supdate,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(d.supdate,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(d.supdate,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_dbksup d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit_code=e.unit_code and d.unit_code=nvl(punit_code,d.unit_code) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supdate =v_date and d.sup_type_code=t.sup_ty_code and upper(pextra1)!='U'
            group by d.comp_code,d.unit_code,d.supdate,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no,d.sup_rate
            union
            select d.comp_code comp_code,d.unit unit_code,v_date supdate,p.publ_name publ_name,cir_get_edtn_name(d.comp_code,e.main_edtn) mainedtn_name,
            cir_get_edtn_seqno(d.comp_code,e.main_edtn) main_edtn_seqno,
            e.edtn edtn,e.edtn_name edtn_name,e.edtn_seq_no edtn_seqno,t.sup_ty_name sup_ty_name,t.sup_seq_no sup_seqno,
            cir_get_edtn_rate(d.comp_code,d.unit,e.edtn,to_char(v_date,'dd/mm/yyyy'),'dd/mm/yyyy') sup_rate, 
            case when to_char(v_date,'DY')='SUN' then sum(nvl(d.base_supply,0)+nvl(d.supply_sun,0))
                 when to_char(v_date,'DY')='MON' then sum(nvl(d.base_supply,0)+nvl(d.supply_mon,0))
                 when to_char(v_date,'DY')='TUE' then sum(nvl(d.base_supply,0)+nvl(d.supply_tue,0))
                 when to_char(v_date,'DY')='WED' then sum(nvl(d.base_supply,0)+nvl(d.supply_wed,0))
                 when to_char(v_date,'DY')='THU' then sum(nvl(d.base_supply,0)+nvl(d.supply_thu,0))
                 when to_char(v_date,'DY')='FRI' then sum(nvl(d.base_supply,0)+nvl(d.supply_fri,0))
            else sum(nvl(d.base_supply,0)+nvl(d.supply_sat,0)) end supply_copy,
            cir_get_edtn_supl(d.comp_code,d.unit,e.edtn,v_date,pdateformat,1,null,null,null,null,null) supl_name,
            case when to_char(v_date,'DY')='SUN' then min(nvl(e.main_issue_pgno_sun,0)+nvl(e.pullout_pgno_sun,0))
                when to_char(v_date,'DY')='MON' then min(nvl(e.main_issue_pgno_mon,0)+nvl(e.pullout_pgno_mon,0))
                when to_char(v_date,'DY')='TUE' then min(nvl(e.main_issue_pgno_tue,0)+nvl(e.pullout_pgno_tue,0))
                when to_char(v_date,'DY')='WED' then min(nvl(e.main_issue_pgno_wed,0)+nvl(e.pullout_pgno_wed,0))
                when to_char(v_date,'DY')='THU' then min(nvl(e.main_issue_pgno_thu,0)+nvl(e.pullout_pgno_thu,0))
                when to_char(v_date,'DY')='FRI' then min(nvl(e.main_issue_pgno_fri,0)+nvl(e.pullout_pgno_fri,0)) else min(nvl(e.main_issue_pgno_sat,0)+nvl(e.pullout_pgno_sat,0)) end pgno
            from cir_supply d,cir_edtn_mast e,cir_publ_mast p,cir_supply_type_mast t
            where d.comp_code=e.comp_code and d.comp_code=p.comp_code and d.comp_code=t.comp_code and d.comp_code=pcomp_code and
            d.unit=e.unit_code and d.unit=nvl(punit_code,d.unit) and d.publ=p.publ and d.publ=e.publ and d.publ=nvl(ppubl,d.publ) and 
            d.edtn=e.edtn and d.supply_flag='Y' and d.supply_type_code=t.sup_ty_code and upper(pextra1)='U'
            group by d.comp_code,d.unit,p.publ_name,e.main_edtn,e.edtn,e.edtn_name,e.edtn_seq_no,t.sup_ty_name,t.sup_seq_no) x
            order by comp_code,unit_code,supdate,publ_name,main_edtn_seqno,mainedtn_name,edtn_seqno,edtn_name,sup_seqno,sup_ty_name;
        rec_dbk cur_dbk%rowtype;
        cursor cur_main_edtn is
            select comp_code,unit_code,agcd,dpcd
            from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null
            group by comp_code,unit_code,agcd,dpcd
            order by comp_code,unit_code,agcd,dpcd;
        rec_main_edtn cur_main_edtn%rowtype;                                    
        cursor cur_supl is
            select chq_bank,sum(rec_seqno) sup_copy
            from cir_ledger_report where sess_id=userenv('sessionid') and comp_code=rec_main_edtn.comp_code and 
            unit_code=rec_main_edtn.unit_code and agcd=rec_main_edtn.agcd and dpcd=rec_main_edtn.dpcd and
            remarks is null
            group by chq_bank
            order by chq_bank;
        rec_supl cur_supl%rowtype;        
    vvar        varchar2(4000);
    vvar_sum    varchar2(4000);
    vquery      varchar2(8000);
    v_count     number(5);
    vlength     number(7);
    vrunval     varchar2(8000);
    v_val       varchar2(800);
    v_name      varchar2(8000);
    vno         number:=0;
    v_remarks   varchar2(500);
  Begin
    if upper(pextra1)='U' then  
        v_date:=to_date(trunc(sysdate),''''||pdateformat||'''');
    else
        v_date:=to_date(psupdate,''''||pdateformat||'''');
    end if;    
    delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    --delete from test1;commit;
    open cur_dbk;
    loop
        fetch cur_dbk into rec_dbk;
        exit when cur_dbk%notfound;
        v_count:=nvl(v_count,0)+1;
        if rec_dbk.pgno=0 then
            rec_dbk.pgno:=null;
        end if;
        vlength :=null; v_val :=null; vrunval :=null; vno:=null;
        v_val   :=replace(rec_dbk.supl_name||'+','+',',');
        vlength :=length(v_val);
        vno:=1;
        for i in 1.. vlength loop
        vrunval:=substr(v_val,i,1);
        if vrunval!=',' then
            v_name:=v_name||vrunval;
        else
            insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, recptno, chq_bank, rec_seqno,sess_id)
                    values (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,v_name,rec_dbk.supply_copy,userenv('sessionid'));
            vno:=vno+1;
            v_name:='';
        end if;
        end loop;
        insert into cir_temp_bill_collection
        (comp_code, unit_code, billdt, publ_code, agcd, dpcd, supply_copy, gross_amt, 
        cur_sessionid, agname,return_copy,remarks,dn_amt,cn_amt,rec_amt)
        values
        (rec_dbk.comp_code,rec_dbk.unit_code,v_date,rec_dbk.publ_name,rec_dbk.mainedtn_name,rec_dbk.edtn_name,rec_dbk.supply_copy,rec_dbk.sup_rate,
        userenv('sessionid'),rec_dbk.sup_ty_name,rec_dbk.pgno,rec_dbk.supl_name,rec_dbk.main_edtn_seqno,rec_dbk.edtn_seqno,rec_dbk.sup_seqno);
    end loop;
    close cur_dbk;
    open cur_main_edtn;
    loop
        fetch cur_main_edtn into rec_main_edtn;
        exit when cur_main_edtn%notfound;
        open cur_supl;
        loop
            fetch cur_supl into rec_supl;
            exit when cur_supl%notfound;
            if v_remarks is null then
                v_remarks:=rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            else
                v_remarks:=v_remarks||','||rec_supl.chq_bank||' # '||rec_supl.sup_copy;
            end if;
            if rec_supl.chq_bank is null then
                v_remarks:=null;
            end if;             
        end loop;
        close cur_supl;
        insert into cir_ledger_report(comp_code, unit_code, recptdt,agcd, dpcd, remarks,sess_id)
                values (rec_main_edtn.comp_code,rec_main_edtn.unit_code,v_date,rec_main_edtn.agcd,rec_main_edtn.dpcd,v_remarks,userenv('sessionid'));        
       v_remarks:=null;
    end loop;
    close cur_main_edtn;    
    delete from cir_ledger_report where sess_id=userenv('sessionid') and remarks is null;
    delete from test1;commit;
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
        exit when cur_sup_type%notfound;
        if vvar is null then
            vvar       :='case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :='sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        else
            vvar       :=vvar||','||'case when d.agname='||''''||rec_sup_type.supply_type_name||''''||' then d.supply_copy else 0 end "'||rec_sup_type.supply_type_name||'"';
            vvar_sum   :=vvar_sum||','||'sum("'||rec_sup_type.supply_type_name||'")'||' "'||rec_sup_type.supply_type_name||'"';
        end if;            
    end loop;
    close cur_sup_type;
    --insert into test1(vstring) values (pextra1||' '||vquery);
    if vvar is null then            
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate, sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,x.edtn edtn,x.edtn_name "EDITION NAME",
                x.supdate supdate,'||vvar_sum||', sum(x.supply_copy) TOTAL,x.mainedtn_name mainedtn_name,x.supl_name supl_name,x.main_seqno main_seqno,x.edtn_seqno edtn_seqno,x.return_copy page_no,x.supl_detail supl_detail
                from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy,
                (select remarks from cir_ledger_report where sess_id=userenv(''sessionid'') and remarks is not null and comp_code=d.comp_code and unit_code=d.unit_code and agcd=d.publ_code and dpcd=d.agcd and recptdt=d.billdt) supl_detail,d.RETURN_COPY return_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x  group by x.comp_code,x.unit_code,x.publ,x.publ_name,x.edtn,x.edtn_name,x.supdate,x.mainedtn_name,x.supl_name,x.main_seqno,x.edtn_seqno,x.return_copy,x.supl_detail
                order by comp_code,unit_code,publ_name,main_seqno,edtn_seqno';
    end if;                    
    --insert into test1(vstring) values ('1 pextra1 '||vquery);commit;
    open p_accounts for vquery;
    if vvar is null then
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                 sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';                
    else
        vquery:=' select x.comp_code comp_code,x.unit_code unit_code,x.publ publ,x.publ_name publ_name,
                '||vvar_sum||', sum(x.supply_copy) TOTAL from
                (select d.comp_code comp_code,d.unit_code unit_code,d.publ_code publ,d.publ_code publ_name,d.dpcd edtn,d.dpcd edtn_name,
                to_char(d.billdt'||','||''''||pdateformat||''''||') supdate,'||vvar||',d.agcd mainedtn_name,d.remarks supl_name,d.dn_amt main_seqno,d.cn_amt edtn_seqno,d.supply_copy supply_copy from cir_temp_bill_collection d
                where d.cur_sessionid=userenv(''sessionid'')) x group by x.comp_code,x.unit_code,x.publ,x.publ_name
                order by comp_code,unit_code,publ_name';    
    end if;
    --insert into test1(vstring) values ('2 pextra1 '||vquery);commit;
    --delete from cir_temp_bill_collection where cur_sessionid=userenv('sessionid');
    --delete from cir_ledger_report where sess_id=userenv('sessionid');commit;
    open p_accounts1 for vquery;    
  End cir_rep_supply_po;
  procedure cir_rep_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",
       nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
            nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND
        A.PUBL=PPUBL AND A.EDTN=NVL(PEDTN,A.EDTN) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND 
        A.SUPDATE >= VFRDT AND A.SUPDATE <=VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,/*A.EDTN,*/B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD;
       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,'NA') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),'NA') "STATE NAME",COUNTRY_CODE,
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE;
       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE<=VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;
  End cir_rep_daybook;
  procedure cir_rep_dist_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt            date;
     vtodt            date;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(DIST_CODE,'NA') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",
       STATE_CODE,SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT    AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD;
       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,'NA') DIST_CODE,nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),'NA') "DISTRICT NAME",
       nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,pdateformat,'',''),'NA') "DISTRICT ONAME",STATE_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.DIST_CODE DIST_CODE,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT  AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.DIST_CODE,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE;
       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;
  End cir_rep_dist_daybook;
  procedure cir_rep_taluka_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vfrdt          date;
     vtodt          date;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
       open p_accounts for
       SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,pdateformat,'',''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'',EDTN,2,pdateformat,'',''),'NA') "EDITION ONAME",
       nvl(CITY_CODE,'NA') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),'NA') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,pdateformat,'',''),'NA') "CITY ONAME",
       nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",
       STATE_CODE "STATE CODE",
        SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
            nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD;
       open p_accounts1 for
       SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,'NA') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),'NA') "TALUKA NAME",
       nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,pdateformat,'',''),'NA') "TALUKA ONAME",STATE_CODE "STATE CODE",
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.STATE_CODE STATE_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.STATE_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,STATE_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,TEHSIL_TALUKA;
       open p_accounts2 for
       SELECT COMP_CODE,UNIT_CODE,
       SUM(p01) AS "01",SUM(p02) AS "02",SUM(p03) AS "03",SUM(p04) AS "04",SUM(p05) AS "05",
        SUM(p06) AS "06",SUM(p07) AS "07",SUM(p08) AS "08",SUM(p09) AS "09",SUM(p10) AS "10",
        SUM(p11) AS "11",SUM(p12) AS "12",SUM(p13) AS "13",SUM(p14) AS "14",SUM(p15) AS "15",
        SUM(p16) AS "16",SUM(p17) AS "17",SUM(p18) AS "18",SUM(p19) AS "19",SUM(p20) AS "20",
        SUM(p21) AS "21",SUM(p22) AS "22",SUM(p23) AS "23",SUM(p24) AS "24",SUM(p25) AS "25",
        SUM(p26) AS "26",SUM(p27) AS "27",SUM(p28) AS "28",SUM(p29) AS "29",SUM(p30) AS "30",SUM(p31) AS "31",
        SUM(nvl(p01,0)+nvl(p02,0)+nvl(p03,0)+nvl(p04,0)+nvl(p05,0)+nvl(p06,0)+nvl(p07,0)+nvl(p08,0)+nvl(p09,0)+nvl(p10,0)+
        nvl(p11,0)+nvl(p12,0)+nvl(p13,0)+nvl(p14,0)+nvl(p15,0)+nvl(p16,0)+nvl(p17,0)+nvl(p18,0)+nvl(p19,0)+nvl(p20,0)+
        nvl(p21,0)+nvl(p22,0)+nvl(p23,0)+nvl(p24,0)+nvl(p25,0)+nvl(p26,0)+nvl(p27,0)+nvl(p28,0)+nvl(p29,0)+nvl(p30,0)+nvl(p31,0)) AS "TOTAL"
        FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'01',SUM(nvl(A.SUP_COPY,0))) p01,DECODE(TO_CHAR(A.SUPDATE,'DD'),'02',SUM(nvl(A.SUP_COPY,0))) p02,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'03',SUM(nvl(A.SUP_COPY,0))) p03, DECODE(TO_CHAR(A.SUPDATE,'DD'),'04',SUM(nvl(A.SUP_COPY,0))) p04,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'05',SUM(nvl(A.SUP_COPY,0))) p05, DECODE(TO_CHAR(A.SUPDATE,'DD'),'06',SUM(nvl(A.SUP_COPY,0))) p06,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'07',SUM(nvl(A.SUP_COPY,0))) p07, DECODE(TO_CHAR(A.SUPDATE,'DD'),'08',SUM(nvl(A.SUP_COPY,0))) p08,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'09',SUM(nvl(A.SUP_COPY,0))) p09, DECODE(TO_CHAR(A.SUPDATE,'DD'),'10',SUM(nvl(A.SUP_COPY,0))) p10,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'11',SUM(nvl(A.SUP_COPY,0))) p11, DECODE(TO_CHAR(A.SUPDATE,'DD'),'12',SUM(nvl(A.SUP_COPY,0))) p12,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'13',SUM(nvl(A.SUP_COPY,0))) p13, DECODE(TO_CHAR(A.SUPDATE,'DD'),'14',SUM(nvl(A.SUP_COPY,0))) p14,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'15',SUM(nvl(A.SUP_COPY,0))) p15, DECODE(TO_CHAR(A.SUPDATE,'DD'),'16',SUM(nvl(A.SUP_COPY,0))) p16,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'17',SUM(nvl(A.SUP_COPY,0))) p17, DECODE(TO_CHAR(A.SUPDATE,'DD'),'18',SUM(nvl(A.SUP_COPY,0))) p18,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'19',SUM(nvl(A.SUP_COPY,0))) p19, DECODE(TO_CHAR(A.SUPDATE,'DD'),'20',SUM(nvl(A.SUP_COPY,0))) p20,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'21',SUM(nvl(A.SUP_COPY,0))) p21, DECODE(TO_CHAR(A.SUPDATE,'DD'),'22',SUM(nvl(A.SUP_COPY,0))) p22,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'23',SUM(nvl(A.SUP_COPY,0))) p23, DECODE(TO_CHAR(A.SUPDATE,'DD'),'24',SUM(nvl(A.SUP_COPY,0))) p24,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'25',SUM(nvl(A.SUP_COPY,0))) p25, DECODE(TO_CHAR(A.SUPDATE,'DD'),'26',SUM(nvl(A.SUP_COPY,0))) p26,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'27',SUM(nvl(A.SUP_COPY,0))) p27, DECODE(TO_CHAR(A.SUPDATE,'DD'),'28',SUM(nvl(A.SUP_COPY,0))) p28,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'29',SUM(nvl(A.SUP_COPY,0))) p29, DECODE(TO_CHAR(A.SUPDATE,'DD'),'30',SUM(nvl(A.SUP_COPY,0))) p30,
        DECODE(TO_CHAR(A.SUPDATE,'DD'),'31',SUM(nvl(A.SUP_COPY,0))) p31
        FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE=PCOMP_CODE AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE=PUNIT_CODE AND
        A.AGCD=B.AGCD AND A.AGCD=NVL(PAGCODE,A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=B.DPCD AND  A.DPCD=NVL(PDPCODE,A.DPCD) AND 
        A.PUBL=PPUBL AND (A.EDTN=PEDTN OR PEDTN IS NULL) AND (B.CITY_CODE=PCITYCD OR PCITYCD IS NULL) AND
        (B.STATE_CODE=PSTATECD OR PSTATECD IS NULL) AND (B.DIST_CODE=PDISTCODE OR PDISTCODE IS NULL) AND (B.TEHSIL_TALUKA=PTALUKA OR PTALUKA IS NULL) AND 
        (B.BRANCH_CODE=PBRANCH OR PBRANCH IS NULL) AND (B.AG_TYPE=PAGTYPE OR PAGTYPE IS NULL) AND (B.AG_CLASS=PAGCLASS OR PAGCLASS IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE=PEXTRA1 OR PEXTRA1 IS NULL) AND A.SUPDATE >= VFRDT AND A.SUPDATE <= VTODT AND NVL(A.SUP_COPY,0)>0
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE;
  End cir_rep_taluka_daybook;
  procedure cir_rep_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(12000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;
    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');
    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,CITY_CODE,EDTN,AGCD,DPCD';
       insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(STATE_CODE,''NA'') "STATE CODE",nvl(CIR_GET_STATE(COMP_CODE,COUNTRY_CODE,STATE_CODE),''NA'') "STATE NAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE';
insert into test1(vstring,vstring2) values('3 '||vquery3,VQUERY2);commit;
       open p_accounts1 for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0 AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
insert into test1(vstring,vstring2) values('4 '||vquery3,VQUERY2);commit;        
       open p_accounts2 for vquery3||vquery2;
  End cir_rep_day_daybook;
  procedure cir_rep_dist_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;
    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');
    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
    substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",
       COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,CITY_CODE,EDTN,AGCD,DPCD';
       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(DIST_CODE,''NA'') "DIST CODE",nvl(CIR_GET_DIST(COMP_CODE,STATE_CODE,DIST_CODE),''NA'') "DISTRICT NAME",nvl(CIR_GET_NAME.CIR_DISTRICT(COMP_CODE,DIST_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "DISTRICT ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.STATE_CODE STATE_CODE,B.DIST_CODE DIST_CODE,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
        vquery2:='  FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.STATE_CODE,B.DIST_CODE,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,STATE_CODE,DIST_CODE,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,DIST_CODE,STATE_CODE';
       open p_accounts1 for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;
   End cir_rep_dist_day_daybook;
  procedure cir_rep_taluka_day_daybook(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pedtn          in varchar2,
     pcitycd        in varchar2,
     pstatecd       in varchar2,
     pmonth         in varchar2,
     pyear          in number,
     pday           in varchar2,
     pdateformat    in varchar2,
     pbranch        in varchar2,
     pdistcode      in varchar2,
     ptaluka        in varchar2,
     pagtype        in varchar2,
     pagclass       in varchar2,
     pagcode        in varchar2,
     pdpcode        in varchar2,
     pextra1        in varchar2,--it is used for supply type
     pextra2        in varchar2,
     pextra3        in varchar2,
     pextra4        in varchar2,
     pextra5        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts)
    As
     vquery1        varchar2(4000);
     vquery2        varchar2(12000);
     vquery3        varchar2(12000);
     vdaysup        varchar2(2000);
     vtotsup        varchar2(1000);
     vfrdt          date;
     vtodt          date;
     v_dt           date;
     v_day          varchar2(3);
     v_cnt          number:=0;
       cursor c1 is
           select dt,upper(to_char(dt,'DY')) supply_day from cir_temp_dt order by sqno,dt;
   Begin
       vfrdt:=to_date('01/'||pmonth||'/'||pyear,pdateformat);
       vtodt:=last_day(vfrdt);
    delete from cir_temp_dt;
    loop
        if v_dt>=vtodt then
            exit;
        else
            if v_dt is null then
                v_dt:=vfrdt;
            else
                v_dt:=v_dt+1;
            end if;
        end if;
           if upper(to_char(v_dt,'DY'))=upper(pday) then
               insert into cir_temp_dt(sqno,dt) values(1,v_dt);
           else
               insert into cir_temp_dt(sqno,dt) values(2,v_dt);
           end if;
    end loop;
    open c1;
    loop
        fetch c1 into v_dt,v_day;
        exit when c1%notfound;
        v_cnt        := v_cnt+1;
        if vquery1 is null then
            vquery1:='DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:='SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:='NVL(P'||lpad(v_cnt,2,'0')||',0)';
        else
            vquery1:=vquery1||','||'DECODE(TO_CHAR(A.SUPDATE,''DD''),'''||to_char(v_dt,'dd')||''',SUM(nvl(A.SUP_COPY,0))) P'||lpad(v_cnt,2,'0');
            vdaysup:=vdaysup||','||'SUM(NVL(P'||lpad(v_cnt,2,'0')||',0)) AS '||'"'||lpad(v_cnt,2,'0')||'"';
            vtotsup:=vtotsup||'+'||'NVL(P'||lpad(v_cnt,2,'0')||',0)';
        end if;
    end loop;
    close c1;
    vtotsup:='SUM('||vtotsup||')';
    --insert into test1(vstring,vstring2) values('1 '||vquery1,vdaysup||','||vtotsup||'AS "TOTAL"');
    vquery3:='SELECT COMP_CODE,UNIT_CODE,AGCD "AGENCY CODE",DPCD "AGENCY SUBCODE",substr(cir_get_agency(comp_code,unit_code,agcd,dpcd),1,50) "AGENCY NAME",
       substr(cir_get_name.cir_agname(comp_code,unit_code,agcd,dpcd,2,'||''''||pdateformat||''''||','''',''''),1,50) "AGENCY ONAME",
       EDTN,CIR_GET_EDTN_NAME(COMP_CODE,EDTN) "EDITION NAME",nvl(CIR_GET_NAME.CIR_EDTN(COMP_CODE,'''',EDTN,2,'||''''||pdateformat||''''||','''',''''),''NA'') "EDITION ONAME",
       nvl(CITY_CODE,''NA'') "CITY CODE",nvl(CIR_GET_CITY(COMP_CODE,CITY_CODE),''NA'') "CITY NAME",nvl(CIR_GET_NAME.CIR_CITY(COMP_CODE,CITY_CODE,2,'||''''||pdateformat||''''||','''',''''),''NA'') "CITY ONAME",
       nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
       ' FROM (SELECT A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,A.AGCD AGCD,A.DPCD DPCD,MIN(A.EDTN) EDTN,B.CITY_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE >= '''||VFRDT||''' AND A.SUPDATE <='''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.AGCD,A.DPCD,A.SUPDATE,B.CITY_CODE,TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,AGCD,DPCD,EDTN,CITY_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,CITY_CODE,EDTN,AGCD,DPCD';
       --insert into test1(vstring,vstring2) values('2 '||vquery3,VQUERY2);commit;
       open p_accounts for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,nvl(TEHSIL_TALUKA,''NA'') "TALUKA CODE",nvl(CIR_GET_TALUKA(COMP_CODE,TEHSIL_TALUKA),''NA'') "TALUKA NAME",nvl(CIR_GET_NAME.CIR_TALUKA(COMP_CODE,TEHSIL_TALUKA,2,'||''''||pdateformat||''''||','''',''''),''NA'') "TALUKA ONAME",COUNTRY_CODE "COUNTRY CODE",'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,B.TEHSIL_TALUKA TEHSIL_TALUKA,B.COUNTRY_CODE COUNTRY_CODE,'||vquery1;
        vquery2:='    FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
        WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND 
        A.SUP_TYPE_CODE=C.SUP_TY_CODE AND
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE,B.TEHSIL_TALUKA,B.COUNTRY_CODE)
        GROUP BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA,COUNTRY_CODE
        ORDER BY COMP_CODE,UNIT_CODE,TEHSIL_TALUKA';
       open p_accounts1 for vquery3||vquery2;
        vquery3:='SELECT COMP_CODE,UNIT_CODE,'||vdaysup||','||vtotsup||'AS "TOTAL"'||
        ' FROM (SELECT     A.COMP_CODE COMP_CODE,A.UNIT_CODE UNIT_CODE,'||vquery1;
       vquery2:=' FROM CIR_DBKSUP A,CIR_AGMAST B,CIR_SUPPLY_TYPE_MAST C
       WHERE A.COMP_CODE=B.COMP_CODE AND A.COMP_CODE=C.COMP_CODE AND A.COMP_CODE='''||PCOMP_CODE||''' AND A.UNIT_CODE=B.UNIT AND A.UNIT_CODE='''||PUNIT_CODE||''' AND
        A.AGCD=B.AGCD AND A.AGCD=NVL('''||PAGCODE||''',A.AGCD) AND A.DPCD=B.DPCD AND A.DPCD=NVL('''||PDPCODE||''',A.DPCD) AND 
        A.PUBL='''||PPUBL||''' AND (A.EDTN='''||PEDTN||''' OR '''||PEDTN||''' IS NULL) AND (B.CITY_CODE='''||PCITYCD||''' OR '''||PCITYCD ||''' IS NULL) AND
        (B.STATE_CODE='''||PSTATECD||''' OR '''||PSTATECD||''' IS NULL) AND (B.DIST_CODE='''||PDISTCODE||''' OR '''||PDISTCODE||''' IS NULL) AND 
        (B.TEHSIL_TALUKA='''||PTALUKA||''' OR '''||PTALUKA||''' IS NULL) AND (B.BRANCH_CODE='''||PBRANCH||''' OR '''||PBRANCH||''' IS NULL) AND
        (B.AG_TYPE='''||PAGTYPE||''' OR '''||PAGTYPE||''' IS NULL) AND (B.AG_CLASS='''||PAGCLASS||''' OR '''||PAGCLASS||''' IS NULL) AND
         A.SUP_TYPE_CODE=C.SUP_TY_CODE AND (A.SUP_TYPE_CODE='''||PEXTRA1||''' OR '''||PEXTRA1||''' IS NULL) AND 
        A.SUPDATE>= '''||VFRDT||''' AND A.SUPDATE <= '''||VTODT||''' AND NVL(A.SUP_COPY,0)>0  AND upper(to_char(A.SUPDATE,''DY''))=upper('''||pday||''')
        GROUP BY A.COMP_CODE,A.UNIT_CODE,A.SUPDATE)
        GROUP BY COMP_CODE,UNIT_CODE
        ORDER BY COMP_CODE,UNIT_CODE';
       open p_accounts2 for vquery3||vquery2;
   End cir_rep_taluka_day_daybook;
  Procedure cir_rep_route_challan(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     pperiod        in number,
     prmode         in varchar2,
     psupdate       in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,
     pextra2        in varchar2,
     p_accounts     out t_accounts)
  As
      vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vquery     varchar2(4000);
  Begin
    --insert into test1(vstring,vstring2) values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    --insert into test1(vstring,vstring2) values('2222 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate '||psupdate);commit;
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
    --vvar:=substr(vvar,1,length(vvar)-1);
    --insert into test1(vstring,vstring2) values('1 '||vvar,' vsupdate '||vsupdate);commit;
        if vvar is null then
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        else
            vquery:='select a.route "ROUTE CODE",cir_get_route_name(a.comp_code,a.unit_code,a.route) "ROUTE NAME",a.subrt "SUB ROUTE",cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt) "SUBROUTE NAME",a.sub_subrt "SUB SUBROUTE",cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt) "SUB SUBROUTE NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by a.route,cir_get_route_name(a.comp_code,a.unit_code,a.route),a.subrt,cir_get_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt),a.sub_subrt,cir_get_sub_subroute_name(a.comp_code,a.unit_code,a.route,a.subrt,a.sub_subrt),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by a.route,a.subrt,a.sub_subrt,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('2 '||vquery,null);commit;
    open p_accounts for vquery;
  End cir_rep_route_challan;
procedure cir_rep_dist_challan(
   pcomp_code       in varchar2,
   punit_code       in varchar2,
   pperiod          in number,
   prmode           in varchar2,
   psupdate         in varchar2,
   pdateformat      in varchar2,
   pextra1          in varchar2,
   pextra2          in varchar2,
   p_accounts       out t_accounts)
   As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn_1--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
Begin
    vsupdate:=to_date(psupdate,''''||pdateformat||'''');
    open cur_edtn;
    loop
        fetch cur_edtn into rec_edtn;
      exit when cur_edtn%notfound;
                if vvar is null then
              vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                else
                    vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                end if;
    end loop;
    close cur_edtn;
        if vvar is null then
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        else
            vquery:='select b.dist_code "DISTRICT CODE",cir_get_dist(b.comp_code,b.state_code,b.dist_code) "DISTRICT NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
                where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.dist_code,cir_get_dist(b.comp_code,b.state_code,b.dist_code),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.dist_code,b.ag_name';--,'||vvar||'
        end if;
    --insert into test1(vstring,vstring2) values('DIST '||vquery,null);commit;
    open p_accounts for vquery;
  End cir_rep_dist_challan;
    procedure cir_rep_taluka_challan(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        pperiod        in number,
        prmode         in varchar2,
        psupdate       in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     As
     vsupdate date;
     cursor cur_edtn is
         select distinct edtn,edtn_seq_no from cir_edtn_mast where comp_code=pcomp_code and edtn in(select distinct edtn--'sum(decode(edtn,'||''''||edtn||''''||')) '||edtn||',' vty,
      from cir_lblmast where comp_code=pcomp_code and unit_code     = punit_code and
                  publ in (select publ from cir_publ_mast
                      where comp_code = pcomp_code and
                            period    = pperiod) and route in (select route_code from cir_route_mast
                            where comp_code = pcomp_code and
                                  unit_code = punit_code and
                                  ((route_mode = prmode) or (prmode is null))) and lbl_dt   = vsupdate)
      order by edtn_seq_no,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar         varchar2(4000);
     vquery     varchar2(4000);
    Begin
        vsupdate:=to_date(psupdate,''''||pdateformat||'''');
        open cur_edtn;
        loop
            fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
                    if vvar is null then
                  vvar:='sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';--'sum(decode(edtn,'||''''||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    else
                        vvar:=vvar||','||'sum(decode(edtn,'||''''||rec_edtn.edtn||''''||',supply_1,0))"'||cir_get_edtnnm_rate(pcomp_code,punit_code,rec_edtn.edtn,psupdate,pdateformat)||'"';
                    end if;
        end loop;
        close cur_edtn;
        if vvar is null then
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET" from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        else
        vquery:='select b.tehsil_taluka "TALUKA CODE",cir_get_taluka(b.comp_code,b.tehsil_taluka) "TALUKA NAME",a.agcd "AGENCY CODE",a.dpcd "AGENCY SUBCODE",b.ag_name "AGENCY NAME",b.city_code "CITY CODE",cir_get_city(b.comp_code,b.city_code) "CITY NAME",max(a.lbl_sno) "TOTAL PACKET",'||vvar||'from cir_lblmast a,cir_agmast b--sum(a.SUPPLY_1) "SUPPLY COPY",
            where a.comp_code = b.comp_code and a.unit_code = b.unit and a.agcd = b.agcd and a.dpcd = b.dpcd and a.comp_code = '||''''||pcomp_code||''''||' and a.unit_code = '||''''||punit_code||''''||' and a.publ in (select publ from cir_publ_mast where comp_code = '||''''||pcomp_code||''''||' and period = '||''''||pperiod||''''||') and a.route in (select route_code from cir_route_mast where comp_code = '||''''||pcomp_code||''''||' and ((route_mode = '||''''||prmode||''''||') or ('||''''||prmode||''''||' is null))) and a.lbl_dt = '||''''||vsupdate||''''||' group by b.tehsil_taluka,cir_get_taluka(b.comp_code,b.tehsil_taluka),a.agcd,a.dpcd,b.ag_name,b.city_code,cir_get_city(b.comp_code,b.city_code),a.edtn order by b.tehsil_taluka,b.ag_name';--,'||vvar||'
        end if;
        --insert into tes t1(vstring,vstring2) values('TALUKA '||vquery,null);commit;
        open p_accounts for vquery;
    End cir_rep_taluka_challan;
    procedure cir_route_wise_supply(
        pcomp_code     in varchar2,
        punit_code     in varchar2,
        ppubl          in varchar2,
        pmainedtn      in varchar2,
        pedtn          in varchar2,
        proute         in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,--for login user id
        pextra2        in varchar2,
        p_accounts     out t_accounts,
        p_accounts1    out t_accounts,
        p_accounts2    out t_accounts,
        p_accounts3    out t_accounts)
     As
        vfrom_supdate    date;
        vtill_supdate    date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
       select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_supply_seqno(d.comp_code,d.unit_code,ppubl,pedtn,d.agcd,d.dpcd) AS "SUPPLY_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME",
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code,supply_seqno ,d.agcd,d.dpcd;
       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               d.route_code AS "ROUTE_CODE",cir_get_route_name(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_route_seqno(d.comp_code,d.unit_code,d.route_code) AS "ROUTE_SEQNO",
               cir_get_name.cir_route(d.comp_code,d.unit_code,d.route_code,2,null,null,null) AS "ROUTE_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,d.route_code
                  order by d.comp_code,d.unit_code,route_seqno,d.route_code;
       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by d.comp_code,d.unit_code;
       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (d.route_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by d.comp_code;
    End cir_route_wise_supply;
    procedure cir_dist_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vfrom_supdate  date;
     vtill_supdate  date;
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,ag_name,agcd,dpcd;
       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;
       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;
       open p_accounts3 for
       select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.dist_code = proute or proute is null) and
                     d.supdate between vfrom_supdate and vtill_supdate and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
  End cir_dist_wise_supply;
    procedure cir_taluka_wise_supply(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts)
     as
     vsupdate date;
     vsupdate1 date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,taluka_name,ag_name,agcd,dpcd;
       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.tehsil_taluka
                  order by comp_code,unit_code,taluka_name;
       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and 
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;
       open p_accounts3 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as  "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and d.comp_code    = pcomp_code and
                     d.unit_code    = m.unit and d.unit_code    = punit_code and
                     d.agcd         = m.agcd and d.dpcd         = m.dpcd and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
     End cir_taluka_wise_supply;
    procedure cir_dist_taluka_wise_sup(
     pcomp_code     in varchar2,
     punit_code     in varchar2,
     ppubl          in varchar2,
     pmainedtn      in varchar2,
     pedtn          in varchar2,
     proute         in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--for login user id
     pextra2        in varchar2,
     p_accounts     out t_accounts,
     p_accounts1    out t_accounts,
     p_accounts2    out t_accounts,
     p_accounts3    out t_accounts,
     p_accounts4    out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     Begin
       vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
       vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
       open p_accounts for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               d.agcd AS "AGCD",d.dpcd AS "DPCD",m.ag_name AS "AG_NAME",m.ag_name_oth_lang AS "AG_NAME_OTH_LANG",sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME", 
               cir_get_city(d.comp_code,m.city_code) as "CITY_NAME",
               cir_get_name.cir_city(d.comp_code,m.city_code,2,null,null,null) as "CITY_ONAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,1) as "DROP_POINT_NAME",
               cir_get_drop_point_name(d.comp_code,d.unit_code,m.station_code,2) as "DROP_POINT_ONAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka,
                           d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,m.city_code,m.station_code
                  order by comp_code,unit_code,dist_name,taluka_name,ag_name,agcd,dpcd;
       open p_accounts1 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               m.tehsil_taluka AS "TEHSIL_TALUKA",cir_get_taluka(d.comp_code,m.tehsil_taluka) AS "TALUKA_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME",
               cir_get_name.cir_taluka(d.comp_code,m.tehsil_taluka,2,null,null,null) as "TALUKA_OTH_NAME" 
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code,m.tehsil_taluka
                  order by comp_code,unit_code,dist_name,taluka_name;
       open p_accounts2 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",
               m.dist_code AS "DIST_CODE",cir_get_dist(d.comp_code,m.state_code,m.dist_code) AS "DIST_NAME",
               sum(d.sup_copy) AS "SUP_COPY",
               cir_get_name.cir_district(d.comp_code,m.dist_code,2,null,null,null) AS "DIST_OTH_NAME"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code,m.dist_code,m.state_code
                  order by comp_code,unit_code,dist_name;
       open p_accounts3 for
        select d.comp_code as "COMP_CODE",d.unit_code AS "UNIT_CODE",sum(d.sup_copy) AS "SUP_COPY"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code,d.unit_code
                  order by comp_code,unit_code;
       open p_accounts4 for
        select d.comp_code as "COMP_CODE",sum(d.sup_copy) AS "SUP_COPY",max(sup_rate) as "COPY_RATE"
               from cir_dbksup d,cir_agmast m,cir_edtn_mast e
               where d.comp_code    = m.comp_code and d.comp_code    = e.comp_code and
                     d.unit_code    = m.unit and
                     d.agcd         = m.agcd and
                     d.dpcd         = m.dpcd and
                     d.comp_code    = pcomp_code and
                     d.unit_code    = punit_code and
                     d.publ         = e.publ and d.publ         = ppubl and
                     d.edtn=e.edtn and (d.edtn       = pedtn or pedtn is null) and
                     (m.tehsil_taluka = proute or proute is null) and
                     d.supdate between vsupdate and vsupdate1 and
                     (e.main_edtn=pmainedtn or pmainedtn is null)
                  group by d.comp_code
                  order by comp_code;
     End cir_dist_taluka_wise_sup;
     procedure cir_supply_comp(
         pcomp_code     in varchar2,
         punit_code     in varchar2,
         ppublication   in varchar2,
         psupdate       in varchar2,
         psupdate1      in varchar2,
         pdateformat    in varchar2,
         pextra1        in varchar2,
         pextra2        in varchar2,
         p_accounts     out t_accounts,
         p_accounts1    out t_accounts,
         p_accounts2    out t_accounts,
         p_accounts3    out t_accounts)
     as
        vsupdate     date;
        vsupdate1    date;
     begin
        vsupdate    :=to_date(psupdate,''''||pdateformat||'''');
        vsupdate1   :=to_date(psupdate1,''''||pdateformat||'''');
        --insert into test1(vstring,vstring2) values(pcomp_code||','||punit_code||','||ppublication,psupdate||','||pdateformat||','||pextra1||','||','||pextra2); commit;
        open p_accounts for
             select comp_code,(select "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"= unit_code) unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,edtn,edtn_name,edtn_name_oth_lang,
             main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             prev_sup,curr_sup,nvl(curr_sup,0)-nvl(prev_sup,0) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno,cir_get_edtn_seqno(comp_code,edtn) edtn_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name,edtn_seqno,edtn_name;
        open p_accounts1 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,main_edtn,cir_get_edtn_name(comp_code,main_edtn) main_edtn_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,cir_get_publ_seqno(comp_code,publ) publ_seqno,
             cir_get_edtn_seqno(comp_code,main_edtn) mainedtn_seqno
             from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code =punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code,main_edtn
                               order by publ_seqno,publ_name,unit_code,mainedtn_seqno,main_edtn_name;
        open p_accounts2 for
             select comp_code,unit_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,main_edtn,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code  =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ       =cir_edtn_mast.publ and
                                     edtn       =cir_edtn_mast.edtn and
                                     supdate    =to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ,unit_code
                               order by publ_seqno,publ_name,unit_code;
             open p_accounts3 for
             select comp_code,publ,cir_get_publ_name(comp_code,publ) publ_name,
             sum(prev_sup) prev_sup,sum(curr_sup) curr_sup,sum(nvl(curr_sup,0)-nvl(prev_sup,0)) diff,
             cir_get_publ_seqno(comp_code,publ) publ_seqno from
                    (select distinct comp_code,unit_code,publ,edtn,edtn_name,edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code =cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=vsupdate1) prev_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code=cir_edtn_mast.comp_code and
                                     unit_code  =cir_edtn_mast.unit_code and
                                     publ=cir_edtn_mast.publ and
                                     edtn=cir_edtn_mast.edtn and
                                     supdate=to_date(vsupdate)) curr_sup
                         from cir_edtn_mast
                         where comp_code=pcomp_code and
                               (publ    =ppublication or ppublication is null) and
                               (unit_code=punit_code or punit_code is null) and
                               nvl(freeze_flag,'N')='N')
                               where nvl(prev_sup,0)+nvl(curr_sup,0)>0
                               group by comp_code,publ
                               order by publ_seqno,publ_name;
     End cir_supply_comp;
    procedure cir_route_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    proute              in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,--it is use for finalised or unfinalised
    pextra2             in varchar2,--it is used for supply type
    pextra3             in varchar2,--agency type
    pextra4             in varchar2,-- agency class
    pextra5             in varchar2,--final.unfinal
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate     date;
     vseconddate    date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(base_supply),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =   'Y' and cir_supply.comp_code = b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd          = a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    = b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          = a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and                                   
                                   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and                                    
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        else
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                                (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,c.station_code station_code,c.branch_code branch_code,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and   
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,route_code,route_name,route_name_oth_lang,station_code,branch_code
                                   order by comp_code,route_code,ag_name;
        end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code     =   pcomp_code and cir_supply.unit =   punit_code and
                                         cir_supply.publ          =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit          =   b.unit and cir_supply.agcd                 =   a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn                     =      a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and                                  
                                   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and  
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        else
            open p_accounts1 for----route wise total
                 select comp_code "COMP CODE",route_code "ROUTE CODE",route_name "ROUTE NAME",route_name_oth_lang "ROUTE NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code                =   pcomp_code and unit_code =   punit_code and
                                         publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                         cir_dbksup.unit_code        =     b.unit and cir_dbksup.agcd                 =   a.agcd and
                                         cir_dbksup.dpcd                 =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                         cir_dbksup.publ                     =      a.publ and cir_dbksup.edtn                     =      a.edtn and
                                         (cir_dbksup.route_code   =      proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate         = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and
                                   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and   
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,route_code,route_name,route_name_oth_lang
                                   order by comp_code,route_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                 (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                        (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code                =   pcomp_code and unit =   punit_code and
                                         cir_supply.publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')                =   'Y' and cir_supply.comp_code =     b.comp_code and
                                         cir_supply.unit     =   b.unit and cir_supply.agcd          =     a.agcd and
                                         cir_supply.dpcd          =   a.dpcd and cir_supply.route_code    =     b.route_code and
                                         cir_supply.publ          =   a.publ and cir_supply.edtn          =     a.edtn and
                                         (cir_supply.route_code   =   proute or proute is null) and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                         (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and unit_code =    punit_code and
                                         publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                         supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                         cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                         (cir_dbksup.route_code= proute or proute is null) and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and 
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_route_mast b,cir_agmast c
                             where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd and                                   
                                   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and
                                   (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                             where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
                open p_accounts2 for----comp wise total
                     select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                     decode(sum(first_sup),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                     (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                            d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                            (m.dist_code = proute or proute is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                            where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                            (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,a.publ,a.edtn,c.ag_name,c.ag_name_oth_lang,c.city_code,a.route_code,b.route_name,b.route_name_oth_lang,
                            (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code                =   pcomp_code and unit_code =   punit_code and
                                             publ                     =   ppublication and (edtn   =   pedtn or pedtn is null) and
                                             supdate                  =   vfirstdate and cir_dbksup.comp_code =     b.comp_code and
                                             cir_dbksup.unit_code     =   b.unit and cir_dbksup.agcd          =     a.agcd and
                                             cir_dbksup.dpcd          =   a.dpcd and cir_dbksup.route_code    =     b.route_code and
                                             cir_dbksup.publ          =   a.publ and cir_dbksup.edtn          =     a.edtn and
                                             (cir_dbksup.route_code   =   proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and
                                             (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and unit_code =    punit_code and
                                             publ         =    ppublication and (edtn   =    pedtn or pedtn is null) and
                                             supdate      = vseconddate and cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd = a.dpcd and cir_dbksup.route_code =  a.route_code and
                                             cir_dbksup.publ = a.publ and cir_dbksup.edtn =  a.edtn and
                                             (cir_dbksup.route_code= proute or proute is null) and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_route_mast b,cir_agmast c
                                 where a.comp_code=pcomp_code and a.comp_code=b.comp_code and a.comp_code=c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=b.unit and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd and
									   (c.AG_TYPE=pextra3 OR pextra3 IS NULL) AND (c.AG_CLASS=pextra4 OR pextra4 IS NULL) and  
                                       (a.route_code=proute or proute is null) and a.route_code=b.route_code )
                                 where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code
                                       order by comp_code;
        end if;
   End cir_route_supply_variance_p;
    procedure cir_dist_supply_variance_p(
        pcomp_code          in varchar2,
        punit_code          in varchar2,
        ppublication        in varchar2,
        pmainedtn           in varchar2,
        pedtn               in varchar2,
        pdist               in varchar2,
        pfirstdate          in varchar2,
        pseconddate         in varchar2,
        pdateformat         in varchar2,
        pextra1             in varchar2,--it is use for finalised or unfinalised
        pextra2             in varchar2,--it is used for supply type        
        pextra3             in varchar2,--agency type
        pextra4             in varchar2,-- agency class
        pextra5             in varchar2,--final.unfinal
        pextra6             in varchar2,
        pextra7             in varchar2,
        pextra8             in varchar2,
        pextra9             in varchar2,
        pextra10            in varchar2,
        p_accounts          out t_accounts,
        p_accounts1         out t_accounts,
        p_accounts2         out t_accounts)
   As
     vfirstdate             date;
     vseconddate            date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                     cir_supply.agcd  =    a.agcd and
                                     cir_supply.dpcd  =    a.dpcd and
                                     cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                     (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         supdate      =    vseconddate and
                                     cir_dbksup.agcd  =    a.agcd and
                                     cir_dbksup.dpcd  =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                   order by comp_code,dist_code,ag_name;
        else
                open p_accounts for
                     select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                     cir_get_city(comp_code,city_code) "CITY NAME",
                     dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                            (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,c.station_code station_code,c.branch_code branch_code,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd 
									   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,dist_code,dist_name,dist_oname,station_code,branch_code
                                       order by comp_code,dist_code,ag_name;            
        end if;
        if upper(pextra1)='U' then
        open p_accounts1 for----district wise total
             select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                          (select nvl(sum(sup_copy),0) from cir_supply
                               where comp_code    =    pcomp_code and
                                     unit    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     nvl(supply_flag,'N')=    'Y' and
                             cir_supply.agcd =    a.agcd and
                             cir_supply.dpcd =    a.dpcd and
                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ                =    ppublication and
                                     (edtn            =    pedtn or pedtn is null) and
                                     supdate        =    vseconddate and
                                 cir_dbksup.agcd                 =    a.agcd and
                                 cir_dbksup.dpcd                 =    a.dpcd and
                                 cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                 (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_dist_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd
							   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                               (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,dist_code,dist_name,dist_oname
                               order by comp_code,dist_code;
             else
                open p_accounts1 for----district wise total
                     select comp_code "COMP CODE",dist_code "DISTRICT CODE",dist_name "DISTRICT NAME",dist_oname "DISTRICT NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ         =    ppublication and
                                             (edtn        =    pedtn or pedtn is null) and
                                             supdate      =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast 
                                         where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_dist_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd 
									   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                       (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code,dist_code,dist_name,dist_oname
                                       order by comp_code,dist_code;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where comp_code    =    pcomp_code and
                                         unit         =    punit_code and
                                         publ         =    ppublication and
                                         (edtn        =    pedtn or pedtn is null) and
                                         nvl(supply_flag,'N')      =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and 
                                         (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                         cir_dbksup.agcd                 =    a.agcd and
                         cir_dbksup.dpcd                 =    a.dpcd and
                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            else
                open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.dist_code = pdist or pdist is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.dist_code,b.dist_name,b.dist_oname,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                        cir_dbksup.agcd =    a.agcd and
                                        cir_dbksup.dpcd =    a.dpcd and
                                        cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                        (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_dist_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.dist_code=    pdist or pdist is null) and c.dist_code=b.dist_code)
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
            end if;
   End cir_dist_supply_variance_p;
    procedure cir_taluka_supply_variance_p(
    pcomp_code       in varchar2,
    punit_code       in varchar2,
    ppublication     in varchar2,
    pmainedtn        in varchar2,
    pedtn            in varchar2,
    ptaluka          in varchar2,
    pfirstdate       in varchar2,
    pseconddate      in varchar2,
    pdateformat      in varchar2,
    pextra1          in varchar2,--it is use for finalised or unfinalised
    pextra2          in varchar2,--it is used for supply type
    pextra3             in varchar2,--agency type
    pextra4             in varchar2,-- agency class
    pextra5             in varchar2,--final.unfinal
    pextra6             in varchar2,
    pextra7             in varchar2,
    pextra8             in varchar2,
    pextra9             in varchar2,
    pextra10            in varchar2,
    p_accounts       out t_accounts,
    p_accounts1      out t_accounts,
    p_accounts2      out t_accounts)
   As
     vfirstdate      date;
     vseconddate     date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate    :=to_date(pseconddate,''''||pdateformat||'''');
        if upper(pextra1)='U' then
            open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit    =    punit_code and
                                         cir_supply.publ    =    ppublication and
                                         (cir_supply.edtn   =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
				  and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;
             else
                open p_accounts for
                 select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
                 cir_get_city(comp_code,city_code) "CITY NAME",
                 tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                             cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                            cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME" from
                        (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,c.station_code station_code,c.branch_code branch_code,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vfirstdate and
                                         cir_dbksup.agcd =    a.agcd and
                                         cir_dbksup.dpcd =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,tehsil_taluka,talu_name,talu_oname,station_code,branch_code
                                   order by comp_code,tehsil_taluka,ag_name;             
             end if;
        if upper(pextra1)='U' then
            open p_accounts1 for----taluka wise total
                 select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit         =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn        =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N') =    'Y' and
                                         cir_supply.agcd =    a.agcd and
                                         cir_supply.dpcd =    a.dpcd and
                                         cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                   order by comp_code,tehsil_taluka;
              else
                open p_accounts1 for----taluka wise total
                     select comp_code "COMP CODE",tehsil_taluka "TALUKA CODE",nvl(talu_name,'(blank)') "TALUKA NAME",talu_oname "TALUKA NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                     decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                            (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vfirstdate and
                                             cir_dbksup.agcd =    a.agcd and
                                             cir_dbksup.dpcd =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                                  (select nvl(sum(sup_copy),0) from cir_dbksup
                                       where comp_code    =    pcomp_code and
                                             unit_code    =    punit_code and
                                             publ                =    ppublication and
                                             (edtn            =    pedtn or pedtn is null) and
                                             supdate        =    vseconddate and
                                             cir_dbksup.agcd                 =    a.agcd and
                                             cir_dbksup.dpcd                 =    a.dpcd and
                                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                                 from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                                 where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                       a.unit_code=punit_code and a.unit_code=c.unit and
                                       (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                       a.agcd=c.agcd and a.dpcd=c.dpcd 
									   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                       (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                       where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                       group by comp_code ,tehsil_taluka,talu_name,talu_oname
                                       order by comp_code,tehsil_taluka;
        end if;
        if upper(pextra1)='U' then
            open p_accounts2 for----comp wise total
                 select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
                 decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                 decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                        (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                              (select nvl(sum(sup_copy),0) from cir_supply
                                   where cir_supply.comp_code    =    pcomp_code and
                                         cir_supply.unit        =    punit_code and
                                         cir_supply.publ         =    ppublication and
                                         (cir_supply.edtn         =    pedtn or pedtn is null) and
                                         nvl(cir_supply.supply_flag,'N')     =    'Y' and
                                             cir_supply.agcd =    a.agcd and
                                             cir_supply.dpcd =    a.dpcd and
                                             cir_supply.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                             (cir_supply.supply_type_code = pextra2 or pextra2 is null)) first_sup,
                              (select nvl(sum(sup_copy),0) from cir_dbksup
                                   where comp_code    =    pcomp_code and
                                         unit_code    =    punit_code and
                                         publ                =    ppublication and
                                         (edtn            =    pedtn or pedtn is null) and
                                         supdate        =    vseconddate and
                                         cir_dbksup.agcd                 =    a.agcd and
                                         cir_dbksup.dpcd                 =    a.dpcd and
                                         cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                         (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                             from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                             where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                                   a.unit_code=punit_code and a.unit_code=c.unit and
                                   (a.supdate = vfirstdate or a.supdate = vseconddate) and
                                   a.agcd=c.agcd and a.dpcd=c.dpcd 
								   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                                   (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                                   where nvl(second_sup,0)-nvl(first_sup,0)<>0
                                   group by comp_code
                                   order by comp_code;
        else
            open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
             decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
            (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    (m.tehsil_taluka = ptaluka or ptaluka is null) and d.edtn in(select distinct edtn from cir_edtn_mast
                    where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply  from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,c.tehsil_taluka,b.talu_name,b.talu_oname,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ    =    ppublication and
                                     (edtn   =    pedtn or pedtn is null) and
                                     supdate =    vfirstdate and
                             cir_dbksup.agcd =    a.agcd and
                             cir_dbksup.dpcd =    a.dpcd and
                             cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                             (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn        =    pedtn or pedtn is null) and
                                     supdate      =    vseconddate and
                                     cir_dbksup.agcd                 =    a.agcd and
                                     cir_dbksup.dpcd                 =    a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null)) and
                                     (cir_dbksup.sup_type_code = pextra2 or pextra2 is null)) second_sup
                         from cir_dbksup a,cir_taluka_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    c.comp_code and b.comp_code(+)    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code=c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd 
							   and (c.ag_type=pextra3 or pextra3 is null) and (c.ag_class=pextra4 or pextra4 is null) and 
                               (c.tehsil_taluka=    ptaluka or ptaluka is null) and c.tehsil_taluka=b.talu_code(+))
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
        end if;
   End cir_taluka_supply_variance_p;
    procedure cir_edition_supply_variance_p(
    pcomp_code          in varchar2,
    punit_code          in varchar2,
    ppublication        in varchar2,
    pmainedtn           in varchar2,
    pedtn               in varchar2,
    pfirstdate          in varchar2,
    pseconddate         in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,--it is used for supply type
    p_accounts          out t_accounts,
    p_accounts1         out t_accounts,
    p_accounts2         out t_accounts)
   As
     vfirstdate         date;
     vseconddate        date;
    Begin
        vfirstdate    :=to_date(pfirstdate,''''||pdateformat||'''');
        vseconddate   :=to_date(pseconddate,''''||pdateformat||'''');
        open p_accounts for
             select comp_code "COMP CODE",agcd "AGENCY CODE",dpcd "AGENCY SUB CODE",ag_name "AGENCY NAME",ag_name_oth_lang "AGENCY OTHER LANG",
             cir_get_city(comp_code,city_code) "CITY NAME",
             edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                         cir_get_drop_point_name(comp_code,unit_code,station_code,1) "DROP POINT NAME",
                 cir_get_drop_point_name(comp_code,unit_code,station_code,2) "DROP POINT NAME OTHER LANG",branch_code "BRANCH NAME",unit_code "UNIT CODE" from
                    (select distinct a.comp_code comp_code,a.unit_code unit_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                     c.station_code station_code,c.branch_code branch_code,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                    cir_dbksup.agcd =  a.agcd and
                                    cir_dbksup.dpcd =  a.dpcd and
                                    cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                 (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,unit_code,agcd,dpcd,ag_name,ag_name_oth_lang,city_code,edtn,edtn_name,edtn_name_oth_lang,station_code,branch_code
                               order by comp_code,unit_code,edtn_name,ag_name;
        open p_accounts1 for----Edition wise total
             select comp_code "COMP CODE",edtn "EDITION CODE",edtn_name "EDITION NAME",edtn_name_oth_lang "EDITION NAME OTHER LANG",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE" from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code,edtn,edtn_name,edtn_name_oth_lang
                               order by comp_code,edtn_name;
        open p_accounts2 for----comp wise total
             select comp_code "COMP CODE",sum(first_sup) "FIRST SUPPLY",sum(second_sup) "SECOND SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),-1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "INCREASE SUPPLY",
             decode(sign(nvl(sum(second_sup),0)-nvl(sum(first_sup),0)),1,0,(nvl(sum(second_sup),0)-nvl(sum(first_sup),0))) "DECREASE SUPPLY",
                         decode(nvl(sum(first_sup),0),0,100,round(((nvl(sum(second_sup),0)-nvl(sum(first_sup),0))*100)/decode(sign(sum(second_sup)-sum(first_sup)),-1,sum(first_sup),sum(second_sup)),2)) "PERCENT_VARIANCE",
                    (select nvl(sum(d.sup_copy),0) from cir_dbksup d,cir_agmast m  where d.comp_code = m.comp_code and d.comp_code = pcomp_code and d.unit_code = m.unit and d.unit_code = punit_code and
                    d.publ = ppublication and (d.edtn = pedtn or pedtn is null) and d.agcd=m.agcd and d.dpcd=m.dpcd and d.supdate = vfirstdate and
                    d.edtn in(select distinct edtn from cir_edtn_mast where comp_code=d.comp_code and edtn = d.edtn and (main_edtn=pmainedtn or pmainedtn is null)) and
                    (d.sup_type_code = pextra2 or pextra2 is null)) first_total_supply from
                    (select distinct a.comp_code comp_code,a.agcd,a.dpcd,c.ag_name,c.ag_name_oth_lang,c.city_code,a.edtn,b.edtn_name,b.edtn_name_oth_lang,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ            =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vfirstdate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) first_sup,
                          (select nvl(sum(sup_copy),0) from cir_dbksup
                               where comp_code    =    pcomp_code and
                                     unit_code    =    punit_code and
                                     publ         =    ppublication and
                                     (edtn           =    pedtn or pedtn is null) and
                                     cir_dbksup.publ =    b.publ and
                                     cir_dbksup.edtn =    b.edtn and
                                     supdate         =    vseconddate and
                                     cir_dbksup.agcd =  a.agcd and
                                     cir_dbksup.dpcd =  a.dpcd and
                                     cir_dbksup.edtn in(select distinct edtn from cir_edtn_mast where comp_code=pcomp_code and 
                                     (edtn = pedtn or pedtn is null) and (main_edtn=pmainedtn or pmainedtn is null))) second_sup
                         from cir_dbksup a,cir_edtn_mast b,cir_agmast c
                         where a.comp_code    =    pcomp_code and a.comp_code    =    b.comp_code and a.comp_code    =    c.comp_code and
                               a.unit_code=punit_code and a.unit_code    =    c.unit and
                               (a.supdate = vfirstdate or a.supdate = vseconddate) and
                               (a.publ=    b.publ) and (a.publ=    ppublication or ppublication is null) and
                               a.edtn=b.edtn and (a.edtn=    pedtn or pedtn is null) and
                               a.agcd=c.agcd and a.dpcd=c.dpcd)
                               where nvl(second_sup,0)-nvl(first_sup,0)<>0
                               group by comp_code
                               order by comp_code;
   End cir_edition_supply_variance_p;
   procedure cir_rep_supply_unit(
     pcomp_code         in varchar2,
     punit_code         in varchar2,
     ppubl              in varchar2,
     pfrom_supdate      in varchar2,
     ptill_supdate      in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     p_accounts         out t_accounts,
     p_accounts1        out t_accounts)
    as
     vfrom_supdate      date;
     vtill_supdate      date;
     cursor cur_sup_type is
         select distinct 'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) "'||s.sup_ty_name||'",' vty,
        'sum(decode(sup_type_code,'||''''||s.sup_ty_code||''''||',sup_copy,0)) +' vty_sum,s.sup_seq_no sup_seq_no
        from cir_supply_type_mast s,cir_dbksup d
        where s.comp_code=d.comp_code and s.comp_code=pcomp_code and d.unit_code=nvl(punit_code,d.unit_code) and
            d.publ=nvl(ppubl,d.publ) and d.supdate between vfrom_supdate and vtill_supdate and
            s.sup_ty_code=d.sup_type_code
            order by sup_seq_no;
     rec_sup_type cur_sup_type%rowtype;
     vvar           varchar2(4000);
     vvar_sum       varchar2(4000);
     vquery         varchar2(4000);
     vquery1        varchar2(4000);
     Begin
       vfrom_supdate:=to_date(pfrom_supdate,''''||pdateformat||'''');
       vtill_supdate:=to_date(ptill_supdate,''''||pdateformat||'''');
    open cur_sup_type;
    loop
        fetch cur_sup_type into rec_sup_type;
      exit when cur_sup_type%notfound;
          vvar        :=vvar||rec_sup_type.vty;
          vvar_sum:=vvar_sum||rec_sup_type.vty_sum;
    end loop;
    close cur_sup_type;
    vvar        :=substr(vvar,1,length(vvar)-1);
    vvar_sum    :=substr(vvar_sum,1,length(vvar_sum)-1);
    --insert into test1(vstring) values (vquery);
    If vvar is null then
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    Else
        vquery:=' select comp_code AS "COMP_CODE",(select distinct "Pub_Cent_name" from pub_cent_mast where "Pub_cent_Code"=unit_code) AS "UNIT_CODE",publ AS "PUBL",cir_get_publ_name(comp_code,publ)AS "PUBL_NAME",sup_rate as "SUP_RATE", supdate AS "SUPDATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||') and
                to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,unit_code,sup_rate,supdate,publ order by comp_code,unit_code,publ_name,supdate,sup_rate';
    End if;                                    
      --          insert into test1(vstring) values ('11'||vquery);commit;
    open p_accounts for vquery;
    If vvar is null then
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",sum(sup_copy) AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    else
        vquery1:=' select comp_code AS "COMP_CODE",sup_rate as "SUP_RATE",'||vvar||','||vvar_sum||' AS "TOTAL" from cir_dbksup where comp_code='||
                ''''||pcomp_code||''''||' and
                ((unit_code='||''''||punit_code||''''||') or ('||''''||punit_code||''''||' is null)) and
                ((publ='||''''||ppubl||''''||') or ('||''''||ppubl||''''||' is null)) and
                supdate between '||'to_date('||''''||pfrom_supdate||''''||','||''''||pdateformat||''''||')
                and to_date('||''''||ptill_supdate||''''||','||''''||pdateformat||''''||')
                group by comp_code,sup_rate order by comp_code,sup_rate';
    end if;
    --insert into test1(vstring) values ('22'||vquery1);commit;
    open p_accounts1 for vquery1;
  End cir_rep_supply_unit;
procedure cir_dist_taluka_publ_wise(
     pcompcode      in varchar2,
     punitcode      in varchar2,
     pbrancode      in varchar2,
     ppublcode      in varchar2,
     pmainedtn      in varchar2,
     pedtncode      in varchar2,
     pdistcode      in varchar2,
     ptalukacode    in varchar2,
     pagtypecode    in varchar2,
     pagclasscode   in varchar2,
     pagcd          in varchar2,
     pdpcd          in varchar2,
     pfrom_supdate  in varchar2,
     ptill_supdate  in varchar2,
     plangtype      in varchar2,
     pdateformat    in varchar2,
     pextra1        in varchar2,--it is used for agency supply type
     pextra2        in varchar2,--it is used for break on district/taluka wise or datewise(1/2)
     p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(32000);
      v_query1    varchar2(32000);
     cursor cur_edtn is
        select distinct d.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (m.agcd=pagcd or pagcd is null) and (m.dpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and  
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='S' and nvl(sup_rate,0)>0
        union
        select p.publ publ,p.publ_seqno publ_seqno,e. edtn edtn,e.EDTN_SEQ_NO edtn_seqno,
        substr(e.edition_nick,1,15) edtn_name,d.sup_rate sup_rate,e.main_edtn main_edtn
        from cir_agmast m,cir_dbksup d ,cir_publ_mast p,cir_edtn_mast e
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and d.comp_code=e.comp_code and m.unit=d.unit_code and d.unit_code = e.unit_code and d.unit_code = punitcode and
              d.supdate between vsupdate and vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and (d.billagcd=pagcd or pagcd is null) and (d.billdpcd=pdpcd or pdpcd is null) and (d.publ=ppublcode or ppublcode is null) and
              d.publ=p.publ and d.edtn=e.edtn and (d.edtn=pedtncode or pedtncode is null) and (e.main_edtn=pmainedtn or pmainedtn is null) and 
              (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
               (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (m.branch_code=pbrancode or pbrancode is null) and pextra1='B' and nvl(sup_rate,0)>0
        order by publ_seqno,publ,edtn_seqno,edtn;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(8000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar        :='sum(decode(d.edtn||d.sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',d.sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar        :='case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'case when d.edtn||d.sup_rate='||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||' then sum(d.sup_copy) else 0 end"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise ',vvar||' , '||vvar_sum1);commit;
        if pextra2='2' then--for datewise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.comp_code = '||''''||pcompcode||''''||' and d.unit_code = m.unit and   
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,d.supdate,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                else
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
                end if;    
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 else   
                    v_query:='select comp_code,unit_code,supdate,
                    station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||'
                    and nvl(d.sup_rate,0)>0 
                    group by d.comp_code,d.unit_code,d.supdate,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,supdate,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,supdate,agency_name';
                 end if;
            end if;
        else--- for district/taluka wise
            if vvar is null then
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and 
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,d.supdate,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agcd,dpcd,agency_name';
                 end if;   
            else
                if upper(pextra1)='S' then
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and '||''''||pextra1||''''||'=''S'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                else    
                    v_query:='select comp_code,unit_code,dist_code,cir_get_name.cir_district(comp_code,dist_code,''1'','||''''||pdateformat||''''||','''','''') dist_name,
                    tehsil_taluka,cir_get_name.cir_taluka(comp_code,tehsil_taluka,''1'','||''''||pdateformat||''''||','''','''') taluka_name,station_code,cir_get_name.cir_drop_point(comp_code,unit_code,station_code,''1'','||''''||pdateformat||''''||','''','''') drop_point,
                    agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd agcd,d.dpcd dpcd,
                    case when '||''''||plangtype||''''||'=''1'' then
                        substr(m.ag_name,1,25)
                    else
                        substr(m.ag_name_oth_lang,1,25)
                    end agency_name,'||vvar||' from cir_dbksup d,cir_agmast m,cir_edtn_mast e
                    where d.comp_code = m.comp_code and d.comp_code = e.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
                    d.unit_code = '||''''||punitcode||''''||' and (d.publ = '||''''||ppublcode||''''||' or '||''''||ppublcode||''''||' is null) and
                    d.edtn=e.edtn and (d.edtn = '||''''||pedtncode||''''||' or '||''''||pedtncode||''''||' is null) and (e.main_edtn = '||''''||pmainedtn||''''||' or '||''''||pmainedtn||''''||' is null) and
                    d.agcd = m.agcd and d.dpcd = m.dpcd and d.billagcd=nvl('||''''||pagcd||''''||',d.billagcd) and d.billdpcd=nvl('||''''||pdpcd||''''||',d.billdpcd) and '||''''||pextra1||''''||'=''B'' and
                    (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
                    (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
                    (m.branch_code='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
                    and nvl(d.sup_rate,0)>0
                    group by d.comp_code,d.unit_code,m.dist_code,m.tehsil_taluka,m.station_code,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang,d.edtn,d.sup_rate)
                    group by comp_code,unit_code,dist_code,tehsil_taluka,station_code,agcd,dpcd,agency_name
                    order by comp_code,unit_code,dist_name,taluka_name,agency_name';
                end if;    
            end if;
        end if;
        --insert into test1(vstring,vstring2) values('cir_dist_taluka_publ_wise v_query',v_query||v_query1);commit;
        open p_accounts for v_query;
    End cir_dist_taluka_publ_wise;
    procedure cir_datewise_resale(
        pcompcode      in varchar2,
        punitcode      in varchar2,
        pbrancode      in varchar2,
        ppublcode      in varchar2,
        pmainedtn      in varchar2,
        pedtncode      in varchar2,
        pdistcode      in varchar2,
        ptalukacode    in varchar2,
        pagtypecode    in varchar2,
        pagclasscode   in varchar2,
        pagcd          in varchar2,
        pdpcd          in varchar2,
        pfrom_supdate  in varchar2,
        ptill_supdate  in varchar2,
        plangtype      in varchar2,
        pdateformat    in varchar2,
        pextra1        in varchar2,
        pextra2        in varchar2,
        p_accounts     out t_accounts)
     as
     vsupdate   date;
     vsupdate1  date;
     v_query    varchar2(8000);
     cursor cur_edtn is
        select distinct d.publ publ,d.edtn edtn,p.edtn_seq_no edtn_seqno,
         case when plangtype='1' then
          substr(p.edition_nick,1,15)
         else
          substr(p.edtn_name_oth_lang,1,20)
         end edtn_name,d.sup_rate sup_rate,p.main_edtn main_edtn
        from cir_agmast m,cir_dbksup_resale d ,cir_edtn_mast p
        where m.comp_code=pcompcode and m.comp_code=d.comp_code and d.comp_code=p.comp_code and m.unit=d.unit_code and 
              m.unit=p.unit_code and d.unit_code = punitcode and
              d.supdate >= vsupdate and d.supdate <=vsupdate1 and
              m.agcd=d.agcd and m.dpcd=d.dpcd and m.agcd=nvl(pagcd,m.agcd) and m.dpcd=nvl(pdpcd,m.dpcd) and d.publ=nvl(ppublcode,d.publ) and
              d.publ=p.publ and d.edtn=p.edtn and (m.dist_code=pdistcode or pdistcode is null) and (m.tehsil_taluka=ptalukacode or ptalukacode is null) and
              (m.ag_type=pagtypecode or pagtypecode is null) and (m.ag_class=pagclasscode or pagclasscode is null) and
              (d.resale_branch=pbrancode or pbrancode is null)
        order by publ,main_edtn,edtn_seqno,edtn,sup_rate;
     rec_edtn cur_edtn%rowtype;
     vvar       varchar2(4000);
     vvar_sum   varchar2(4000);
     vvar_sum1  varchar2(4000);
     vquery     varchar2(8000);
    Begin
        vsupdate :=to_date(pfrom_supdate,''''||pdateformat||'''');
        vsupdate1:=to_date(ptill_supdate,''''||pdateformat||'''');
        --delete test1;insert into test1(vstring,vstring2)
        --values('1111 '||vvar,' vsupdate '||vsupdate||' pdateformat '||pdateformat||' psupdate1 '||vsupdate1||' PEXTRA1 '||pextra1||' pagcd '||pagcd||' pdpcd '||pdpcd);commit;
        open cur_edtn;
        loop
          fetch cur_edtn into rec_edtn;
          exit when cur_edtn%notfound;
            if vvar is null then
                --vvar    :='decode(u.edtn||u.copy_rate,'||''''||rec_edtn.edtn||rec_edtn.copy_rate||''''||',sum(u.return_copy))"'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                --tot_vvar:=',sum("'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'") "'||rec_edtn.edtn||'_'||rec_edtn.copy_rate||'"';
                vvar        :='sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :='sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            else
                vvar        :=vvar||','||'sum(decode(edtn||sup_rate,'||''''||rec_edtn.edtn||rec_edtn.sup_rate||''''||',sup_copy,0))"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum    :=vvar_sum||','||'sum('||'"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'") "'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
                vvar_sum1   :=vvar_sum1||'+"'||rec_edtn.edtn_name||'_'||rec_edtn.sup_rate||'"';
            end if;
        end loop;
        close cur_edtn;
        if vvar_sum1 is not null then
            vvar_sum1:=vvar_sum1||') Total';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale ',vvar||' , '||vvar_sum1);commit;
        if vvar is null then
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name from(select d.comp_code,d.unit_code,d.agcd agcd,d.dpcd dpcd,d.supdate supdate,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <='||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agcd,dpcd,agency_name';
        else
            v_query:='select comp_code,unit_code,supdate,
            agcd,dpcd,agency_name,'||vvar_sum||','||vvar_sum1||' from(select d.comp_code,d.unit_code,d.supdate supdate,d.agcd agcd,d.dpcd dpcd,
            case when '||''''||plangtype||''''||'=''1'' then
                substr(m.ag_name,1,25)
            else
                substr(m.ag_name_oth_lang,1,25)
            end agency_name,'||vvar||' from cir_dbksup_resale d,cir_agmast m
            where d.comp_code = m.comp_code and d.unit_code = m.unit and d.comp_code = '||''''||pcompcode||''''||' and
            d.unit_code = '||''''||punitcode||''''||' and d.publ = nvl('||''''||ppublcode||''''||',d.publ) and
            d.agcd = m.agcd and d.dpcd = m.dpcd and d.agcd=nvl('||''''||pagcd||''''||',d.agcd) and d.dpcd=nvl('||''''||pdpcd||''''||',d.dpcd) and 
            (m.dist_code = '||''''||pdistcode||''''||' or '||''''||pdistcode||''''||' is null) and (m.tehsil_taluka = '||''''||ptalukacode||''''||' or '||''''||ptalukacode||''''||' is null) and
            (m.ag_type='||''''||pagtypecode||''''||' or '||''''||pagtypecode||''''||' is null) and (m.ag_class='||''''||pagclasscode||''''||' or '||''''||pagclasscode||''''||' is null) and
            (d.resale_branch='||''''||pbrancode||''''||' or '||''''||pbrancode||''''||' is null) and d.supdate >= '||''''||vsupdate||''''||' and d.supdate <= '||''''||vsupdate1||''''||' 
            group by d.comp_code,d.unit_code,d.supdate,d.agcd,d.dpcd,m.ag_name,m.ag_name_oth_lang)
            group by comp_code,unit_code,supdate,agcd,dpcd,agency_name
            order by comp_code,unit_code,supdate,agency_name';
        end if;
        --insert into test1(vstring,vstring2) values('cir_datewise_resale v_query',v_query);commit;
        open p_accounts for v_query;
    End cir_datewise_resale;
END cir_rep_supply;
/
///////////////////////////////////////////////end by Garima

////////////////////add By Garima
CREATE OR REPLACE procedure cir_rep_supply_detail_p(
    pcomp_code      in varchar2,
    punit_code      in varchar2,
    ppubl           in varchar2,
    pdateformat     in varchar2,
    puserid         in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pextra3         in varchar2,
    pextra4         in varchar2,
    pextra5         in varchar2,
    pextra6         in varchar2,
    pextra7         in varchar2,
    pextra8         in varchar2,
    pextra9         in varchar2,
    pextra10        in varchar2,
    p_accounts      OUT Cur_Type_New1.cursor_type)
As
Begin

    open p_accounts for
    select m.comp_code as "COMP_CODE", m.unit as "UNIT", m.agcd as "AGCD", m.dpcd as "DPCD",m.ag_name as "AG_NAME",
    m.station_code as "DROP_POINT",cir_get_drop_point_name(m.comp_code,m.unit,m.station_code,1) as "DROP_POINT_NAME",
    m.city_code as "CITY_CODE", cir_get_city(m.comp_code,m.city_code) as "CITY_NAME", s.publ as "PUBL",p.publ_name as "PUBL_NAME",
    e.main_edtn as "MAIN_EDTN",cir_get_edtn_name(m.comp_code,e.main_edtn) as "MAIN_EDTN_NAME",
    s.edtn as "EDTN",e.edtn_name as "EDTN_NAME",
    s.supply_flag as "SUPPLY_FLAG", s.supply_type_code as "SUPPLY_TYPE_CODE",t.sup_ty_name as "SUP_TY_NAME",
    s.base_supply as "BASE_SUPPLY", s.supply_sun as "SUPPLY_SUN", s.supply_mon as "SUPPLY_MON", s.supply_tue as "SUPPLY_TUE", s.supply_wed as "SUPPLY_WED",
    s.supply_thu as "SUPPLY_THU", s.supply_fri as "SUPPLY_FRI", s.supply_sat as "SUPPLY_SAT", s.supply_spl1 as "SUPPLY_SPL1", s.supply_spl2 as "SUPPLY_SPL2",
    m.SUSPEND_DATE as"SUSPEND_DATE",get_suspend_type(m.suspend_type) as"SUSPEND_TYPE"
    from cir_supply s,cir_agmast m,cir_publ_mast p,cir_edtn_mast e,cir_supply_type_mast t
    where m.comp_code=s.comp_code and m.comp_code=p.comp_code and m.comp_code=e.comp_code and m.comp_code=t.comp_code and m.comp_code=nvl(pcomp_code,m.comp_code) and
    m.unit=s.unit and m.unit=nvl(punit_code,m.unit) and m.agcd=s.agcd and  m.dpcd=s.dpcd and s.publ=p.publ and s.publ=nvl(ppubl,s.publ) and
    s.edtn=e.edtn and s.supply_type_code=t.sup_ty_code
    --and nvl(m.freeze_flag,'N') ='N' and nvl(m.suspend,'N')='Y'
    order by comp_code,unit,city_name,drop_point_name,ag_name,publ_name,main_edtn_name,edtn_name,sup_ty_name;

End cir_rep_supply_detail_p;
/

//////////////////////////End By Garima


//////////////////////////////////////////send by laxman sir 29/02/2012////////////////////////////////////////////////


CREATE OR REPLACE PACKAGE Cir_Genrate_Code IS
    type p_circul_cursor is ref cursor;
PROCEDURE agency_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE agency_class_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE suspend_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE area_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE publ_mast_p(
   pcompcode    in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   ppubl_code   out p_circul_cursor);

PROCEDURE edtn_mast_p (
    pcompcode   in varchar2,
    ppubl_code  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pedtn_code  out p_circul_cursor);

PROCEDURE agmast_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pag_code    out p_circul_cursor);

PROCEDURE agsubcode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pag_code        out p_circul_cursor);

PROCEDURE areacode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    parea_code      out p_circul_cursor);

PROCEDURE drop_point_code_P (
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pdrop_point_code    out p_circul_cursor);

Procedure executive_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pexe_code   out p_circul_cursor);

PROCEDURE routecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    prt_code    out p_circul_cursor);

PROCEDURE subroutecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    prtcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psubrt_code out p_circul_cursor);

PROCEDURE subsubroutecode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    prtcode         in varchar2,
    psubrtcode      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    psubsubrt_code  out p_circul_cursor);

PROCEDURE transportercode_P (
    pcompcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptp_code    out p_circul_cursor);

PROCEDURE districtcode_P (
    pcompcode   in varchar2,
    pstatecode  in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdist_code  out p_circul_cursor);

PROCEDURE comm_catg_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE comm_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE zone_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE taluka_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE receipt_p (
    pcompcode   in varchar2,
    pbranchcode in varchar2,
    pdoctype    in varchar2,
    precptdt    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE mode_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE supply_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE expenses_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE city_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor);

PROCEDURE cir_region_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preg_code   out p_circul_cursor);

PROCEDURE cir_unsold_receipt_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preceipt_no out p_circul_cursor);

PROCEDURE cir_surcharge_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor);

PROCEDURE cir_roleMatser_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor);

PROCEDURE cir_narr_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pnarr_cd        out p_circul_cursor);

Procedure cir_taxi_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptaxi_code  out p_circul_cursor);

PROCEDURE cir_lable_htmlformatid_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pformat_id  out p_circul_cursor);
PROCEDURE cir_installment_code_p (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pcode       out p_circul_cursor);
PROCEDURE race_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);  
    
PROCEDURE inct_slab_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);
PROCEDURE festival_code_P (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    ptype_code      out p_circul_cursor); 
PROCEDURE mach_config_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);
    
PROCEDURE spons_code_P (
    pcompcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code     out p_circul_cursor);
    
PROCEDURE cir_unsold_scnction_p (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdoctype    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,--for unsold receipt date
    pextra2     in varchar2,--for agency or distribution
    preceipt_no out p_circul_cursor);    
END Cir_Genrate_Code;
/
CREATE OR REPLACE PACKAGE BODY Cir_Genrate_Code IS
PROCEDURE agency_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(agency_type_code,3,5))+1 into vno from cir_agency_typ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
      vtype_code:='AT'||'001';
     Else
    vtype_code:='AT'||lpad(vno,3,'0');
     End if;

  open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_type_p;

PROCEDURE agency_class_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(8);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select to_number(max(substr(class_code,3,5)))+1 into vno from cir_agency_class_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='AC'||'001';
     Else
        vtype_code:='AC'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End agency_class_p;

PROCEDURE suspend_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(suspend_type_code,3,5))+1 into vno from cir_suspend_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        vtype_code:='ST'||'001';
     Else
        vtype_code:='ST'||lpad(vno,3,'0');
     End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End suspend_type_p;

PROCEDURE area_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(area_type,3,5))+1 into vno from cir_area_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
    vtype_code:='AR'||'001';
    Else
    vtype_code:='AR'||lpad(vno,3,'0');
    End if;

     open ptype_code for select vtype_code as "VAR_CODE" from dual;

End area_type_p;

PROCEDURE publ_mast_p(
   pcompcode    in varchar2,
   pdateformat  in varchar2,
   pextra1      in varchar2,
   pextra2      in varchar2,
   ppubl_code   out p_circul_cursor) as
    vno         number(5);
    vpubl_code  varchar2(15);

BEGIN

    Begin
       select max(to_number(substr(publ,2)))+1 into vno from cir_publ_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vpubl_code:='P'||'01';
    Else
        vpubl_code:='P'||lpad(vno,2,'0');
    End if;

    open ppubl_code for  select vpubl_code as "VAR_CODE" from dual;

End publ_mast_p;

PROCEDURE edtn_mast_p (
    pcompcode   in varchar2,
    ppubl_code  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pedtn_code  out p_circul_cursor) as
    vno         number(5);
    vedtn_code  varchar2(15);
BEGIN

    Begin
       select max(substr(edtn,2))+1 into vno from cir_edtn_mast where comp_code=pcompcode /*and publ=ppubl_code*/;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vedtn_code:=/*'E'||*/'001';
    Else
        vedtn_code:=/*'E'||*/lpad(vno,3,'0');
    End if;

    open pedtn_code for select vedtn_code as "VAR_CODE" from dual;

End edtn_mast_p;

PROCEDURE agmast_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pag_code    out p_circul_cursor) as
    vno         number(8);
    vag_code    varchar2(8);
    v_prefix    varchar2(20);
Begin

    Begin
        if upper(pextra2)='D' then
          v_prefix:='D'||upper(pprefix);
          select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast_dis
              where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        else
            v_prefix:=upper(pprefix);
            select max(substr(agcd,length(v_prefix)+1))+1 into vno from cir_agmast
                  where comp_code=pcompcode and unit=punitcode and upper(substr(agcd,1,length(v_prefix)))=upper(v_prefix);
        end if;
    Exception when others then
         vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:=upper(v_prefix)||'0001';
    else
       vag_code:=upper(v_prefix)||lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agmast_P;

PROCEDURE agsubcode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pagcode         in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pag_code        out p_circul_cursor) as
    vno             number(8);
    vag_code        varchar2(8);

BEGIN

    Begin
        if upper(pextra2)='D' then
            select to_number(max(dpcd))+1 into vno from cir_agmast_dis
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        else
            select to_number(max(dpcd))+1 into vno from cir_agmast
                where comp_code=pcompcode and unit=punitcode and upper(agcd)=upper(pagcode);
        end if;
    Exception when others then
      vno:=0;
    End;
    if nvl(vno,0)=0 then
       vag_code:='0001';
    else
       vag_code:=lpad(vno,4,'0');
    end if;

    open pag_code for select vag_code as "VAR_CODE" from dual;

End agsubcode_P;

PROCEDURE areacode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    parea_code      out p_circul_cursor) as
    vno             number(8);
    varea_code      varchar2(15);

BEGIN

    Begin
       select max(substr(area_code,2,5))+1 into vno from cir_area_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
     If nvl(vno,0)=0 Then
        varea_code:='A'||'0001';
     Else
        varea_code:='A'||lpad(vno,4,'0');
     End if;

    open parea_code for select varea_code as "VAR_CODE" from dual;

End areacode_P;

PROCEDURE drop_point_code_P (
    pcompcode           in varchar2,
    punitcode           in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pdrop_point_code    out p_circul_cursor) as
    vno         number(8);
    vdrop_point varchar2(15);

BEGIN

    Begin
        select max(substr(drop_point,2,5))+1 into vno from cir_drop_point_mast where comp_code=pcompcode and unit_code=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vdrop_point:='D'||'0001';
    Else
        vdrop_point:='D'||lpad(vno,4,'0');
    End if;

    open pdrop_point_code for select vdrop_point as "VAR_CODE" from dual;

End drop_point_code_P;

Procedure executive_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pexe_code   out p_circul_cursor) as
    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
       select max(substr(executive_code,2,5))+1 into vno from cir_executive_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        v_code:='E'||'00001';
    Else
        v_code:='E'||lpad(vno,5,'0');
    End if;

    open pexe_code for select v_code as "VAR_CODE" from dual;

End executive_code_p;

PROCEDURE routecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    prt_code    out p_circul_cursor) As
    vno         number(8);
    vrt_code    varchar2(15);
BEGIN
    Begin
       select max(substr(route_code,3,5))+1 into vno from cir_route_mast where comp_code=pcompcode and unit=punitcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vrt_code:='RT'||'001';
    Else
        vrt_code:='RT'||lpad(vno,3,'0');
    End if;

    open prt_code for select vrt_code as "VAR_CODE" from dual;

End routecode_P;

PROCEDURE subroutecode_P (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    prtcode     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psubrt_code out p_circul_cursor) as
    vno         number(8);
    vsubrt_code varchar2(15);
BEGIN
    Begin
        select max(substr(subrt_code,3,5))+1 into vno from cir_sub_route_mast where comp_code=pcompcode and unit=punitcode and route_code=prtcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubrt_code:='SR'||'001';
    Else
        vsubrt_code:='SR'||lpad(vno,3,'0');
    End if;

    open psubrt_code for select vsubrt_code as "VAR_CODE" from dual;

End subroutecode_P;

PROCEDURE subsubroutecode_P (
    pcompcode       in varchar2,
    punitcode       in varchar2,
    prtcode         in varchar2,
    psubrtcode      in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    psubsubrt_code  out p_circul_cursor) as
    vno             number(8);
    vsubsubrt_code  varchar2(15);
BEGIN
    Begin
        select max(substr(sub_subrt_code,3,5))+1 into vno from cir_sub_subroute_mast
            where comp_code=pcompcode and unit=punitcode and route_code=prtcode and
                    subrt_code=psubrtcode;
    Exception When Others Then
       vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsubsubrt_code:='SS'||'001';
    Else
        vsubsubrt_code:='SS'||lpad(vno,3,'0');
    End if;
    open psubsubrt_code for select vsubsubrt_code as "VAR_CODE" from dual;

End subsubroutecode_P;

PROCEDURE transportercode_P (
    pcompcode   in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptp_code    out p_circul_cursor) as
    vno         number(8);
    vtp_code    varchar2(8);

Begin

    Begin
        select max(substr(transporter_code,2))+1 into vno from cir_transporter_mast
            where comp_code=pcompcode and upper(substr(transporter_code,1,1))=upper(pprefix);
    Exception when others then
        vno:=0;
    End;

    if nvl(vno,0)=0 then
        vtp_code:=upper(pprefix)||'0001';
    else
        vtp_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open ptp_code for select vtp_code as "VAR_CODE" from dual;
End transportercode_P;

PROCEDURE districtcode_P (
    pcompcode   in varchar2,
    pstatecode  in varchar2,
    pprefix     in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pdist_code  out p_circul_cursor) as
    vno         number(8);
    vdist_code  varchar2(8);

Begin

    Begin
        select max(substr(dist_code,3))+1 into vno from cir_dist_mast
            where comp_code=pcompcode and upper(substr(dist_code,1,2))=upper(pprefix);
    Exception when others then
    vno:=0;
    End;
    if nvl(vno,0)=0 then
        vdist_code:=upper(pprefix)||'0001';
    else
        vdist_code:=upper(pprefix)||lpad(vno,4,'0');
    end if;

    open pdist_code for select vdist_code as "VAR_CODE" from dual;

End districtcode_P;

PROCEDURE comm_catg_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);
    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_catg_code,3,5))+1 into vno from cir_comm_catg_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='C';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_catg_p;

PROCEDURE comm_p (
    pcompcode   in varchar2,
    pcomm_type  in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

    vcomm_type  varchar2(1);
BEGIN

    Begin
        select max(substr(comm_code,3,5))+1 into vno from cir_comm_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If pcomm_type is null then
        vcomm_type:='F';
    Else
        vcomm_type:=pcomm_type;
    End if;
    If nvl(vno,0)=0 Then
        vtype_code:='C'||pcomm_type||'001';
    Else
        vtype_code:='C'||pcomm_type||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End comm_p;

PROCEDURE zone_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor) as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(zone_code,3,5))+1 into vno from cir_zone_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='ZN'||'001';
    Else
        vtype_code:='ZN'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End zone_p;

PROCEDURE taluka_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(talu_code,3,6))+1 into vno from cir_taluka_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='TK'||'0001';
    Else
        vtype_code:='TK'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End taluka_p;

PROCEDURE receipt_p (
    pcompcode   in varchar2,
    pbranchcode in varchar2,
    pdoctype    in varchar2,
    precptdt    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(20);
    vrecptno  varchar2(15);
    v_dt date;
BEGIN

    v_dt:=to_date(precptdt,''''||pdateformat||'''');

    Begin
       if upper(pextra2)='D' then
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr_dis
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       else
        select max(to_number(substr(recptno,-8)))+1 into vno from cir_rcphdr
            where comp_code=pcompcode and doctype=pdoctype and to_char(recptdt,'yymm')=to_char(v_dt,'yymm') and branch_code=pbranchcode;
       end if;
    Exception When Others Then
       vno:=null;
    End;

    If nvl(vno,0)=0 Then
      vrecptno:=pbranchcode||'-'||to_char(v_dt,'yymm')||'0001';
    Else
      vrecptno:=pbranchcode||'-'||lpad(vno,8,'0');
    End if;

    open ptype_code for select vrecptno as "VAR_CODE" from dual;

End receipt_p;

PROCEDURE mode_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(mode_code,3,3))+1 into vno from cir_route_mode_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='RM'||'001';
    Else
        vtype_code:='RM'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End mode_p;

PROCEDURE supply_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(sup_ty_code,2,2))+1 into vno from cir_supply_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='S'||'01';
    Else
        vtype_code:='S'||lpad(vno,2,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End supply_type_p;

PROCEDURE expenses_type_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(exp_type_code,2,3))+1 into vno from cir_expenses_type_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='E'||'001';
    Else
        vtype_code:='E'||lpad(vno,3,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End expenses_type_p;

PROCEDURE city_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptype_code  out p_circul_cursor)
    as
    vno         number(5);
    vtype_code  varchar2(15);

BEGIN

    Begin
       select max(substr(city_code,3,6))+1 into vno from cir_city_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 then
        vtype_code:='CT'||'0001';
    Else
        vtype_code:='CT'||lpad(vno,4,'0');
    End if;

    open ptype_code for select vtype_code as "VAR_CODE" from dual;

End city_p;

PROCEDURE cir_region_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    preg_code   out p_circul_cursor)
    as
    vno         number(5);
    vreg_code   varchar2(15);
BEGIN

    Begin
       select max(substr(reg_code,3,6))+1 into vno from cir_region_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vreg_code:='RG'||'0001';
    Else
        vreg_code:='RG'||lpad(vno,4,'0');
    End if;

    open preg_code for select vreg_code as "VAR_CODE" from dual;

End cir_region_p;

PROCEDURE cir_unsold_receipt_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    preceipt_no     out p_circul_cursor)
    As
    vno number(5);
    vtype_code  varchar2(15);
    v_sess_id   number(20);
    v_prefix    varchar2(20);
    v_no        varchar2(20);
    v_dt        date;
    v_chkdt     date;
BEGIN
    /*loop
     begin
        select gen_unsold_rec_yn into v_gen_unsold_rec_yn from cir_control;
        if nvl(v_gen_unsold_rec_yn,'N')  = 'N' then
           exit;
        end if;
        exception when no_data_found then
            insert into cir_control values('Y');
            exit;
     end;
    end loop;
    update cir_control set GEN_UNSOLD_REC_YN='Y';commit;*/

    /*Begin
        if upper(pextra2)='D' then
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr_dis where comp_code=pcompcode;
        else
            select max(substr(RECPTNO,3,8))+1 into vno from cir_unsold_hdr where comp_code=pcompcode;
        end if;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vtype_code:='UN'||'000001';
    Else
        vtype_code:='UN'||lpad(vno,6,'0');
    End if;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
    */

    v_dt    :=to_date(pextra1,''''||pdateformat||'''');
    v_prefix:='UN'||to_char(v_dt,'yymm');

    select trunc(v_dt,'mm') into v_chkdt from dual;

    begin
        select curr_no into v_no from cir_series
        where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    exception when no_data_found then
        v_no:=null;
    end;

    if v_no is null or v_no='0' then
        vtype_code:=v_prefix||'00001';
        insert into cir_series(comp_code,unit_code,branch_code,ty,year_monid,prefix, curr_no)
        values(pcompcode,null,null,'UCN',trunc(v_dt,'mm'),v_prefix,1);
    else
        v_no        :=to_number(v_no)+1;
        vtype_code  :=v_prefix||lpad(v_no,5,'0');
        update cir_series set curr_no=nvl(curr_no,0)+1
            where comp_code=pcompcode and ty='UCN' and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    end if;
    commit;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
End cir_unsold_receipt_p;

PROCEDURE cir_surcharge_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
            select max(substr(surch_cd,2,3))+1 into vno from cir_surcharge_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='S'||'001';
    Else
        vsurch_cd:='S'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_surcharge_p;

PROCEDURE cir_roleMatser_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    psurch_cd   out p_circul_cursor)
    as
    vno         number(5);
    vsurch_cd   varchar2(15);

BEGIN

    Begin
       select max(substr(role_code,2,3))+1 into vno from cir_role_mast where comp_code=pcompcode;
          Exception When Others Then
               vno:=null;
    End;
    If nvl(vno,0)=0 Then
        vsurch_cd:='R'||'001';
    Else
        vsurch_cd:='R'||lpad(vno,3,'0');
    End if;

    open psurch_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_roleMatser_p;

PROCEDURE cir_narr_p (
    pcompcode       in varchar2,
    pdateformat     in varchar2,
    pextra1         in varchar2,
    pextra2         in varchar2,
    pnarr_cd        out p_circul_cursor)
    as
    vno             number(5);
    vsurch_cd       varchar2(15);
BEGIN
    Begin
        select max(substr(na_code,3,4))+1 into vno from fa_vch_narration_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        vsurch_cd:='N'||'001';
    Else
        vsurch_cd:='N'||lpad(vno,3,'0');
    End if;

    open pnarr_cd for select vsurch_cd as "VAR_CODE" from dual;

End cir_narr_p;

Procedure cir_taxi_code_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    ptaxi_code  out p_circul_cursor) as

    vno         number(8);
    v_code      varchar2(15);

Begin

    Begin
        select max(substr(taxi_id,2,4))+1 into vno from cir_taxi_mast where comp_code=pcompcode;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='V'||'0001';
    Else
        v_code:='V'||lpad(vno,4,'0');
    End if;

    open ptaxi_code for select v_code as "VAR_CODE" from dual;

End cir_taxi_code_p;

PROCEDURE cir_lable_htmlformatid_p (
    pcompcode   in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,
    pextra2     in varchar2,
    pformat_id  out p_circul_cursor)
    As
    vno         number(8);
    v_code      varchar2(15);
    v_sess_id   number(20);
Begin
    Begin
        select max(formatid)+1 into vno from cir_lable_htmlformat;
    Exception When Others Then
        vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:=1;
    Else
        v_code:=vno;
    End if;
    insert into cir_lable_htmlformat(comp_code,formatid,format_desc) values(pcompcode,v_code,pextra1);commit;
    open pformat_id for select v_code as "FORMAT_ID" from dual;

End cir_lable_htmlformatid_p;
PROCEDURE cir_installment_code_p (
        pcompcode   in varchar2,
        punitcode   in varchar2,
        pdateformat in varchar2,
        pextra1     in varchar2,
        pextra2     in varchar2,
        pcode       out p_circul_cursor) as
    vno         number(10);
    v_code      varchar2(15);
    Begin

    Begin
        select max(substr(inst_code,2,7))+1 into vno from cir_installment_mast where comp_code=pcompcode;
        Exception When Others Then
            vno:=null;
    End;

    If nvl(vno,0)=0 Then
        v_code:='I'||'0000001';
    Else
        v_code:='I'||lpad(vno,7,'0');
    End if;

    open pcode for select v_code as "VAR_CODE" from dual;

    End cir_installment_code_p;
PROCEDURE race_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN
    Begin
       select to_number(max(substr(race_code,3,5)))+1 into vno from cir_race_mast;
    Exception When Others Then
        vno:=null;
    End;
    
    If nvl(vno,0)=0 Then
        vtype_code:='RC'||'001';
    Else
        vtype_code:='RC'||lpad(vno,3,'0');
    End if;
    open ptype_code for select vtype_code as "VAR_CODE" from dual;
    
End race_code_P; 

PROCEDURE inct_slab_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(inct_slab_id),0)+1 into vno from cir_inct_slab_hdr;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End inct_slab_code_p;   

PROCEDURE festival_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
    vtype_code  varchar2(25);
BEGIN

    select nvl(max(fest_code),0)+1 into vno from cir_festival_mast;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End festival_code_p;

PROCEDURE mach_config_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
BEGIN

    select nvl(max(MACH_ID),0)+1 into vno from cir_mach_config_mast;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End mach_config_code_p;

PROCEDURE spons_code_P (
    pcompcode 	in varchar2,
    pdateformat in varchar2,
    pextra1 	in varchar2,
    pextra2 	in varchar2,
    ptype_code 	out p_circul_cursor) as
    
    vno         number(8);
BEGIN

    select nvl(max(SPONS_ID),0)+1 into vno from CIR_SPONS_HDR;
    

    open ptype_code for select vno as "VAR_CODE" from dual;
    
End spons_code_P;

PROCEDURE cir_unsold_scnction_p (
    pcompcode   in varchar2,
    punitcode   in varchar2,
    pdoctype    in varchar2,
    pdateformat in varchar2,
    pextra1     in varchar2,--for unsold receipt date
    pextra2     in varchar2,--for agency or distribution
    preceipt_no out p_circul_cursor)
    As
    vno number(5);
    vtype_code  varchar2(15);
    v_sess_id   number(20);
    v_prefix    varchar2(20);
    v_no        varchar2(20);
    v_dt        date;
    v_chkdt     date;
BEGIN

    v_dt    :=to_date(pextra1,''''||pdateformat||'''');
    v_prefix:='SN'||to_char(v_dt,'yymm');

    select trunc(v_dt,'mm') into v_chkdt from dual;

    begin
        select curr_no into v_no from cir_series
        where comp_code=pcompcode and unit_code=punitcode and 
        ty=nvl(pdoctype,'SCN') and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    exception when no_data_found then
        v_no:=null;
    end;

    if v_no is null or v_no='0' then
        vtype_code:=v_prefix||'00001';
        insert into cir_series(comp_code,unit_code,branch_code,ty,year_monid,prefix, curr_no)
        values(pcompcode,punitcode,null,nvl(pdoctype,'SCN'),trunc(v_dt,'mm'),v_prefix,1);
    else
        v_no        :=to_number(v_no)+1;
        vtype_code  :=v_prefix||lpad(v_no,5,'0');
        update cir_series set curr_no=nvl(curr_no,0)+1
            where comp_code=pcompcode and unit_code=punitcode and 
            ty=nvl(pdoctype,'SCN') and trunc(year_monid,'mm')=v_chkdt and prefix=v_prefix;
    end if;
    commit;

    open preceipt_no for
    select vtype_code as "VAR_CODE" from dual;
    
End cir_unsold_scnction_p;
END Cir_Genrate_Code;
/

//////////////////////////////////////////////end of procedure////////////////////////////////////////////////////////////////////////////////



///////////////////////////////////////sent by Laxman sir 29/02/2012 updated by Deepika////////////////////////////////
CREATE OR REPLACE PROCEDURE cir_route_drop_point_detail_p
   (pcomp_code          in varchar2,
    punit_code          in varchar2,
    ptaxi_code          in varchar2,
    proute_code         in varchar2,
    psubroutecode       in varchar2,
    psub_subroutecode   in varchar2,
    puserid             in varchar2,
    pdateformat         in varchar2,
    pextra1             in varchar2,
    pextra2             in varchar2,
    pextra3             in varchar2,
    pextra4             in varchar2,
    pextra5             in varchar2,
    p_accounts          OUT Cur_Type_New1.cursor_type)
  As
Begin
    if proute_code is not null and psubroutecode is null then        

        open p_accounts for 
        select distinct x.comp_code comp_code, x.unit_code unit_code, x.tpt_code tpt_code,x.tpt_name tpt_name,
        x.rt_code rt_code,x.rt_name rt_name,x.subrt_code subrt_code, x.subrt_name subrt_name,x.sub_subrt_code sub_subrt_code,x.sub_subrt_name sub_subrt_name,
        x.taxi_id taxi_id, x.vehicle_name vehicle_name, x.vehicle_no vehicle_no,
        y.drop_point_code drop_point_code,y.drop_point_name drop_point_name,y.latitude latitude,y.lognitude lognitude,
        min(y.lbl_printno) lbl_printno 
        from
        (select t.comp_code comp_code, t.unit_code unit_code, t.tpt_code tpt_code,(select transporter_name from cir_transporter_mast where comp_code=t.comp_code and transporter_code=t.tpt_code) tpt_name,
        t.rt_code rt_code,r.route_name rt_name,   
        t.subrt_code subrt_code,(select subrt_name from cir_sub_route_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code) subrt_name, 
        t.sub_subrt_code sub_subrt_code,(select sub_subrt_name from cir_sub_subroute_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code and sub_subrt_code=t.sub_subrt_code) sub_subrt_name,
        t.taxi_id ,t.vehicle_name vehicle_name, t.vehicle_no vehicle_no
        from cir_taxi_mast t,cir_route_mast r
        where t.comp_code=r.comp_code and t.comp_code=pcomp_code and t.unit_code=r.unit and (t.unit_code=punit_code or punit_code is null) and 
        t.rt_code=r.route_code and (t.rt_code=proute_code or proute_code is null) and taxi_id=ptaxi_code) x,
        (select distinct b.comp_code comp_code,b.unit unit_code,b.route_code route_code,b.subroute_code subroute_code,
        b.sub_subroute_code sub_subroute_code,a.station_code drop_point_code,c.drop_point_name drop_point_name,
        c.latitude latitude,c.lognitude lognitude,b.lbl_printno lbl_printno
        from cir_agmast a,cir_supply b,cir_drop_point_mast c
        where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit=b.unit and
        a.unit=c.unit_code and (a.unit=punit_code or  punit_code is null) and a.agcd=b.agcd and a.dpcd=b.dpcd and
        a.station_code=c.drop_point and (b.route_code=proute_code or proute_code is null) and 
        nvl(a.suspend,'N')='N' and nvl(a.freeze_flag,'N')='N' and nvl(c.freeze_flag,'N')='N') y
        where x.comp_code=y.comp_code and x.unit_code=y.unit_code and x.rt_code=y.route_code and y.subroute_code is null
        group by x.comp_code, x.unit_code, x.tpt_code,x.tpt_name,
        x.rt_code,x.rt_name,x.subrt_code, x.subrt_name,x.sub_subrt_code,x.sub_subrt_name,
        x.taxi_id, x.vehicle_name, x.vehicle_no,
        y.drop_point_code,y.drop_point_name,y.latitude,y.lognitude 
        order by x.comp_code, x.unit_code,x.taxi_id,lbl_printno,y.drop_point_name;

    elsif psubroutecode is not null and psub_subroutecode is null then
        open p_accounts for
        select distinct x.comp_code comp_code, x.unit_code unit_code, x.tpt_code tpt_code,x.tpt_name tpt_name,
        x.rt_code rt_code,x.rt_name rt_name,x.subrt_code subrt_code, x.subrt_name subrt_name,x.sub_subrt_code sub_subrt_code,x.sub_subrt_name sub_subrt_name,
        x.taxi_id taxi_id, x.vehicle_name vehicle_name, x.vehicle_no vehicle_no,
        y.drop_point_code drop_point_code,y.drop_point_name drop_point_name,y.latitude latitude,y.lognitude lognitude,
        min(y.lbl_printno) lbl_printno 
        from
        (select t.comp_code comp_code, t.unit_code unit_code, t.tpt_code tpt_code,(select transporter_name from cir_transporter_mast where comp_code=t.comp_code and transporter_code=t.tpt_code) tpt_name,
        t.rt_code rt_code,r.route_name rt_name,  
        t.subrt_code subrt_code,(select subrt_name from cir_sub_route_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code) subrt_name, 
        t.sub_subrt_code sub_subrt_code,(select sub_subrt_name from cir_sub_subroute_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code and sub_subrt_code=t.sub_subrt_code) sub_subrt_name,
        t.taxi_id ,t.vehicle_name vehicle_name, t.vehicle_no vehicle_no
        from cir_taxi_mast t,cir_route_mast r
        where t.comp_code=r.comp_code and t.comp_code=pcomp_code and t.unit_code=r.unit and (t.unit_code=punit_code or punit_code is null) and 
        t.rt_code=r.route_code and (t.rt_code=proute_code or proute_code is null) and taxi_id=ptaxi_code) x,
        (select distinct b.comp_code comp_code,b.unit unit_code,b.route_code route_code,b.subroute_code subroute_code,
        b.sub_subroute_code sub_subroute_code,a.station_code drop_point_code,c.drop_point_name drop_point_name,
        c.latitude latitude,c.lognitude lognitude,b.lbl_printno lbl_printno
        from cir_agmast a,cir_supply b,cir_drop_point_mast c
        where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit=b.unit and
        a.unit=c.unit_code and (a.unit=punit_code or punit_code is null) and a.agcd=b.agcd and a.dpcd=b.dpcd and
        a.station_code=c.drop_point and (b.route_code=proute_code or proute_code is null) and 
        nvl(a.suspend,'N')='N' and nvl(a.freeze_flag,'N')='N' and nvl(c.freeze_flag,'N')='N') y
        where x.comp_code=y.comp_code and x.unit_code=y.unit_code and x.rt_code=y.route_code and 
        x.subrt_code=y.subroute_code and (x.subrt_code=psubroutecode or psubroutecode is null) and y.subroute_code is not null and y.sub_subroute_code is null
        group by x.comp_code, x.unit_code, x.tpt_code,x.tpt_name,
        x.rt_code,x.rt_name,x.subrt_code, x.subrt_name,x.sub_subrt_code,x.sub_subrt_name,
        x.taxi_id, x.vehicle_name, x.vehicle_no,
        y.drop_point_code,y.drop_point_name,y.latitude,y.lognitude 
        order by x.comp_code, x.unit_code,x.taxi_id,y.drop_point_name;

    else
        open p_accounts for
        select distinct x.comp_code comp_code, x.unit_code unit_code, x.tpt_code tpt_code,x.tpt_name tpt_name,
        x.rt_code rt_code,x.rt_name rt_name,x.subrt_code subrt_code, x.subrt_name subrt_name,x.sub_subrt_code sub_subrt_code,x.sub_subrt_name sub_subrt_name,
        x.taxi_id taxi_id, x.vehicle_name vehicle_name, x.vehicle_no vehicle_no,
        y.drop_point_code drop_point_code,y.drop_point_name drop_point_name,y.latitude latitude,y.lognitude lognitude,
        min(y.lbl_printno) lbl_printno 
        from
        (select t.comp_code comp_code, t.unit_code unit_code, t.tpt_code tpt_code,(select transporter_name from cir_transporter_mast where comp_code=t.comp_code and transporter_code=t.tpt_code) tpt_name,
        t.rt_code rt_code,r.route_name rt_name, 
        t.subrt_code subrt_code,(select subrt_name from cir_sub_route_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code) subrt_name, 
        t.sub_subrt_code sub_subrt_code,(select sub_subrt_name from cir_sub_subroute_mast where comp_code=t.comp_code and unit=t.unit_code and route_code=t.rt_code and subrt_code=t.subrt_code and sub_subrt_code=t.sub_subrt_code) sub_subrt_name,
        t.taxi_id, t.vehicle_name vehicle_name, t.vehicle_no vehicle_no 
        from cir_taxi_mast t,cir_route_mast r
        where t.comp_code=r.comp_code and t.comp_code=pcomp_code and t.unit_code=r.unit and (t.unit_code=punit_code or punit_code is null) and 
        t.rt_code=r.route_code and (t.rt_code=proute_code or proute_code is null) and taxi_id=ptaxi_code) x,
        (select distinct b.comp_code comp_code,b.unit unit_code,b.route_code route_code,b.subroute_code subroute_code,
        b.sub_subroute_code sub_subroute_code,a.station_code drop_point_code,c.drop_point_name drop_point_name,
        c.latitude latitude,c.lognitude lognitude,b.lbl_printno lbl_printno
        from cir_agmast a,cir_supply b,cir_drop_point_mast c
        where a.comp_code=b.comp_code and a.comp_code=c.comp_code and a.comp_code=pcomp_code and a.unit=b.unit and
        a.unit=c.unit_code and (a.unit=punit_code or punit_code is null) and a.agcd=b.agcd and a.dpcd=b.dpcd and
        a.station_code=c.drop_point and (b.route_code=proute_code or proute_code is null) and 
        nvl(a.suspend,'N')='N' and nvl(a.freeze_flag,'N')='N' and nvl(c.freeze_flag,'N')='N') y
        where x.comp_code=y.comp_code and x.unit_code=y.unit_code and x.rt_code=y.route_code and 
        x.subrt_code=y.subroute_code and (x.subrt_code=psubroutecode or psubroutecode is null) and 
        x.sub_subrt_code=y.sub_subroute_code and (x.sub_subrt_code=psub_subroutecode or psub_subroutecode is null) and 
        y.subroute_code is not null and y.sub_subroute_code is not null
        group by x.comp_code, x.unit_code, x.tpt_code,x.tpt_name,
        x.rt_code,x.rt_name,x.subrt_code, x.subrt_name,x.sub_subrt_code,x.sub_subrt_name,
        x.taxi_id, x.vehicle_name, x.vehicle_no,y.drop_point_code,y.drop_point_name,y.latitude,y.lognitude 
        order by x.comp_code, x.unit_code,x.taxi_id,y.drop_point_name;       
    end if;
End cir_route_drop_point_detail_p;
/


//////////////////////////////////////////////////////////////////////////////////////////////////////////////

CREATE OR REPLACE procedure cir_rep_do_agencywise_p(
     pcompcode          in varchar2,
     punitcode          in varchar2,
     pbrancode          in varchar2,
     proutemode         in varchar2,
     proute             in varchar2,
     psubroute          in varchar2,
     psubsub_route      in varchar2,
     ppubl              in varchar2,
     pagtype            in varchar2,
     pagclass           in varchar2,
     pagcd              in varchar2,
     pdpcd              in varchar2,
     pdistcode          in varchar2,
     plbldt             in varchar2,
     preptype           in varchar2,---1 for do report and 2 for packing list report
     puserid            in varchar2,
     pdateformat        in varchar2,
     pextra1            in varchar2,
     pextra2            in varchar2,
     pextra3            in varchar2,
     pextra4            in varchar2,
     pextra5            in varchar2,
     p_accounts         OUT Cur_Type_New1.cursor_type,
     p_accounts1        OUT Cur_Type_New1.cursor_type)
As
    vlbldt date;
Begin
    vlbldt:=to_date(plbldt,''''||pdateformat||'''');

    open p_accounts for
    select distinct l.comp_code as "COMP_CODE",l.unit_code as "UNIT_CODE",l.agcd as "AGCD", l.dpcd as "DPCD",l.lbl_dt as "LBL_DT",
    l.route as "ROUTE_CODE",l.rtnm as "RTNM",l.rtonm as "RTONM",l.subrt as "SUBROUTE_CODE",l.subrtnm as "SUBRTNM",l.subrtonm as "SUBRTONM",
    l.sub_subrt as "SUB_SUBROUTE_CODE",l.subsubrtnm as "SUBSUBRTNM",l.subsubrtonm as "SUBSUBRTONM",l.pkt_size as "PACKET_SIZE", 
    l.lbl_tno as "NO_OF_PACKET",m.mode_desc as "MODE_NAME",
    l.agname as "AGNAME",l.agoname as "AGONAME", l.city_name as "CITY_NAME", l.city_oname as "CITY_ONAME", 
    a.station_code as "DROP_POINT", l.station_name as "DROP_POINT_NAME", l.station_oname as "DROP_POINT_ONAME", l.publ as "PUBL",cir_get_publ_name(l.comp_code,l.publ) as "PUBL_NAME", 
    l.edtn as "EDTN",cir_get_edtn_name(l.comp_code,l.edtn) as "EDTN_NAME", 
    sum(l.supply_1) as "NO_OF_COPY",case when l.lbl_tno<=1 then 0 else l.lbl_tno-1 end "STD_PACKET",
    case when l.lbl_tno<=1 then sum(l.supply_1) else sum(l.supply_1)-((l.lbl_tno-1)*l.PKT_SIZE) end as "END_PACKET_COPY",
    l.sup_rate as "SUP_RATE", l.distname as "DISTNAME", l.distoname as "DISTONAME"
    from cir_agmast a,cir_lblmast l,cir_route_mast r,cir_route_mode_mast m
    where a.comp_code=l.comp_code and a.comp_code=r.comp_code and a.comp_code=m.comp_code and a.comp_code=pcompcode and 
    a.unit=l.unit_code and a.unit=r.unit and a.unit=punitcode and a.agcd=l.agcd and a.agcd=nvl(pagcd,l.agcd) and a.dpcd=l.dpcd and a.dpcd=nvl(pdpcd,l.dpcd) and 
    r.route_code=l.route and r.route_code=nvl(proute,r.route_code) and (l.subrt=psubroute or psubroute is null) and
    (l.sub_subrt=psubsub_route or psubsub_route is null) and r.route_mode=m.mode_code and r.route_mode=nvl(proutemode,r.route_mode) and 
    l.lbl_dt=vlbldt and (a.ag_type=pagtype or pagtype is null) and (a.ag_class=pagclass or pagclass is null) and 
    (a.branch_code=pbrancode or pbrancode is null) and (a.dist_code=pdistcode or pdistcode is null)
    group by l.comp_code,l.unit_code,l.agcd, l.dpcd,l.lbl_dt,l.route,l.rtnm,l.rtonm,l.subrt,l.subrtnm,l.subrtonm,
    l.sub_subrt,l.subsubrtnm,l.subsubrtonm,l.pkt_size,l.lbl_tno,m.mode_desc,l.agname,l.agoname, l.city_name, l.city_oname, 
    a.station_code,l.station_name, l.station_oname,publ,edtn,l.sup_rate, l.publ_name, l.distname, l.distoname
    order by comp_code,unit_code,rtnm,subrtnm,subsubrtnm,agname;
    
    open p_accounts1 for
    select sysdate as "CUR_DATE" from dual; 
End cir_rep_do_agencywise_p;
/

/////////////////////////////////////////////End of Procedure////////////////////////////////////////////////
